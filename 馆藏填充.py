import sqlite3
import os
import random
import datetime

# 数据库路径
DB_PATH = os.path.join(os.getcwd(), 'instance', 'library.db')

# 模拟真实书籍数据 (每类约8本，涵盖不同领域)
# 格式: (ISBN, 书名, 作者, 出版社, CLC分类号)
# 注意：为了脚本简洁，部分ISBN可能为模拟的13位数字，但格式符合标准
BOOKS_DATA = {
    'A': [  # 马列主义
        ('9787010009149', '资本论(第一卷)', '马克思', '人民出版社', 'A11'),
        ('9787010009224', '资本论(第二卷)', '马克思', '人民出版社', 'A11'),
        ('9787010009231', '资本论(第三卷)', '马克思', '人民出版社', 'A11'),
        ('9787010214048', '共产党宣言', '马克思', '人民出版社', 'A12'),
        ('9787010069907', '毛泽东选集', '毛泽东', '人民出版社', 'A41'),
        ('9787010008890', '列宁选集', '列宁', '人民出版社', 'A2'),
        ('9787010009668', '邓小平文选', '邓小平', '人民出版社', 'A49'),
        ('9787010183887', '习近平谈治国理政', '习近平', '外文出版社', 'A51'),
    ],
    'B': [  # 哲学
        ('9787100017688', '纯粹理性批判', '康德', '商务印书馆', 'B516.31'),
        ('9787100011495', '形而上学', '亚里士多德', '商务印书馆', 'B502.233'),
        ('9787100021319', '存在与时间', '海德格尔', '三联书店', 'B516.54'),
        ('9787532739563', '查拉图斯特拉如是说', '尼采', '上海译文出版社', 'B516.47'),
        ('9787100003353', '理想国', '柏拉图', '商务印书馆', 'B502.232'),
        ('9787208063853', '中国哲学简史', '冯友兰', '北京大学出版社', 'B2'),
        ('9787101003468', '论语译注', '杨伯峻', '中华书局', 'B222.2'),
        ('9787508647340', '苏菲的世界', '乔斯坦·贾德', '中信出版社', 'B50'),
    ],
    'C': [  # 社会科学
        ('9787508603438', '引爆点', '马尔科姆·格拉德威尔', '中信出版社', 'C912.6'),
        ('9787544270634', '乌合之众', '古斯塔夫·勒庞', '中央编译出版社', 'C912.64'),
        ('9787108022872', '乡土中国', '费孝通', '三联书店', 'C912.81'),
        ('9787508643168', '从0到1', '彼得·蒂尔', '中信出版社', 'C93'),
        ('9787100022378', '社会契约论', '卢梭', '商务印书馆', 'C0'),
        ('9787208092280', '社会学想象力', 'C.赖特·米尔斯', '三联书店', 'C91'),
        ('9787300243451', '社会心理学', '戴维·迈尔斯', '人民邮电出版社', 'C912.6'),
        ('9787508678405', '原则', '瑞·达利欧', '中信出版社', 'C93'),
    ],
    'F': [  # 经济
        ('9787100022347', '国富论', '亚当·斯密', '商务印书馆', 'F091.33'),
        ('9787508649719', '21世纪资本论', '托马斯·皮凯蒂', '中信出版社', 'F0'),
        ('9787111340798', '曼昆经济学原理', '曼昆', '机械工业出版社', 'F0'),
        ('9787508638362', '思考，快与慢', '丹尼尔·卡尼曼', '中信出版社', 'F06'),
        ('9787508634197', '黑天鹅', '纳西姆·尼古拉斯·塔勒布', '中信出版社', 'F069.9'),
        ('9787508616902', '非理性繁荣', '罗伯特·席勒', '中国人民大学出版社', 'F830.91'),
        ('9787508645063', '激荡三十年', '吴晓波', '中信出版社', 'F12'),
        ('9787111231645', '货币战争', '宋鸿兵', '中信出版社', 'F821.5'),
    ],
    'H': [  # 语言
        ('9787100000000', '现代汉语词典', '社科院', '商务印书馆', 'H164'),
        ('9787560013460', '新概念英语', '亚历山大', '外语教学与研究出版社', 'H31'),
        ('9787100039277', '语言学纲要', '叶蜚声', '北京大学出版社', 'H0'),
        ('9787544627063', '翻译论', '许渊冲', '上海外语教育出版社', 'H059'),
        ('9787208006454', '修辞学发凡', '陈望道', '上海教育出版社', 'H15'),
        ('9787100010955', '说文解字', '许慎', '中华书局', 'H161'),
        ('9787513529372', '牛津高阶英汉双解词典', '霍恩比', '商务印书馆', 'H316'),
        ('9787560032904', '雅思词汇真经', '刘洪波', '外语教学与研究出版社', 'H313'),
    ],
    'I': [  # 文学
        ('9787020002207', '平凡的世界', '路遥', '人民文学出版社', 'I247.57'),
        ('9787532725696', '挪威的森林', '村上春树', '上海译文出版社', 'I313.45'),
        ('9787544253996', '百年孤独', '加西亚·马尔克斯', '南海出版公司', 'I775.45'),
        ('9787020024759', '红楼梦', '曹雪芹', '人民文学出版社', 'I242.4'),
        ('9787530211566', '活着', '余华', '北京十月文艺出版社', 'I247.57'),
        ('9787544270870', '解忧杂货店', '东野圭吾', '南海出版公司', 'I313.45'),
        ('9787506365437', '三体', '刘慈欣', '重庆出版社', 'I247.5'),
        ('9787500601593', '围城', '钱钟书', '人民文学出版社', 'I247.57'),
    ],
    'J': [  # 艺术
        ('9787535653621', '艺术的故事', '贡布里希', '广西美术出版社', 'J110.9'),
        ('9787102021676', '中国美术史', '王逊', '人民美术出版社', 'J120.9'),
        ('9787112076046', '建筑空间组合论', '彭一刚', '中国建筑工业出版社', 'J59'),
        ('9787561825314', '电影艺术', '大卫·波德维尔', '世界图书出版公司', 'J901'),
        ('9787806653686', '西方音乐史', '格劳特', '人民音乐出版社', 'J609.1'),
        ('9787532269220', '设计心理学', '唐纳德·诺曼', '中信出版社', 'J50-05'),
        ('9787115166417', '摄影笔记', '宁思潇潇', '人民邮电出版社', 'J40'),
        ('9787540458022', '美的历程', '李泽厚', '生活·读书·新知三联书店', 'J120.9'),
    ],
    'K': [  # 历史
        ('9787108047913', '万历十五年', '黄仁宇', '三联书店', 'K248.3'),
        ('9787508647357', '人类简史', '尤瓦尔·赫拉利', '中信出版社', 'K02'),
        ('9787101003239', '史记', '司马迁', '中华书局', 'K204.2'),
        ('9787508660752', '丝绸之路', '彼得·弗兰科潘', '中信出版社', 'K93'),
        ('9787208060012', '叫魂', '孔飞力', '上海三联书店', 'K249.3'),
        ('9787100012218', '全球通史', '斯塔夫里阿诺斯', '北京大学出版社', 'K10'),
        ('9787544760548', '枪炮、病菌与钢铁', '贾雷德·戴蒙德', '上海译文出版社', 'K02'),
        ('9787108013894', '明朝那些事儿', '当年明月', '中国海关出版社', 'K248'),
    ],
    'N': [  # 自然科学总论
        ('9787542845339', '科学革命的结构', '托马斯·库恩', '北京大学出版社', 'N09'),
        ('9787535732302', '时间简史', '史蒂芬·霍金', '湖南科学技术出版社', 'N49'),
        ('9787532753309', '从一到无穷大', '伽莫夫', '科学出版社', 'N49'),
        ('9787544328397', '自私的基因', '理查德·道金斯', '中信出版社', 'Q111.2'),
        ('9787535733576', '果壳中的宇宙', '史蒂芬·霍金', '湖南科学技术出版社', 'P159'),
        ('9787208093683', '万物简史', '比尔·布莱森', '接力出版社', 'N49'),
        ('9787540467369', '三体中的物理学', '李淼', '四川科学技术出版社', 'N0'),
        ('9787030103520', '自然辩证法', '恩格斯', '人民出版社', 'N031'),
    ],
    'T': [  # 工业技术
        ('9787111326440', '代码整洁之道', 'Robert C. Martin', '人民邮电出版社', 'TP311.5'),
        ('9787111370061', '算法导论', 'Cormen', '机械工业出版社', 'TP301.6'),
        ('9787111255833', '人月神话', 'Brooks', '清华大学出版社', 'TP311.52'),
        ('9787121155952', '深入理解计算机系统', 'Bryant', '机械工业出版社', 'TP3'),
        ('9787115147317', 'C++ Primer', 'Lippman', '人民邮电出版社', 'TP312'),
        ('9787111213826', 'Java编程思想', 'Eckel', '机械工业出版社', 'TP312'),
        ('9787302423287', '机器学习', '周志华', '清华大学出版社', 'TP181'),
        ('9787115546081', 'Python编程：从入门到实践', 'Matthes', '人民邮电出版社', 'TP311.56')
    ]
}

# 补充其他分类 (O, P, Q, R, S, U, V, X, Z) 避免数据太少
# 使用生成逻辑填充剩余分类
ADDITIONAL_CATS = ['O', 'P', 'Q', 'R', 'S', 'U', 'V', 'X', 'Z']
for cat in ADDITIONAL_CATS:
    BOOKS_DATA[cat] = []
    for i in range(8):
        isbn = f"9787{random.randint(10000000, 99999999)}"
        BOOKS_DATA[cat].append((
            isbn,
            f"{cat}类-专业书籍-{i + 1}",
            f"专家{chr(65 + i)}",
            "科学技术出版社",
            f"{cat}{i + 10}"
        ))


# --- 服务类函数 (复制自 MapService 避免导入问题) ---
def generate_call_number(db, clc_code, author):
    # 统计种次号
    row = db.execute("SELECT COUNT(*) FROM CIRCULATION_HEAD WHERE CLC_CODE = ?", (clc_code,)).fetchone()
    count = row[0] if row else 0
    sequence = count + 1

    # 作者号处理
    author_code = 'A'
    if author:
        try:
            first_char = author.strip()[0]
            if '\u4e00' <= first_char <= '\u9fff':
                author_code = 'Z'
            else:
                author_code = first_char.upper()
        except:
            pass

    return f"{clc_code}/{author_code}-{sequence}"


def run():
    print(f">>> 连接数据库: {DB_PATH}")
    if not os.path.exists(DB_PATH):
        print("!!! 错误：数据库文件不存在。请先运行 run.py 初始化项目。")
        return

    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    # 1. 整理所有待插入书籍
    all_books = []
    for cat, books in BOOKS_DATA.items():
        for book in books:
            all_books.append(book)

    # 2. 随机打乱顺序 (这样 New Arrivals 就会是混合分类的)
    print(f">>> 正在准备 {len(all_books)} 种图书数据...")
    random.shuffle(all_books)

    # 3. 开始插入
    count_head = 0
    count_detail = 0

    print(">>> 开始批量入库...")
    for isbn, title, author, publisher, clc in all_books:
        # 检查 ISBN 是否已存在
        exist = cursor.execute("SELECT ISBN FROM CIRCULATION_HEAD WHERE ISBN=?", (isbn,)).fetchone()
        if exist:
            print(f"    跳过已存在图书: {title}")
            continue

        # 生成索书号
        call_no = generate_call_number(conn, clc, author)

        # 插入头表
        cursor.execute(
            "INSERT INTO CIRCULATION_HEAD (ISBN, CALL_NUMBER, BOOK_NAME, AUTHOR, CLC_CODE) VALUES (?, ?, ?, ?, ?)",
            (isbn, call_no, title, author, clc)
        )

        # 插入明细表 (10个复本)
        for i in range(10):
            # 生成唯一条码
            suffix = str(random.randint(1000, 9999))
            barcode = f"{isbn[-6:]}-{suffix}-{i}"

            # 确定馆藏地
            floor = 1 if clc[0] in ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K'] else 2
            location = f"{floor}楼流通库-{clc[0]}区"

            cursor.execute(
                "INSERT INTO CIRCULATION_DETAIL (BARCODE, ISBN, LOCATION, STATUS) VALUES (?, ?, ?, 1)",
                (barcode, isbn, location)
            )
            count_detail += 1

        count_head += 1

    conn.commit()
    conn.close()
    print(f"\n>>> 数据库填充完成！")
    print(f"    新增图书种类: {count_head}")
    print(f"    新增馆藏册数: {count_detail}")
    print(">>> 您现在可以启动 run.py 查看效果了。")


if __name__ == '__main__':
    run()