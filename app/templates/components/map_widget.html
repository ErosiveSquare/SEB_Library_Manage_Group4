{% macro render_map(map_data, container_height="600px") %}
<style>
    /* --- Digital Twin Map Container (iOS Style) --- */
    .dt-wrapper {
        position: relative;
        width: 100%;
        height: {{ container_height }};
        background: #f5f5f7; /* Apple System Gray 6 */
        border-radius: 24px;
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.08);
        box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    }

    /* Floor Control (Floating Segmented Control) */
    .dt-controls {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        display: flex; background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        padding: 4px; border-radius: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.04);
        z-index: 10;
    }
    .dt-tab {
        padding: 8px 24px; border-radius: 20px; font-size: 14px;
        font-weight: 600;
        cursor: pointer; color: #86868b; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex; align-items: center; gap: 6px;
    }
    .dt-tab.active {
        background: white; color: #1d1d1f;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .dt-tab:hover:not(.active) { color: #1d1d1f; }

    /* Map Canvas */
    .dt-canvas {
        width: 100%;
        height: 100%;
        display: flex; align-items: center; justify-content: center;
        perspective: 1000px; /* 3D Perspective */
    }

    .floor-view {
        position: absolute;
        width: 100%; height: 100%;
        opacity: 0; pointer-events: none;
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        transform: scale(0.95) translateY(10px);
        display: flex;
        align-items: center; justify-content: center;
    }
    .floor-view.active {
        opacity: 1;
        pointer-events: all;
        transform: scale(1) translateY(0);
    }

    /* Shelf Elements */
    .shelf-group { cursor: pointer; transition: transform 0.3s; }
    .shelf-group:hover { transform: translateY(-2px); }

    .shelf-body {
        stroke: white; stroke-width: 2;
        vector-effect: non-scaling-stroke;
        filter: url(#shelfShadow);
        transition: fill 0.3s ease;
    }

    /* Heatmap Colors (Dynamic Fill) */
    .fill-level-0 { fill: #e5e7eb; } /* Empty */
    .fill-level-1 { fill: #dbeafe; } /* Low */
    .fill-level-2 { fill: #93c5fd; } /* Med */
    .fill-level-3 { fill: #3b82f6; } /* High */
    .fill-level-4 { fill: #2563eb; } /* Full */

    /* Target Shelf Styling (High Contrast for Selected Shelf) */
    .target-shelf-body {
        stroke: #ef4444 !important; /* Red Border */
        stroke-width: 3;
        fill: #fee2e2 !important; /* Light Red Fill */
    }

    /* --- [关键修改] 新的矩形波纹动画逻辑 --- */
    .ripple-rect {
        fill: none;
        stroke: #ef4444; /* 红色波纹 */
        stroke-width: 2;
        opacity: 0;

        /* 核心：确保变换基于元素自身的边界框中心 */
        transform-box: fill-box;
        transform-origin: center;

        animation: rippleExpand 2s infinite cubic-bezier(0, 0.2, 0.5, 1);
        pointer-events: none; /* 让鼠标事件穿透波纹层 */
    }

    /* 第二层延迟波纹，增加回声质感 */
    .ripple-rect-delay {
        animation-delay: 0.6s;
    }

    @keyframes rippleExpand {
        0% {
            opacity: 0.8;
            transform: scale(1); /* 从原始大小开始 */
            stroke-width: 4px;
        }
        100% {
            opacity: 0;
            transform: scale(1.4); /* 向四周均匀扩大 40% */
            stroke-width: 0px;
        }
    }

    /* Pin Marker Animation */
    .pin-marker {
        animation: bouncePin 2s infinite;
        transform-origin: bottom center;
        /* 确保 Pin 也是相对于自身位置跳动 */
        transform-box: fill-box;
    }
    @keyframes bouncePin {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }

    /* HUD Info Overlay */
    .dt-info-panel {
        position: absolute;
        bottom: 30px; left: 30px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        padding: 16px 24px; border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.05);
        display: none; animation: slideUp 0.3s ease;
        z-index: 20; min-width: 200px;
    }
    @keyframes slideUp { from {transform: translateY(10px); opacity:0;} to {transform: translateY(0); opacity:1;} }

    .info-title { font-size: 16px; font-weight: 700; color: #1d1d1f; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .info-stat { font-size: 13px; color: #86868b; display: flex; justify-content: space-between; margin-top: 8px; }
    .info-bar { height: 4px; background: #f5f5f7; border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .info-bar-fill { height: 100%; background: #3b82f6; width: 0%; transition: width 0.5s; }

    /* Legend */
    .dt-legend {
        position: absolute;
        bottom: 30px; right: 30px;
        display: flex; gap: 15px; align-items: center;
        font-size: 12px; color: #86868b;
        background: rgba(255,255,255,0.6); padding: 8px 16px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
    }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
</style>

<div class="dt-wrapper">
    <div class="dt-controls">
        <div class="dt-tab {{ 'active' if map_data.target_floor == 1 else '' }}" onclick="switchFloor(1)">
            <i class="fas fa-layer-group"></i> 1F 人文社科
        </div>
        <div class="dt-tab {{ 'active' if map_data.target_floor == 2 else '' }}" onclick="switchFloor(2)">
            <i class="fas fa-flask"></i> 2F 自然科学
        </div>
    </div>

    <div class="dt-canvas">
        <svg style="position: absolute; width:0; height:0;">
            <defs>
                <filter id="shelfShadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="0" dy="4" stdDeviation="4" flood-color="#000" flood-opacity="0.1"/>
                </filter>
                <pattern id="gridPattern" width="40" height="40" patternUnits="userSpaceOnUse">
                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#e5e7eb" stroke-width="0.5"/>
                </pattern>
            </defs>
        </svg>

        {% for floor_num in [1, 2] %}
        <div class="floor-view {{ 'active' if map_data.target_floor == floor_num else '' }}" id="floor-{{ floor_num }}">
            <svg viewBox="0 0 1000 600" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
                <rect x="0" y="0" width="1000" height="600" fill="url(#gridPattern)" opacity="0.6"/>

                {% for zone in map_data.zones if zone.floor == floor_num %}
                    {% set fill_class = 'fill-level-0' %}
                    {% if zone.intensity > 0.8 %} {% set fill_class = 'fill-level-4' %}
                    {% elif zone.intensity > 0.5 %} {% set fill_class = 'fill-level-3' %}
                    {% elif zone.intensity > 0.2 %} {% set fill_class = 'fill-level-2' %}
                    {% elif zone.intensity > 0 %} {% set fill_class = 'fill-level-1' %}
                    {% endif %}

                    <g class="shelf-group"
                       onclick="showZoneInfo('{{ zone.name }}', {{ zone.count }}, {{ zone.intensity }}, '{{ zone.icon }}')"
                       onmouseenter="highlightShelf(this)" onmouseleave="unhighlightShelf(this)">

                        <rect x="{{ zone.x }}" y="{{ zone.y }}" width="{{ zone.w }}" height="{{ zone.h }}" rx="6"
                              class="shelf-body {{ fill_class }} {{ 'target-shelf-body' if zone.id == map_data.target_zone_id else '' }}">
                        </rect>

                        <text x="{{ zone.x + zone.w/2 }}" y="{{ zone.y + zone.h/2 }}"
                              text-anchor="middle" dominant-baseline="middle"
                              fill="#1d1d1f" font-weight="700" font-size="16"
                              style="pointer-events:none; opacity: 0.8;">
                            {{ zone.id }}
                        </text>

                        {% if zone.id == map_data.target_zone_id %}
                            <rect x="{{ zone.x }}" y="{{ zone.y }}"
                                  width="{{ zone.w }}" height="{{ zone.h }}"
                                  rx="6"
                                  class="ripple-rect">
                            </rect>

                            <rect x="{{ zone.x }}" y="{{ zone.y }}"
                                  width="{{ zone.w }}" height="{{ zone.h }}"
                                  rx="6"
                                  class="ripple-rect ripple-rect-delay">
                            </rect>

                            <foreignObject x="{{ zone.x + zone.w/2 - 15 }}" y="{{ zone.y - 45 }}" width="30" height="30" class="pin-marker">
                                <div style="width:30px; height:30px; background:#ef4444; border-radius:50%;
                                            display:flex; align-items:center; justify-content:center;
                                            color:white; box-shadow:0 4px 10px rgba(239,68,68,0.4); border: 2px solid white;">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                            </foreignObject>
                        {% endif %}
                    </g>
                {% endfor %}
            </svg>
        </div>
        {% endfor %}
    </div>

    <div class="dt-info-panel" id="zoneInfo">
        <div class="info-title">
            <i id="infoIcon" class="fas fa-book"></i> <span id="infoName">区域名称</span>
        </div>
        <div class="info-stat">
            <span>当前藏书</span> <span style="font-weight:600; color:#1d1d1f;" id="infoCount">0</span>
        </div>
        <div class="info-stat">
            <span>区域密度</span> <span id="infoPercent">0%</span>
        </div>
        <div class="info-bar"><div class="info-bar-fill" id="infoBar"></div></div>
    </div>

    <div class="dt-legend">
        <div class="legend-item"><div class="legend-dot" style="background:#dbeafe;"></div> 空闲</div>
        <div class="legend-item"><div class="legend-dot" style="background:#93c5fd;"></div> 适中</div>
        <div class="legend-item"><div class="legend-dot" style="background:#2563eb;"></div> 密集</div>
        {% if map_data.target_zone_id %}
        <div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div> 目标位置</div>
        {% endif %}
    </div>
</div>

<script>
    function switchFloor(floor) {
        document.querySelectorAll('.dt-tab').forEach((el, idx) => el.classList.toggle('active', idx + 1 === floor));
        document.getElementById('floor-1').classList.toggle('active', floor === 1);
        document.getElementById('floor-2').classList.toggle('active', floor === 2);
    }

    function showZoneInfo(name, count, intensity, iconClass) {
        const panel = document.getElementById('zoneInfo');
        document.getElementById('infoName').innerText = name;
        document.getElementById('infoCount').innerText = count + ' 本';
        document.getElementById('infoPercent').innerText = Math.round(intensity * 100) + '%';
        document.getElementById('infoBar').style.width = (intensity * 100) + '%';
        document.getElementById('infoIcon').className = iconClass || 'fas fa-book';

        panel.style.display = 'block';
    }

    function highlightShelf(el) { el.style.filter = 'brightness(0.95)'; }
    function unhighlightShelf(el) { el.style.filter = 'none'; }

    {% if map_data.target_zone_id %}
    // 自动高亮目标区域信息 (可选)
    // 实际项目中可以通过 JS 传递数据自动触发 showZoneInfo
    {% endif %}
</script>
{% endmacro %}