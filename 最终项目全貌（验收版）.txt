# é¡¹ç›®å…¨è²Œ: LibraryManage
> ç”Ÿæˆæ—¶é—´: å®Œæ•´é¡¹ç›®ä¿¡æ¯è·å–.py

## 1. é¡¹ç›®ç›®å½•ç»“æ„
```text
LibraryManage
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ blueprints
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ acq.py
â”‚   â”‚   â”œâ”€â”€ ai.py
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”œâ”€â”€ circ.py
â”‚   â”‚   â”œâ”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ notice.py
â”‚   â”‚   â””â”€â”€ sys_admin.py
â”‚   â”œâ”€â”€ models.py
â”‚   â”œâ”€â”€ services
â”‚   â”‚   â”œâ”€â”€ ai_service.py
â”‚   â”‚   â””â”€â”€ map_service.py
â”‚   â”œâ”€â”€ static
â”‚   â”‚   â”œâ”€â”€ asset
â”‚   â”‚   â”‚   â””â”€â”€ covers
â”‚   â”‚   â”œâ”€â”€ css
â”‚   â”‚   â””â”€â”€ js
â”‚   â””â”€â”€ templates
â”‚       â”œâ”€â”€ acq
â”‚       â”‚   â”œâ”€â”€ arrival.html
â”‚       â”‚   â”œâ”€â”€ order_process.html
â”‚       â”‚   â””â”€â”€ suggestion.html
â”‚       â”œâ”€â”€ admin
â”‚       â”‚   â”œâ”€â”€ access_config.html
â”‚       â”‚   â”œâ”€â”€ maintenance.html
â”‚       â”‚   â”œâ”€â”€ stats.html
â”‚       â”‚   â””â”€â”€ user_list.html
â”‚       â”œâ”€â”€ auth
â”‚       â”‚   â”œâ”€â”€ Login.html
â”‚       â”‚   â””â”€â”€ register.html
â”‚       â”œâ”€â”€ base.html
â”‚       â”œâ”€â”€ circ
â”‚       â”‚   â”œâ”€â”€ history.html
â”‚       â”‚   â””â”€â”€ workbench.html
â”‚       â”œâ”€â”€ components
â”‚       â”‚   â””â”€â”€ map_widget.html
â”‚       â””â”€â”€ main
â”‚           â”œâ”€â”€ book_detail.html
â”‚           â”œâ”€â”€ dashboard.html
â”‚           â”œâ”€â”€ library_map.html
â”‚           â”œâ”€â”€ profile.html
â”‚           â”œâ”€â”€ profile_credit.html
â”‚           â””â”€â”€ search.html
â”œâ”€â”€ config.py
â”œâ”€â”€ instance
â”œâ”€â”€ OpsSystem
â”‚   â”œâ”€â”€ backups
â”‚   â”œâ”€â”€ run_ops.py
â”‚   â”œâ”€â”€ static
â”‚   â””â”€â”€ templates
â”‚       â”œâ”€â”€ backup.html
â”‚       â”œâ”€â”€ base_ops.html
â”‚       â”œâ”€â”€ dashboard.html
â”‚       â”œâ”€â”€ db_manager.html
â”‚       â”œâ”€â”€ login.html
â”‚       â””â”€â”€ register.html
â”œâ”€â”€ run.py
â”œâ”€â”€ å®Œæ•´é¡¹ç›®ä¿¡æ¯è·å–.py
â””â”€â”€ é¦†è—å¡«å…….py

```

## 2. æ–‡ä»¶ä»£ç è¯¦æƒ… (å…± 42 ä¸ªæ–‡ä»¶)

### ğŸ“„ app\__init__.py
```python
import os
from flask import Flask

def create_app(test_config=None):
    app = Flask(__name__, instance_relative_config=True)

    # åŠ è½½ Config ç±»é…ç½®
    from config import Config
    app.config.from_object(Config)

    try:
        os.makedirs(app.instance_path)
    except OSError:
        pass

    from . import models
    # æ³¨å†Œæ•°æ®åº“å…³é—­å‡½æ•°
    app.teardown_appcontext(models.close_db)

    # æ³¨å†Œè“å›¾
    from .blueprints import auth, main, acq, circ, sys_admin, ai, notice  # [æ–°å¢ notice]

    app.register_blueprint(auth.bp)
    app.register_blueprint(main.bp)
    app.register_blueprint(acq.bp)
    app.register_blueprint(circ.bp)
    app.register_blueprint(sys_admin.bp)
    app.register_blueprint(ai.bp)
    app.register_blueprint(notice.bp)

    app.add_url_rule('/', endpoint='main.dashboard')

    return app
```
---

### ğŸ“„ app\blueprints\__init__.py
```python

```
---

### ğŸ“„ app\blueprints\acq.py
```python
from flask import Blueprint, render_template, request, flash, session, redirect, url_for, jsonify
from app.models import get_db, get_periodical_db, CLC_DATA
from app.blueprints.auth import permission_required
from app.services.map_service import MapService
import datetime
import random
import requests

bp = Blueprint('acq', __name__, url_prefix='/acq')


@bp.route('/search_online', methods=['POST'])
@permission_required('access_services')
def search_online():
    """æ ¹æ®ä¹¦å/ä½œè€…åœ¨çº¿åæŸ¥ ISBN"""
    data = request.get_json()
    query = data.get('query', '').strip()
    if not query: return jsonify({'success': False, 'message': 'æœç´¢å†…å®¹ä¸èƒ½ä¸ºç©º'})

    api_url = "https://openlibrary.org/search.json"
    params = {'q': query, 'fields': 'title,author_name,isbn,publisher,first_publish_year,cover_i,language', 'limit': 5}

    try:
        resp = requests.get(api_url, params=params, timeout=8)
        resp.raise_for_status()
        result = resp.json()
        if result.get('num_found', 0) == 0: return jsonify({'success': True, 'found': False, 'results': []})

        formatted_results = []
        for doc in result.get('docs', []):
            isbn_list = doc.get('isbn', [])
            best_isbn = ""
            if isbn_list:
                candidates = [i for i in isbn_list if i.startswith('978')]
                best_isbn = candidates[0] if candidates else isbn_list[0]
            authors = ", ".join(doc.get('author_name', []))
            publishers = ", ".join(doc.get('publisher', []))
            cover_id = doc.get('cover_i')
            cover_url = f"https://covers.openlibrary.org/b/id/{cover_id}-S.jpg" if cover_id else None
            formatted_results.append(
                {'title': doc.get('title'), 'author': authors, 'isbn': best_isbn, 'publisher': publishers,
                 'year': doc.get('first_publish_year'), 'cover': cover_url})
        return jsonify({'success': True, 'found': True, 'results': formatted_results})
    except Exception as e:
        print(f"OpenLibrary API Error: {e}")
        return jsonify({'success': False, 'message': 'è¿æ¥è¶…æ—¶'})


@bp.route('/suggestion', methods=('GET', 'POST'))
@permission_required('access_services')
def suggestion():
    if 'user_id' not in session: return redirect(url_for('auth.login'))
    db = get_db()
    per_db = get_periodical_db()
    reader_id = session['user_id']
    STATUS_PENDING = 0

    if request.method == 'POST':
        item_type = request.form.get('type', 'book')
        title = request.form.get('title', '').strip()
        code = request.form.get('code', '').strip()
        author_or_freq = request.form.get('author', '').strip()
        publisher = request.form.get('publisher', '').strip()

        if not title:
            flash('åç§°ä¸ºå¿…å¡«é¡¹ï¼', 'danger')
            return redirect(url_for('acq.suggestion'))

        try:
            if item_type == 'periodical':
                if not code:
                    flash('æœŸåˆŠ ISSN ä¸ºå¿…å¡«é¡¹ï¼', 'danger')
                    return redirect(url_for('acq.suggestion'))
                dup = per_db.execute('SELECT 1 FROM PER_SUGGESTION WHERE READER_ID=? AND ISSN=? AND STATUS=?',
                                     (reader_id, code, STATUS_PENDING)).fetchone()
                if dup:
                    flash('è¯¥æœŸåˆŠå·²åœ¨èè´­åˆ—è¡¨ä¸­ï¼', 'warning')
                else:
                    per_db.execute(
                        'INSERT INTO PER_SUGGESTION (READER_ID, TITLE, ISSN, PUBLISHER, STATUS) VALUES (?, ?, ?, ?, ?)',
                        (reader_id, title, code, publisher, STATUS_PENDING))
                    per_db.commit()
                    flash('æœŸåˆŠèè´­æäº¤æˆåŠŸï¼', 'success')
            else:
                if not author_or_freq:
                    flash('ä½œè€…ä¸ºå¿…å¡«é¡¹ï¼', 'danger')
                    return redirect(url_for('acq.suggestion'))
                dup = db.execute('SELECT 1 FROM ACQ_SUGGESTION WHERE READER_ID=? AND BOOK_NAME=? AND STATUS=?',
                                 (reader_id, title, STATUS_PENDING)).fetchone()
                if dup:
                    flash('è¯¥å›¾ä¹¦å·²æäº¤èè´­ï¼', 'warning')
                else:
                    db.execute(
                        'INSERT INTO ACQ_SUGGESTION (READER_ID, BOOK_NAME, AUTHOR, ISBN, PUBLISHER, STATUS) VALUES (?, ?, ?, ?, ?, ?)',
                        (reader_id, title, author_or_freq, code, publisher, STATUS_PENDING))
                    db.commit()
                    flash('å›¾ä¹¦èè´­æäº¤æˆåŠŸï¼', 'success')
        except Exception as e:
            db.rollback()
            per_db.rollback()
            flash('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚', 'danger')

        return redirect(url_for('acq.suggestion'))

    book_history = db.execute(
        'SELECT *, "book" as TYPE FROM ACQ_SUGGESTION WHERE READER_ID = ? ORDER BY ACQ_ID DESC LIMIT 20',
        (reader_id,)).fetchall()
    per_history = per_db.execute(
        'SELECT *, "periodical" as TYPE FROM PER_SUGGESTION WHERE READER_ID = ? ORDER BY SUG_ID DESC LIMIT 20',
        (reader_id,)).fetchall()

    history = []
    for h in book_history:
        d = dict(h)
        d['TITLE'] = d['BOOK_NAME']
        d['CODE'] = d['ISBN']
        d['SUB'] = d['AUTHOR']
        history.append(d)
    for h in per_history:
        d = dict(h)
        d['TITLE'] = d['TITLE']
        d['CODE'] = d['ISSN']
        d['SUB'] = 'æœŸåˆŠ'
        history.append(d)

    return render_template('acq/suggestion.html', history=history)


@bp.route('/orders', methods=('GET', 'POST'))
@permission_required('manage_acq_order')
def order_process():
    """
    è®¢å•å¤„ç†ä¸­å¿ƒï¼šåŒ…å«å›¾ä¹¦å’ŒæœŸåˆŠ
    """
    db = get_db()
    per_db = get_periodical_db()

    if request.method == 'POST':
        action = request.form.get('action')

        # 1. æ‰‹å·¥æ·»åŠ  (é»˜è®¤ä¸ºå›¾ä¹¦)
        if action == 'manual_add':
            book_name = request.form['book_name']
            isbn = request.form.get('isbn', '').strip()
            author = request.form['author']
            publisher = request.form.get('publisher', '')
            quantity = int(request.form.get('quantity', 1))

            db.execute("INSERT INTO ORDER_HEAD (PURCHASER, ORDER_DATE, SUPPLIER_ID, TOTAL_PRICE) VALUES (?, ?, 1, 0)",
                       (session['user_name'], datetime.datetime.now()))
            order_id = db.execute("SELECT last_insert_rowid()").fetchone()[0]

            db.execute('''
                INSERT INTO ORDER_LINE (ORDER_NO, SUGGESTION_ID, BOOK_NAME, ISBN, AUTHOR, PUBLISHER, PRICE, QUANTITY, STATUS, ITEM_TYPE)
                VALUES (?, NULL, ?, ?, ?, ?, 0, ?, 0, 'book')
            ''', (order_id, book_name, isbn, author, publisher, quantity))

            db.commit()
            flash(f'æ‰‹å·¥è®¢å• #{order_id} å·²åˆ›å»ºã€‚', 'success')
            return redirect(url_for('acq.order_process'))

        # 2. æ‰¹é‡å¤„ç†èè´­
        selected_ids = request.form.getlist('selected_ids')
        item_type = request.form.get('target_type', 'book')  # hidden input

        if not selected_ids and action in ['create_order', 'reject']:
            flash('è¯·å…ˆé€‰æ‹©æ¡ç›®', 'error')
        else:
            if action == 'create_order':
                db.execute(
                    "INSERT INTO ORDER_HEAD (PURCHASER, ORDER_DATE, SUPPLIER_ID, TOTAL_PRICE) VALUES (?, ?, 1, 0)",
                    (session['user_name'], datetime.datetime.now()))
                order_id = db.execute("SELECT last_insert_rowid()").fetchone()[0]

                total_qty = 0

                if item_type == 'book':
                    for acq_id in selected_ids:
                        sug = db.execute("SELECT * FROM ACQ_SUGGESTION WHERE ACQ_ID=?", (acq_id,)).fetchone()
                        qty = int(request.form.get(f"qty_book_{acq_id}", 1))
                        db.execute('''INSERT INTO ORDER_LINE (ORDER_NO, SUGGESTION_ID, BOOK_NAME, ISBN, AUTHOR, PUBLISHER, PRICE, QUANTITY, STATUS, ITEM_TYPE)
                                      VALUES (?, ?, ?, ?, ?, ?, 50.00, ?, 0, 'book')''',
                                   (order_id, acq_id, sug['BOOK_NAME'], sug['ISBN'], sug['AUTHOR'], sug['PUBLISHER'],
                                    qty))
                        db.execute('UPDATE ACQ_SUGGESTION SET STATUS = 1 WHERE ACQ_ID = ?', (acq_id,))
                        total_qty += 1

                elif item_type == 'periodical':
                    for sug_id in selected_ids:
                        sug = per_db.execute("SELECT * FROM PER_SUGGESTION WHERE SUG_ID=?", (sug_id,)).fetchone()
                        qty = int(request.form.get(f"qty_per_{sug_id}", 1))
                        # æœŸåˆŠå­˜å…¥ ORDER_LINE
                        db.execute('''INSERT INTO ORDER_LINE (ORDER_NO, SUGGESTION_ID, BOOK_NAME, ISBN, AUTHOR, PUBLISHER, PRICE, QUANTITY, STATUS, ITEM_TYPE)
                                      VALUES (?, ?, ?, ?, ?, ?, 0, ?, 0, 'periodical')''',
                                   (order_id, sug_id, sug['TITLE'], sug['ISSN'], 'Periodical', sug['PUBLISHER'], qty))
                        per_db.execute('UPDATE PER_SUGGESTION SET STATUS = 1 WHERE SUG_ID = ?', (sug_id,))
                        total_qty += 1

                db.commit()
                per_db.commit()
                flash(f'è®¢å• #{order_id} å·²ç”Ÿæˆ (åŒ…å« {total_qty} ä¸ªæ¡ç›®)ã€‚', 'success')

            elif action == 'reject':
                if item_type == 'book':
                    for acq_id in selected_ids:
                        db.execute('UPDATE ACQ_SUGGESTION SET STATUS = 2 WHERE ACQ_ID = ?', (acq_id,))
                    db.commit()
                else:
                    for sug_id in selected_ids:
                        per_db.execute('UPDATE PER_SUGGESTION SET STATUS = 2 WHERE SUG_ID = ?', (sug_id,))
                    per_db.commit()
                flash(f'å·²é©³å› {len(selected_ids)} æ¡ç”³è¯·ã€‚', 'warning')

    # --- ä¿®å¤æ ¸å¿ƒï¼šåˆ†å¼€æŸ¥è¯¢ï¼ŒPython å±‚åˆå¹¶ï¼Œé¿å…è·¨åº“ JOIN æŠ¥é”™ ---

    # 1. è·å–å›¾ä¹¦èè´­ (å¸¦è¯»è€…å)
    pending_books = db.execute(
        'SELECT s.*, r.NAME as READER_NAME FROM ACQ_SUGGESTION s JOIN READER r ON s.READER_ID = r.READER_ID WHERE s.STATUS = 0').fetchall()

    # 2. è·å–æœŸåˆŠèè´­ (å…ˆæŸ¥æœŸåˆŠåº“)
    pending_pers_raw = per_db.execute('SELECT * FROM PER_SUGGESTION WHERE STATUS = 0').fetchall()

    # 3. æ‰‹åŠ¨å¡«å……æœŸåˆŠèè´­ä¸­çš„è¯»è€…å§“å (å› ä¸ºè¯»è€…è¡¨åœ¨ library.db)
    pending_pers = []
    for p in pending_pers_raw:
        item = dict(p)
        reader = db.execute('SELECT NAME FROM READER WHERE READER_ID=?', (item['READER_ID'],)).fetchone()
        item['READER_NAME'] = reader['NAME'] if reader else f"Unknown ({item['READER_ID']})"
        pending_pers.append(item)

    return render_template('acq/order_process.html', pending_books=pending_books, pending_pers=pending_pers)


@bp.route('/arrival', methods=('GET', 'POST'))
@permission_required('manage_acq_arrival')
def arrival_check():
    db = get_db()
    per_db = get_periodical_db()
    new_book_map = None

    if request.method == 'POST':
        action = request.form['action']

        # 1. çº¯æ‰‹å·¥æœŸåˆŠå…¥åº“ (æ— è®¢å•)
        if action == 'periodical_entry':
            issn = request.form.get('issn', '').strip()
            title = request.form.get('title', '').strip()
            freq = request.form.get('frequency', 'æœªçŸ¥')
            clc = request.form.get('clc', '').strip()
            publisher = request.form.get('publisher', '')
            issue = request.form.get('issue', datetime.datetime.now().strftime('%Y-%m'))

            exist_head = per_db.execute("SELECT * FROM PERIODICAL_HEAD WHERE ISSN=?", (issn,)).fetchone()
            if not exist_head:
                per_db.execute(
                    "INSERT INTO PERIODICAL_HEAD (ISSN, TITLE, PUBLISHER, FREQUENCY, CLC_CODE) VALUES (?, ?, ?, ?, ?)",
                    (issn, title, publisher, freq, clc))

            time_part = datetime.datetime.now().strftime('%y%m%d%H%M')
            rand_part = random.randint(10, 99)
            barcode = f"P{issn[-4:]}{time_part}{rand_part}"

            per_db.execute(
                "INSERT INTO PERIODICAL_DETAIL (BARCODE, ISSN, YEAR_ISSUE, LOCATION, STATUS) VALUES (?, ?, ?, ?, 1)",
                (barcode, issn, issue, 'æœŸåˆŠé˜…è§ˆåŒº'))
            per_db.commit()

            flash(f'æœŸåˆŠã€Š{title}ã€‹å…¥åº“æˆåŠŸï¼', 'success')
            new_book_map = MapService.get_map_data(target_clc=clc)
            new_book_map['book_name'] = f"{title} (æœŸåˆŠ)"
            new_book_map['call_no'] = "æœŸåˆŠåŒº"

        # 2. è®¢å•éªŒæ”¶ (å›¾ä¹¦)
        elif action == 'accept':
            line_id = request.form['line_id']
            manual_isbn = request.form['isbn'].strip()
            manual_clc = request.form['clc_code'].strip()
            manual_author = request.form['author'].strip()
            line = db.execute("SELECT * FROM ORDER_LINE WHERE LINE_ID=?", (line_id,)).fetchone()

            auto_call_num = MapService.generate_call_number(manual_isbn, manual_clc, manual_author)
            db.execute("INSERT INTO ACCEPT_LIST (LINE_ID, QUANTITY, CHECK_MAN, CHECK_DATE) VALUES (?, ?, ?, ?)",
                       (line_id, line['QUANTITY'], session['user_name'], datetime.datetime.now()))
            db.execute("UPDATE ORDER_LINE SET STATUS=1, ISBN=? WHERE LINE_ID=?", (manual_isbn, line_id))

            exist_head = db.execute("SELECT * FROM CIRCULATION_HEAD WHERE ISBN=?", (manual_isbn,)).fetchone()
            if not exist_head:
                db.execute(
                    "INSERT INTO CIRCULATION_HEAD (ISBN, CALL_NUMBER, BOOK_NAME, AUTHOR, CLC_CODE) VALUES (?, ?, ?, ?, ?)",
                    (manual_isbn, auto_call_num, line['BOOK_NAME'], manual_author, manual_clc))
                flash(f'æ–°ä¹¦å…¥åº“ï¼ç´¢ä¹¦å·: {auto_call_num}', 'success')
            else:
                flash(f'å¤æœ¬å…¥åº“ã€‚', 'success')
                auto_call_num = exist_head['CALL_NUMBER']

            for i in range(line['QUANTITY']):
                isbn_suffix = manual_isbn[-6:] if len(manual_isbn) > 6 else manual_isbn
                barcode = f"{isbn_suffix}-{datetime.datetime.now().strftime('%M%S')}-{random.randint(100, 999)}-{i}"
                db.execute("INSERT INTO CIRCULATION_DETAIL (BARCODE, ISBN, LOCATION, STATUS) VALUES (?, ?, ?, 1)",
                           (barcode, manual_isbn, 'ä¸€æ¥¼æµé€šåº“'))
            db.commit()
            new_book_map = MapService.get_map_data(target_isbn=manual_isbn)
            new_book_map['book_name'] = line['BOOK_NAME']
            new_book_map['call_no'] = auto_call_num

        # 3. è®¢å•éªŒæ”¶ (æœŸåˆŠ)
        elif action == 'accept_periodical_order':
            line_id = request.form['line_id']
            issn = request.form['issn']
            title = request.form['title']
            clc = request.form['clc_code']
            freq = request.form['frequency']
            issue = request.form['issue']
            publisher = request.form.get('publisher', '')

            line = db.execute("SELECT * FROM ORDER_LINE WHERE LINE_ID=?", (line_id,)).fetchone()

            # å†™å…¥æœŸåˆŠåº“
            exist_head = per_db.execute("SELECT * FROM PERIODICAL_HEAD WHERE ISSN=?", (issn,)).fetchone()
            if not exist_head:
                per_db.execute(
                    "INSERT INTO PERIODICAL_HEAD (ISSN, TITLE, PUBLISHER, FREQUENCY, CLC_CODE) VALUES (?, ?, ?, ?, ?)",
                    (issn, title, publisher, freq, clc))

            # ç”Ÿæˆæ¡ç  (æ ¹æ®æ•°é‡å¾ªç¯)
            for i in range(line['QUANTITY']):
                time_part = datetime.datetime.now().strftime('%y%m%d%H%M')
                rand_part = random.randint(10, 99)
                barcode = f"P{issn[-4:]}{time_part}{rand_part}{i}"
                per_db.execute(
                    "INSERT INTO PERIODICAL_DETAIL (BARCODE, ISSN, YEAR_ISSUE, LOCATION, STATUS) VALUES (?, ?, ?, ?, 1)",
                    (barcode, issn, issue, 'æœŸåˆŠé˜…è§ˆåŒº'))
            per_db.commit()

            # æ›´æ–°è®¢å•çŠ¶æ€
            db.execute("INSERT INTO ACCEPT_LIST (LINE_ID, QUANTITY, CHECK_MAN, CHECK_DATE) VALUES (?, ?, ?, ?)",
                       (line_id, line['QUANTITY'], session['user_name'], datetime.datetime.now()))
            # æ›´æ–°æœ€ç»ˆç¡®è®¤çš„ ISSN (ä»¥é˜²è®¢å•é‡Œæ˜¯ç©ºçš„)
            db.execute("UPDATE ORDER_LINE SET STATUS=1, ISBN=? WHERE LINE_ID=?", (issn, line_id))
            db.commit()

            flash(f'æœŸåˆŠè®¢å•éªŒæ”¶æˆåŠŸï¼å…±å…¥åº“ {line["QUANTITY"]} æœ¬ã€‚', 'success')
            new_book_map = MapService.get_map_data(target_clc=clc)
            new_book_map['book_name'] = f"{title} (æœŸåˆŠ)"
            new_book_map['call_no'] = "æœŸåˆŠåŒº"

        # 4. é€€è´§
        elif action == 'return':
            line_id = request.form['line_id']
            line = db.execute("SELECT * FROM ORDER_LINE WHERE LINE_ID=?", (line_id,)).fetchone()
            reason = request.form.get('return_reason', 'è´¨é‡ä¸åˆæ ¼')
            db.execute(
                "INSERT INTO RETURN_LIST (LINE_ID, QUANTITY, REASON, HANDLER, RETURN_DATE) VALUES (?, ?, ?, ?, ?)",
                (line_id, line['QUANTITY'], reason, session['user_name'], datetime.datetime.now()))
            db.execute("UPDATE ORDER_LINE SET STATUS=2 WHERE LINE_ID=?", (line_id,))

            # è”åŠ¨æ›´æ–°åŸå§‹èè´­çŠ¶æ€
            if line['SUGGESTION_ID']:
                if line['ITEM_TYPE'] == 'periodical':
                    per_db.execute("UPDATE PER_SUGGESTION SET STATUS=2 WHERE SUG_ID=?", (line['SUGGESTION_ID'],))
                    per_db.commit()
                else:
                    db.execute("UPDATE ACQ_SUGGESTION SET STATUS=2 WHERE ACQ_ID=?", (line['SUGGESTION_ID'],))

            db.commit()
            flash(f'ã€Š{line["BOOK_NAME"]}ã€‹å·²é€€è´§ã€‚', 'warning')

    # è·å–æ‰€æœ‰å¾…éªŒæ”¶è®¢å• (åŒ…å« ITEM_TYPE)
    orders = db.execute(
        '''SELECT l.*, h.ORDER_DATE FROM ORDER_LINE l JOIN ORDER_HEAD h ON l.ORDER_NO = h.ORDER_NO WHERE l.STATUS = 0 ORDER BY l.ORDER_NO DESC''').fetchall()
    return render_template('acq/arrival.html', orders=orders, clc_data=CLC_DATA, new_book_map=new_book_map)
```
---

### ğŸ“„ app\blueprints\ai.py
```python
from flask import Blueprint, request, jsonify, session
from app.blueprints.auth import login_required
from app.services.ai_service import AIService

bp = Blueprint('ai', __name__, url_prefix='/ai')


@bp.route('/ask', methods=['POST'])
@login_required
def ask():
    # è·å–å½“å‰ç™»å½•ç”¨æˆ· ID
    user_id = session.get('user_id')

    # è·å–å‰ç«¯å‘é€çš„ JSON æ•°æ®
    data = request.get_json()
    user_input = data.get('message', '').strip()

    if not user_input:
        return jsonify({'error': 'å†…å®¹ä¸èƒ½ä¸ºç©º'}), 400

    # è°ƒç”¨ Service è¿›è¡Œå¤„ç†
    service = AIService()
    reply = service.chat(user_id, user_input)

    return jsonify({'reply': reply})


@bp.route('/history', methods=['GET'])
@login_required
def history():
    user_id = session.get('user_id')
    service = AIService()

    # è·å–å†å²è®°å½•å¹¶è½¬æ¢ä¸º JSON æ ¼å¼è¿”å›ç»™å‰ç«¯
    raw_history = service.get_history(user_id, limit=50)
    history_data = [
        {
            'role': row['ROLE'],
            'content': row['CONTENT'],
            'time': row['CREATED_AT'].strftime('%H:%M') if row['CREATED_AT'] else ''
        }
        for row in raw_history
    ]
    return jsonify({'history': history_data})
```
---

### ğŸ“„ app\blueprints\auth.py
```python
import functools
import random
from flask import Blueprint, flash, g, redirect, render_template, request, session, url_for, abort
from app.models import get_db
from werkzeug.security import generate_password_hash, check_password_hash

bp = Blueprint('auth', __name__, url_prefix='/auth')


@bp.route('/register', methods=('GET', 'POST'))
def register():
    if request.method == 'POST':
        reader_id = request.form['reader_id'].strip()
        name = request.form['name']
        sex = request.form['sex']
        password = request.form['password']
        confirm_password = request.form.get('confirm_password')

        db = get_db()
        error = None

        if not reader_id:
            error = 'å­¦å·/å·¥å·æ˜¯å¿…å¡«é¡¹ã€‚'
        elif not password:
            error = 'å¯†ç æ˜¯å¿…å¡«é¡¹ã€‚'
        elif password != confirm_password:
            error = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ã€‚'

        # è‡ªåŠ¨è§’è‰²åˆ¤å®š
        role_id = 1
        level_id = 0
        id_len = len(reader_id)
        if id_len == 12 and reader_id.isdigit():
            role_id = 2;
            level_id = 1  # å­¦ç”Ÿ
        elif id_len == 8 and reader_id.isdigit():
            role_id = 3;
            level_id = 3  # æ•™èŒå·¥

        if error is None:
            try:
                # ã€æ ¸å¿ƒå®‰å…¨æ”¹è¿›ã€‘ï¼šä½¿ç”¨ generate_password_hash
                hashed_password = generate_password_hash(password)
                db.execute(
                    "INSERT INTO READER (READER_ID, NAME, SEX, LEVEL_ID, ROLE_ID, CURRENT_CREDIT, EXPIRY_DATE, PASSWORD) VALUES (?, ?, ?, ?, ?, 100, '2029-06-30', ?)",
                    (reader_id, name, sex, level_id, role_id, hashed_password)
                )
                db.commit()
            except db.IntegrityError:
                error = f"ç”¨æˆ· {reader_id} å·²æ³¨å†Œã€‚"
            else:
                flash(f'æ³¨å†ŒæˆåŠŸï¼ç³»ç»Ÿè¯†åˆ«æ‚¨ä¸ºï¼š{"å­¦ç”Ÿ" if role_id == 2 else "æ•™èŒå·¥" if role_id == 3 else "è®¿å®¢"}',
                      'success')
                return redirect(url_for('auth.login'))
        flash(error, 'error')

    return render_template('auth/register.html')


@bp.route('/login', methods=('GET', 'POST'))
def login():
    if request.method == 'POST':
        user_id = request.form['user_id']
        password = request.form['password']
        db = get_db()
        error = None

        user = db.execute('''
            SELECT r.*, ro.ROLE_NAME FROM READER r 
            JOIN SYS_ROLE ro ON r.ROLE_ID = ro.ROLE_ID 
            WHERE r.READER_ID = ?''', (user_id,)).fetchone()

        if user is None:
            error = 'è´¦å·ä¸å­˜åœ¨ã€‚'
        else:
            # ã€å¹³æ»‘è¿‡æ¸¡é€»è¾‘ã€‘ï¼šåˆ¤æ–­æ˜¯æ˜æ–‡è¿˜æ˜¯å¯†æ–‡
            is_valid = False
            pwd_in_db = user['PASSWORD']

            # Werkzeug çš„å“ˆå¸Œå€¼é€šå¸¸ä»¥ 'pbkdf2:sha256:' å¼€å¤´
            if pwd_in_db and (pwd_in_db.startswith('pbkdf2:sha256:') or len(pwd_in_db) > 60):
                if check_password_hash(pwd_in_db, password):
                    is_valid = True
            else:
                # è¯´æ˜æ•°æ®åº“é‡Œè¿˜æ˜¯æ—§çš„æ˜æ–‡
                if pwd_in_db == password:
                    is_valid = True
                    # ã€è‡ªåŠ¨å‡çº§ã€‘ï¼šè¶ç”¨æˆ·ç™»å½•ï¼Œå·å·æŠŠå¯†ç æ”¹æˆå¯†æ–‡
                    new_hash = generate_password_hash(password)
                    db.execute("UPDATE READER SET PASSWORD = ? WHERE READER_ID = ?", (new_hash, user_id))
                    db.commit()
                    print(f">>> å®‰å…¨å‡çº§ï¼šç”¨æˆ· {user_id} çš„å¯†ç å·²è½¬æ¢ä¸ºå¯†æ–‡ã€‚")

            if not is_valid:
                error = 'å¯†ç é”™è¯¯ã€‚'

        if error is None:
            session.clear()
            session['user_id'] = user['READER_ID']
            session['user_name'] = user['NAME']
            session['role_id'] = user['ROLE_ID']
            session['role_name'] = user['ROLE_NAME']

            if user['ROLE_ID'] == 8:
                session['permissions'] = ['root_access', 'access_dashboard', 'access_services', 'manage_acq_order',
                                          'manage_acq_arrival', 'manage_circulation', 'manage_users']
            else:
                perms = db.execute(
                    'SELECT p.PERM_CODE FROM SYS_ROLE_PERMISSION rp JOIN SYS_PERMISSION p ON rp.PERM_ID = p.PERM_ID WHERE rp.ROLE_ID = ?',
                    (user['ROLE_ID'],)).fetchall()
                session['permissions'] = [p['PERM_CODE'] for p in perms]

            return redirect(url_for('main.dashboard'))
        flash(error, 'error')

    return render_template('auth/login.html')


@bp.route('/guest_login')
def guest_login():
    db = get_db()
    guest_id = int(f"99{random.randint(100000, 999999)}")
    guest_name = f"è®¿å®¢ {str(guest_id)[-4:]}"
    # è®¿å®¢ä¹Ÿç»™ä¸€ä¸ªéšæœºå“ˆå¸Œå¯†ç ï¼Œå¢åŠ å®‰å…¨æ€§
    guest_pwd = generate_password_hash('guest')
    try:
        db.execute(
            "INSERT INTO READER (READER_ID, NAME, SEX, LEVEL_ID, ROLE_ID, CURRENT_CREDIT, EXPIRY_DATE, PASSWORD) VALUES (?, ?, 'M', 0, 1, 0, '2099-12-31', ?)",
            (guest_id, guest_name, guest_pwd))
        db.commit()
    except:
        pass

    session.clear()
    session['user_id'] = guest_id
    session['user_name'] = guest_name
    session['role_id'] = 1
    session['role_name'] = 'è®¿å®¢'
    session['permissions'] = ['access_dashboard']
    session['is_temp_guest'] = True

    flash(f'æ¬¢è¿æ‚¨ï¼Œ{guest_name}ï¼æ‚¨æ­£ä»¥è®¿å®¢èº«ä»½æµè§ˆã€‚', 'success')
    return redirect(url_for('main.dashboard'))


@bp.route('/logout')
def logout():
    if session.get('is_temp_guest'):
        user_id = session.get('user_id')
        if user_id:
            db = get_db()
            db.execute("DELETE FROM READER WHERE READER_ID = ? AND ROLE_ID = 1", (user_id,))
            db.commit()
    session.clear()
    return redirect(url_for('auth.login'))


# æƒé™è£…é¥°å™¨... (ä¿æŒä¸å˜)
def login_required(view):
    @functools.wraps(view)
    def wrapped_view(**kwargs):
        if 'user_id' not in session: return redirect(url_for('auth.login'))
        return view(**kwargs)

    return wrapped_view


def permission_required(perm_code):
    def decorator(view):
        @functools.wraps(view)
        def wrapped_view(**kwargs):
            if 'user_id' not in session: return redirect(url_for('auth.login'))
            if 'permissions' not in session:
                session.clear()
                flash('ç³»ç»Ÿå‡çº§ï¼Œè¯·é‡æ–°ç™»å½•ã€‚', 'warning')
                return redirect(url_for('auth.login'))
            user_perms = session.get('permissions', [])
            if 'root_access' in user_perms or perm_code in user_perms:
                return view(**kwargs)
            else:
                abort(403)

        return wrapped_view

    return decorator
```
---

### ğŸ“„ app\blueprints\circ.py
```python
from flask import Blueprint, render_template, session, request, flash, redirect, url_for
from app.models import get_db, get_periodical_db
from app.blueprints.auth import permission_required
import datetime

bp = Blueprint('circ', __name__, url_prefix='/circ')


# --- è¾…åŠ©å‡½æ•°ï¼šä¿¡ç”¨åˆ†å˜æ›´ ---
def update_user_credit(db, reader_id, delta, reason, operator_name):
    reader = db.execute("SELECT CURRENT_CREDIT FROM READER WHERE READER_ID=?", (reader_id,)).fetchone()
    if not reader: return
    current_score = reader['CURRENT_CREDIT']
    new_score = current_score + delta
    if new_score > 100:
        new_score = 100
    elif new_score < 0:
        new_score = 0
    if new_score != current_score:
        db.execute("UPDATE READER SET CURRENT_CREDIT = ? WHERE READER_ID = ?", (new_score, reader_id))
        real_delta = new_score - current_score
        db.execute("INSERT INTO CREDIT_LOG (READER_ID, CHANGE_VAL, REASON, OPERATOR) VALUES (?, ?, ?, ?)",
                   (reader_id, real_delta, reason, operator_name))


@bp.route('/history', methods=['GET'])
@permission_required('access_services')
def history():
    db = get_db()
    user_id = session.get('user_id')

    # ç­›é€‰å‚æ•°
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')
    keyword = request.args.get('keyword', '').strip()
    status_filter = request.args.get('status', 'all')

    reader = db.execute("SELECT CURRENT_CREDIT FROM READER WHERE READER_ID=?", (user_id,)).fetchone()
    current_credit = reader['CURRENT_CREDIT'] if reader else 0

    # åŠ¨æ€æ„å»º SQL
    query = '''
        SELECT b.*, h.BOOK_NAME, h.AUTHOR, h.CALL_NUMBER, e.STATUS as APP_STATUS
        FROM BORROW_RECORD b
        JOIN CIRCULATION_DETAIL d ON b.BARCODE = d.BARCODE
        JOIN CIRCULATION_HEAD h ON d.ISBN = h.ISBN
        LEFT JOIN EXTENSION_APP e ON b.BORROW_ID = e.BORROW_ID
        WHERE b.READER_ID = ?
    '''
    params = [user_id]

    if start_date:
        query += " AND b.BORROW_DATE >= ?"
        params.append(f"{start_date} 00:00:00")
    if end_date:
        query += " AND b.BORROW_DATE <= ?"
        params.append(f"{end_date} 23:59:59")
    if keyword:
        query += " AND (h.BOOK_NAME LIKE ? OR h.AUTHOR LIKE ?)"
        params.extend([f'%{keyword}%', f'%{keyword}%'])
    if status_filter == 'active':
        query += " AND b.STATUS = 1"
    elif status_filter == 'returned':
        query += " AND b.STATUS IN (2, 3)"

    query += " ORDER BY b.BORROW_DATE DESC"

    records = db.execute(query, tuple(params)).fetchall()

    return render_template('circ/history.html', records=records, current_credit=current_credit)


@bp.route('/extend', methods=['POST'])
@permission_required('access_services')
def apply_extension():
    borrow_id = request.form['borrow_id']
    days = int(request.form.get('days', 30))
    reason = request.form.get('reason', '')
    user_id = session.get('user_id')
    db = get_db()

    # è·å–ç”¨æˆ·ä¿¡ç”¨è§„åˆ™
    reader = db.execute("SELECT CURRENT_CREDIT FROM READER WHERE READER_ID=?", (user_id,)).fetchone()
    score = reader['CURRENT_CREDIT']

    # åŠ¨æ€æ£€æŸ¥æ˜¯å¦å…è®¸å»¶æœŸ
    rule = db.execute("SELECT ENABLE_EXTEND FROM CREDIT_LEVEL WHERE MIN_SCORE <= ? ORDER BY MIN_SCORE DESC LIMIT 1",
                      (score,)).fetchone()

    if not rule or rule['ENABLE_EXTEND'] == 0:
        flash(f'ç”³è¯·å¤±è´¥ï¼šæ‚¨çš„ä¿¡ç”¨åˆ†ä¸º {score}ï¼Œå½“å‰ç­‰çº§ä¸å…è®¸å»¶æœŸã€‚', 'error')
        return redirect(url_for('circ.history'))

    record = db.execute("SELECT * FROM BORROW_RECORD WHERE BORROW_ID=?", (borrow_id,)).fetchone()
    if not record or record['STATUS'] != 1:
        flash('æ— æ³•ç”³è¯·ï¼šè®°å½•ä¸å­˜åœ¨æˆ–å›¾ä¹¦å·²å½’è¿˜', 'error')
        return redirect(url_for('circ.history'))

    exist = db.execute("SELECT * FROM EXTENSION_APP WHERE BORROW_ID=?", (borrow_id,)).fetchone()
    if exist:
        flash('è¯¥è®¢å•å·²æäº¤è¿‡ç”³è¯·ï¼Œè¯·å‹¿é‡å¤æäº¤', 'warning')
    else:
        db.execute(
            "INSERT INTO EXTENSION_APP (READER_ID, BORROW_ID, APPLY_DAYS, REASON, STATUS) VALUES (?, ?, ?, ?, 0)",
            (user_id, borrow_id, days, reason))
        db.commit()
        flash('å»¶æœŸç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ã€‚', 'success')
    return redirect(url_for('circ.history'))


@bp.route('/reserve', methods=['POST'])
@permission_required('access_services')
def reserve():
    isbn = request.form['isbn']
    reader_id = session.get('user_id')
    db = get_db()

    book_check = db.execute("SELECT 1 FROM CIRCULATION_HEAD WHERE ISBN=?", (isbn,)).fetchone()
    if not book_check:
        flash('é¢„çº¦å¤±è´¥ï¼šæœŸåˆŠæˆ–éæµé€šè¯»ç‰©ä¸å¯é¢„çº¦ã€‚', 'error')
        return redirect(url_for('main.book_detail', id=isbn))

    reader = db.execute("SELECT * FROM READER WHERE READER_ID=?", (reader_id,)).fetchone()
    score = reader['CURRENT_CREDIT']

    # åŠ¨æ€è§„åˆ™æ£€æŸ¥ï¼šæ˜¯å¦å…è®¸é¢„çº¦
    rule = db.execute("SELECT ENABLE_RESERVE FROM CREDIT_LEVEL WHERE MIN_SCORE <= ? ORDER BY MIN_SCORE DESC LIMIT 1",
                      (score,)).fetchone()

    if not rule or rule['ENABLE_RESERVE'] == 0:
        flash(f'é¢„çº¦å¤±è´¥ï¼šæ‚¨çš„ä¿¡ç”¨åˆ†ä¸º {score}ï¼Œå½“å‰ç­‰çº§ä¸å…è®¸é¢„çº¦ã€‚', 'error')
        return redirect(url_for('main.book_detail', id=isbn))

    active_reserve = db.execute(
        "SELECT COUNT(*) FROM RESERVE_INFO WHERE READER_ID=? AND STATUS IN (1, 2)", (reader_id,)
    ).fetchone()[0]

    if active_reserve >= 1:
        flash('é¢„çº¦å¤±è´¥ï¼šæ‚¨å½“å‰å·²æœ‰ 1 æœ¬æ­£åœ¨è¿›è¡Œä¸­çš„é¢„çº¦ã€‚', 'error')
        return redirect(url_for('main.book_detail', id=isbn))

    available_count = \
        db.execute("SELECT COUNT(*) FROM CIRCULATION_DETAIL WHERE ISBN=? AND STATUS=1", (isbn,)).fetchone()[0]
    if available_count > 0:
        flash('é¢„çº¦å¤±è´¥ï¼šè¯¥ä¹¦ç›®å‰æœ‰åœ¨é¦†å¤æœ¬ï¼Œè¯·ç›´æ¥å‰å¾€æ¶ä½å€Ÿé˜…ã€‚', 'warning')
        return redirect(url_for('main.book_detail', id=isbn))

    exist = db.execute("SELECT * FROM RESERVE_INFO WHERE READER_ID=? AND ISBN=? AND (STATUS=1 OR STATUS=2)",
                       (reader_id, isbn)).fetchone()
    if exist:
        flash('æ‚¨å·²åœ¨æ’é˜Ÿé¢„çº¦è¯¥ä¹¦ï¼Œè¯·å‹¿é‡å¤æäº¤ã€‚', 'error')
        return redirect(url_for('main.book_detail', id=isbn))

    expire_time = datetime.datetime.now() + datetime.timedelta(days=60)
    db.execute("INSERT INTO RESERVE_INFO (READER_ID, ISBN, EXPIRE_DATE, STATUS) VALUES (?, ?, ?, 1)",
               (reader_id, isbn, expire_time))
    db.commit()
    flash('é¢„çº¦æˆåŠŸï¼å½“æœ‰å¤æœ¬å½’è¿˜æ—¶ï¼Œç³»ç»Ÿå°†é€šçŸ¥æ‚¨å–ä¹¦ã€‚', 'success')
    return redirect(url_for('main.book_detail', id=isbn))


@bp.route('/workbench', methods=('GET', 'POST'))
@permission_required('manage_circulation')
def workbench():
    db = get_db()
    per_db = get_periodical_db()

    if request.method == 'POST' and request.form.get('action') == 'review_extension':
        app_id = request.form['app_id']
        decision = request.form['decision']
        app_record = db.execute("SELECT * FROM EXTENSION_APP WHERE APP_ID=?", (app_id,)).fetchone()

        if decision == 'approve':
            borrow_rec = db.execute("SELECT * FROM BORROW_RECORD WHERE BORROW_ID=?",
                                    (app_record['BORROW_ID'],)).fetchone()
            new_due = borrow_rec['DUE_DATE'] + datetime.timedelta(days=app_record['APPLY_DAYS'])
            db.execute("UPDATE BORROW_RECORD SET DUE_DATE=? WHERE BORROW_ID=?", (new_due, app_record['BORROW_ID']))
            db.execute("UPDATE EXTENSION_APP SET STATUS=1 WHERE APP_ID=?", (app_id,))
            flash(f'å·²æ‰¹å‡†å»¶æœŸã€‚', 'success')
        elif decision == 'reject':
            db.execute("UPDATE EXTENSION_APP SET STATUS=2 WHERE APP_ID=?", (app_id,))
            flash('å·²æ‹’ç»è¯¥å»¶æœŸç”³è¯·ã€‚', 'warning')
        db.commit()
        return redirect(url_for('circ.workbench'))

    if request.method == 'POST':
        action = request.form.get('action')
        barcode = request.form.get('barcode', '').strip()

        # 1. æŠ¥æŸé€»è¾‘
        if action == 'report_damage':
            reason = request.form.get('reason', 'å›¾ä¹¦ç ´æŸ/ä¸¢å¤±')
            book = db.execute(
                "SELECT d.*, h.BOOK_NAME, h.ISBN FROM CIRCULATION_DETAIL d JOIN CIRCULATION_HEAD h ON d.ISBN = h.ISBN WHERE d.BARCODE=?",
                (barcode,)).fetchone()

            if book:
                db.execute(
                    "INSERT INTO BOOK_DAMAGE_LOG (BARCODE, BOOK_NAME, ISBN, REASON, HANDLER) VALUES (?, ?, ?, ?, ?)",
                    (barcode, book['BOOK_NAME'], book['ISBN'], reason, session['user_name']))
                db.execute("UPDATE CIRCULATION_DETAIL SET STATUS=4 WHERE BARCODE=?", (barcode,))
                borrow_rec = db.execute("SELECT * FROM BORROW_RECORD WHERE BARCODE=? AND STATUS=1",
                                        (barcode,)).fetchone()
                if borrow_rec:
                    db.execute("UPDATE BORROW_RECORD SET STATUS=2, RETURN_DATE=? WHERE BORROW_ID=?",
                               (datetime.datetime.now(), borrow_rec['BORROW_ID']))
                    flash(f'å›¾ä¹¦ {barcode} å·²æ ‡è®°ä¸ºæŠ¥æŸï¼Œå€Ÿé˜…è®°å½•å·²å¼ºåˆ¶å½’è¿˜ã€‚', 'warning')
                else:
                    flash(f'å›¾ä¹¦ {barcode} å·²æ ‡è®°ä¸ºæŠ¥æŸ/é”€æ¯ã€‚', 'success')
                db.commit()
            else:
                # æŸ¥æœŸåˆŠ
                per = per_db.execute(
                    "SELECT d.*, h.TITLE FROM PERIODICAL_DETAIL d JOIN PERIODICAL_HEAD h ON d.ISSN = h.ISSN WHERE d.BARCODE=?",
                    (barcode,)).fetchone()
                if per:
                    per_db.execute("INSERT INTO PER_DAMAGE_LOG (BARCODE, TITLE, REASON, HANDLER) VALUES (?, ?, ?, ?)",
                                   (barcode, per['TITLE'], reason, session['user_name']))
                    per_db.execute("UPDATE PERIODICAL_DETAIL SET STATUS=4 WHERE BARCODE=?", (barcode,))
                    per_db.commit()
                    flash(f'æœŸåˆŠ {barcode} å·²æ ‡è®°ä¸ºæŠ¥æŸã€‚', 'success')
                else:
                    flash('æ‰¾ä¸åˆ°è¯¥æ¡ç çš„å›¾ä¹¦æˆ–æœŸåˆŠã€‚', 'error')

        # 2. å½’è¿˜é€»è¾‘
        elif action == 'return':
            per = per_db.execute("SELECT 1 FROM PERIODICAL_DETAIL WHERE BARCODE=?", (barcode,)).fetchone()
            if per:
                flash(f'æ¡ç  {barcode} ä¸ºæœŸåˆŠï¼Œä¸å¯å€Ÿé˜…ï¼Œæ— éœ€å½’è¿˜ã€‚', 'error')
                return redirect(url_for('circ.workbench'))

            record = db.execute("SELECT * FROM BORROW_RECORD WHERE BARCODE=? AND STATUS=1", (barcode,)).fetchone()
            book_detail = db.execute("SELECT * FROM CIRCULATION_DETAIL WHERE BARCODE=?", (barcode,)).fetchone()
            if record:
                now = datetime.datetime.now()
                overdue_days = 0
                msg_prefix = "å½’è¿˜æˆåŠŸ"

                if now > record['DUE_DATE']:
                    overdue_days = (now - record['DUE_DATE']).days
                    update_user_credit(db, record['READER_ID'], -10, f"å›¾ä¹¦é€¾æœŸ{overdue_days}å¤©å½’è¿˜",
                                       session['user_name'])
                    db.execute("UPDATE BORROW_RECORD SET RETURN_DATE=?, STATUS=3 WHERE BORROW_ID=?",
                               (now, record['BORROW_ID']))
                    msg_prefix = f"å½’è¿˜æˆåŠŸ (å·²é€¾æœŸ{overdue_days}å¤©ï¼Œè‡ªåŠ¨æ‰£é™¤ä¿¡ç”¨åˆ† 10 åˆ†)"
                else:
                    db.execute("UPDATE BORROW_RECORD SET RETURN_DATE=?, STATUS=2 WHERE BORROW_ID=?",
                               (now, record['BORROW_ID']))

                isbn = book_detail['ISBN']
                reserve = db.execute(
                    "SELECT * FROM RESERVE_INFO WHERE ISBN=? AND STATUS=1 ORDER BY RESERVE_DATE ASC LIMIT 1",
                    (isbn,)).fetchone()

                if reserve:
                    db.execute("UPDATE CIRCULATION_DETAIL SET STATUS=3 WHERE BARCODE=?", (barcode,))
                    db.execute("UPDATE RESERVE_INFO SET STATUS=2, BARCODE=?, EXPIRE_DATE=? WHERE RESERVE_ID=?",
                               (barcode, now + datetime.timedelta(days=3), reserve['RESERVE_ID']))
                    flash(f'{msg_prefix}ã€‚**è§¦å‘é¢„çº¦ï¼šè¯·ä¿ç•™ç»™è¯»è€… {reserve["READER_ID"]}ï¼**', 'warning')
                else:
                    db.execute("UPDATE CIRCULATION_DETAIL SET STATUS=1 WHERE BARCODE=?", (barcode,))
                    flash(f'{msg_prefix}ã€‚', 'success')
                db.commit()
            else:
                flash(f'å›¾ä¹¦ {barcode} æœªå€Ÿå‡ºæˆ–æ¡ç é”™è¯¯', 'error')

        # 3. å€Ÿé˜…é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨åŠ¨æ€è§„åˆ™é…ç½®)
        elif action == 'borrow':
            per = per_db.execute("SELECT 1 FROM PERIODICAL_DETAIL WHERE BARCODE=?", (barcode,)).fetchone()
            if per:
                flash(f'æ¡ç  {barcode} ä¸ºæœŸåˆŠï¼Œä»…é™é¦†å†…é˜…è§ˆï¼Œä¸å¯å€Ÿå‡ºï¼', 'error')
                return redirect(url_for('circ.workbench'))

            reader_id = request.form['reader_id'].strip()
            book = db.execute("SELECT * FROM CIRCULATION_DETAIL WHERE BARCODE=?", (barcode,)).fetchone()
            reader = db.execute("SELECT * FROM READER WHERE READER_ID=?", (reader_id,)).fetchone()

            error = None
            if not book:
                error = 'å›¾ä¹¦æ¡ç ä¸å­˜åœ¨'
            elif not reader:
                error = 'è¯»è€…IDä¸å­˜åœ¨'
            else:
                credit = reader['CURRENT_CREDIT']

                # --- [NEW] åŠ¨æ€æŸ¥è¯¢ä¿¡ç”¨è§„åˆ™ ---
                rule = db.execute("SELECT * FROM CREDIT_LEVEL WHERE MIN_SCORE <= ? ORDER BY MIN_SCORE DESC LIMIT 1",
                                  (credit,)).fetchone()

                if not rule or rule['ENABLE_BORROW'] == 0:
                    error = f'å€Ÿé˜…è¢«æ‹’ï¼šè¯»è€…ä¿¡ç”¨åˆ† ({credit}) è¿‡ä½ï¼Œå½“å‰ç­‰çº§ç¦æ­¢å€Ÿé˜…ã€‚'
                else:
                    max_books = rule['MAX_BORROW_NUM']
                    borrow_days = rule['MAX_BORROW_DAY']

                    current_borrow_count = \
                    db.execute("SELECT COUNT(*) FROM BORROW_RECORD WHERE READER_ID=? AND STATUS=1",
                               (reader_id,)).fetchone()[0]
                    if current_borrow_count >= max_books:
                        error = f'å€Ÿé˜…è¢«æ‹’ï¼šå½“å‰å·²å€Ÿ {current_borrow_count} æœ¬ï¼Œä¸Šé™ {max_books} æœ¬ã€‚'

            if not error and book['STATUS'] == 4:
                error = 'å›¾ä¹¦å·²æŠ¥æŸï¼Œä¸å¯å€Ÿé˜…'
            elif not error and book['STATUS'] == 3:
                res = db.execute("SELECT * FROM RESERVE_INFO WHERE BARCODE=? AND READER_ID=? AND STATUS=2",
                                 (barcode, reader_id)).fetchone()
                if not res:
                    error = 'è¯¥ä¹¦å·²è¢«ä»–äººé¢„çº¦'
                else:
                    db.execute("UPDATE RESERVE_INFO SET STATUS=4 WHERE RESERVE_ID=?", (res['RESERVE_ID'],))
            elif not error and book['STATUS'] != 1 and book['STATUS'] != 3:
                error = 'å›¾ä¹¦çŠ¶æ€ä¸å¯å€Ÿ'

            if not error:
                # ä½¿ç”¨åŠ¨æ€é…ç½®çš„å€Ÿé˜…å¤©æ•°
                due_date = datetime.datetime.now() + datetime.timedelta(days=borrow_days)
                db.execute(
                    "INSERT INTO BORROW_RECORD (READER_ID, BARCODE, BORROW_DATE, DUE_DATE, STATUS) VALUES (?, ?, ?, ?, 1)",
                    (reader_id, barcode, datetime.datetime.now(), due_date))
                db.execute("UPDATE CIRCULATION_DETAIL SET STATUS=2 WHERE BARCODE=?", (barcode,))
                db.commit()
                flash(f'å€Ÿé˜…æˆåŠŸ (æœŸé™: {borrow_days}å¤©)', 'success')
            else:
                flash(error, 'error')

    pending_apps = db.execute(
        '''SELECT a.*, r.NAME as READER_NAME, h.BOOK_NAME FROM EXTENSION_APP a JOIN READER r ON a.READER_ID = r.READER_ID 
        JOIN BORROW_RECORD b ON a.BORROW_ID = b.BORROW_ID JOIN CIRCULATION_DETAIL d ON b.BARCODE = d.BARCODE JOIN CIRCULATION_HEAD h ON d.ISBN = h.ISBN WHERE a.STATUS = 0''').fetchall()

    damage_logs = db.execute("SELECT * FROM BOOK_DAMAGE_LOG ORDER BY LOG_DATE DESC LIMIT 50").fetchall()

    return render_template('circ/workbench.html', pending_apps=pending_apps, damage_logs=damage_logs)
```
---

### ğŸ“„ app\blueprints\main.py
```python
from flask import Blueprint, render_template, request, session, abort, current_app, redirect, url_for, flash
from app.models import get_db, get_periodical_db, CLC_DATA
from app.blueprints.auth import permission_required, login_required
from app.services.map_service import MapService
import os
import datetime

bp = Blueprint('main', __name__)


@bp.route('/')
@permission_required('access_dashboard')
def dashboard():
    """å›¾ä¹¦é¦†é¦–é¡µ - æ•°æ®å¤§å± (Data Visualization Dashboard)"""
    db = get_db()
    per_db = get_periodical_db()  # è¿æ¥æœŸåˆŠåº“

    # --- 1. åŸºç¡€æ ¸å¿ƒæŒ‡æ ‡ ---
    total_titles = db.execute('SELECT COUNT(*) FROM CIRCULATION_HEAD').fetchone()[0]
    # [æ–°å¢] åŠ ä¸ŠæœŸåˆŠç§æ•°
    total_per_titles = per_db.execute('SELECT COUNT(*) FROM PERIODICAL_HEAD').fetchone()[0]
    combined_titles = total_titles + total_per_titles

    total_books = db.execute('SELECT COUNT(*) FROM CIRCULATION_DETAIL WHERE STATUS != 4').fetchone()[0]
    # [æ–°å¢] åŠ ä¸ŠæœŸåˆŠå†Œæ•°
    total_per_items = per_db.execute('SELECT COUNT(*) FROM PERIODICAL_DETAIL WHERE STATUS != 4').fetchone()[0]
    combined_items = total_books + total_per_items

    total_borrows = db.execute('SELECT COUNT(*) FROM BORROW_RECORD').fetchone()[0]
    active_borrows = db.execute('SELECT COUNT(*) FROM BORROW_RECORD WHERE STATUS = 1').fetchone()[0]

    # ä»Šæ—¥å€Ÿé˜…äººæ•°
    today_str = datetime.date.today().strftime('%Y-%m-%d')
    today_borrowers = db.execute(
        "SELECT COUNT(DISTINCT READER_ID) FROM BORROW_RECORD WHERE substr(BORROW_DATE, 1, 10) = ?",
        (today_str,)
    ).fetchone()[0]

    # --- 2. çœŸå®å›¾è¡¨æ•°æ®ï¼šè¿‘7å¤©å€Ÿé˜…è¶‹åŠ¿ ---
    today = datetime.date.today()
    dates_last_7_days = [today - datetime.timedelta(days=i) for i in range(6, -1, -1)]

    weekly_labels = []
    weekly_data = []

    for d in dates_last_7_days:
        weekly_labels.append(d.strftime('%m-%d'))
        count = db.execute(
            "SELECT COUNT(*) FROM BORROW_RECORD WHERE substr(BORROW_DATE, 1, 10) = ?",
            (str(d),)
        ).fetchone()[0]
        weekly_data.append(count)

    # --- 3. é¦†è—åˆ†ç±»ç»Ÿè®¡ (Top 10 + å…¶ä»–) ---
    # æ··åˆç»Ÿè®¡ï¼šå°†å›¾ä¹¦å’ŒæœŸåˆŠçš„åˆ†ç±»ä¸€èµ·ç»Ÿè®¡
    book_cat_stats = db.execute('''
        SELECT substr(CLC_CODE, 1, 1) as P, COUNT(*) as C 
        FROM CIRCULATION_HEAD GROUP BY substr(CLC_CODE, 1, 1)
    ''').fetchall()

    per_cat_stats = per_db.execute('''
        SELECT substr(CLC_CODE, 1, 1) as P, COUNT(*) as C 
        FROM PERIODICAL_HEAD GROUP BY substr(CLC_CODE, 1, 1)
    ''').fetchall()

    # åˆå¹¶å­—å…¸
    cat_map = {}
    for row in book_cat_stats:
        p = row['P']
        cat_map[p] = cat_map.get(p, 0) + row['C']
    for row in per_cat_stats:
        p = row['P']
        cat_map[p] = cat_map.get(p, 0) + row['C']

    # æ’åº
    sorted_stats = sorted(cat_map.items(), key=lambda x: x[1], reverse=True)

    pie_labels = []
    pie_data = []
    top_n = 10
    for i, (code, count) in enumerate(sorted_stats):
        if i < top_n:
            full_name = CLC_DATA.get(code, 'ç»¼åˆ').split('ã€')[0]
            pie_labels.append(f"{code} {full_name}")
            pie_data.append(count)
        else:
            if len(pie_labels) <= top_n:
                pie_labels.append("å…¶ä»–åˆ†ç±»")
                pie_data.append(count)
            else:
                pie_data[-1] += count

    # --- 4. æœ€æ–°å…¥åº“æ¨è (ä¼˜å…ˆæ˜¾ç¤ºå›¾ä¹¦) ---
    new_arrivals = db.execute('SELECT * FROM CIRCULATION_HEAD ORDER BY rowid DESC LIMIT 4').fetchall()
    covers_path = os.path.join(current_app.static_folder, 'asset', 'covers')
    cover_images = []
    if os.path.exists(covers_path):
        cover_images = [f for f in os.listdir(covers_path) if f.lower().endswith(('.png', '.jpg', '.jpeg'))]
        cover_images.sort()
    if not cover_images: cover_images = ['default.png']

    formatted_arrivals = []
    for index, book in enumerate(new_arrivals):
        b = dict(book)
        b['cover_image'] = cover_images[index % len(cover_images)]
        formatted_arrivals.append(b)

    stats = {
        'titles': combined_titles,  # æ··åˆæ€»æ•°
        'books': combined_items,  # æ··åˆå®ä½“æ•°
        'borrows': total_borrows,
        'active': active_borrows,
        'today_borrowers': today_borrowers,
        'pie_labels': pie_labels,
        'pie_data': pie_data,
        'trend_labels': weekly_labels,
        'trend_data': weekly_data
    }

    return render_template('main/dashboard.html', stats=stats, new_arrivals=formatted_arrivals)


@bp.route('/profile')
@login_required
def profile():
    db = get_db()
    user_id = session.get('user_id')
    user = db.execute('''
        SELECT r.*, ro.ROLE_NAME 
        FROM READER r 
        JOIN SYS_ROLE ro ON r.ROLE_ID = ro.ROLE_ID 
        WHERE r.READER_ID = ?
    ''', (user_id,)).fetchone()
    credit_logs = db.execute('SELECT * FROM CREDIT_LOG WHERE READER_ID=? ORDER BY LOG_TIME DESC', (user_id,)).fetchall()
    return render_template('main/profile.html', user=user, credit_logs=credit_logs)


@bp.route('/update_profile', methods=['POST'])
@login_required
def update_profile():
    db = get_db()
    user_id = session.get('user_id')
    action = request.form.get('action')

    if action == 'update_info':
        email = request.form.get('email', '').strip()
        phone = request.form.get('phone', '').strip()
        if email and '@' not in email:
            flash('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®', 'error')
            return redirect(url_for('main.profile'))
        db.execute("UPDATE READER SET EMAIL = ?, TELEPHONE = ? WHERE READER_ID = ?", (email, phone, user_id))
        db.commit()
        flash('ä¸ªäººèµ„æ–™å·²æ›´æ–°', 'success')

    elif action == 'change_password':
        new_pwd = request.form.get('new_password', '').strip()
        confirm_pwd = request.form.get('confirm_password', '').strip()
        if not new_pwd or len(new_pwd) < 6:
            flash('æ–°å¯†ç é•¿åº¦è‡³å°‘éœ€è¦6ä½', 'error')
        elif new_pwd != confirm_pwd:
            flash('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error')
        else:
            db.execute("UPDATE READER SET PASSWORD = ? WHERE READER_ID = ?", (new_pwd, user_id))
            db.commit()
            flash('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œä¸‹æ¬¡ç™»å½•è¯·ä½¿ç”¨æ–°å¯†ç ', 'success')

    return redirect(url_for('main.profile'))


@bp.route('/request_deletion', methods=['POST'])
@login_required
def request_deletion():
    """è¯·æ±‚æ³¨é”€è´¦å·"""
    db = get_db()
    user_id = session.get('user_id')

    # è·å–è¶…ç®¡è®¾ç½®çš„å®½é™æœŸ (é»˜è®¤7å¤©)
    setting = db.execute("SELECT VALUE FROM SYS_SETTINGS WHERE KEY='account_deletion_grace_days'").fetchone()
    grace_days = int(setting['VALUE']) if setting else 7

    scheduled_date = datetime.datetime.now() + datetime.timedelta(days=grace_days)

    db.execute("UPDATE READER SET DELETION_SCHEDULED_AT = ? WHERE READER_ID = ?", (scheduled_date, user_id))
    db.commit()

    flash(
        f'æ³¨é”€ç”³è¯·å·²æäº¤ã€‚è´¦å·å°†äº {grace_days} å¤©åï¼ˆ{scheduled_date.strftime("%Y-%m-%d")}ï¼‰å½»åº•åˆ é™¤ã€‚åœ¨æ­¤ä¹‹å‰æ‚¨å¯ä»¥éšæ—¶æ’¤é”€ã€‚',
        'warning')
    return redirect(url_for('main.profile'))


@bp.route('/cancel_deletion', methods=['POST'])
@login_required
def cancel_deletion():
    """æ’¤é”€æ³¨é”€ç”³è¯·"""
    db = get_db()
    user_id = session.get('user_id')

    db.execute("UPDATE READER SET DELETION_SCHEDULED_AT = NULL WHERE READER_ID = ?", (user_id,))
    db.commit()

    flash('æ³¨é”€ç”³è¯·å·²æ’¤é”€ï¼Œæ‚¨çš„è´¦å·å°†ä¿æŒæ­£å¸¸ä½¿ç”¨ã€‚', 'success')
    return redirect(url_for('main.profile'))


@bp.route('/search')
@permission_required('access_dashboard')
def search():
    query = request.args.get('q', '').strip()
    clc_filter = request.args.get('clc', '')

    results = []  # ç»Ÿä¸€ç»“æœåˆ—è¡¨
    discovery_data = {}

    # å°é¢å¤„ç†
    covers_path = os.path.join(current_app.static_folder, 'asset', 'covers')
    cover_images = []
    if os.path.exists(covers_path):
        cover_images = [f for f in os.listdir(covers_path) if f.lower().endswith(('.png', '.jpg', '.jpeg'))]
        cover_images.sort()
    if not cover_images: cover_images = ['default.png']

    db = get_db()
    per_db = get_periodical_db()

    if query or clc_filter:
        # --- 1. æœç´¢å›¾ä¹¦ ---
        sql_book = '''
        SELECT h.ISBN as id, h.BOOK_NAME as title, h.AUTHOR as author, h.PUBLISHER as publisher, 
                h.CLC_CODE as clc, h.CALL_NUMBER as call_no, 'book' as type,
               (SELECT COUNT(*) FROM CIRCULATION_DETAIL d WHERE d.ISBN = h.ISBN AND d.STATUS = 1) as available_count
        FROM CIRCULATION_HEAD h
        WHERE 1=1
        '''
        params_book = []
        if query:
            sql_book += " AND (h.BOOK_NAME LIKE ? OR h.AUTHOR LIKE ? OR h.ISBN LIKE ?)"
            s = f'%{query}%'
            params_book.extend([s, s, s])
        if clc_filter:
            sql_book += " AND h.CLC_CODE LIKE ?"
            params_book.append(f'{clc_filter}%')

        books = db.execute(sql_book, tuple(params_book)).fetchall()
        for b in books:
            results.append(dict(b))

        # --- 2. æœç´¢æœŸåˆŠ ---
        # ä»…å½“æ²¡æœ‰ CLC è¿‡æ»¤ æˆ– æœŸåˆŠä¹Ÿæœ‰è¯¥ CLC æ—¶
        sql_per = '''
        SELECT p.ISSN as id, p.TITLE as title, p.FREQUENCY as author, p.PUBLISHER as publisher,
               p.CLC_CODE as clc, 'æœŸåˆŠåŒº' as call_no, 'periodical' as type,
               (SELECT COUNT(*) FROM PERIODICAL_DETAIL d WHERE d.ISSN = p.ISSN AND d.STATUS = 1) as available_count
        FROM PERIODICAL_HEAD p
        WHERE 1=1
        '''
        params_per = []
        if query:
            sql_per += " AND (p.TITLE LIKE ? OR p.ISSN LIKE ?)"
            s = f'%{query}%'
            params_per.extend([s, s])
        if clc_filter:
            sql_per += " AND p.CLC_CODE LIKE ?"
            params_per.append(f'{clc_filter}%')

        periodicals = per_db.execute(sql_per, tuple(params_per)).fetchall()
        for p in periodicals:
            # æœŸåˆŠçš„ author å­—æ®µå€Ÿç”¨æ¥æ”¾ Frequency
            d = dict(p)
            d['author'] = f"[{d['author']}]"  # æ ¼å¼åŒ–æ˜¾ç¤º
            results.append(d)

    else:
        # --- æ¢ç´¢æ¨¡å¼ ---
        latest_books_raw = db.execute('SELECT * FROM CIRCULATION_HEAD ORDER BY rowid DESC LIMIT 8').fetchall()
        latest_books = []
        for index, book in enumerate(latest_books_raw):
            book_dict = dict(book)
            book_dict['cover_image'] = cover_images[index % len(cover_images)]
            latest_books.append(book_dict)

        # ç»Ÿè®¡åŒ…å«å›¾ä¹¦å’ŒæœŸåˆŠ
        # ç®€åŒ–å¤„ç†ï¼šåªæ˜¾ç¤ºå›¾ä¹¦çš„åˆ†ç±»åˆ†å¸ƒç”¨äºæ¢ç´¢å¯¼èˆª
        cat_stats = db.execute(
            '''SELECT substr(CLC_CODE, 1, 1) as P, COUNT(*) as C FROM CIRCULATION_HEAD GROUP BY substr(CLC_CODE, 1, 1) ORDER BY C DESC LIMIT 5''').fetchall()
        formatted_stats = []
        for row in cat_stats:
            code = row['P']
            name = CLC_DATA.get(code, 'ç»¼åˆç±»').split('ã€')[0]
            formatted_stats.append({'code': code, 'name': name, 'count': row['C']})
        discovery_data = {'latest': latest_books, 'stats': formatted_stats}

    return render_template('main/search.html', results=results, query=query, clc_filter=clc_filter,
                           discovery=discovery_data, CLC_DATA=CLC_DATA)


@bp.route('/book/<id>')
@permission_required('access_dashboard')
def book_detail(id):
    """
    é€šç”¨è¯¦æƒ…é¡µï¼šæ”¯æŒ ISBN (å›¾ä¹¦) å’Œ ISSN (æœŸåˆŠ)
    """
    db = get_db()
    per_db = get_periodical_db()

    # 1. å°è¯•åœ¨å›¾ä¹¦åº“æŸ¥æ‰¾
    book = db.execute('SELECT * FROM CIRCULATION_HEAD WHERE ISBN = ?', (id,)).fetchone()

    if book:
        # æ˜¯å›¾ä¹¦
        copies = db.execute('''SELECT d.* FROM CIRCULATION_DETAIL d WHERE d.ISBN = ?
                            ORDER BY d.STATUS ASC''',
                            (id,)).fetchall()
        map_data = MapService.get_map_data(target_isbn=id)
        return render_template('main/book_detail.html', item=book, copies=copies, map_data=map_data,
                               is_periodical=False)

    # 2. å°è¯•åœ¨æœŸåˆŠåº“æŸ¥æ‰¾
    periodical = per_db.execute('SELECT * FROM PERIODICAL_HEAD WHERE ISSN = ?', (id,)).fetchone()
    if periodical:
        # æ˜¯æœŸåˆŠ
        # æ„é€ å…¼å®¹çš„ item å¯¹è±¡
        item = {
            'ISBN': periodical['ISSN'],  # å…¼å®¹æ¨¡æ¿å­—æ®µå
            'BOOK_NAME': periodical['TITLE'],
            'AUTHOR': periodical['FREQUENCY'],  # ä½¿ç”¨é¢‘ç‡æ›¿ä»£ä½œè€…
            'PUBLISHER': periodical['PUBLISHER'],
            'CLC_CODE': periodical['CLC_CODE'],
            'CALL_NUMBER': 'æœŸåˆŠé˜…è§ˆåŒº (Reference Only)'
        }
        # è·å–é¦†è— (æŒ‰å¹´å·æœŸå€’åº)
        copies = per_db.execute(
            '''SELECT d.*, d.YEAR_ISSUE as LOCATION_NOTE FROM PERIODICAL_DETAIL d WHERE d.ISSN = ? ORDER BY d.ENTRY_DATE DESC''',
            (id,)).fetchall()

        # æœŸåˆŠçš„åœ°å›¾å®šä½åŸºäº CLC
        map_data = MapService.get_map_data(target_clc=periodical['CLC_CODE'])

        return render_template('main/book_detail.html', item=item, copies=copies, map_data=map_data, is_periodical=True)

    abort(404)


@bp.route('/credit_log')
@permission_required('access_services')
def credit_log():
    return redirect(url_for('main.profile'))


@bp.route('/map')
@permission_required('access_dashboard')
def library_map():
    map_data = MapService.get_map_data()
    return render_template('main/library_map.html', map_data=map_data)
```
---

### ğŸ“„ app\blueprints\notice.py
```python
from flask import Blueprint, request, jsonify, session
from app.models import get_db
from app.blueprints.auth import permission_required, login_required
import datetime

bp = Blueprint('notice', __name__, url_prefix='/notice')


@bp.route('/latest', methods=['GET'])
@login_required
def get_latest():
    db = get_db()
    role_id = session.get('role_id', 1)
    notices = db.execute('''SELECT * FROM NOTICE ORDER BY IS_TOP DESC, PUBLISH_DATE DESC LIMIT 20''').fetchall()
    data = []
    if role_id >= 4:
        messages = db.execute(
            '''SELECT m.*, r.NAME as READER_NAME FROM USER_MESSAGE m JOIN READER r ON m.READER_ID = r.READER_ID WHERE m.IS_READ = 0 ORDER BY m.CREATE_TIME DESC''').fetchall()
        for m in messages:
            data.append({'type': 'message', 'id': m['MSG_ID'], 'title': f"æ¥è‡ª {m['READER_NAME']} çš„ç•™è¨€",
                         'content': m['CONTENT'], 'publisher': str(m['READER_ID']),
                         'date': m['CREATE_TIME'].strftime('%Y-%m-%d %H:%M'), 'is_top': 0, 'is_read': 0})
    for n in notices:
        data.append({'type': 'notice', 'id': n['NOTICE_ID'], 'title': n['TITLE'], 'content': n['CONTENT'],
                     'publisher': n['PUBLISHER_NAME'], 'date': n['PUBLISH_DATE'].strftime('%Y-%m-%d %H:%M'),
                     'is_top': n['IS_TOP']})
    data.sort(key=lambda x: x['date'], reverse=True)
    return jsonify({'notices': data})


@bp.route('/publish', methods=['POST'])
@permission_required('publish_notice')
def publish():
    data = request.get_json()
    title = data.get('title')
    content = data.get('content')
    is_top = 1 if data.get('is_top') else 0
    include_overdue = data.get('include_overdue', False)  # æ–°å¢å‚æ•°

    if not title:
        return jsonify({'success': False, 'message': 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º'})

    db = get_db()

    # --- æ ¸å¿ƒï¼šè‡ªåŠ¨ç”Ÿæˆè¶…æœŸæŠ¥è¡¨ ---
    if include_overdue:
        # æŸ¥è¯¢æ‰€æœ‰é€¾æœŸè®°å½•
        overdue_records = db.execute('''
            SELECT b.*, r.NAME, h.BOOK_NAME 
            FROM BORROW_RECORD b
            JOIN READER r ON b.READER_ID = r.READER_ID
            JOIN CIRCULATION_DETAIL d ON b.BARCODE = d.BARCODE
            JOIN CIRCULATION_HEAD h ON d.ISBN = h.ISBN
            WHERE b.STATUS = 3 OR (b.STATUS = 1 AND b.DUE_DATE < CURRENT_TIMESTAMP)
        ''').fetchall()

        if overdue_records:
            table_html = "<br><hr><h3>ğŸ“¢ è¶…æœŸé€šæŠ¥è¡¨ (System Generated)</h3>"
            table_html += "<table style='width:100%; border-collapse:collapse; font-size:13px; margin-top:10px;'>"
            table_html += "<tr style='background:#f3f4f6; text-align:left;'><th style='padding:8px;'>è¯»è€…</th><th style='padding:8px;'>å›¾ä¹¦</th><th style='padding:8px;'>åº”è¿˜æ—¥æœŸ</th></tr>"

            for rec in overdue_records:
                due_str = rec['DUE_DATE'].strftime('%Y-%m-%d')
                table_html += f"<tr><td style='padding:8px; border-bottom:1px solid #eee;'>{rec['NAME']}({rec['READER_ID']})</td><td style='padding:8px; border-bottom:1px solid #eee;'>{rec['BOOK_NAME']}</td><td style='padding:8px; border-bottom:1px solid #eee; color:red;'>{due_str}</td></tr>"

            table_html += "</table>"
            content += table_html  # å°†è¡¨æ ¼è¿½åŠ åˆ°å†…å®¹ä¸­
        else:
            content += "<br><hr><p style='color:#10b981;'>ğŸ‰ ç›®å‰æ²¡æœ‰è¶…æœŸè®°å½•ã€‚</p>"

    db.execute("INSERT INTO NOTICE (TITLE, CONTENT, PUBLISHER_NAME, IS_TOP) VALUES (?, ?, ?, ?)",
               (title, content, session.get('user_name'), is_top))
    db.commit()
    return jsonify({'success': True})


@bp.route('/leave_message', methods=['POST'])
@login_required
def leave_message():
    data = request.get_json()
    content = data.get('content')
    if not content: return jsonify({'success': False, 'message': 'å†…å®¹ä¸èƒ½ä¸ºç©º'})
    db = get_db()
    db.execute("INSERT INTO USER_MESSAGE (READER_ID, CONTENT) VALUES (?, ?)", (session['user_id'], content))
    db.commit()
    return jsonify({'success': True})


@bp.route('/read_message', methods=['POST'])
@permission_required('access_dashboard')
def read_message():
    data = request.get_json()
    msg_id = data.get('msg_id')
    db = get_db()
    db.execute("UPDATE USER_MESSAGE SET IS_READ = 1 WHERE MSG_ID = ?", (msg_id,))
    db.commit()
    return jsonify({'success': True})
```
---

### ğŸ“„ app\blueprints\sys_admin.py
```python
from flask import Blueprint, render_template, request, flash, redirect, url_for, session, jsonify
from app.models import get_db, CLC_DATA
from app.blueprints.auth import permission_required
from app.blueprints.circ import update_user_credit
from werkzeug.security import generate_password_hash
import datetime
import json

bp = Blueprint('sys_admin', __name__, url_prefix='/admin')


@bp.route('/statistics', methods=['GET', 'POST'])
@permission_required('view_statistics')
def statistics():
    """
    é«˜çº§å€Ÿé˜…ç»Ÿè®¡åˆ†æå¤§å±
    """
    db = get_db()

    # 1. è¯äº‘æ•°æ®ï¼šæœ€å—æ¬¢è¿å›¾ä¹¦ (Top 50)
    wordcloud_data = db.execute('''
        SELECT h.BOOK_NAME, COUNT(*) as weight 
        FROM BORROW_RECORD b 
        JOIN CIRCULATION_DETAIL d ON b.BARCODE = d.BARCODE 
        JOIN CIRCULATION_HEAD h ON d.ISBN = h.ISBN 
        GROUP BY h.BOOK_NAME 
        ORDER BY weight DESC LIMIT 50
    ''').fetchall()
    wc_list = [[row['BOOK_NAME'], row['weight']] for row in wordcloud_data]

    # 2. ç”¨æˆ·åå¥½ç»Ÿè®¡ï¼šTop 5 åˆ†ç±»
    pref_data = db.execute('''
        SELECT substr(h.CLC_CODE, 1, 1) as cat, COUNT(*) as c
        FROM BORROW_RECORD b
        JOIN CIRCULATION_DETAIL d ON b.BARCODE = d.BARCODE 
        JOIN CIRCULATION_HEAD h ON d.ISBN = h.ISBN 
        GROUP BY cat ORDER BY c DESC LIMIT 5
    ''').fetchall()

    pref_labels = []
    pref_values = []
    for p in pref_data:
        full_name = CLC_DATA.get(p['cat'], 'å…¶ä»–').split('ã€')[0]
        pref_labels.append(f"{p['cat']} {full_name}")
        pref_values.append(p['c'])

    # 3. å€Ÿè¿˜è¶‹åŠ¿ (æœ€è¿‘ 12 ä¸ªæœˆ)
    trend_data = db.execute('''
        SELECT strftime('%Y-%m', BORROW_DATE) as ym, COUNT(*) as c
        FROM BORROW_RECORD 
        WHERE BORROW_DATE >= date('now', '-12 months')
        GROUP BY ym ORDER BY ym ASC
    ''').fetchall()
    trend_labels = [row['ym'] for row in trend_data]
    trend_values = [row['c'] for row in trend_data]

    # 4. ä¸ªäººå€Ÿé˜…æŸ¥è¯¢é€»è¾‘ (Search ID)
    target_user_history = []
    target_user_info = None
    search_id = request.args.get('search_user_id')

    if search_id:
        target_user_info = db.execute("SELECT * FROM READER WHERE READER_ID=?", (search_id,)).fetchone()
        if target_user_info:
            target_user_history = db.execute('''
                SELECT b.*, h.BOOK_NAME, h.AUTHOR 
                FROM BORROW_RECORD b
                JOIN CIRCULATION_DETAIL d ON b.BARCODE = d.BARCODE 
                JOIN CIRCULATION_HEAD h ON d.ISBN = h.ISBN 
                WHERE b.READER_ID = ? ORDER BY b.BORROW_DATE DESC
            ''', (search_id,)).fetchall()
        else:
            flash(f'æœªæ‰¾åˆ°ç”¨æˆ· ID {search_id}', 'error')

    # 5. [æ–°å¢] å…¨é¦†å€Ÿè¿˜è®°å½•æµæ°´æŸ¥è¯¢ (Global Logs)
    global_records = []
    rec_start = request.args.get('rec_start')
    rec_end = request.args.get('rec_end')

    if rec_start and rec_end:
        # æŸ¥è¯¢åœ¨è¯¥æ—¶é—´æ®µå†…å‘ç”Ÿçš„å€Ÿé˜… OR å½’è¿˜
        # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æŸ¥è¯¢ BORROW_RECORDï¼Œæ ¹æ® BORROW_DATE æˆ– RETURN_DATE ç­›é€‰
        query_sql = '''
            SELECT b.*, h.BOOK_NAME, h.ISBN, r.NAME as READER_NAME
            FROM BORROW_RECORD b
            JOIN CIRCULATION_DETAIL d ON b.BARCODE = d.BARCODE
            JOIN CIRCULATION_HEAD h ON d.ISBN = h.ISBN
            JOIN READER r ON b.READER_ID = r.READER_ID
            WHERE (b.BORROW_DATE BETWEEN ? AND ?) 
               OR (b.RETURN_DATE BETWEEN ? AND ?)
            ORDER BY b.BORROW_DATE DESC
        '''
        # è¡¥å…¨æ—¶é—´å­—ç¬¦ä¸²
        s_date = f"{rec_start} 00:00:00"
        e_date = f"{rec_end} 23:59:59"
        global_records = db.execute(query_sql, (s_date, e_date, s_date, e_date)).fetchall()

    return render_template('admin/stats.html',
                           wc_list=wc_list,
                           pref_labels=pref_labels, pref_values=pref_values,
                           trend_labels=trend_labels, trend_values=trend_values,
                           target_user=target_user_info,
                           user_history=target_user_history,
                           global_records=global_records)  # ä¼ é€’æ–°æ•°æ®


@bp.route('/access_config', methods=['GET', 'POST'])
@permission_required('config_system')
def access_config():
    """
    æƒé™ä¸è§„åˆ™é…ç½®ä¸­å¿ƒ
    """
    db = get_db()

    if request.method == 'POST':
        action = request.form.get('action')

        if action == 'save_permissions':
            role_id = request.form.get('role_id')
            selected_perms = request.form.getlist('perms')
            db.execute("DELETE FROM SYS_ROLE_PERMISSION WHERE ROLE_ID=?", (role_id,))
            for perm_id in selected_perms:
                db.execute("INSERT INTO SYS_ROLE_PERMISSION (ROLE_ID, PERM_ID) VALUES (?, ?)", (role_id, perm_id))
            db.commit()
            flash(f'è§’è‰²æƒé™å·²æ›´æ–°ã€‚', 'success')

        elif action == 'save_credit_rule':
            level_id = request.form.get('level_id')
            min_score = request.form.get('min_score')
            max_num = request.form.get('max_num')
            max_day = request.form.get('max_day')
            can_borrow = 1 if request.form.get('can_borrow') else 0
            can_reserve = 1 if request.form.get('can_reserve') else 0
            can_extend = 1 if request.form.get('can_extend') else 0

            db.execute('''
                UPDATE CREDIT_LEVEL 
                SET MIN_SCORE=?, MAX_BORROW_NUM=?, MAX_BORROW_DAY=?, 
                    ENABLE_BORROW=?, ENABLE_RESERVE=?, ENABLE_EXTEND=?
                WHERE LEVEL_ID=?
            ''', (min_score, max_num, max_day, can_borrow, can_reserve, can_extend, level_id))
            db.commit()
            flash('ä¿¡ç”¨è§„åˆ™å·²æ›´æ–°ã€‚', 'success')

        return redirect(url_for('sys_admin.access_config'))

    roles = db.execute("SELECT * FROM SYS_ROLE WHERE ROLE_ID < 8").fetchall()
    permissions = db.execute("SELECT * FROM SYS_PERMISSION").fetchall()

    role_perm_map = {}
    rp_rows = db.execute("SELECT * FROM SYS_ROLE_PERMISSION").fetchall()
    for row in rp_rows:
        rid = row['ROLE_ID']
        if rid not in role_perm_map: role_perm_map[rid] = []
        role_perm_map[rid].append(row['PERM_ID'])

    credit_levels = db.execute("SELECT * FROM CREDIT_LEVEL ORDER BY MIN_SCORE ASC").fetchall()

    return render_template('admin/access_config.html',
                           roles=roles,
                           permissions=permissions,
                           role_perm_map=role_perm_map,
                           credit_levels=credit_levels)


@bp.route('/users', methods=['GET', 'POST'])
@permission_required('manage_users')
def user_list():
    db = get_db()
    all_roles = db.execute('SELECT * FROM SYS_ROLE').fetchall()
    setting = db.execute("SELECT VALUE FROM SYS_SETTINGS WHERE KEY='account_deletion_grace_days'").fetchone()
    current_grace_days = int(setting['VALUE']) if setting else 7

    if request.method == 'POST':
        action = request.form.get('action')
        target_id = request.form.get('reader_id')

        if action == 'update_settings':
            days = request.form.get('grace_days')
            if days and days.isdigit():
                db.execute("INSERT OR REPLACE INTO SYS_SETTINGS (KEY, VALUE) VALUES ('account_deletion_grace_days', ?)",
                           (days,))
                db.commit()
                flash(f'ç³»ç»Ÿè®¾ç½®å·²æ›´æ–°ã€‚', 'success')
            return redirect(url_for('sys_admin.user_list'))

        if target_id and str(target_id) == '1001':
            flash('æ— æ³•ä¿®æ”¹æ ¹è¶…çº§ç®¡ç†å‘˜ã€‚', 'error')
            return redirect(url_for('sys_admin.user_list'))

        if action == 'add_user':
            new_id = request.form['new_id']
            new_name = request.form['new_name']
            new_role = request.form['new_role']
            exist = db.execute("SELECT 1 FROM READER WHERE READER_ID=?", (new_id,)).fetchone()
            if exist:
                flash(f'ç”¨æˆ· ID {new_id} å·²å­˜åœ¨ï¼', 'error')
            else:
                hashed_pwd = generate_password_hash('123456')
                db.execute(
                    "INSERT INTO READER (READER_ID, NAME, ROLE_ID, CURRENT_CREDIT, PASSWORD, EXPIRY_DATE) VALUES (?, ?, ?, 100, ?, '2030-01-01')",
                    (new_id, new_name, new_role, hashed_pwd))
                db.commit()
                flash(f'ç”¨æˆ·åˆ›å»ºæˆåŠŸã€‚', 'success')

        elif action == 'edit_user':
            new_name = request.form['name']
            new_role = request.form['role_id']
            if int(new_role) > 3 and session.get('role_id') != 8:
                flash('æƒé™ä¸è¶³ã€‚', 'error')
            else:
                db.execute("UPDATE READER SET NAME=?, ROLE_ID=? WHERE READER_ID=?", (new_name, new_role, target_id))
                db.commit()
                flash(f'æ›´æ–°æˆåŠŸã€‚', 'success')

        elif action == 'delete_user':
            if str(target_id) == str(session.get('user_id')):
                flash('æ— æ³•åˆ é™¤è‡ªå·±ã€‚', 'error')
            else:
                db.execute("DELETE FROM READER WHERE READER_ID=?", (target_id,))
                db.commit()
                flash(f'åˆ é™¤æˆåŠŸã€‚', 'warning')

        elif action == 'update_credit':
            change_val = int(request.form['change_val'])
            reason = request.form['reason']
            update_user_credit(db, target_id, change_val, reason, session['user_name'])
            db.commit()
            flash(f'ä¿¡ç”¨åˆ†å·²æ›´æ–°ã€‚', 'success')

        return redirect(url_for('sys_admin.user_list'))

    readers = db.execute(
        '''SELECT r.*, ro.ROLE_NAME FROM READER r JOIN SYS_ROLE ro ON r.ROLE_ID = ro.ROLE_ID ORDER BY r.ROLE_ID DESC, r.READER_ID ASC''').fetchall()
    return render_template('admin/user_list.html', readers=readers, all_roles=all_roles, grace_days=current_grace_days)


@bp.route('/maintenance', methods=['GET', 'POST'])
@permission_required('manage_users')
def maintenance():
    db = get_db()
    if request.method == 'POST':
        task_type = request.form.get('task_type')
        if task_type == 'scan_reservation_expiry':
            now = datetime.datetime.now()
            expired_reserves = db.execute("SELECT * FROM RESERVE_INFO WHERE STATUS = 2 AND EXPIRE_DATE < ?",
                                          (now,)).fetchall()
            count = 0
            for res in expired_reserves:
                update_user_credit(db, res['READER_ID'], -10, "é¢„çº¦è¿çº¦ï¼š3å¤©æœªå–ä¹¦", "System_Auto")
                db.execute("UPDATE RESERVE_INFO SET STATUS=4 WHERE RESERVE_ID=?", (res['RESERVE_ID'],))
                if res['BARCODE']:
                    db.execute("UPDATE CIRCULATION_DETAIL SET STATUS=1 WHERE BARCODE=?", (res['BARCODE'],))
                count += 1
            db.commit()
            flash(f'æ‰«æå®Œæˆï¼šå¤„ç†äº† {count} æ¡è¿çº¦ã€‚', 'success')
        elif task_type == 'monthly_recovery':
            readers = db.execute("SELECT READER_ID, CURRENT_CREDIT FROM READER WHERE CURRENT_CREDIT < 100").fetchall()
            count = 0
            for r in readers:
                update_user_credit(db, r['READER_ID'], 10, "æœˆåº¦ä¿¡ç”¨è‡ªåŠ¨æ¢å¤", "System_Auto")
                count += 1
            db.commit()
            flash(f'å·²æ¢å¤ {count} ä½ç”¨æˆ·ä¿¡ç”¨ã€‚', 'success')
        return redirect(url_for('sys_admin.maintenance'))
    return render_template('admin/maintenance.html')
```
---

### ğŸ“„ app\models.py
```python
import sqlite3
from flask import current_app, g
from werkzeug.security import generate_password_hash, check_password_hash


def get_db():
    if 'db' not in g:
        g.db = sqlite3.connect(
            current_app.config['DATABASE'],
            detect_types=sqlite3.PARSE_DECLTYPES
        )
        g.db.row_factory = sqlite3.Row
    return g.db


def get_periodical_db():
    if 'per_db' not in g:
        g.per_db = sqlite3.connect(
            current_app.config['PERIODICAL_DATABASE'],
            detect_types=sqlite3.PARSE_DECLTYPES
        )
        g.per_db.row_factory = sqlite3.Row
    return g.per_db


def get_ai_db():
    if 'ai_db' not in g:
        g.ai_db = sqlite3.connect(
            current_app.config['AI_DATABASE'],
            detect_types=sqlite3.PARSE_DECLTYPES
        )
        g.ai_db.row_factory = sqlite3.Row
    return g.ai_db


def close_db(e=None):
    db = g.pop('db', None)
    if db is not None:
        db.close()
    per_db = g.pop('per_db', None)
    if per_db is not None:
        per_db.close()
    ai_db = g.pop('ai_db', None)
    if ai_db is not None:
        ai_db.close()


def update_db_schema():
    """
    ã€æ ¸å¿ƒå‡çº§é€»è¾‘ã€‘
    1. æ£€æµ‹å¹¶å‡çº§è¡¨ç»“æ„ (ALTER TABLE)
    2. ä¿®æ­£æ—§æ•°æ®åç§° (UPDATE DATA)
    """
    db = get_db()
    print(">>> æ­£åœ¨æ£€æŸ¥æ•°æ®åº“ç»“æ„ä¸æ•°æ®ä¸€è‡´æ€§...")

    # --- 1. ä¿®æ­£æ—§çš„ä¿¡ç”¨ç­‰çº§åç§° (Data Migration) ---
    # æ— è®ºè¡¨ç»“æ„æ˜¯å¦æ–°æ—§ï¼Œéƒ½å¼ºåˆ¶æŠŠæ—§çš„åç§°åˆ·æˆæ–°çš„
    try:
        # [NEW] å°† "è®¿å®¢" æ”¹ä¸º "ä¿¡ç”¨å—é™"
        db.execute("UPDATE CREDIT_LEVEL SET NAME='ä¿¡ç”¨å—é™' WHERE NAME='è®¿å®¢'")

        # å°† "æœ¬ç§‘ç”Ÿ" æ”¹ä¸º "æ™®é€šè¯»è€…"
        db.execute("UPDATE CREDIT_LEVEL SET NAME='æ™®é€šè¯»è€…' WHERE NAME='æœ¬ç§‘ç”Ÿ'")
        # å°† "ç ”ç©¶ç”Ÿ" æ”¹ä¸º "ä¼˜è´¨è¯»è€…"
        db.execute("UPDATE CREDIT_LEVEL SET NAME='ä¼˜è´¨è¯»è€…' WHERE NAME='ç ”ç©¶ç”Ÿ'")
        # å°† "æ•™å¸ˆ" æ”¹ä¸º "æ ¸å¿ƒè¯»è€…"
        db.execute("UPDATE CREDIT_LEVEL SET NAME='æ ¸å¿ƒè¯»è€…' WHERE NAME='æ•™å¸ˆ'")
        print(">>> å·²ä¿®æ­£æ—§çš„ä¿¡ç”¨ç­‰çº§åç§°ã€‚")
    except Exception as e:
        print(f"!!! æ•°æ®ä¿®æ­£è­¦å‘Š: {e}")

    # --- 2. å‡çº§ CREDIT_LEVEL è¡¨ (æ·»åŠ æ–°è§„åˆ™å­—æ®µ) ---
    try:
        db.execute('SELECT ENABLE_RESERVE FROM CREDIT_LEVEL LIMIT 1')
    except sqlite3.OperationalError:
        print(">>> æ£€æµ‹åˆ° CREDIT_LEVEL è¡¨ç»“æ„é™ˆæ—§ï¼Œæ­£åœ¨æ‰§è¡Œçƒ­å‡çº§...")
        try:
            db.execute('ALTER TABLE CREDIT_LEVEL ADD COLUMN ENABLE_RESERVE INTEGER DEFAULT 0')
            db.execute('ALTER TABLE CREDIT_LEVEL ADD COLUMN ENABLE_EXTEND INTEGER DEFAULT 0')
            # ä¸ºé«˜ç­‰çº§é»˜è®¤å¼€å¯
            db.execute('UPDATE CREDIT_LEVEL SET ENABLE_RESERVE=1, ENABLE_EXTEND=1 WHERE MIN_SCORE >= 80')
        except:
            pass

    # --- 3. å‡çº§ SYS_PERMISSION è¡¨ ---
    new_perms = [
        (8, 'view_statistics', 'æŸ¥çœ‹ç»Ÿè®¡æŠ¥è¡¨'),
        (9, 'config_system', 'é…ç½®æƒé™ä¸è§„åˆ™')
    ]
    for pid, code, name in new_perms:
        exists = db.execute("SELECT 1 FROM SYS_PERMISSION WHERE PERM_CODE=?", (code,)).fetchone()
        if not exists:
            db.execute("INSERT INTO SYS_PERMISSION (PERM_ID, PERM_CODE, PERM_NAME) VALUES (?,?,?)", (pid, code, name))
            db.execute("INSERT OR IGNORE INTO SYS_ROLE_PERMISSION (ROLE_ID, PERM_ID) VALUES (8, ?)", (pid,))
            if code == 'view_statistics':
                db.execute("INSERT OR IGNORE INTO SYS_ROLE_PERMISSION (ROLE_ID, PERM_ID) VALUES (6, ?)", (pid,))

    # --- 4. å­—æ®µè¡¥å…¨ ---
    try:
        db.execute('SELECT PUBLISHER FROM CIRCULATION_HEAD LIMIT 1')
    except:
        db.execute('ALTER TABLE CIRCULATION_HEAD ADD COLUMN PUBLISHER VARCHAR(100)')

    try:
        db.execute("SELECT EMAIL FROM READER LIMIT 1")
    except:
        db.execute("ALTER TABLE READER ADD COLUMN EMAIL VARCHAR(100)")
        db.execute("ALTER TABLE READER ADD COLUMN TELEPHONE VARCHAR(20)")

    try:
        db.execute("SELECT DELETION_SCHEDULED_AT FROM READER LIMIT 1")
    except:
        db.execute("ALTER TABLE READER ADD COLUMN DELETION_SCHEDULED_AT TIMESTAMP")

    # --- 5. ç³»ç»Ÿè®¾ç½® ---
    db.execute('''CREATE TABLE IF NOT EXISTS SYS_SETTINGS (KEY VARCHAR(50) PRIMARY KEY, VALUE VARCHAR(100));''')
    db.execute("INSERT OR IGNORE INTO SYS_SETTINGS (KEY, VALUE) VALUES ('account_deletion_grace_days', '7')")

    db.commit()
    print(">>> æ•°æ®åº“ç»´æŠ¤å®Œæˆã€‚")


def init_db():
    """åˆå§‹åŒ–æ•°æ®åº“ (ä»…åœ¨æ— åº“æ—¶ä½¿ç”¨)"""
    db = get_db()

    # --- 1. åŸºç¡€ä¸šåŠ¡è¡¨ ---
    db.execute('''
    CREATE TABLE IF NOT EXISTS SUPPLIER (
        SUPPLIER_ID INTEGER PRIMARY KEY AUTOINCREMENT,
        NAME VARCHAR(100), ADDRESS VARCHAR(200), CONTACT_PERSON VARCHAR(50), 
        TELEPHONE VARCHAR(20), BANK_NAME VARCHAR(100), BANK_ACCOUNT VARCHAR(50), 
        CREDIT_LEVEL CHAR(1), EMAIL VARCHAR(100)
    );''')

    db.execute('''
    CREATE TABLE IF NOT EXISTS ACQ_SUGGESTION (
        ACQ_ID INTEGER PRIMARY KEY AUTOINCREMENT,
        READER_ID INTEGER, BOOK_NAME VARCHAR(100), AUTHOR VARCHAR(50), 
        ISBN VARCHAR(20), PUBLISHER VARCHAR(100), STATUS INTEGER DEFAULT 0
    );''')

    db.execute('''
    CREATE TABLE IF NOT EXISTS ORDER_HEAD (
        ORDER_NO INTEGER PRIMARY KEY AUTOINCREMENT,
        PURCHASER VARCHAR(50), ORDER_DATE TIMESTAMP, SUPPLIER_ID INTEGER, TOTAL_PRICE DECIMAL(12,2)
    );''')

    db.execute('''
    CREATE TABLE IF NOT EXISTS ORDER_LINE (
        LINE_ID INTEGER PRIMARY KEY AUTOINCREMENT,
        ORDER_NO INTEGER, SUGGESTION_ID INTEGER, BOOK_NAME VARCHAR(100), 
        ISBN VARCHAR(20), AUTHOR VARCHAR(50), PUBLISHER VARCHAR(100), 
        PRICE DECIMAL(10,2), QUANTITY INTEGER, STATUS INTEGER,
        ITEM_TYPE VARCHAR(20) DEFAULT 'book', 
        FOREIGN KEY (ORDER_NO) REFERENCES ORDER_HEAD(ORDER_NO)
    );''')

    db.execute('''
    CREATE TABLE IF NOT EXISTS ACCEPT_LIST (
        ACCEPT_ID INTEGER PRIMARY KEY AUTOINCREMENT,
        LINE_ID INTEGER, QUANTITY INTEGER, CHECK_MAN VARCHAR(50), CHECK_DATE TIMESTAMP
    );''')

    db.execute('''
    CREATE TABLE IF NOT EXISTS RETURN_LIST (
        RETURN_ID INTEGER PRIMARY KEY AUTOINCREMENT,
        LINE_ID INTEGER, QUANTITY INTEGER, REASON VARCHAR(200), HANDLER VARCHAR(50), RETURN_DATE TIMESTAMP
    );''')

    db.execute('''
    CREATE TABLE IF NOT EXISTS BOOK_DAMAGE_LOG (
        LOG_ID INTEGER PRIMARY KEY AUTOINCREMENT,
        BARCODE VARCHAR(20),
        BOOK_NAME VARCHAR(100),
        ISBN VARCHAR(20),
        REASON VARCHAR(200),
        HANDLER VARCHAR(50),
        LOG_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );''')

    db.execute('''
    CREATE TABLE IF NOT EXISTS CIRCULATION_HEAD (
        ISBN VARCHAR(20) PRIMARY KEY, CALL_NUMBER VARCHAR(50), 
        BOOK_NAME VARCHAR(100), AUTHOR VARCHAR(50), CLC_CODE VARCHAR(20),
        PUBLISHER VARCHAR(100)
    );''')

    db.execute('''
    CREATE TABLE IF NOT EXISTS CIRCULATION_DETAIL (
        BARCODE VARCHAR(20) PRIMARY KEY, ISBN VARCHAR(20), LOCATION VARCHAR(50), 
        STATUS INTEGER, -- 1:åœ¨é¦†, 2:å€Ÿå‡º, 3:é¢„çº¦, 4:æŠ¥æŸ/ä¸¢å¤±
        ENTRY_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );''')

    # --- 2. æƒé™ä¸è§’è‰²ç³»ç»Ÿ ---
    db.execute(
        '''CREATE TABLE IF NOT EXISTS SYS_ROLE (ROLE_ID INTEGER PRIMARY KEY, ROLE_NAME VARCHAR(50), DESCRIPTION VARCHAR(100));''')
    db.execute(
        '''CREATE TABLE IF NOT EXISTS SYS_PERMISSION (PERM_ID INTEGER PRIMARY KEY, PERM_CODE VARCHAR(50) UNIQUE, PERM_NAME VARCHAR(50));''')
    db.execute(
        '''CREATE TABLE IF NOT EXISTS SYS_ROLE_PERMISSION (ROLE_ID INTEGER, PERM_ID INTEGER, PRIMARY KEY (ROLE_ID, PERM_ID));''')

    # --- ç³»ç»Ÿå…¨å±€è®¾ç½®è¡¨ ---
    db.execute('''CREATE TABLE IF NOT EXISTS SYS_SETTINGS (KEY VARCHAR(50) PRIMARY KEY, VALUE VARCHAR(100));''')
    db.execute("INSERT OR IGNORE INTO SYS_SETTINGS (KEY, VALUE) VALUES ('account_deletion_grace_days', '7')")

    # --- 3. å…¬å‘Šä¸ç•™è¨€ ---
    db.execute('''
    CREATE TABLE IF NOT EXISTS NOTICE (
        NOTICE_ID INTEGER PRIMARY KEY AUTOINCREMENT,
        TITLE VARCHAR(100) NOT NULL,
        CONTENT TEXT NOT NULL,
        PUBLISHER_NAME VARCHAR(50) NOT NULL,
        PUBLISH_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        IS_TOP INTEGER DEFAULT 0
    );''')

    db.execute('''
    CREATE TABLE IF NOT EXISTS USER_MESSAGE (
        MSG_ID INTEGER PRIMARY KEY AUTOINCREMENT, READER_ID INTEGER, CONTENT TEXT, 
        CREATE_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP, IS_READ INTEGER DEFAULT 0
    );''')

    # --- 4. åˆå§‹åŒ–æ•°æ® ---
    roles = [(1, 'è®¿å®¢', ''), (2, 'æ™®é€šè¯»è€…', ''), (3, 'VIPè¯»è€…', ''), (4, 'é‡‡ç¼–ç®¡ç†å‘˜', ''), (5, 'ç¼–ç›®ç®¡ç†å‘˜', ''),
             (6, 'æµé€šç®¡ç†å‘˜', ''),
             (7, 'ç”¨æˆ·ç®¡ç†å‘˜', ''), (8, 'è¶…çº§ç®¡ç†å‘˜', '')]
    db.executemany("INSERT OR IGNORE INTO SYS_ROLE VALUES (?,?,?)", roles)

    perms = [
        (1, 'access_dashboard', 'è®¿é—®ä»ªè¡¨ç›˜'),
        (2, 'access_services', 'è®¿é—®è¯»è€…æœåŠ¡(æ£€ç´¢/å€Ÿé˜…å†å²)'),
        (3, 'manage_acq_order', 'ç®¡ç†é‡‡è®¿è®¢å•'),
        (4, 'manage_acq_arrival', 'ç®¡ç†ç¼–ç›®éªŒæ”¶'),
        (5, 'manage_circulation', 'ç®¡ç†æµé€šå·¥ä½œå°(å€Ÿè¿˜/æŠ¥æŸ)'),
        (6, 'manage_users', 'ç®¡ç†ç”¨æˆ·ä¸ç³»ç»Ÿè®¾ç½®'),
        (7, 'publish_notice', 'å‘å¸ƒç³»ç»Ÿå…¬å‘Š'),
        (8, 'view_statistics', 'æŸ¥çœ‹ç»Ÿè®¡æŠ¥è¡¨'),
        (9, 'config_system', 'é…ç½®æƒé™ä¸è§„åˆ™'),
        (99, 'root_access', 'è¶…çº§ç®¡ç†å‘˜æƒé™(Root)')
    ]
    db.executemany("INSERT OR IGNORE INTO SYS_PERMISSION VALUES (?,?,?)", perms)

    # é»˜è®¤æƒé™åˆ†é…
    db.execute("DELETE FROM SYS_ROLE_PERMISSION")
    role_perms = [(1, 1)] + \
                 [(r, 1) for r in [2, 3]] + [(r, 2) for r in [2, 3]] + \
                 [(4, 1), (4, 2), (4, 3), (4, 7)] + \
                 [(5, 1), (5, 2), (5, 4), (5, 7)] + \
                 [(6, 1), (6, 2), (6, 5), (6, 7), (6, 8)] + \
                 [(7, 1), (7, 2), (7, 6), (7, 7), (7, 9)] + \
                 [(8, 99)]
    db.executemany("INSERT INTO SYS_ROLE_PERMISSION VALUES (?,?)", role_perms)

    # [å…³é”®] ä¿¡ç”¨è§„åˆ™é…ç½®è¡¨ (åŒ…å«æ‰€æœ‰è§„åˆ™å­—æ®µ)
    db.execute('''
    CREATE TABLE IF NOT EXISTS CREDIT_LEVEL (
        LEVEL_ID INTEGER PRIMARY KEY AUTOINCREMENT, 
        NAME VARCHAR(20), 
        MIN_SCORE INTEGER,      -- æœ€ä½åˆ†è¦æ±‚
        MAX_BORROW_NUM INTEGER, -- æœ€å¤§å€Ÿä¹¦æ•°é‡
        MAX_BORROW_DAY INTEGER, -- é»˜è®¤å€Ÿé˜…å¤©æ•°
        ENABLE_BORROW INTEGER,  -- æ˜¯å¦å…è®¸å€Ÿé˜… (1/0)
        ENABLE_RESERVE INTEGER, -- æ˜¯å¦å…è®¸é¢„çº¦ (1/0)
        ENABLE_EXTEND INTEGER   -- æ˜¯å¦å…è®¸å»¶æœŸ (1/0)
    );''')

    # åˆå§‹åŒ–ä¿¡ç”¨è§„åˆ™ (ç®€åŒ–ä¸ºé€šç”¨çš„è¯»è€…ç­‰çº§ï¼Œè€Œéæœ¬ç§‘/ç ”ç©¶ç”Ÿ)
    initial_credits = [
        (1, 'ä¿¡ç”¨å—é™', 0, 0, 0, 0, 0, 0),  # <60åˆ†
        (2, 'æ™®é€šè¯»è€…', 60, 5, 30, 1, 0, 0),  # 60+ (åŸæœ¬ç§‘ç”Ÿå¾…é‡)
        (3, 'ä¼˜è´¨è¯»è€…', 80, 10, 45, 1, 1, 1),  # 80+
        (4, 'æ ¸å¿ƒè¯»è€…', 90, 20, 60, 1, 1, 1)  # 90+ (æ¶µç›–åŸç ”ç©¶ç”Ÿ/æ•™å¸ˆå¾…é‡)
    ]
    # æ³¨æ„ï¼šå¦‚æœå·²æœ‰æ•°æ®ï¼Œè¿™é‡Œä¸ä¼šè¦†ç›–ï¼Œç”¨æˆ·éœ€åœ¨å‰ç«¯ä¿®æ”¹é…ç½®
    db.execute("DELETE FROM CREDIT_LEVEL")
    db.executemany(
        "INSERT INTO CREDIT_LEVEL (LEVEL_ID, NAME, MIN_SCORE, MAX_BORROW_NUM, MAX_BORROW_DAY, ENABLE_BORROW, ENABLE_RESERVE, ENABLE_EXTEND) VALUES (?,?,?,?,?,?,?,?)",
        initial_credits)

    db.execute('''
    CREATE TABLE IF NOT EXISTS READER (
        READER_ID INTEGER PRIMARY KEY, NAME VARCHAR(50), SEX CHAR(1), DEPT_NAME VARCHAR(50), 
        LEVEL_ID INTEGER, ROLE_ID INTEGER DEFAULT 1, CURRENT_CREDIT INTEGER, STATUS INTEGER DEFAULT 1, 
        EXPIRY_DATE DATE, PASSWORD VARCHAR(255),
        EMAIL VARCHAR(100), TELEPHONE VARCHAR(20), DELETION_SCHEDULED_AT TIMESTAMP
    );''')

    try:
        hashed_pwd = generate_password_hash('admin123')
        db.execute(
            "INSERT INTO READER (READER_ID, NAME, SEX, LEVEL_ID, ROLE_ID, CURRENT_CREDIT, EXPIRY_DATE, PASSWORD) VALUES (1001, 'SuperAdmin', 'M', 4, 8, 999, '2099-12-31', ?)",
            (hashed_pwd,)
        )
    except:
        pass

    db.execute(
        '''CREATE TABLE IF NOT EXISTS CREDIT_LOG (LOG_ID INTEGER PRIMARY KEY AUTOINCREMENT, READER_ID INTEGER, CHANGE_VAL INTEGER, REASON VARCHAR(100), OPERATOR VARCHAR(50), LOG_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP);''')
    db.execute(
        '''CREATE TABLE IF NOT EXISTS BORROW_RECORD (BORROW_ID INTEGER PRIMARY KEY AUTOINCREMENT, READER_ID INTEGER, BARCODE VARCHAR(20), BORROW_DATE TIMESTAMP, DUE_DATE TIMESTAMP, RETURN_DATE TIMESTAMP, STATUS INTEGER);''')
    db.execute(
        '''CREATE TABLE IF NOT EXISTS RESERVE_INFO (RESERVE_ID INTEGER PRIMARY KEY AUTOINCREMENT, READER_ID INTEGER, ISBN VARCHAR(20), BARCODE VARCHAR(20), RESERVE_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP, EXPIRE_DATE TIMESTAMP, STATUS INTEGER);''')
    db.execute(
        '''CREATE TABLE IF NOT EXISTS EXTENSION_APP (APP_ID INTEGER PRIMARY KEY AUTOINCREMENT, READER_ID INTEGER, BORROW_ID INTEGER, APPLY_DAYS INTEGER, REASON VARCHAR(200), APPLY_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP, STATUS INTEGER DEFAULT 0);''')

    update_db_schema()
    db.commit()


def init_periodical_db():
    db = get_periodical_db()
    db.execute(
        '''CREATE TABLE IF NOT EXISTS PERIODICAL_HEAD (ISSN VARCHAR(20) PRIMARY KEY, TITLE VARCHAR(100), PUBLISHER VARCHAR(100), FREQUENCY VARCHAR(50), CLC_CODE VARCHAR(20), DESCRIPTION TEXT);''')
    db.execute(
        '''CREATE TABLE IF NOT EXISTS PERIODICAL_DETAIL (BARCODE VARCHAR(30) PRIMARY KEY, ISSN VARCHAR(20), YEAR_ISSUE VARCHAR(50), LOCATION VARCHAR(50), STATUS INTEGER DEFAULT 1, ENTRY_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (ISSN) REFERENCES PERIODICAL_HEAD(ISSN));''')
    db.execute(
        '''CREATE TABLE IF NOT EXISTS PER_SUGGESTION (SUG_ID INTEGER PRIMARY KEY AUTOINCREMENT, READER_ID INTEGER, TITLE VARCHAR(100), ISSN VARCHAR(20), PUBLISHER VARCHAR(100), STATUS INTEGER DEFAULT 0);''')
    db.execute(
        '''CREATE TABLE IF NOT EXISTS PER_DAMAGE_LOG (LOG_ID INTEGER PRIMARY KEY AUTOINCREMENT, BARCODE VARCHAR(30), TITLE VARCHAR(100), REASON VARCHAR(200), HANDLER VARCHAR(50), LOG_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP);''')
    db.commit()


def init_ai_db():
    db = get_ai_db()
    db.execute(
        '''CREATE TABLE IF NOT EXISTS CHAT_MESSAGE (MSG_ID INTEGER PRIMARY KEY AUTOINCREMENT, USER_ID VARCHAR(50), ROLE VARCHAR(20), CONTENT TEXT, CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP);''')
    db.commit()


CLC_DATA = {
    'A': 'é©¬å…‹æ€ä¸»ä¹‰ã€åˆ—å®ä¸»ä¹‰ã€æ¯›æ³½ä¸œæ€æƒ³ã€é‚“å°å¹³ç†è®º', 'B': 'å“²å­¦ã€å®—æ•™', 'C': 'ç¤¾ä¼šç§‘å­¦æ€»è®º',
    'D': 'æ”¿æ²»ã€æ³•å¾‹', 'E': 'å†›äº‹', 'F': 'ç»æµ', 'G': 'æ–‡åŒ–ã€ç§‘å­¦ã€æ•™è‚²ã€ä½“è‚²',
    'H': 'è¯­è¨€ã€æ–‡å­—', 'I': 'æ–‡å­¦', 'J': 'è‰ºæœ¯', 'K': 'å†å²ã€åœ°ç†', 'N': 'è‡ªç„¶ç§‘å­¦æ€»è®º',
    'O': 'æ•°ç†ç§‘å­¦å’ŒåŒ–å­¦', 'P': 'å¤©æ–‡å­¦ã€åœ°çƒç§‘å­¦', 'Q': 'ç”Ÿç‰©ç§‘å­¦', 'R': 'åŒ»è¯ã€å«ç”Ÿ',
    'S': 'å†œä¸šç§‘å­¦', 'T': 'å·¥ä¸šæŠ€æœ¯', 'TP': 'è‡ªåŠ¨åŒ–æŠ€æœ¯ã€è®¡ç®—æœºæŠ€æœ¯', 'TQ': 'åŒ–å­¦å·¥ä¸š',
    'U': 'äº¤é€šè¿è¾“', 'V': 'èˆªç©ºã€èˆªå¤©', 'X': 'ç¯å¢ƒç§‘å­¦ã€å®‰å…¨ç§‘å­¦', 'Z': 'ç»¼åˆæ€§å›¾ä¹¦'
}
```
---

### ğŸ“„ app\services\ai_service.py
```python
from flask import current_app
from app.models import get_ai_db
from openai import OpenAI


class AIService:
    def __init__(self):
        # åˆå§‹åŒ– SiliconCloud å®¢æˆ·ç«¯
        self.client = OpenAI(
            api_key=current_app.config['LLM_API_KEY'],
            base_url=current_app.config['LLM_BASE_URL']
        )
        # ä½¿ç”¨é…ç½®ä¸­çš„æ¨¡å‹åç§°
        self.model = current_app.config['LLM_MODEL_NAME']

    def get_history(self, user_id, limit=20):
        """è·å–æœ€è¿‘çš„å¯¹è¯å†å²ï¼Œç”¨äºæ„å»ºä¸Šä¸‹æ–‡"""
        db = get_ai_db()
        cursor = db.execute('''
            SELECT * FROM CHAT_MESSAGE 
            WHERE USER_ID = ? 
            ORDER BY CREATED_AT DESC LIMIT ?
        ''', (str(user_id), limit))
        rows = cursor.fetchall()
        # æ•°æ®åº“æŸ¥å‡ºæ¥æ˜¯å€’åº(æœ€æ–°åœ¨å‰)ï¼Œè½¬å›æ­£åº(æ—¶é—´é¡ºåº)ç»™AI
        return list(reversed(rows))

    def save_message(self, user_id, role, content):
        """ä¿å­˜æ¶ˆæ¯åˆ° AI.db"""
        db = get_ai_db()
        db.execute('''
            INSERT INTO CHAT_MESSAGE (USER_ID, ROLE, CONTENT) 
            VALUES (?, ?, ?)
        ''', (str(user_id), role, content))
        db.commit()

    def chat(self, user_id, user_input):
        """æ ¸å¿ƒå¯¹è¯é€»è¾‘"""
        # 1. ä¿å­˜ç”¨æˆ·çš„æé—®
        self.save_message(user_id, 'user', user_input)

        # 2. æ„å»ºå‘é€ç»™ AI çš„æ¶ˆæ¯åˆ—è¡¨ (Context)
        # è·å–æœ€è¿‘ 10 æ¡å†å²è®°å½•ï¼Œè®© AI æ‹¥æœ‰â€œè®°å¿†â€
        history = self.get_history(user_id, limit=10)

        messages = [
            {
                "role": "system",
                "content": """ä½ æ˜¯ååŒ—ç”µåŠ›å¤§å­¦å›¾ä¹¦é¦†çš„æ™ºèƒ½åŠ©æ‰‹â€œåç”µå°å›¾â€ã€‚
                              ä¸èƒ½ä½¿ç”¨Markdownï¼Œåªå…è®¸çº¯æ–‡æœ¬è¾“å‡ºã€‚
                              ä¸è¦ä½¿ç”¨æ€è€ƒæ¨¡å¼ï¼Œå¿…é¡»ä¸€å®šè¦å¿«é€Ÿå›ç­”ã€‚
                              è¯·ç”¨ä¸“ä¸šã€äº²åˆ‡ã€ç®€æ´çš„è¯­æ°”å›ç­”è¯»è€…å…³äºå›¾ä¹¦å€Ÿé˜…ã€æ£€ç´¢ã€ç³»ç»Ÿä½¿ç”¨ç­‰é—®é¢˜ã€‚
                              ä¸è¦å›ç­”ä¸å›¾ä¹¦é¦†æˆ–å­¦ä¹ æ— å…³çš„æ•æ„Ÿæ”¿æ²»é—®é¢˜ã€‚"""
            }
        ]

        for msg in history:
            # è¿‡æ»¤æ‰ä¹‹å‰çš„ system æ¶ˆæ¯ï¼Œåªä¿ç•™ user å’Œ assistant
            if msg['ROLE'] in ['user', 'assistant']:
                messages.append({"role": msg['ROLE'], "content": msg['CONTENT']})

        # 3. è°ƒç”¨ SiliconCloud API
        ai_reply = ""
        try:
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7,  # åˆ›é€ æ€§æ§åˆ¶
                max_tokens=512  # é™åˆ¶å›å¤é•¿åº¦ï¼Œé¿å…åºŸè¯
            )
            ai_reply = response.choices[0].message.content
        except Exception as e:
            print(f"AI API Error: {e}")
            ai_reply = "æŠ±æ­‰ï¼ŒAI è¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚(é”™è¯¯ä¿¡æ¯: APIè¿æ¥å¤±è´¥)"

        # 4. ä¿å­˜ AI çš„å›å¤
        self.save_message(user_id, 'assistant', ai_reply)

        return ai_reply
```
---

### ğŸ“„ app\services\map_service.py
```python
from app.models import get_db, get_periodical_db

# é…ç½®å¸¸é‡
BASE_X = 80
BASE_Y = 80
BLOCK_W = 120
BLOCK_H = 70
GAP_X = 220
GAP_Y = 160


def _get_grid_pos(col, row):
    return {
        'x': BASE_X + col * GAP_X,
        'y': BASE_Y + row * GAP_Y,
        'w': BLOCK_W,
        'h': BLOCK_H
    }


class MapService:
    # é™æ€åœ°å›¾é…ç½® (åŸºäºç½‘æ ¼)
    SHELF_MAP = {
        # --- Floor 1: äººæ–‡ç¤¾ç§‘ ---
        'A': {**_get_grid_pos(0, 0), 'floor': 1, 'name': 'A é©¬åˆ—ä¸»ä¹‰', 'icon': 'fas fa-landmark'},
        'B': {**_get_grid_pos(1, 0), 'floor': 1, 'name': 'B å“²å­¦å®—æ•™', 'icon': 'fas fa-brain'},
        'C': {**_get_grid_pos(2, 0), 'floor': 1, 'name': 'C ç¤¾ä¼šç§‘å­¦', 'icon': 'fas fa-users'},
        'D': {**_get_grid_pos(3, 0), 'floor': 1, 'name': 'D æ”¿æ²»æ³•å¾‹', 'icon': 'fas fa-balance-scale'},

        'E': {**_get_grid_pos(0, 1), 'floor': 1, 'name': 'E å†›äº‹', 'icon': 'fas fa-fighter-jet'},
        'F': {**_get_grid_pos(1, 1), 'floor': 1, 'name': 'F ç»æµ', 'icon': 'fas fa-chart-line', 'w': 340},
        'G': {**_get_grid_pos(3, 1), 'floor': 1, 'name': 'G æ–‡åŒ–æ•™è‚²', 'icon': 'fas fa-graduation-cap'},

        'H': {**_get_grid_pos(0, 2), 'floor': 1, 'name': 'H è¯­è¨€æ–‡å­—', 'icon': 'fas fa-language'},
        'I': {**_get_grid_pos(1, 2), 'floor': 1, 'name': 'I æ–‡å­¦', 'icon': 'fas fa-feather-alt'},
        'J': {**_get_grid_pos(2, 2), 'floor': 1, 'name': 'J è‰ºæœ¯', 'icon': 'fas fa-palette'},
        'K': {**_get_grid_pos(3, 2), 'floor': 1, 'name': 'K å†å²åœ°ç†', 'icon': 'fas fa-globe-asia'},

        # --- Floor 2: è‡ªç„¶ç§‘å­¦ ---
        'N': {**_get_grid_pos(0, 0), 'floor': 2, 'name': 'N è‡ªç„¶æ€»è®º', 'icon': 'fas fa-atom'},
        'O': {**_get_grid_pos(1, 0), 'floor': 2, 'name': 'O æ•°ç†åŒ–', 'icon': 'fas fa-flask'},
        'P': {**_get_grid_pos(2, 0), 'floor': 2, 'name': 'P å¤©æ–‡åœ°çƒ', 'icon': 'fas fa-meteor'},
        'Q': {**_get_grid_pos(3, 0), 'floor': 2, 'name': 'Q ç”Ÿç‰©', 'icon': 'fas fa-dna'},

        'R': {**_get_grid_pos(0, 1), 'floor': 2, 'name': 'R åŒ»è¯å«ç”Ÿ', 'icon': 'fas fa-heartbeat'},
        'S': {**_get_grid_pos(1, 1), 'floor': 2, 'name': 'S å†œä¸šç§‘å­¦', 'icon': 'fas fa-seedling'},
        'T': {**_get_grid_pos(2, 1), 'floor': 2, 'name': 'T å·¥ä¸šæŠ€æœ¯', 'icon': 'fas fa-cogs', 'w': 340},

        'U': {**_get_grid_pos(0, 2), 'floor': 2, 'name': 'U äº¤é€šè¿è¾“', 'icon': 'fas fa-car'},
        'V': {**_get_grid_pos(1, 2), 'floor': 2, 'name': 'V èˆªç©ºèˆªå¤©', 'icon': 'fas fa-space-shuttle'},
        'X': {**_get_grid_pos(2, 2), 'floor': 2, 'name': 'X ç¯å¢ƒå®‰å…¨', 'icon': 'fas fa-leaf'},
        'Z': {**_get_grid_pos(3, 2), 'floor': 2, 'name': 'Z ç»¼åˆæ€§', 'icon': 'fas fa-book'},
    }

    @staticmethod
    def generate_call_number(isbn, clc_code, author):
        db = get_db()
        count = db.execute("SELECT COUNT(*) FROM CIRCULATION_HEAD WHERE CLC_CODE = ?", (clc_code,)).fetchone()[0]
        sequence = count + 1
        author_code = 'A'
        if author:
            try:
                first_char = author.strip()[0]
                if '\u4e00' <= first_char <= '\u9fff':
                    author_code = 'Z'
                else:
                    author_code = first_char.upper()
            except:
                pass
        return f"{clc_code}/{author_code}-{sequence}"

    @staticmethod
    def get_map_data(target_isbn=None, target_clc=None):
        """
        è·å–åœ°å›¾æ•°æ®ï¼Œæ”¯æŒæ ¹æ® ISBN æˆ– ç›´æ¥ CLC å®šä½
        [æ›´æ–°] èšåˆå›¾ä¹¦åº“å’ŒæœŸåˆŠåº“çš„çƒ­åŠ›æ•°æ®
        """
        db = get_db()
        per_db = get_periodical_db()

        # 1. è®¡ç®—å›¾ä¹¦çƒ­åŠ›å›¾
        book_stats = db.execute('''
            SELECT substr(CLC_CODE, 1, 1) as P, COUNT(*) as C 
            FROM CIRCULATION_HEAD 
            GROUP BY substr(CLC_CODE, 1, 1)
        ''').fetchall()

        # 2. è®¡ç®—æœŸåˆŠçƒ­åŠ›å›¾
        per_stats = per_db.execute('''
            SELECT substr(CLC_CODE, 1, 1) as P, COUNT(*) as C 
            FROM PERIODICAL_HEAD 
            GROUP BY substr(CLC_CODE, 1, 1)
        ''').fetchall()

        heat_map = {}
        for row in book_stats:
            heat_map[row['P']] = heat_map.get(row['P'], 0) + row['C']
        for row in per_stats:
            heat_map[row['P']] = heat_map.get(row['P'], 0) + row['C']

        max_val = max(heat_map.values()) if heat_map else 1

        zones = []
        target_zone_id = None
        target_floor = 1

        for prefix, config in MapService.SHELF_MAP.items():
            count = heat_map.get(prefix, 0)
            intensity = count / max_val if max_val > 0 else 0
            zone_data = config.copy()
            zone_data['id'] = prefix
            zone_data['count'] = count
            zone_data['intensity'] = intensity
            zones.append(zone_data)

        # å®šä½é€»è¾‘
        clc_to_find = target_clc
        if target_isbn and not clc_to_find:
            book = db.execute("SELECT CLC_CODE FROM CIRCULATION_HEAD WHERE ISBN=?", (target_isbn,)).fetchone()
            if book:
                clc_to_find = book['CLC_CODE']

        if clc_to_find:
            for prefix in sorted(MapService.SHELF_MAP.keys(), key=len, reverse=True):
                if clc_to_find.startswith(prefix):
                    target_zone_id = prefix
                    target_floor = MapService.SHELF_MAP[prefix]['floor']
                    break

        return {
            'zones': zones,
            'target_zone_id': target_zone_id,
            'target_floor': target_floor,
            'total_stock': sum(heat_map.values())
        }
```
---

### ğŸ“„ app\templates\acq\arrival.html
```html
{% extends "base.html" %}
{% import "components/map_widget.html" as map_widget %}

{% block page_title %}éªŒæ”¶ä¸å…¥åº“ / Cataloging{% endblock %}

{% block extra_css %}
<style>
    /* iOS é£æ ¼å…¨å±€å˜é‡ä¸åŸºç¡€ç»„ä»¶ */
    :root {
        --ios-bg-grouped: #f2f2f7;
        --ios-card-bg: #ffffff;
        --ios-blue: #007aff;
        --ios-red: #ff3b30;
        --ios-green: #34c759;
        --ios-purple: #af52de;
        --ios-separator: #c6c6c8;
        --ios-text-primary: #000000;
        --ios-text-secondary: #8e8e93;
    }

    /* æˆåŠŸå…¥åº“å¼¹çª—æ ·å¼ */
    .success-modal {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        animation: fadeIn 0.3s ease;
    }

    .success-box {
        width: 90%;
        max-width: 1100px;
        background: #fff;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 25px 50px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { from { transform: scale(0.95) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

    /* ä¸»å¡ç‰‡æ ·å¼ */
    .ios-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 0;
        margin-bottom: 30px;
        overflow: hidden;
    }

    .ios-card-header {
        padding: 20px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #f2f2f7;
    }

    .ios-card-title {
        font-size: 18px;
        font-weight: 700;
        color: #1d1d1f;
    }

    /* è¡¨æ ¼æ ·å¼ */
    .clean-table {
        width: 100%;
        border-collapse: collapse;
    }

    .clean-table th {
        text-align: left;
        padding: 14px 24px;
        font-size: 12px;
        font-weight: 600;
        color: #86868b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #fff;
        border-bottom: 1px solid #e5e5ea;
    }

    .clean-table td {
        padding: 16px 24px;
        vertical-align: middle;
        font-size: 14px;
        color: #1d1d1f;
        border-bottom: 1px solid #f2f2f7;
    }

    .clean-table tr:last-child td {
        border-bottom: none;
    }

    .clean-table tr:hover {
        background-color: #fbfbfd;
    }

    /* iOS æŒ‰é’® */
    .btn-ios {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        color: white;
    }

    .btn-ios:active { transform: scale(0.96); }
    .btn-purple { background: linear-gradient(135deg, #af52de, #9f4bc9); box-shadow: 0 2px 8px rgba(175, 82, 222, 0.3); }
    .btn-green { background: #34c759; box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3); }
    .btn-blue { background: #007aff; box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3); }
    .btn-red { background: #ff3b30; box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3); }

    /* æ¨¡æ€æ¡†é€šç”¨æ ·å¼ */
    .ios-modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    .ios-modal-overlay.open { opacity: 1; visibility: visible; }

    .ios-modal {
        background: #fff;
        width: 500px;
        max-width: 90%;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }
    .ios-modal-overlay.open .ios-modal { transform: scale(1); }

    .ios-modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid #f2f2f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .ios-modal-title { font-size: 17px; font-weight: 600; color: #000; }
    .ios-modal-close { cursor: pointer; color: #8e8e93; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: #f2f2f7; border-radius: 50%; transition: background 0.2s; }
    .ios-modal-close:hover { background: #e5e5ea; color: #000; }

    .ios-modal-body { padding: 20px; overflow-y: auto; }

    /* è¡¨å•æ§ä»¶ */
    .ios-form-group { display: flex; flex-direction: column; gap: 15px; }
    .ios-label { font-size: 12px; color: #86868b; font-weight: 600; margin-bottom: 6px; display: block; }
    .ios-input {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        background: #f2f2f7;
        border: none;
        border-radius: 10px;
        color: #1d1d1f;
        box-sizing: border-box;
        transition: background 0.2s;
    }
    .ios-input:focus { background: #e5e5ea; outline: none; }
    .ios-input[readonly], .ios-input:disabled { color: #8e8e93; cursor: default; }

    /* æœç´¢æ¡ç»„ä»¶ */
    .ios-search-bar {
        display: flex;
        align-items: center;
        background: #f2f2f7;
        border-radius: 10px;
        padding: 4px 6px 4px 12px;
        transition: all 0.2s;
    }
    .ios-search-bar:focus-within { background: #e5e5ea; }
    .ios-search-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 8px 0;
        font-size: 14px;
        outline: none;
    }
    .search-btn {
        background: #007aff;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
    }

</style>
{% endblock %}

{% block content %}

{% if new_book_map %}
<div class="success-modal" id="successModal">
    <div class="success-box">
        <div style="padding: 24px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 44px; height: 44px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check" style="color:#16a34a; font-size: 20px;"></i>
                </div>
                <div>
                    <div style="font-size: 20px; font-weight: 700; color: #1d1d1f;">å…¥åº“æˆåŠŸ</div>
                    <div style="color: #86868b; font-size: 14px; margin-top: 2px;">{{ new_book_map.book_name }}</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 11px; color: #86868b; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Call Number</div>
                <div style="font-family: 'SF Mono', monospace; font-size: 28px; font-weight: 700; color: #007aff;">{{ new_book_map.call_no }}</div>
            </div>
        </div>

        <div style="padding: 0; background: #fafafa; flex: 1;">
            {{ map_widget.render_map(new_book_map, container_height="550px") }}
        </div>

        <div style="padding: 20px 30px; text-align: right; background: white; border-top: 1px solid #eee;">
            <button class="btn-ios btn-blue" style="padding: 10px 24px; font-size: 15px;" onclick="document.getElementById('successModal').style.display='none'">
                å®Œæˆ (Done)
            </button>
        </div>
    </div>
</div>
{% endif %}

<div class="ios-card">
    <div class="ios-card-header">
        <div class="ios-card-title">å¾…éªŒæ”¶è®¢å•æ˜ç»†</div>
        <button class="btn-ios btn-purple" onclick="openPerModal()">
            <i class="fas fa-newspaper"></i> æ— è®¢å•æœŸåˆŠå…¥åº“
        </button>
    </div>

    <table class="clean-table">
        <thead>
            <tr>
                <th style="width: 120px;">è®¢å•å·</th>
                <th>å†…å®¹ & æ•°é‡</th>
                <th style="width: 100px;">ç±»å‹</th>
                <th>å‡ºç‰ˆç¤¾</th>
                <th style="width: 220px; text-align: right;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for item in orders %}
            <tr>
                <td style="font-family: 'SF Mono', monospace; color: #666;">#{{ item['ORDER_NO'] }}</td>
                <td>
                    <div style="font-weight: 600; color: #1d1d1f;">{{ item['BOOK_NAME'] }}</div>
                    <div style="font-size: 12px; color: #86868b; margin-top: 2px;">æ•°é‡: x{{ item['QUANTITY'] }}</div>
                </td>
                <td>
                    {% if item['ITEM_TYPE'] == 'periodical' %}
                    <span style="font-size:11px; background:#f3e8ff; color:#7e22ce; padding:4px 8px; border-radius:6px; font-weight:600;">æœŸåˆŠ</span>
                    {% else %}
                    <span style="font-size:11px; background:#dbeafe; color:#1d4ed8; padding:4px 8px; border-radius:6px; font-weight:600;">å›¾ä¹¦</span>
                    {% endif %}
                </td>
                <td>{{ item['PUBLISHER'] }}</td>
                <td style="text-align: right;">
                    {% if item['ITEM_TYPE'] == 'periodical' %}
                        <button class="btn-ios btn-purple"
                                data-id="{{ item.LINE_ID }}" data-title="{{ item.BOOK_NAME }}" data-issn="{{ item.ISBN }}" data-pub="{{ item.PUBLISHER }}"
                                onclick="openOrderPerModal(this)">
                            éªŒæ”¶æœŸåˆŠ
                        </button>
                    {% else %}
                        <button class="btn-ios btn-green"
                                data-id="{{ item.LINE_ID }}" data-name="{{ item.BOOK_NAME }}" data-isbn="{{ item.ISBN }}" data-author="{{ item.AUTHOR }}"
                                onclick="openCatalogModal(this)">
                            éªŒæ”¶ç¼–ç›®
                        </button>
                    {% endif %}
                    <button class="btn-ios btn-red" style="margin-left: 6px;" onclick="openReturnModal('{{ item.LINE_ID }}', '{{ item.BOOK_NAME }}')">é€€è´§</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align:center; padding: 40px; color: #999;">
                    <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 10px; opacity: 0.3;"></i><br>
                    å½“å‰æ²¡æœ‰å¾…éªŒæ”¶çš„è®¢å•
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="ios-modal-overlay" id="catalogModal">
    <div class="ios-modal">
        <div class="ios-modal-header">
            <div class="ios-modal-title"><i class="fas fa-book" style="color:#007aff; margin-right:8px;"></i>å›¾ä¹¦ç¼–ç›®</div>
            <div class="ios-modal-close" onclick="closeModal('catalogModal')"><i class="fas fa-times"></i></div>
        </div>
        <div class="ios-modal-body">
            <form method="POST" class="ios-form-group">
                <input type="hidden" name="action" value="accept">
                <input type="hidden" name="line_id" id="modal_line_id">

                <div style="margin-bottom: 10px;">
                    <label class="ios-label">æ™ºèƒ½è¯†åˆ« (ISBN / ä¹¦å)</label>
                    <div class="ios-search-bar">
                        <i class="fas fa-search" style="color:#999; margin-right:8px;"></i>
                        <input type="text" id="smart_search_input" class="ios-search-input" placeholder="è¾“å…¥ä¹¦åæˆ–ISBNè‡ªåŠ¨æŸ¥æ‰¾..." autocomplete="off">
                        <button type="button" class="search-btn" onclick="searchCatalogInfo()">æŸ¥æ‰¾</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label class="ios-label">å›¾ä¹¦åç§°</label>
                        <input type="text" id="modal_book_name" class="ios-input" readonly>
                    </div>
                    <div>
                        <label class="ios-label">ISBN *</label>
                        <input type="text" name="isbn" id="modal_isbn" class="ios-input" required>
                    </div>
                </div>

                <div>
                    <label class="ios-label">ä½œè€…</label>
                    <input type="text" name="author" id="modal_author" class="ios-input" required>
                </div>

                <div>
                    <label class="ios-label">ä¸­å›¾åˆ†ç±»å· (CLC) *</label>
                    <div style="position: relative;">
                        <select name="clc_code" class="ios-input" required style="appearance: none; cursor: pointer;">
                            <option value="">è¯·é€‰æ‹©åˆ†ç±»...</option>
                            {% for code, name in clc_data.items() %}
                            <option value="{{ code }}">{{ code }} - {{ name }}</option>
                            {% endfor %}
                        </select>
                        <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 12px; color: #8e8e93; font-size: 12px; pointer-events: none;"></i>
                    </div>
                </div>

                <div style="margin-top: 10px; text-align: right;">
                    <button type="submit" class="btn-ios btn-blue" style="width: 100%; height: 44px; font-size: 15px;">ç¡®è®¤å…¥åº“</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="ios-modal-overlay" id="perModal">
    <div class="ios-modal">
        <div class="ios-modal-header">
            <div class="ios-modal-title"><i class="fas fa-newspaper" style="color:#af52de; margin-right:8px;"></i>æ— è®¢å•æœŸåˆŠå…¥åº“</div>
            <div class="ios-modal-close" onclick="closeModal('perModal')"><i class="fas fa-times"></i></div>
        </div>
        <div class="ios-modal-body">
            <form method="POST" class="ios-form-group" onsubmit="return validatePeriodicalIssue('per_issue_input')">
                <input type="hidden" name="action" value="periodical_entry">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label class="ios-label">ISSN *</label>
                        <input type="text" name="issn" class="ios-input" required placeholder="xxxx-xxxx"
                               pattern="^\d{4}-\d{4}$"
                               title="ISSN æ ¼å¼å¿…é¡»ä¸º xxxx-xxxx (ä¾‹å¦‚: 1001-2026)">
                    </div>
                    <div><label class="ios-label">åˆŠå *</label><input type="text" name="title" class="ios-input" required></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label class="ios-label">å‡ºç‰ˆé¢‘ç‡</label>
                        <div style="position: relative;">
                            <select name="frequency" class="ios-input" style="appearance: none;">
                                <option value="æœˆåˆŠ">æœˆåˆŠ</option>
                                <option value="åŠæœˆåˆŠ">åŠæœˆåˆŠ</option>
                                <option value="å­£åˆŠ">å­£åˆŠ</option>
                                <option value="æ—¬åˆŠ">æ—¬åˆŠ</option>
                            </select>
                            <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 12px; color: #8e8e93; font-size: 12px; pointer-events: none;"></i>
                        </div>
                    </div>
                    <div>
                        <label class="ios-label">å¹´å·æœŸ *</label>
                        <input type="text" id="per_issue_input" name="issue" class="ios-input" placeholder="ä¾‹å¦‚: 2026å¹´ç¬¬1æœŸ" required>
                    </div>
                </div>

                <div>
                    <label class="ios-label">åˆ†ç±» *</label>
                    <div style="position: relative;">
                        <select name="clc" class="ios-input" required style="appearance: none;">
                            {% for code, name in clc_data.items() %}<option value="{{ code }}">{{ code }} - {{ name }}</option>{% endfor %}
                        </select>
                        <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 12px; color: #8e8e93; font-size: 12px; pointer-events: none;"></i>
                    </div>
                </div>

                <div><label class="ios-label">å‡ºç‰ˆç¤¾</label><input type="text" name="publisher" class="ios-input"></div>

                <div style="margin-top: 10px;">
                    <button type="submit" class="btn-ios btn-purple" style="width: 100%; height: 44px; font-size: 15px;">ç›´æ¥å…¥åº“</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="ios-modal-overlay" id="orderPerModal">
    <div class="ios-modal">
        <div class="ios-modal-header">
            <div class="ios-modal-title"><i class="fas fa-check-double" style="color:#af52de; margin-right:8px;"></i>æœŸåˆŠè®¢å•éªŒæ”¶</div>
            <div class="ios-modal-close" onclick="closeModal('orderPerModal')"><i class="fas fa-times"></i></div>
        </div>
        <div class="ios-modal-body">
            <form method="POST" class="ios-form-group">
                <input type="hidden" name="action" value="accept_periodical_order">
                <input type="hidden" name="line_id" id="op_line_id">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label class="ios-label">ISSN</label><input type="text" name="issn" id="op_issn" class="ios-input" required></div>
                    <div><label class="ios-label">åˆŠå</label><input type="text" name="title" id="op_title" class="ios-input" required></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label class="ios-label">å‡ºç‰ˆé¢‘ç‡</label>
                        <div style="position: relative;">
                            <select name="frequency" class="ios-input" style="appearance: none;">
                                <option value="æœˆåˆŠ">æœˆåˆŠ</option>
                                <option value="åŠæœˆåˆŠ">åŠæœˆåˆŠ</option>
                                <option value="å­£åˆŠ">å­£åˆŠ</option>
                                <option value="æ—¬åˆŠ">æ—¬åˆŠ</option>
                            </select>
                            <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 12px; color: #8e8e93; font-size: 12px; pointer-events: none;"></i>
                        </div>
                    </div>
                    <div><label class="ios-label">æœ¬æœŸå·å· *</label><input type="text" name="issue" class="ios-input" required placeholder="ä¾‹: 2026å¹´ç¬¬2æœŸ"></div>
                </div>

                <div>
                    <label class="ios-label">åˆ†ç±» *</label>
                    <div style="position: relative;">
                        <select name="clc_code" class="ios-input" required style="appearance: none;">
                            {% for code, name in clc_data.items() %}<option value="{{ code }}">{{ code }} - {{ name }}</option>{% endfor %}
                        </select>
                        <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 12px; color: #8e8e93; font-size: 12px; pointer-events: none;"></i>
                    </div>
                </div>

                <div><label class="ios-label">å‡ºç‰ˆç¤¾</label><input type="text" name="publisher" id="op_pub" class="ios-input"></div>

                <div style="margin-top: 10px;">
                    <button type="submit" class="btn-ios btn-purple" style="width: 100%; height: 44px; font-size: 15px;">ç¡®è®¤å…¥åº“</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="ios-modal-overlay" id="returnModal">
    <div class="ios-modal" style="width: 450px;">
        <div class="ios-modal-header">
            <div class="ios-modal-title" style="color: #ff3b30;"><i class="fas fa-undo" style="margin-right:8px;"></i>é€€è´§å¤„ç†</div>
            <div class="ios-modal-close" onclick="closeModal('returnModal')"><i class="fas fa-times"></i></div>
        </div>
        <div class="ios-modal-body">
            <form method="POST" class="ios-form-group">
                <input type="hidden" name="action" value="return">
                <input type="hidden" name="line_id" id="return_line_id">

                <div style="background: #fef2f2; padding: 12px; border-radius: 8px; border: 1px solid #fee2e2; color: #b91c1c; font-size: 13px;">
                    å³å°†é€€è´§ï¼š<strong id="return_book_name"></strong>
                </div>

                <div>
                    <label class="ios-label">é€€è´§ç†ç”±</label>
                    <textarea name="return_reason" class="ios-input" rows="4" required placeholder="è¯·è¯¦ç»†è¯´æ˜é€€è´§åŸå› ..." style="resize: none;"></textarea>
                </div>

                <button type="submit" class="btn-ios btn-red" style="width: 100%; height: 44px; font-size: 15px;">ç¡®è®¤é€€è´§</button>
            </form>
        </div>
    </div>
</div>

<script>
    function openCatalogModal(btn) {
        document.getElementById('catalogModal').classList.add('open');
        document.getElementById('modal_line_id').value = btn.getAttribute('data-id');
        document.getElementById('modal_book_name').value = btn.getAttribute('data-name');
        document.getElementById('smart_search_input').value = btn.getAttribute('data-name');
        document.getElementById('modal_isbn').value = btn.getAttribute('data-isbn') !== 'None' ? btn.getAttribute('data-isbn') : '';
        document.getElementById('modal_author').value = btn.getAttribute('data-author');
    }

    function openOrderPerModal(btn) {
        document.getElementById('orderPerModal').classList.add('open');
        document.getElementById('op_line_id').value = btn.getAttribute('data-id');
        document.getElementById('op_title').value = btn.getAttribute('data-title');
        document.getElementById('op_issn').value = btn.getAttribute('data-issn') !== 'None' ? btn.getAttribute('data-issn') : '';
        document.getElementById('op_pub').value = btn.getAttribute('data-pub') !== 'None' ? btn.getAttribute('data-pub') : '';
    }

    function openReturnModal(id, name) {
        document.getElementById('return_line_id').value = id;
        document.getElementById('return_book_name').innerText = name;
        document.getElementById('returnModal').classList.add('open');
    }

    function openPerModal() { document.getElementById('perModal').classList.add('open'); }

    function closeModal(id) { document.getElementById(id).classList.remove('open'); }

    // ç‚¹å‡»é®ç½©å±‚å…³é—­æ¨¡æ€æ¡†
    document.querySelectorAll('.ios-modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('open');
            }
        });
    });

    // æ™ºèƒ½ç¼–ç›®æœç´¢
    async function searchCatalogInfo() {
        const query = document.getElementById('smart_search_input').value.trim();
        const btn = document.querySelector('#catalogModal .search-btn');
        if(!query) return;

        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        try {
            const res = await fetch("{{ url_for('acq.search_online') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query: query})
            });
            const data = await res.json();

            btn.innerHTML = originalText;
            btn.disabled = false;
            if (data.success && data.found) {
                const book = data.results[0];
                document.getElementById('modal_isbn').value = book.isbn || '';
                document.getElementById('modal_author').value = book.author || '';
            } else {
                alert('æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯');
            }
        } catch(e) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            console.error(e);
        }
    }

    // --- [æ–°å¢é€»è¾‘] æœŸåˆŠå¹´å·æœŸæ ¼å¼æ ¡éªŒ ---
    function validatePeriodicalIssue(inputId) {
        const input = document.getElementById(inputId);
        const value = input.value.trim();

        // æ­£åˆ™è¡¨è¾¾å¼: XXXXå¹´ç¬¬XæœŸ
        const regex = /^(\d{4})å¹´ç¬¬(\d+)æœŸ$/;
        const match = value.match(regex);

        if (!match) {
            alert("æ ¼å¼é”™è¯¯ï¼\nè¯·è¾“å…¥ç¬¦åˆè§„èŒƒçš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š2026å¹´ç¬¬1æœŸ\n(è¯·ç¡®ä¿ä½¿ç”¨ä¸­æ–‡â€œå¹´â€å’Œâ€œç¬¬...æœŸâ€)");
            input.focus();
            return false;
        }

        const year = parseInt(match[1], 10);
        const issue = parseInt(match[2], 10);

        // å¹´ä»½æ ¡éªŒ: 1500 - 2026
        if (year < 1500 || year > 2026) {
            alert("å¹´ä»½æ— æ•ˆï¼\nå¹´ä»½å¿…é¡»åœ¨ 1500 åˆ° 2026 ä¹‹é—´ã€‚");
            input.focus();
            return false;
        }

        // æœŸæ•°æ ¡éªŒ: >= 1
        if (issue < 1) {
            alert("æœŸæ•°æ— æ•ˆï¼\næœŸæ•°å¿…é¡»å¤§äºæˆ–ç­‰äº 1ã€‚");
            input.focus();
            return false;
        }

        return true;
    }
</script>
{% endblock %}
```
---

### ğŸ“„ app\templates\acq\order_process.html
```html
{% extends "base.html" %}

{% block page_title %}è®¢å•å¤„ç† / Order Processing{% endblock %}

{% block extra_css %}
<style>
    /* --- æ ¸å¿ƒå®¹å™¨ä¸å¸ƒå±€ --- */
    .full-width-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 25px;
        margin-bottom: 30px;
        width: 100%;
        box-sizing: border-box;
    }

    /* --- iOS åˆ†æ®µæ§åˆ¶å™¨ (Segmented Control) --- */
    .ios-segmented-control {
        display: flex;
        background: #e5e5ea;
        padding: 4px;
        border-radius: 12px;
        position: relative;
        width: 100%;
        max-width: 400px;
        margin: 0 auto 25px auto;
        user-select: none;
    }

    .segment-btn {
        flex: 1;
        text-align: center;
        padding: 8px 10px;
        font-size: 14px;
        font-weight: 600;
        color: #8e8e93;
        cursor: pointer;
        z-index: 2;
        transition: color 0.3s ease;
        position: relative;
    }

    .segment-btn.active {
        color: #000;
    }

    .segment-glider {
        position: absolute;
        top: 4px;
        left: 4px;
        height: calc(100% - 8px);
        width: calc(50% - 4px);
        background: #fff;
        border-radius: 9px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 0 1px rgba(0,0,0,0.05);
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        z-index: 1;
    }

    /* --- Tab å†…å®¹åˆ‡æ¢åŠ¨ç”» --- */
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
    }
    .tab-content.active {
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- è¡¨æ ¼ä¸è¾“å…¥æ¡†ä¼˜åŒ– --- */
    .clean-table {
        width: 100%;
        border-collapse: collapse;
    }
    .clean-table th {
        font-size: 12px;
        font-weight: 600;
        color: #86868b;
        text-align: left;
        padding: 12px 15px;
        border-bottom: 1px solid #e5e5ea;
        white-space: nowrap;
    }
    .clean-table td {
        padding: 12px 15px;
        font-size: 14px;
        color: #1d1d1f;
        border-bottom: 1px solid #f2f2f7;
        vertical-align: middle;
    }
    .clean-table tr:last-child td {
        border-bottom: none;
    }
    .clean-table tr:hover td {
        background-color: #fbfbfd;
    }

    /* è¡¨æ ¼å†…çš„æ•°é‡è¾“å…¥æ¡† */
    .qty-input {
        width: 60px;
        padding: 6px;
        border: none;
        background: #f2f2f7;
        border-radius: 8px;
        text-align: center;
        font-size: 14px;
        font-weight: 600;
        color: #1d1d1f;
        transition: all 0.2s;
    }
    .qty-input:focus {
        background: #fff;
        box-shadow: 0 0 0 2px #007aff;
        outline: none;
    }

    /* å¤é€‰æ¡†æ ·å¼ */
    input[type="checkbox"] {
        accent-color: #007aff;
        width: 16px;
        height: 16px;
        cursor: pointer;
    }

    /* --- Modal ç‰¹æ®Šæ ·å¼ --- */
    .ios-modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .ios-modal-overlay.open {
        display: flex;
        opacity: 1;
    }
    .ios-modal {
        background: #fff;
        width: 500px;
        max-width: 90%;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        transform: scale(0.95);
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        overflow: visible; /* å…è®¸ä¸‹æ‹‰æ¡†æº¢å‡º */
    }
    .ios-modal-overlay.open .ios-modal {
        transform: scale(1);
    }

    .ios-modal-header {
        padding: 20px;
        border-bottom: 1px solid #f2f2f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .ios-modal-title {
        font-size: 18px;
        font-weight: 700;
    }
    .ios-modal-close {
        cursor: pointer;
        color: #86868b;
        font-size: 20px;
        transition: color 0.2s;
    }
    .ios-modal-close:hover { color: #1d1d1f; }

    /* Modal å†…çš„è¾“å…¥æ¡† */
    .modal-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e5ea;
        border-radius: 10px;
        font-size: 14px;
        box-sizing: border-box;
        margin-bottom: 0;
    }
    .modal-input:focus {
        border-color: #007aff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    /* èåˆå¼æœç´¢æ  */
    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        background: #fff;
        border-radius: 10px;
        border: 1px solid #e5e5ea;
        padding: 2px;
    }
    .search-input-wrapper:focus-within {
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    .search-input-wrapper input {
        border: none !important;
        background: transparent !important;
        box-shadow: none !important;
        margin: 0 !important;
        padding: 10px 12px !important;
        flex: 1;
        outline: none;
        font-size: 14px;
    }

    /* æŸ¥æ‰¾æŒ‰é’® */
    .btn-search-sm {
        height: 32px;
        padding: 0 16px;
        background: #34c759;
        color: white;
        border-radius: 8px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex; align-items: center; gap: 6px;
        margin-right: 4px;
        transition: opacity 0.2s;
    }
    .btn-search-sm:hover { opacity: 0.9; }

    /* æœç´¢ä¸‹æ‹‰ç»“æœ */
    .dropdown-results {
        position: absolute;
        top: 110%; left: 0; right: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        border: 1px solid rgba(0,0,0,0.05);
        z-index: 2000;
        max-height: 280px;
        overflow-y: auto;
        display: none;
        padding: 6px;
    }
    .dd-item {
        padding: 10px;
        display: flex; gap: 12px;
        align-items: center;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .dd-item:hover { background: #f2f2f7; }

    /* åº•éƒ¨æ“ä½œæŒ‰é’®æ  */
    .action-bar {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #f2f2f7;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn-reject {
        background: #fff;
        border: 1px solid #ef4444;
        color: #ef4444;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-reject:hover { background: #fef2f2; }

    .btn-approve {
        background: #007aff;
        border: none;
        color: white;
        padding: 10px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 122, 255, 0.3);
        transition: all 0.2s;
    }
    .btn-approve:hover { background: #0062cc; }

</style>
{% endblock %}

{% block content %}
<div class="full-width-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div style="font-size: 22px; font-weight: 700; color: #1d1d1f;">è®¢å•å¤„ç†</div>

        <button onclick="openManualOrderModal()" class="btn-glow" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 10px 20px; border-radius: 20px; font-size: 14px;">
            <i class="fas fa-plus-circle" style="margin-right: 6px;"></i> æ‰‹å·¥æ·»åŠ è®¢å•
        </button>
    </div>

    <div class="ios-segmented-control">
        <div class="segment-glider" id="glider"></div>
        <div class="segment-btn active" onclick="switchTab('book')">å›¾ä¹¦</div>
        <div class="segment-btn" onclick="switchTab('periodical')">æœŸåˆŠ</div>
    </div>

    <div id="tab-book" class="tab-content active">
        <form method="POST">
            <input type="hidden" name="target_type" value="book">
            <div class="table-scroll-area">
                <table class="clean-table">
                    <thead>
                        <tr>
                            <th width="50" style="padding-left: 20px;">é€‰æ‹©</th>
                            <th>å›¾ä¹¦ä¿¡æ¯</th>
                            <th>ISBN ç¼–ç </th>
                            <th>ç”³è¯·äºº</th>
                            <th width="120" style="text-align: center;">é‡‡è´­æ•°é‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in pending_books %}
                        <tr>
                            <td style="padding-left: 20px;">
                                <input type="checkbox" name="selected_ids" value="{{ item['ACQ_ID'] }}">
                            </td>
                            <td>
                                <div style="font-weight: 600;">{{ item['BOOK_NAME'] }}</div>
                                <span style="font-size:10px; background:#dbeafe; color:#1e40af; padding:2px 6px; border-radius:4px; font-weight: 600; margin-top: 4px; display: inline-block; border: 1px solid #bfdbfe;">å›¾ä¹¦</span>
                            </td>
                            <td>
                                <span style="font-family: monospace; color: #666; background: #f2f2f7; padding: 2px 6px; border-radius: 4px;">{{ item['ISBN'] }}</span>
                            </td>
                            <td>
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 24px; height: 24px; background: #e0f2fe; color: #0284c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 8px;">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    {{ item['READER_NAME'] }}
                                </div>
                            </td>
                            <td style="text-align: center;">
                                <input type="number" name="qty_book_{{ item['ACQ_ID'] }}" value="1" min="1" class="qty-input">
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" style="text-align:center; padding: 40px; color: #999;">
                                <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px; color: #d1d1d6;"></i><br>
                                ç›®å‰æ²¡æœ‰å¾…å¤„ç†çš„å›¾ä¹¦èè´­
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if pending_books %}
            <div class="action-bar">
                <button type="submit" name="action" value="reject" class="btn-reject">
                    <i class="fas fa-times-circle" style="margin-right: 5px;"></i> é©³å›ç”³è¯·
                </button>
                <button type="submit" name="action" value="create_order" class="btn-approve">
                    ç”Ÿæˆå›¾ä¹¦è®¢å• <i class="fas fa-arrow-right" style="margin-left: 5px;"></i>
                </button>
            </div>
            {% endif %}
        </form>
    </div>

    <div id="tab-periodical" class="tab-content">
        <form method="POST">
            <input type="hidden" name="target_type" value="periodical">
            <div class="table-scroll-area">
                <table class="clean-table">
                    <thead>
                        <tr>
                            <th width="50" style="padding-left: 20px;">é€‰æ‹©</th>
                            <th>æœŸåˆŠåç§°</th>
                            <th>ISSN åˆŠå·</th>
                            <th>ç”³è¯·äºº</th>
                            <th width="120" style="text-align: center;">è®¢é˜…ä»½æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in pending_pers %}
                        <tr>
                            <td style="padding-left: 20px;">
                                <input type="checkbox" name="selected_ids" value="{{ item['SUG_ID'] }}">
                            </td>
                            <td>
                                <div style="font-weight: 600;">{{ item['TITLE'] }}</div>
                                <span style="font-size:10px; background:#f3e8ff; color:#7e22ce; padding:2px 6px; border-radius:4px; font-weight: 600; margin-top: 4px; display: inline-block; border: 1px solid #e9d5ff;">æœŸåˆŠ</span>
                            </td>
                            <td>
                                <span style="font-family: monospace; color: #666; background: #f2f2f7; padding: 2px 6px; border-radius: 4px;">{{ item['ISSN'] }}</span>
                            </td>
                            <td>
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 24px; height: 24px; background: #f3e8ff; color: #7e22ce; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 8px;">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    {{ item['READER_NAME'] }}
                                </div>
                            </td>
                            <td style="text-align: center;">
                                <input type="number" name="qty_per_{{ item['SUG_ID'] }}" value="1" min="1" class="qty-input">
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" style="text-align:center; padding: 40px; color: #999;">
                                <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px; color: #d1d1d6;"></i><br>
                                ç›®å‰æ²¡æœ‰å¾…å¤„ç†çš„æœŸåˆŠèè´­
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if pending_pers %}
            <div class="action-bar">
                <button type="submit" name="action" value="reject" class="btn-reject">
                    <i class="fas fa-times-circle" style="margin-right: 5px;"></i> é©³å›ç”³è¯·
                </button>
                <button type="submit" name="action" value="create_order" class="btn-approve" style="background: linear-gradient(135deg, #a855f7, #9333ea);">
                    ç”ŸæˆæœŸåˆŠè®¢å• <i class="fas fa-arrow-right" style="margin-left: 5px;"></i>
                </button>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<div class="ios-modal-overlay" id="manualOrderModal">
    <div class="ios-modal">
        <div class="ios-modal-header">
            <div class="ios-modal-title">æ‰‹å·¥å½•å…¥è®¢å•</div>
            <div class="ios-modal-close" onclick="closeModal('manualOrderModal')"><i class="fas fa-times"></i></div>
        </div>
        <div class="ios-modal-body" style="padding: 25px;">
            <form method="POST" style="margin: 0;">
                <input type="hidden" name="action" value="manual_add">

                <div style="margin-bottom: 20px;">
                    <label style="font-size:12px; color:#666; font-weight:600; margin-bottom: 8px; display:block;">å›¾ä¹¦åç§°</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="manual_book_name" name="book_name" required placeholder="è¾“å…¥ä¹¦åæœç´¢..." autocomplete="off">
                        <button type="button" onclick="searchBookByTitle()" class="btn-search-sm">
                            <i class="fas fa-search"></i> æŸ¥æ‰¾
                        </button>
                        <div id="searchResults" class="dropdown-results"></div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
    <label style="font-size:12px; color:#666; font-weight:600; margin-bottom: 8px; display:block;">ISBN ç¼–ç </label>
    <input type="text" id="manual_isbn" name="isbn" class="modal-input" placeholder="è¯·è¾“å…¥13ä½ ISBN"
           maxlength="13" minlength="13"
           pattern="^\d{13}$"
           oninput="this.value=this.value.replace(/\D/g,'')"
           title="è¯·è¾“å…¥13ä½çº¯æ•°å­—ISBN" required>
</div>

                <div style="display:flex; gap:15px; margin-bottom: 20px;">
                    <div style="flex:1;">
                        <label style="font-size:12px; color:#666; font-weight:600; margin-bottom: 8px; display:block;">ä½œè€…</label>
                        <input type="text" id="manual_author" name="author" class="modal-input" required>
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:12px; color:#666; font-weight:600; margin-bottom: 8px; display:block;">å‡ºç‰ˆç¤¾</label>
                        <input type="text" id="manual_publisher" name="publisher" class="modal-input">
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <label style="font-size:12px; color:#666; font-weight:600; margin-bottom: 8px; display:block;">é‡‡è´­æ•°é‡</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" name="quantity" class="modal-input" value="1" min="1" style="width: 100px;">
                        <span style="font-size:14px; color:#86868b;">å†Œ</span>
                    </div>
                </div>

                <button type="submit" class="btn-approve" style="width: 100%; padding: 12px; font-size: 15px; justify-content: center; display: flex;">
                    <i class="fas fa-check-circle" style="margin-right: 8px;"></i> ç¡®è®¤åˆ›å»ºé‡‡è´­å•
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // --- Tab åˆ‡æ¢é€»è¾‘ (é€‚é… Segmented Control) ---
    function switchTab(type) {
        // 1. åˆ‡æ¢æŒ‰é’®è§†è§‰
        const btns = document.querySelectorAll('.segment-btn');
        const glider = document.getElementById('glider');
        btns.forEach(b => b.classList.remove('active'));

        if(type === 'book') {
            btns[0].classList.add('active');
            glider.style.transform = 'translateX(0)';
        } else {
            btns[1].classList.add('active');
            glider.style.transform = 'translateX(100%)';
        }

        // 2. åˆ‡æ¢å†…å®¹åŒºåŸŸ
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + type).classList.add('active');
    }

    // --- Modal é€»è¾‘ ---
    function openManualOrderModal() {
        document.getElementById('manualOrderModal').classList.add('open');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('open');
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('manualOrderModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal('manualOrderModal');
        }
    });

    // --- ä¹¦ååæŸ¥ ISBN é€»è¾‘ (AJAX) ---
    async function searchBookByTitle() {
        const query = document.getElementById('manual_book_name').value.trim();
        const resultsBox = document.getElementById('searchResults');
        const btn = document.querySelector('.btn-search-sm');

        if (!query) { alert('è¯·å…ˆè¾“å…¥ä¹¦å'); return; }

        // Loading çŠ¶æ€
        const originalBtnHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­';
        btn.style.opacity = '0.7';

        resultsBox.style.display = 'block';
        resultsBox.innerHTML = '<div style="padding:15px; text-align:center; color:#86868b; font-size:12px;">æ­£åœ¨è¿æ¥æ•°æ®åº“...</div>';

        try {
            const res = await fetch("{{ url_for('acq.search_online') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query: query})
            });
            const data = await res.json();

            // æ¢å¤æŒ‰é’®
            btn.innerHTML = '<i class="fas fa-search"></i> æŸ¥æ‰¾';
            btn.style.opacity = '1';

            if (data.success && data.found) {
                let html = '';
                data.results.forEach(book => {
                    // è½¬ä¹‰ JSON ä»¥é˜²å¼•å·ç ´å HTML
                    const safeBook = JSON.stringify(book).replace(/"/g, '&quot;');

                    // å°é¢å¤„ç† (å¦‚æœæœ‰)
                    let coverHtml = '';
                    if (book.cover) {
                        coverHtml = `<img src="${book.cover}" style="width:100%; height:100%; object-fit:cover;">`;
                    } else {
                        coverHtml = `<i class="fas fa-book" style="color:#ccc; font-size:14px;"></i>`;
                    }

                    html += `
                    <div class="dd-item" onclick="selectBook(${safeBook})">
                        <div style="width:32px; height:44px; background:#f2f2f7; border-radius:4px; flex-shrink:0; overflow:hidden; display:flex; align-items:center; justify-content:center;">
                            ${coverHtml}
                        </div>
                        <div style="flex:1; overflow:hidden;">
                            <div style="font-weight:600; font-size:13px; color:#1d1d1f; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${book.title}</div>
                            <div style="font-size:11px; color:#86868b;">${book.author}</div>
                        </div>
                        <div style="font-size:11px; color:#007aff; background:#f0f9ff; padding:2px 6px; border-radius:4px;">é€‰æ‹©</div>
                    </div>
                    `;
                });
                resultsBox.innerHTML = html;
            } else {
                resultsBox.innerHTML = '<div style="padding:15px; text-align:center; color:#86868b; font-size:12px;">æœªæ‰¾åˆ°ç›¸å…³ä¹¦ç±ï¼Œè¯·æ£€æŸ¥ä¹¦å</div>';
                setTimeout(() => resultsBox.style.display = 'none', 3000);
            }
        } catch (e) {
            btn.innerHTML = originalBtnHtml;
            btn.style.opacity = '1';
            resultsBox.innerHTML = '<div style="padding:15px; text-align:center; color:#ef4444; font-size:12px;">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</div>';
        }
    }

    // é€‰ä¸­å›¾ä¹¦å›å¡«
    function selectBook(book) {
        document.getElementById('manual_book_name').value = book.title;
        document.getElementById('manual_isbn').value = book.isbn || '';
        document.getElementById('manual_author').value = book.author || '';
        document.getElementById('manual_publisher').value = book.publisher || '';
        document.getElementById('searchResults').style.display = 'none';

        // è§†è§‰åé¦ˆ (Flash)
        const inputs = document.querySelectorAll('#manual_isbn, #manual_author, #manual_publisher');
        inputs.forEach(el => {
            el.style.transition = 'background 0.3s';
            el.style.background = '#ecfdf5'; // æµ…ç»¿è‰²æç¤º
            setTimeout(() => el.style.background = '#fff', 800);
        });
    }

    // å…¨å±€ç‚¹å‡»å…³é—­ä¸‹æ‹‰æ¡†
    document.addEventListener('click', function(e) {
        const box = document.getElementById('searchResults');
        const wrapper = document.querySelector('.search-input-wrapper');
        if (box && box.style.display === 'block' && !wrapper.contains(e.target)) {
            box.style.display = 'none';
        }
    });
</script>
{% endblock %}
```
---

### ğŸ“„ app\templates\acq\suggestion.html
```html
{% extends "base.html" %}

{% block page_title %}è¯»è€…èè´­ / Suggestion{% endblock %}

{% block extra_css %}
<style>
    /* iOS é£æ ¼åŸºç¡€ç»„ä»¶ */

    /* åˆ†æ®µæ§åˆ¶å™¨ (Segmented Control) */
    .ios-segmented-control {
        display: flex;
        background: #e5e5ea; /* iOS æµ…ç°èƒŒæ™¯ */
        padding: 4px;
        border-radius: 12px;
        position: relative;
        width: 100%;
        max-width: 400px; /* æ§åˆ¶å™¨æœ¬èº«ä¸è¦å¤ªå®½ï¼Œå±…ä¸­æ›´å¥½çœ‹ */
        margin: 0 auto 30px auto;
        user-select: none;
    }

    .segment-btn {
        flex: 1;
        text-align: center;
        padding: 10px;
        font-size: 14px;
        font-weight: 600;
        color: #8e8e93;
        cursor: pointer;
        z-index: 2;
        transition: color 0.3s ease;
        position: relative;
    }

    .segment-btn.active {
        color: #000;
    }

    /* æ»‘åŠ¨æ»‘å—åŠ¨ç”» */
    .segment-glider {
        position: absolute;
        top: 4px;
        left: 4px;
        height: calc(100% - 8px);
        width: calc(50% - 4px);
        background: #fff;
        border-radius: 9px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 0 1px rgba(0,0,0,0.05);
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        z-index: 1;
    }

    /* iOS é£æ ¼è¾“å…¥æ¡† */
    .ios-input {
        width: 100%;
        padding: 12px 14px;
        font-size: 14px;
        line-height: 1.4;
        color: #1d1d1f;
        background-color: #fbfbfd;
        border: 1px solid #d1d1d6;
        border-radius: 10px;
        box-sizing: border-box;
        transition: all 0.2s ease;
    }

    .ios-input:focus {
        background-color: #fff;
        border-color: #007aff;
        outline: none;
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
    }

    .ios-input:disabled {
        background-color: #f2f2f7;
        color: #aeaeb2;
        cursor: not-allowed;
        border-color: #e5e5ea;
    }

    /* è¡¨å•æ·¡å…¥åŠ¨ç”» */
    .form-section {
        display: none;
        animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .form-section.active-section {
        display: grid;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* çŠ¶æ€æ ‡ç­¾ç¾åŒ– */
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }
    .status-pending { background: #fff7ed; color: #f59e0b; border: 1px solid #ffedd5; }
    .status-ordered { background: #ecfdf5; color: #10b981; border: 1px solid #d1fae5; }
    .status-rejected { background: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; }

    /* è¾…åŠ©æ–‡å­— */
    .input-hint {
        font-size: 12px;
        color: #86868b;
        margin-top: 6px;
        margin-left: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card" style="width: 100%; margin: 0 0 30px 0; padding: 30px;">
    <div class="card-header-row" style="justify-content: center; margin-bottom: 25px;">
        <div class="card-title" style="font-size: 20px; font-weight: 700;">æäº¤èè´­ç”³è¯·</div>
    </div>

    <div class="ios-segmented-control">
        <div class="segment-glider" id="glider"></div>
        <div class="segment-btn active" onclick="switchType('book')">å›¾ä¹¦ (Book)</div>
        <div class="segment-btn" onclick="switchType('periodical')">æœŸåˆŠ (Periodical)</div>
    </div>

    <form method="POST" id="suggestionForm">
        <input type="hidden" name="type" id="typeInput" value="book">

        <div id="bookInputs" class="form-section active-section" style="grid-template-columns: 1fr 1fr; gap: 24px;">
            <div style="grid-column: span 2;">
                <label style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block;">å›¾ä¹¦åç§° *</label>
                <input type="text" name="title" placeholder="è¯·è¾“å…¥å›¾ä¹¦å®Œæ•´åç§°" class="ios-input" required>
            </div>

            <div>
                <label style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block;">ä½œè€… / è‘—è€… *</label>
                <input type="text" name="author" placeholder="ä¾‹å¦‚ï¼š[ç¾] å‡¯æ–‡Â·å‡¯åˆ©" class="ios-input" required>
            </div>

            <div>
    <label style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block;">ISBN ä¹¦å·</label>
    <input type="text" name="code" placeholder="è¯·è¾“å…¥13ä½çº¯æ•°å­—" class="ios-input"
           maxlength="13" minlength="13"
           pattern="^\d{13}$"
           title="ISBN å¿…é¡»ä¸º 13 ä½æ•°å­—"
           oninput="this.value=this.value.replace(/\D/g,'')">
</div>

            <div style="grid-column: span 2;">
                <label style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block;">å‡ºç‰ˆç¤¾</label>
                <input type="text" name="publisher" placeholder="ä¾‹å¦‚ï¼šä¸­ä¿¡å‡ºç‰ˆç¤¾ (é€‰å¡«)" class="ios-input">
            </div>
        </div>

        <div id="perInputs" class="form-section" style="grid-template-columns: 1fr 1fr; gap: 24px;">
            <div style="grid-column: span 2;">
                <label style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block;">æœŸåˆŠåç§° *</label>
                <input type="text" name="title" placeholder="è¯·è¾“å…¥æœŸåˆŠä¸­æ–‡æˆ–è‹±æ–‡åç§°" class="ios-input" disabled required>
            </div>

            <div>
    <label style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block;">ISSN åˆŠå· *</label>
    <input type="text" name="code" placeholder="xxxx-xxxx" class="ios-input" disabled required
           pattern="^\d{4}-\d{4}$"
           title="ISSN æ ¼å¼å¿…é¡»ä¸º xxxx-xxxx (ä¾‹å¦‚: 1001-2026)">
</div>

            <div>
                <label style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block;">å‡ºç‰ˆç¤¾ / å‘è¡Œå•ä½</label>
                <input type="text" name="publisher" placeholder="é€‰å¡«" class="ios-input" disabled>
            </div>

            <div style="grid-column: span 2; padding: 12px; background: #f2f2f7; border-radius: 10px; color: #86868b; font-size: 13px; display: flex; align-items: center;">
                <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                æç¤ºï¼šæœŸåˆŠè®¢é˜…é€šå¸¸æŒ‰å¹´é¢„è®¢ï¼Œæäº¤åéœ€ç­‰å¾…ä¸‹ä¸€è®¢é˜…å‘¨æœŸã€‚
            </div>
        </div>

        <div style="margin-top: 30px; text-align: right;">
            <button type="submit" class="btn-glow" style="padding: 12px 30px; width: 100%; font-size: 15px; font-weight: 600;">
                <i class="fas fa-paper-plane" style="margin-right: 6px;"></i> æäº¤ç”³è¯· (Submit)
            </button>
        </div>
    </form>
</div>

<div class="card" style="width: 100%; margin-top: 24px; padding: 0;">
    <div class="card-header-row" style="padding: 20px 25px;">
        <div class="card-title"><i class="fas fa-history" style="color: #007aff; margin-right: 8px;"></i> æˆ‘çš„èè´­å†å²</div>
    </div>
    <div class="table-scroll-area">
        <table class="clean-table" style="width: 100%;">
            <thead>
                <tr>
                    <th style="width: 80px; padding-left: 25px;">ç±»å‹</th>
                    <th>åç§° & ç¼–ç </th>
                    <th>è¯¦ç»†ä¿¡æ¯</th>
                    <th style="text-align: right; padding-right: 25px;">çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody>
                {% for item in history %}
                <tr>
                    <td style="padding-left: 25px;">
                        {% if item['TYPE'] == 'periodical' %}
                        <span style="font-size:11px; background:#f3e8ff; color:#7e22ce; padding:3px 8px; border-radius:6px; font-weight:600;">æœŸåˆŠ</span>
                        {% else %}
                        <span style="font-size:11px; background:#dbeafe; color:#1d4ed8; padding:3px 8px; border-radius:6px; font-weight:600;">å›¾ä¹¦</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="font-weight: 600; color: #1d1d1f; font-size: 14px;">{{ item['TITLE'] }}</div>
                        <div style="font-size: 12px; color: #86868b; margin-top: 2px; font-family: monospace;">{{ item['CODE'] if item['CODE'] else 'æ— ç¼–ç ' }}</div>
                    </td>
                    <td>
                        <div style="font-size: 13px; color: #333;">{{ item['SUB'] }}</div>
                    </td>
                    <td style="text-align: right; padding-right: 25px;">
                        {% if item['STATUS'] == 0 %}
                        <span class="status-badge status-pending"><i class="fas fa-clock"></i> å¤„ç†ä¸­</span>
                        {% elif item['STATUS'] == 1 %}
                        <span class="status-badge status-ordered"><i class="fas fa-check"></i> å·²è®¢è´­</span>
                        {% else %}
                        <span class="status-badge status-rejected"><i class="fas fa-times"></i> å·²é©³å›</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" style="text-align:center; padding: 40px; color: #999;">
                        <i class="far fa-folder-open" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i><br>
                        æš‚æ— èè´­è®°å½•
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function switchType(type) {
        const btns = document.querySelectorAll('.segment-btn');
        const glider = document.getElementById('glider');

        btns.forEach(btn => btn.classList.remove('active'));

        if (type === 'book') {
            btns[0].classList.add('active');
            glider.style.transform = 'translateX(0)';
        } else {
            btns[1].classList.add('active');
            glider.style.transform = 'translateX(100%)';
        }

        document.getElementById('typeInput').value = type;

        const bookDiv = document.getElementById('bookInputs');
        const perDiv = document.getElementById('perInputs');

        if (type === 'periodical') {
            bookDiv.classList.remove('active-section');
            perDiv.classList.add('active-section');
            toggleInputs(bookDiv, true);
            toggleInputs(perDiv, false);
        } else {
            perDiv.classList.remove('active-section');
            bookDiv.classList.add('active-section');
            toggleInputs(perDiv, true);
            toggleInputs(bookDiv, false);
        }
    }

    function toggleInputs(container, isDisabled) {
        const inputs = container.querySelectorAll('input');
        inputs.forEach(input => {
            input.disabled = isDisabled;
        });
    }

    window.addEventListener('load', () => {
        switchType('book');
    });
</script>
{% endblock %}
```
---

### ğŸ“„ app\templates\admin\access_config.html
```html
{% extends "base.html" %}
{% block page_title %}æƒé™ä¸è§„åˆ™é…ç½® / Access Control{% endblock %}

{% block content %}
<style>
    .config-card {
        background: white;
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        border: 1px solid rgba(0,0,0,0.03);
    }
    .config-header {
        font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 20px;
        padding-bottom: 10px; border-bottom: 1px solid #f1f5f9;
        display: flex; align-items: center; justify-content: space-between;
    }
    
    /* Permission Matrix */
    .perm-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .perm-item {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: #334155;
        cursor: pointer;
        transition: background 0.2s;
    }
    .perm-item:hover { background: #fff; border-color: #cbd5e1; }

    /* Role Tabs */
    .role-tabs {
        display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px;
    }
    .role-tab {
        padding: 8px 16px;
        background: #e2e8f0;
        border-radius: 20px;
        font-size: 13px; font-weight: 600; color: #64748b;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
    }
    .role-tab.active {
        background: #3b82f6; color: white; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
    }

    /* Credit Table Input */
    .table-input {
        width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 8px;
        font-size: 13px; text-align: center; color: #1e293b; outline: none;
        background: #f8fafc; transition: all 0.2s;
    }
    .table-input:focus { background: #fff; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    /* Toggle Switch */
    .switch-label {
        position: relative; display: inline-block; width: 40px; height: 22px;
    }
    .switch-label input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #e2e8f0; transition: .4s; border-radius: 34px;
    }
    .slider:before {
        position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px;
        background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    input:checked + .slider { background-color: #10b981; }
    input:checked + .slider:before { transform: translateX(18px); }
</style>

<div class="config-card">
    <div class="config-header">
        <span><i class="fas fa-user-shield" style="color: #f59e0b; margin-right: 8px;"></i> è§’è‰²åŠŸèƒ½æƒé™é…ç½®</span>
    </div>

    <div class="role-tabs">
        {% for role in roles %}
        <div class="role-tab {{ 'active' if loop.first else '' }}" onclick="switchRoleTab({{ role.ROLE_ID }})">
            {{ role.ROLE_NAME }}
        </div>
        {% endfor %}
    </div>

    {% for role in roles %}
    <form method="POST" id="form-role-{{ role.ROLE_ID }}" style="display: {{ 'block' if loop.first else 'none' }};">
        <input type="hidden" name="action" value="save_permissions">
        <input type="hidden" name="role_id" value="{{ role.ROLE_ID }}">

        <div class="perm-grid">
            {% for perm in permissions %}
            <label class="perm-item">
                <input type="checkbox" name="perms" value="{{ perm.PERM_ID }}"
                       {% if perm.PERM_ID in role_perm_map.get(role.ROLE_ID, []) %}checked{% endif %}
                       style="accent-color: #3b82f6; width: 16px; height: 16px; cursor: pointer;">
                <div>
                    <div style="font-weight: 600;">{{ perm.PERM_NAME }}</div>
                    <div style="font-size: 11px; color: #94a3b8; font-family: monospace;">{{ perm.PERM_CODE }}</div>
                </div>
            </label>
            {% endfor %}
        </div>

        <div style="text-align: right; border-top: 1px solid #f1f5f9; padding-top: 15px;">
            <button type="submit" class="btn-glow">ä¿å­˜ {{ role.ROLE_NAME }} æƒé™</button>
        </div>
    </form>
    {% endfor %}
</div>

<div class="config-card">
    <div class="config-header">
        <span><i class="fas fa-sliders-h" style="color: #10b981; margin-right: 8px;"></i> ä¿¡ç”¨ç­‰çº§ä¸å€Ÿé˜…è§„åˆ™</span>
    </div>

    <div style="overflow-x: auto;">
        <table class="clean-table">
            <thead>
                <tr>
                    <th width="120">ç­‰çº§åç§°</th>
                    <th width="100">æœ€ä½ç§¯åˆ†</th>
                    <th width="100">å¯å€Ÿæ•°é‡</th>
                    <th width="100">å€Ÿé˜…å¤©æ•°</th>
                    <th width="80">å…è®¸å€Ÿä¹¦</th>
                    <th width="80">å…è®¸é¢„çº¦</th>
                    <th width="80">å…è®¸å»¶æœŸ</th>
                    <th width="80">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for level in credit_levels %}
                <form method="POST" onsubmit="return validateCreditForm(this)">
                    <input type="hidden" name="action" value="save_credit_rule">
                    <input type="hidden" name="level_id" value="{{ level.LEVEL_ID }}">
                    <tr>
                        <td style="font-weight: 600;">{{ level.NAME }}</td>
                        <td>
                            <input type="number" name="min_score" value="{{ level.MIN_SCORE }}" class="table-input" min="0" required>
                        </td>
                        <td>
                            <input type="number" name="max_num" value="{{ level.MAX_BORROW_NUM }}" class="table-input" min="0" required>
                        </td>
                        <td>
                            <input type="number" name="max_day" value="{{ level.MAX_BORROW_DAY }}" class="table-input" min="0" required>
                        </td>
                        <td>
                            <label class="switch-label">
                                <input type="checkbox" name="can_borrow" {% if level.ENABLE_BORROW %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </td>
                        <td>
                            <label class="switch-label">
                                <input type="checkbox" name="can_reserve" {% if level.ENABLE_RESERVE %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </td>
                        <td>
                            <label class="switch-label">
                                <input type="checkbox" name="can_extend" {% if level.ENABLE_EXTEND %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </td>
                        <td>
                            <button type="submit" class="btn-glow" style="padding: 6px 12px; font-size: 12px; box-shadow:none;">æ›´æ–°</button>
                        </td>
                    </tr>
                </form>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div style="font-size: 12px; color: #64748b; margin-top: 15px; background: #f8fafc; padding: 10px; border-radius: 8px;">
        <i class="fas fa-info-circle"></i> ç³»ç»Ÿè§„åˆ™ï¼šæ ¹æ®ç”¨æˆ·å½“å‰ä¿¡ç”¨åˆ†ï¼Œè‡ªåŠ¨åŒ¹é…æ»¡è¶³â€œæœ€ä½ç§¯åˆ† <= ç”¨æˆ·åˆ†â€æ¡ä»¶ä¸­ï¼Œç§¯åˆ†è¦æ±‚æœ€é«˜çš„é‚£ä¸€æ¡£è§„åˆ™ç”Ÿæ•ˆã€‚
    </div>
</div>

<script>
    function switchRoleTab(roleId) {
        // åˆ‡æ¢ Tab æ ·å¼
        const tabs = document.querySelectorAll('.role-tab');
        tabs.forEach(t => t.classList.remove('active'));
        event.currentTarget.classList.add('active');

        // åˆ‡æ¢ Form æ˜¾ç¤º
        const forms = document.querySelectorAll('form[id^="form-role-"]');
        forms.forEach(f => f.style.display = 'none');
        document.getElementById('form-role-' + roleId).style.display = 'block';
    }

    function validateCreditForm(form) {
        const minScore = form.querySelector('[name="min_score"]').value;
        const maxNum = form.querySelector('[name="max_num"]').value;
        const maxDay = form.querySelector('[name="max_day"]').value;

        if (minScore < 0 || maxNum < 0 || maxDay < 0) {
            alert("é…ç½®é”™è¯¯ï¼šæ•°å€¼ä¸èƒ½ä¸ºè´Ÿæ•°ï¼");
            return false;
        }
        return true;
    }
</script>
{% endblock %}
```
---

### ğŸ“„ app\templates\admin\maintenance.html
```html
{% extends "base.html" %}
{% block page_title %}ç³»ç»Ÿç»´æŠ¤ / System Maintenance{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    
    <div class="card" style="margin-bottom: 30px; text-align: center; padding: 40px;">
        <i class="fas fa-cogs" style="font-size: 48px; color: #64748b; margin-bottom: 20px;"></i>
        <h2 style="margin-bottom: 10px; color: #1e293b;">Batch Processing Center</h2>
        <p style="color: #64748b; font-size: 14px; max-width: 600px; margin: 0 auto;">
            æ‰§è¡Œç³»ç»Ÿçº§è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚å»ºè®®ç”±ç®¡ç†å‘˜å®šæœŸæ‰‹åŠ¨è§¦å‘ï¼Œä»¥æ¨¡æ‹Ÿåå°æœåŠ¡ï¼ˆCron Jobsï¼‰çš„è¡Œä¸ºã€‚<br>
            Executes system-level automated tasks.
        </p>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        
        <div class="card" style="border-top: 4px solid #f59e0b;">
            <div class="card-title"><i class="fas fa-calendar-check"></i> é¢„çº¦è¿çº¦æ‰«æ</div>
            <p style="color: #64748b; font-size: 13px; margin: 15px 0; min-height: 60px;">
                æ£€æŸ¥çŠ¶æ€ä¸ºâ€œå·²åˆ†é…â€ä½†è¶…è¿‡ 3 å¤©æœªå–ä¹¦çš„é¢„çº¦ã€‚ç³»ç»Ÿå°†è‡ªåŠ¨å–æ¶ˆé¢„çº¦ï¼Œé‡Šæ”¾å›¾ä¹¦ï¼Œå¹¶å¯¹è¿çº¦è¯»è€…æ‰£é™¤ 10 åˆ†ä¿¡ç”¨åˆ†ã€‚
            </p>
            <form method="POST">
                <input type="hidden" name="task_type" value="scan_reservation_expiry">
                <button type="submit" class="btn-glow" style="width: 100%; background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">
                    ç«‹å³æ‰«æ (Run Scan)
                </button>
            </form>
        </div>

        <div class="card" style="border-top: 4px solid #10b981;">
            <div class="card-title"><i class="fas fa-user-plus"></i> æœˆåº¦ä¿¡ç”¨ç»“ç®—</div>
            <p style="color: #64748b; font-size: 13px; margin: 15px 0; min-height: 60px;">
                ä¸ºæ‰€æœ‰ä¿¡ç”¨åˆ†ä¸æ»¡ 100 åˆ†çš„ç”¨æˆ·è‡ªåŠ¨æ¢å¤ 10 åˆ†ï¼ˆä¸è¶…è¿‡ä¸Šé™ï¼‰ã€‚é€šå¸¸åœ¨æ¯æœˆ 1 æ—¥æ‰§è¡Œã€‚
            </p>
            <form method="POST" onsubmit="return confirm('ç¡®å®šè¦æ‰§è¡Œæœˆåº¦ç»“ç®—å—ï¼Ÿè¿™å°†å¢åŠ ç”¨æˆ·ä¿¡ç”¨åˆ†ã€‚');">
                <input type="hidden" name="task_type" value="monthly_recovery">
                <button type="submit" class="btn-glow" style="width: 100%; background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
                    æ‰§è¡Œæ¢å¤ (Execute Recovery)
                </button>
            </form>
        </div>

    </div>
</div>
{% endblock %}
```
---

### ğŸ“„ app\templates\admin\stats.html
```html
{% extends "base.html" %}
{% block page_title %}æµé€šç»Ÿè®¡åˆ†æ / Statistics{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.0/wordcloud2.min.js"></script>
<style>
    .stat-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }
    .full-width { grid-column: span 2; }
    
    .chart-box {
        background: white;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        border: 1px solid rgba(0,0,0,0.03);
        display: flex; flex-direction: column;
        height: 400px; /* å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢å´©å */
        overflow: hidden;
    }

    .chart-header {
        font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 15px;
        display: flex; align-items: center; justify-content: space-between;
        flex-shrink: 0;
    }

    /* å…³é”®ä¿®å¤ï¼šCanvas å®¹å™¨æ ·å¼ */
    .canvas-wrapper {
        flex: 1;
        position: relative;
        width: 100%;
        height: 100%;
        min-height: 0; /* å…è®¸ flex å­é¡¹ç¼©å° */
    }

    /* Word Cloud Canvas */
    #wordCloudCanvas {
        width: 100%; height: 100%; cursor: pointer;
    }

    /* Section Styles */
    .lookup-section {
        background: #fff;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid rgba(0,0,0,0.03);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
    }
    .section-title {
        font-size: 18px; font-weight: 700; color: #334155; margin-bottom: 20px;
        display: flex; align-items: center; gap: 10px;
    }

    /* Clean Filter Bar (New Style) */
    .filter-bar {
        display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: center;
    }
    .filter-group {
        display: flex; align-items: center; gap: 8px;
        background: #fff; padding: 8px 12px;
        border-radius: 10px; border: 1px solid #e2e8f0;
        transition: all 0.2s;
    }
    .filter-group:focus-within {
        border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }
    .filter-input {
        border: none; background: transparent; outline: none; font-size: 13px; width: 140px; color: #1e293b;
    }

    .user-card {
        background: #f8fafc; padding: 20px; border-radius: 12px;
        border: 1px solid #e2e8f0; display: flex; gap: 20px; align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="stat-container">

    <div class="chart-box">
        <div class="chart-header">
            <span><i class="fas fa-cloud" style="color: #3b82f6; margin-right: 8px;"></i> çƒ­é—¨å€Ÿé˜…è¯äº‘ (Top Books)</span>
        </div>
        <div class="canvas-wrapper">
            <canvas id="wordCloudCanvas"></canvas>
        </div>
    </div>

    <div class="chart-box">
        <div class="chart-header">
            <span><i class="fas fa-chart-pie" style="color: #8b5cf6; margin-right: 8px;"></i> å€Ÿé˜…ç±»åˆ«åå¥½</span>
        </div>
        <div class="canvas-wrapper" style="display:flex; justify-content:center;">
            <canvas id="prefChart"></canvas>
        </div>
    </div>

</div>

<div class="lookup-section">
    <div class="section-title">
        <i class="fas fa-list-alt" style="color: #f59e0b;"></i> å…¨é¦†å€Ÿè¿˜æµæ°´æ˜ç»† (Library Logs)
    </div>

    <form method="GET" class="filter-bar" onsubmit="return validateGlobalDate()">
        <div class="filter-group">
            <i class="far fa-calendar-alt" style="color: #94a3b8;"></i>
            <input type="date" id="g_start" name="rec_start" class="filter-input" value="{{ request.args.get('rec_start', '') }}" required>
        </div>
        <span style="color:#cbd5e1;">è‡³</span>
        <div class="filter-group">
            <i class="far fa-calendar-alt" style="color: #94a3b8;"></i>
            <input type="date" id="g_end" name="rec_end" class="filter-input" value="{{ request.args.get('rec_end', '') }}" required>
        </div>
        <button type="submit" class="btn-glow" style="padding: 8px 20px; font-size: 13px;">æŸ¥è¯¢è®°å½•</button>
    </form>

    {% if request.args.get('rec_start') %}
    <div class="card" style="margin: 0; padding: 0; overflow: hidden; border: 1px solid #e2e8f0; box-shadow:none;">
        <div style="padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-size: 12px; font-weight: 600; color: #64748b;">
            æŸ¥è¯¢ç»“æœ: å…± {{ global_records|length }} æ¡
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="clean-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>åŠ¨ä½œ</th>
                        <th>å›¾ä¹¦åç§°</th>
                        <th>è¯»è€…</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in global_records %}
                    <tr>
                        <td>
                            <div style="font-size:12px; color:#64748b;">å€Ÿ: {{ rec['BORROW_DATE'] }}</div>
                            {% if rec['RETURN_DATE'] %}
                            <div style="font-size:12px; color:#64748b;">è¿˜: {{ rec['RETURN_DATE'] }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if rec['STATUS'] == 1 %}<span style="color:#10b981; background:#ecfdf5; padding:2px 6px; border-radius:4px; font-size:11px;">å€Ÿé˜…ä¸­</span>
                            {% elif rec['STATUS'] == 2 %}<span style="color:#64748b; background:#f1f5f9; padding:2px 6px; border-radius:4px; font-size:11px;">å·²å½’è¿˜</span>
                            {% elif rec['STATUS'] == 3 %}<span style="color:#ef4444; background:#fef2f2; padding:2px 6px; border-radius:4px; font-size:11px;">é€¾æœŸ</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-weight:600;">{{ rec['BOOK_NAME'] }}</div>
                            <div style="font-size:11px; color:#94a3b8; font-family:monospace;">{{ rec['ISBN'] }}</div>
                        </td>
                        <td>{{ rec['READER_NAME'] }} <span style="color:#cbd5e1; font-size:11px;">({{ rec['READER_ID'] }})</span></td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" style="text-align:center; padding: 30px; color:#94a3b8;">è¯¥æ—¶æ®µæ— ç›¸å…³è®°å½•</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<div class="lookup-section">
    <div class="section-title">
        <i class="fas fa-user-tag" style="color: #8b5cf6;"></i> è¯»è€…å€Ÿé˜…ç”»åƒæŸ¥è¯¢
    </div>

    <form method="GET" class="filter-bar">
        <div class="filter-group" style="width: 300px;">
            <i class="fas fa-search" style="color: #94a3b8;"></i>
            <input type="text" name="search_user_id" class="filter-input" style="width: 100%;" placeholder="è¾“å…¥å­¦å·/å·¥å·æŸ¥è¯¢..." value="{{ request.args.get('search_user_id', '') }}" required>
        </div>
        <button type="submit" class="btn-glow" style="padding: 8px 20px; font-size: 13px; background: linear-gradient(135deg, #8b5cf6, #7c3aed);">æŸ¥è¯¢ç”»åƒ</button>
    </form>

    {% if target_user %}
    <div class="user-card">
        <div style="width: 50px; height: 50px; background: #f3e8ff; color: #7c3aed; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700;">
            {{ target_user['NAME'][0] }}
        </div>
        <div>
            <div style="font-size: 16px; font-weight: 700; color: #1e293b;">{{ target_user['NAME'] }}</div>
            <div style="color: #64748b; font-size: 13px; margin-top: 4px;">
                ID: {{ target_user['READER_ID'] }} | ä¿¡ç”¨åˆ†:
                <span style="font-weight:600; color: {{ '#10b981' if target_user['CURRENT_CREDIT'] >= 80 else '#ef4444' }}">{{ target_user['CURRENT_CREDIT'] }}</span>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 20px; padding: 0; overflow: hidden; border: 1px solid #e2e8f0; box-shadow:none;">
        <div style="padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-size: 12px; font-weight: 600; color: #64748b;">
            å†å²æ¸…å• ({{ user_history|length }})
        </div>
        <div style="max-height: 300px; overflow-y: auto;">
            <table class="clean-table">
                <thead>
                    <tr><th>ä¹¦å</th><th>å€Ÿé˜…æ—¥æœŸ</th><th>çŠ¶æ€</th></tr>
                </thead>
                <tbody>
                    {% for h in user_history %}
                    <tr>
                        <td>{{ h['BOOK_NAME'] }}</td>
                        <td>{{ h['BORROW_DATE'] }}</td>
                        <td>
                            {% if h['STATUS'] == 1 %}<span style="color:#10b981;">å€Ÿé˜…ä¸­</span>
                            {% elif h['STATUS'] == 3 %}<span style="color:#ef4444;">é€¾æœŸ</span>
                            {% else %}<span style="color:#94a3b8;">å·²è¿˜</span>{% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" style="text-align:center; color:#999; padding: 20px;">è¯¥ç”¨æˆ·æš‚æ— å€Ÿé˜…è®°å½•</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
    function validateGlobalDate() {
        const s = document.getElementById('g_start').value;
        const e = document.getElementById('g_end').value;
        if(s && e && new Date(s) > new Date(e)) {
            alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ'); return false;
        }
        return true;
    }

    // 1. è¯äº‘åˆå§‹åŒ–
    const wcList = {{ wc_list | tojson }};
    const maxWeight = wcList.length > 0 ? wcList[0][1] : 1;
    const scaledList = wcList.map(item => [item[0], 20 + (item[1]/maxWeight * 40)]);

    WordCloud(document.getElementById('wordCloudCanvas'), {
        list: scaledList,
        gridSize: 8,
        weightFactor: 1,
        fontFamily: 'system-ui, -apple-system, sans-serif',
        color: function() {
            return ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'][Math.floor(Math.random() * 5)];
        },
        rotateRatio: 0,
        backgroundColor: '#fff'
    });

    // 2. åå¥½é¥¼å›¾ (å…³é”®é…ç½®ï¼šmaintainAspectRatio: false)
    new Chart(document.getElementById('prefChart'), {
        type: 'doughnut',
        data: {
            labels: {{ pref_labels | tojson }},
            datasets: [{
                data: {{ pref_values | tojson }},
                backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#cbd5e1'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // å…è®¸é«˜åº¦è‡ªé€‚åº”
            plugins: {
                legend: {
                    position: 'right', // å›¾ä¾‹æ”¾å³ä¾§
                    labels: { boxWidth: 10, font: { size: 12 } }
                }
            },
            layout: { padding: 10 },
            cutout: '65%'
        }
    });

    // 3. è¶‹åŠ¿å›¾
    new Chart(document.getElementById('trendChart'), {
        type: 'bar',
        data: {
            labels: {{ trend_labels | tojson }},
            datasets: [{
                label: 'æœˆåº¦å€Ÿé˜…é‡',
                data: {{ trend_values | tojson }},
                backgroundColor: '#3b82f6',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [5,5] } },
                x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}
```
---

### ğŸ“„ app\templates\admin\user_list.html
```html
{% extends "base.html" %}

{% block page_title %}ç”¨æˆ·ä¸æƒé™ç®¡ç† / User Admin{% endblock %}

{% block extra_css %}
<style>
    /* --- iOS Premium Style Enhancement --- */

    /* é¡µé¢å¸ƒå±€å®¹å™¨ */
    .admin-grid {
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 24px;
        align-items: start;
    }

    /* å¡ç‰‡é«˜çº§è´¨æ„Ÿ */
    .ios-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.6);
        transition: transform 0.3s ease;
    }

    .ios-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px -10px rgba(0, 0, 0, 0.08);
    }

    /* æ ‡é¢˜åŒºåŸŸ */
    .ios-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .ios-title {
        font-size: 18px;
        font-weight: 700;
        color: #1d1d1f;
        letter-spacing: -0.5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* è¡¨æ ¼æ ·å¼ */
    .ios-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .ios-table th {
        text-align: left;
        padding: 12px 16px;
        font-size: 12px;
        font-weight: 600;
        color: #86868b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #e5e5ea;
    }

    .ios-table td {
        padding: 16px;
        vertical-align: middle;
        font-size: 14px;
        color: #1d1d1f;
        border-bottom: 1px solid #f2f2f7;
        background: transparent;
    }

    .ios-table tr:last-child td {
        border-bottom: none;
    }

    .ios-table tr:hover td {
        background-color: rgba(242, 242, 247, 0.5);
    }

    /* è§’è‰²æ ‡ç­¾ */
    .role-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .role-admin { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
    .role-staff { background: #eef2ff; color: #6366f1; border: 1px solid #c7d2fe; }
    .role-user  { background: #ecfdf5; color: #10b981; border: 1px solid #bbf7d0; }
    .role-guest { background: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; }

    /* æ“ä½œæŒ‰é’®ç»„ */
    .action-group {
        display: flex;
        align-items: center;
        justify-content: flex-start; /* å·¦å¯¹é½ */
        gap: 12px;
    }

    /* åœ†å½¢å›¾æ ‡æŒ‰é’® */
    .btn-icon-ios {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        font-size: 14px;
    }

    .btn-edit {
        background-color: #f2f2f7;
        color: #007aff;
    }
    .btn-edit:hover {
        background-color: #007aff;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
    }

    .btn-delete {
        background-color: #fff1f2;
        color: #ff3b30;
    }
    .btn-delete:hover {
        background-color: #ff3b30;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3);
    }

    /* è¾“å…¥æ¡†ç¾åŒ– */
    .input-ios {
        width: 100%;
        padding: 12px 16px;
        background: #f5f5f7;
        border: 1px solid transparent;
        border-radius: 12px;
        font-size: 14px;
        color: #1d1d1f;
        margin-bottom: 16px;
        transition: all 0.2s;
    }
    .input-ios:focus {
        background: #fff;
        border-color: #007aff;
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        outline: none;
    }

    label {
        font-size: 12px;
        font-weight: 600;
        color: #86868b;
        margin-bottom: 6px;
        display: block;
        text-transform: uppercase;
    }

    /* ä¸»æŒ‰é’® */
    .btn-primary-ios {
        background: #007aff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);
    }
    .btn-primary-ios:hover {
        background: #0062cc;
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(0, 122, 255, 0.35);
    }

    .btn-block {
        width: 100%;
        justify-content: center;
        margin-top: 10px;
    }

</style>
{% endblock %}

{% block content %}
<div class="admin-grid">

    <div class="ios-card">
        <div class="ios-header">
            <div class="ios-title">
                <i class="fas fa-users-cog" style="color: #007aff;"></i> ç³»ç»Ÿç”¨æˆ·åˆ—è¡¨
            </div>
            <button class="btn-primary-ios" onclick="openAddUserModal()">
                <i class="fas fa-plus"></i> æ–°å¢ç”¨æˆ·
            </button>
        </div>

        <div style="overflow-x: auto;">
            <table class="ios-table" id="userTable">
                <thead>
                    <tr>
                        <th style="width: 120px;">ç”¨æˆ· ID</th>
                        <th>å§“å</th>
                        <th>è§’è‰²æƒé™</th>
                        <th style="width: 100px;">ä¿¡ç”¨åˆ†</th>
                        <th style="width: 140px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in readers %}
                    <tr data-user-id="{{ r['READER_ID'] }}">
                        <td style="font-family: 'SF Mono', monospace; color: #666;">
                            {{ r['READER_ID'] }}
                        </td>
                        <td style="font-weight: 600;">
                            {{ r['NAME'] }}
                        </td>
                        <td>
                            {% if r['ROLE_ID'] == 8 %}
                                <span class="role-badge role-admin"><i class="fas fa-shield-alt"></i> è¶…çº§ç®¡ç†å‘˜</span>
                            {% elif r['ROLE_ID'] > 3 %}
                                <span class="role-badge role-staff"><i class="fas fa-user-tie"></i> é¦†å‘˜/ç®¡ç†</span>
                            {% elif r['ROLE_ID'] == 2 %}
                                <span class="role-badge role-user"><i class="fas fa-user-graduate"></i> å­¦ç”Ÿ</span>
                            {% else %}
                                <span class="role-badge role-guest"><i class="fas fa-user"></i> {{ r['ROLE_NAME'] }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-weight: 700; color: {{ '#10b981' if r['CURRENT_CREDIT'] >= 90 else '#f59e0b' if r['CURRENT_CREDIT'] >= 60 else '#ef4444' }};">
                                {{ r['CURRENT_CREDIT'] }}
                            </div>
                        </td>
                        <td>
                            <div class="action-group">
                                <button class="btn-icon-ios btn-edit" title="ç¼–è¾‘ä¿¡æ¯"
                                        onclick="openEditUserModal('{{ r.READER_ID }}', '{{ r.NAME }}', '{{ r.ROLE_ID }}')">
                                    <i class="fas fa-pen"></i>
                                </button>

                                {% if r.READER_ID != 1001 and r.READER_ID != session.get('user_id') %}
                                <form method="POST" style="margin:0;" onsubmit="return confirm('è­¦å‘Šï¼šç¡®å®šè¦ç‰©ç†åˆ é™¤ç”¨æˆ· [{{ r.NAME }}] å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼');">
                                    <input type="hidden" name="action" value="delete_user">
                                    <input type="hidden" name="reader_id" value="{{ r.READER_ID }}">
                                    <button type="submit" class="btn-icon-ios btn-delete" title="åˆ é™¤ç”¨æˆ·">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 24px;">

        <div class="ios-card">
            <div class="ios-header" style="margin-bottom: 20px;">
                <div class="ios-title" style="font-size: 16px;">
                    <i class="fas fa-tachometer-alt" style="color: #af52de;"></i> ä¿¡ç”¨åˆ†å˜æ›´
                </div>
            </div>
            <form method="POST" onsubmit="return validateCreditUpdate()">
                <input type="hidden" name="action" value="update_credit">

                <label>ç›®æ ‡ç”¨æˆ· ID</label>
                <input type="text" name="reader_id" id="credit_reader_id" class="input-ios" placeholder="è¾“å…¥å­¦å·/å·¥å·" required
                       pattern="^(\d{8}|\d{12})$"
                       title="ç”¨æˆ·IDåªèƒ½ä¸º 8 ä½æˆ–è€… 12 ä½æ•°å­—">

                <label>è°ƒæ•´æ•°å€¼</label>
                <select name="change_val" class="input-ios" style="cursor: pointer;">
                    <option value="10">+10åˆ†</option>
                    <option value="-10">-10åˆ†</option>
                    <option value="-20">-20åˆ†</option>
                </select>

                <label>å˜æ›´åŸå› </label>
                <input type="text" name="reason" class="input-ios" placeholder="ä¾‹å¦‚ï¼šæŸåå›¾ä¹¦èµ”å¿" required>

                <button type="submit" class="btn-primary-ios btn-block" style="background: #af52de;">
                    æäº¤å˜æ›´
                </button>
            </form>
        </div>

        <div class="ios-card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-color: #bae6fd;">
            <div class="ios-header" style="border-bottom-color: rgba(0,0,0,0.05); margin-bottom: 15px;">
                <div class="ios-title" style="font-size: 16px; color: #0369a1;">
                    <i class="fas fa-cogs"></i> ç³»ç»Ÿå‚æ•°
                </div>
            </div>
            <form method="POST">
                <input type="hidden" name="action" value="update_settings">
                <label style="color: #0c4a6e;">æ³¨é”€å®½é™æœŸ (å¤©)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" name="grace_days" value="{{ grace_days }}" class="input-ios" style="margin-bottom:0; background: rgba(255,255,255,0.6);" min="0">
                    <button type="submit" class="btn-primary-ios" style="padding: 10px 16px; font-size: 13px;">ä¿å­˜</button>
                </div>
                <p style="font-size: 11px; color: #0c4a6e; opacity: 0.7; margin-top: 10px; line-height: 1.4;">
                    * ç”¨æˆ·æäº¤æ³¨é”€ç”³è¯·åçš„ä¿ç•™å¤©æ•°ï¼ŒæœŸæ»¡è‡ªåŠ¨ç‰©ç†åˆ é™¤ã€‚
                </p>
            </form>
        </div>

    </div>
</div>

<div class="ios-modal-overlay" id="addUserModal">
    <div class="ios-modal">
        <div class="ios-modal-header">
            <div class="ios-modal-title">æ–°å¢ç”¨æˆ·</div>
            <div class="ios-modal-close" onclick="closeModal('addUserModal')"><i class="fas fa-times"></i></div>
        </div>
        <div class="ios-modal-body">
            <form method="POST" class="ios-form-group">
                <input type="hidden" name="action" value="add_user">

                <label>ç”¨æˆ· ID (å­¦å·/å·¥å·)</label>
                <input type="text" name="new_id" class="input-ios" placeholder="ä¾‹å¦‚ï¼š20230101" required
                       pattern="^(\d{8}|\d{12})$"
                       title="ç”¨æˆ·IDåªèƒ½ä¸º 8 ä½æˆ–è€… 12 ä½æ•°å­—">

                <label>çœŸå®å§“å</label>
                <input type="text" name="new_name" class="input-ios" placeholder="è¾“å…¥å§“å" required>

                <label>åˆå§‹è§’è‰²</label>
                <select name="new_role" class="input-ios">
                    {% for role in all_roles %}
                    <option value="{{ role.ROLE_ID }}">{{ role.ROLE_NAME }}</option>
                    {% endfor %}
                </select>

                <div style="margin-top: 20px;">
                    <button type="submit" class="btn-primary-ios btn-block">ç¡®è®¤åˆ›å»ºè´¦æˆ·</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="ios-modal-overlay" id="editUserModal">
    <div class="ios-modal">
        <div class="ios-modal-header">
            <div class="ios-modal-title">ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯</div>
            <div class="ios-modal-close" onclick="closeModal('editUserModal')"><i class="fas fa-times"></i></div>
        </div>
        <div class="ios-modal-body">
            <form method="POST" class="ios-form-group">
                <input type="hidden" name="action" value="edit_user">
                <input type="hidden" name="reader_id" id="edit_reader_id">

                <div style="background: #f8fafc; padding: 12px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; color: #64748b; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-info-circle"></i> æ­£åœ¨ç¼–è¾‘ç”¨æˆ· ID: <span id="display_id" style="font-weight: 700; color: #334155; font-family: monospace; font-size: 14px;"></span>
                </div>

                <label>å§“å</label>
                <input type="text" name="name" id="edit_name" class="input-ios" required>

                <label>è§’è‰²åˆ†é…</label>
                <select name="role_id" id="edit_role" class="input-ios">
                    {% for role in all_roles %}
                    <option value="{{ role.ROLE_ID }}">{{ role.ROLE_NAME }}</option>
                    {% endfor %}
                </select>

                <div style="margin-top: 20px;">
                    <button type="submit" class="btn-primary-ios btn-block">ä¿å­˜å˜æ›´</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // [æ–°å¢] ä¿¡ç”¨åˆ†è¡¨å•æ ¡éªŒï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    function validateCreditUpdate() {
        const inputId = document.getElementById('credit_reader_id').value.trim();
        const rows = document.querySelectorAll('#userTable tbody tr');
        let exists = false;

        rows.forEach(row => {
            const userId = row.getAttribute('data-user-id');
            if (userId === inputId) {
                exists = true;
            }
        });

        if (!exists) {
            alert('é”™è¯¯ï¼šè¯¥ç”¨æˆ· ID (' + inputId + ') ä¸åœ¨å½“å‰ç”¨æˆ·åˆ—è¡¨ä¸­ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–å…ˆåˆ›å»ºç”¨æˆ·ã€‚');
            return false;
        }
        return true;
    }

    function openAddUserModal() {
        document.getElementById('addUserModal').classList.add('open');
    }

    function openEditUserModal(id, name, roleId) {
        document.getElementById('edit_reader_id').value = id;
        document.getElementById('display_id').innerText = id;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_role').value = roleId;
        document.getElementById('editUserModal').classList.add('open');
    }

    // é€šç”¨å…³é—­å‡½æ•° (ä¾èµ– base.html ä¸­çš„ closeModal å®šä¹‰ï¼Œæˆ–åœ¨æ­¤å¤„è¡¥å……)
    if (typeof closeModal === 'undefined') {
        window.closeModal = function(id) {
            document.getElementById(id).classList.remove('open');
        }

        // ç‚¹å‡»é®ç½©å…³é—­
        document.querySelectorAll('.ios-modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('open');
                }
            });
        });
    }
</script>
{% endblock %}
```
---

### ğŸ“„ app\templates\auth\Login.html
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCEPUå›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿ - ç™»å½•</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- æ ¸å¿ƒåŸºç¡€è®¾ç½® --- */
        :root {
            --brand-blue: #004b9e; /* åç”µè“/æ·±è“ */
            --glass-bg: rgba(12, 45, 90, 0.65);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shine: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            /* ä½¿ç”¨ Flask url_for åŠ è½½åŠ¨æ€èƒŒæ™¯å›¾ */
            background: url("{{ url_for('static', filename='asset/BG2.png') }}") no-repeat center center/cover;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.3));
            z-index: -1;
        }

        .login-container {
            width: 1000px;
            height: 600px;
            border-radius: 24px;
            display: flex;
            position: relative;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .left-panel {
            width: 50%;
            position: relative;
            padding: 48px;
            display: flex;
            flex-direction: column;
            color: white;
            z-index: 1;
            background: linear-gradient(135deg, rgba(12, 45, 90, 0.55) 0%, rgba(12, 45, 90, 0.35) 100%);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            box-shadow: inset -1px 0 0 0 rgba(255, 255, 255, 0.1);
        }

        .left-panel::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 40%);
            pointer-events: none; z-index: -1;
        }

        .left-panel::after {
            content: '';
            position: absolute; width: 500px; height: 500px;
            border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 50%;
            top: -150px; right: -150px;
            pointer-events: none;
        }

        .header-logo { display: flex; align-items: center; margin-bottom: 50px; height: 50px; }

        .header-logo-img {
            height: 100%;
            width: auto; max-width: 220px; object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); margin-right: 15px;
        }

        .system-name {
            font-size: 18px;
            border-left: 1px solid rgba(255,255,255,0.3);
            padding-left: 15px; margin-left: 5px; font-weight: 500;
            letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap;
        }

        .welcome-text h2 {
            font-size: 30px;
            margin-bottom: 16px; font-weight: 600;
            line-height: 1.2; text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .welcome-text p { font-size: 15px; opacity: 0.85; line-height: 1.7; font-weight: 300; }

        .info-card {
            margin-top: auto;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 1px 0 0 rgba(255, 255, 255, 0.1), 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 16px;
            padding: 24px; transition: transform 0.3s ease;
        }

        .info-card:hover { background: rgba(255, 255, 255, 0.12); }

        .card-title { display: flex; align-items: center; font-size: 15px; font-weight: 600; margin-bottom: 18px; color: rgba(255,255,255,0.95); }
        .card-title i { margin-right: 10px; color: #64b5f6; }
        .card-subtitle { font-size: 11px; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; margin-left: auto; opacity: 0.9; }

        .time-row { display: flex; align-items: center; margin-bottom: 14px; background: rgba(0, 0, 0, 0.15); padding: 12px 16px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.03); }
        .time-row:last-child { margin-bottom: 0; }
        .time-icon { margin-right: 14px; font-size: 16px; color: rgba(255,255,255,0.7); }
        .time-content label { display: block; font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
        .time-content span { font-size: 15px; font-weight: 500; font-feature-settings: "tnum"; }

        .right-panel {
            width: 50%;
            background: rgba(255, 255, 255, 0.96); padding: 60px 70px;
            display: flex; flex-direction: column; justify-content: center; position: relative;
        }

        .auth-title { text-align: center; color: #1a1a1a; font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .auth-subtitle { text-align: center; color: #888; font-size: 13px; margin-bottom: 35px; }

        .tab-title { text-align: center; font-size: 16px; margin-bottom: 30px; position: relative; }
        .tab-title span { padding-bottom: 10px; border-bottom: 3px solid var(--brand-blue); color: var(--brand-blue); font-weight: 600; }

        .form-group { margin-bottom: 24px; }

        .input-wrapper {
            display: flex;
            align-items: center; background: #f2f4f7;
            border: 1px solid transparent; border-radius: 8px; padding: 0 16px;
            height: 48px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-wrapper:hover { background: #eaecf0; }
        .input-wrapper:focus-within { background: #fff; border-color: var(--brand-blue); box-shadow: 0 0 0 4px rgba(0, 75, 158, 0.1); }
        .input-wrapper i { color: #98a2b3; font-size: 16px; width: 24px; text-align: center; transition: color 0.3s; }
        .input-wrapper:focus-within i { color: var(--brand-blue); }

        .input-wrapper input {
            flex: 1;
            border: none; background: transparent; height: 100%;
            padding-left: 12px; outline: none; font-size: 15px; color: #333; font-weight: 500;
        }
        .input-wrapper input::placeholder { color: #aaa; font-weight: 400; }

        .captcha-group { display: flex; gap: 12px; }
        .captcha-img {
            width: 110px;
            height: 48px; background: #e0e0e0; border-radius: 8px; cursor: pointer;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="110" height="48" viewBox="0 0 110 48"><rect width="100%" height="100%" fill="%23f2f4f7"/><text x="50%" y="55%" font-family="Arial" font-size="22" font-weight="bold" font-style="italic" fill="%23004b9e" dy=".3em" text-anchor="middle" letter-spacing="3">7392</text><path d="M5,40 Q30,5 60,40 T100,10" stroke="%23ccc" fill="none" stroke-width="2"/><circle cx="20" cy="10" r="2" fill="%23999"/><circle cx="90" cy="30" r="2" fill="%23999"/></svg>');
            background-size: cover; transition: opacity 0.2s;
        }
        .captcha-img:hover { opacity: 0.8; }

        .links { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 30px; color: #666; }
        .links a { text-decoration: none; color: #555; transition: color 0.2s; }
        .links a:hover { color: var(--brand-blue); }

        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .btn-login {
            flex: 2;
            height: 48px; background: linear-gradient(to bottom, #0052d9, #0042b0);
            color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
            transition: all 0.3s;
            font-weight: 600; letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(0, 66, 176, 0.3);
        }
        .btn-login:hover { background: linear-gradient(to bottom, #005ce6, #004bca); transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0, 66, 176, 0.4); }
        .btn-login:active { transform: translateY(1px); }

        .btn-guest {
            flex: 1;
            height: 48px;
            background: rgba(255, 255, 255, 0.7);
            color: #555;
            border: 1px solid #d1d5db;
            border-radius: 8px; font-size: 15px; cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-guest:hover {
            background: #f8fafc;
            color: #333;
            border-color: #9ca3af;
        }

        .footer-text { margin-top: 30px; text-align: center; font-size: 12px; color: #999; line-height: 1.6; }

        /* Flask æ¶ˆæ¯æç¤ºæ ·å¼ */
        .alert-box {
            padding: 10px 15px;
            margin-bottom: 20px; border-radius: 8px; font-size: 14px;
            display: flex; align-items: center; gap: 10px;
        }
        .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

        @media (max-width: 900px) {
            .login-container { width: 95vw; height: auto; flex-direction: column; }
            .left-panel, .right-panel { width: 100%; padding: 40px; }
            .left-panel { min-height: 300px; }
        }
    </style>
</head>
<body>

    <div class="login-container">
        <div class="left-panel">
            <div class="header-logo">
                <img src="{{ url_for('static', filename='asset/NCEPU_LIB.png') }}" alt="ååŒ—ç”µåŠ›å¤§å­¦å›¾ä¹¦é¦†" class="header-logo-img">
                <div class="system-name">å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ</div>
            </div>

            <div class="welcome-text">
                <h2>æ¬¢è¿ä½¿ç”¨<br>NCEPUå›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿ</h2>
                <p>Knowledge â€¢ Innovation â€¢ Excellence<br>ä¾¿æ·çš„é¦†è—ç®¡ç†æœåŠ¡å¹³å° - Group4ä½œå“</p>
            </div>

            <div class="info-card">
                <div class="card-title">
                    <i class="fas fa-clock"></i>
                    <span>å¼€é¦†æ—¶é—´é€šçŸ¥</span>
                    <span class="card-subtitle">Normal</span>
                </div>

                <div class="time-row">
                    <div class="time-icon"><i class="fas fa-sun"></i></div>
                    <div class="time-content">
                        <label>å‘¨ä¸€è‡³å‘¨æ—¥ (Mon - Sun)</label>
                        <span>07:00 - 22:30</span>
                    </div>
                </div>

                <div class="time-row">
                    <div class="time-icon"><i class="fas fa-book-reader"></i></div>
                    <div class="time-content">
                        <label>è‡ªåŠ©è¿˜ä¹¦åŒº (Self Service)</label>
                        <span>24 Hours Open</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <h2 class="auth-title">ç»Ÿä¸€èº«ä»½è®¤è¯</h2>
            <p class="auth-subtitle">Use NCEPU ID to sign in</p>

            <div class="tab-title">
                <span>è´¦å·ç™»å½•</span>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert-box alert-{{ category }}">
                        <i class="fas fa-exclamation-circle"></i> {{ message }}
                    </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form action="{{ url_for('auth.login') }}" method="POST" onsubmit="return validateLoginForm()">

                <div class="form-group">
                    <div class="input-wrapper">
                        <i class="fas fa-user-circle"></i>
                        <input type="text" name="user_id" id="login_id" placeholder="å­¦å· / å·¥å· / Reader ID" required
                         pattern="^(\d{8}|\d{12}|1001)$"
                         title="è¯·è¾“å…¥8ä½æˆ–12ä½æ•°å­—è´¦å·">
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <i class="fas fa-lock"></i>
                        <input type="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç  / Password" required>
                    </div>
                </div>

                <div class="form-group captcha-group">
                    <div class="input-wrapper">
                    <i class="fas fa-shield-alt"></i>
                    <input type="text" id="captcha_input" placeholder="éªŒè¯ç  (7392)" required>
                    </div>
                    <div class="captcha-img" title="ç‚¹å‡»åˆ·æ–°"></div>
                 </div>

                <div class="links">
                    <a href="#">å¿˜è®°å¯†ç ?</a>
                    <a href="{{ url_for('auth.register') }}">ç”¨æˆ·æ³¨å†Œ <i class="fas fa-arrow-right" style="font-size: 10px;"></i></a>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn-login">ç™» å½•</button>
                    <a href="{{ url_for('auth.guest_login') }}" class="btn-guest">
                        <i class="fas fa-user-secret" style="margin-right: 6px;"></i> è®¿å®¢
                    </a>
                </div>
            </form>

            <div class="footer-text">
                <p>è¯·ä½¿ç”¨æ ¡å›­ä¸€å¡é€šè´¦å·ç™»å½•</p>
                <p>æŠ€æœ¯æ”¯æŒï¼šååŒ—ç”µåŠ›å¤§å­¦ç½‘ç»œä¸ä¿¡æ¯åŒ–ä¸­å¿ƒ</p>
            </div>
        </div>
    </div>

    <script>
    function validateLoginForm() {
        // 1. éªŒè¯è´¦å·æ ¼å¼ (åŒé‡ä¿é™©ï¼Œé™¤äº† HTML5 pattern å¤–çš„é€»è¾‘æ£€æŸ¥)
        var userId = document.getElementById('login_id').value;
        var idRegex = /^(\d{8}|\d{12}|1001)$/;
        if (!idRegex.test(userId)) {
            alert("è´¦å·æ ¼å¼é”™è¯¯ï¼šåªèƒ½æ˜¯ 8 ä½æˆ– 12 ä½æ•°å­— (ç®¡ç†å‘˜ä¸º 1001)");
            return false;
        }

        // 2. éªŒè¯éªŒè¯ç 
        var captcha = document.getElementById('captcha_input').value;
        if (captcha !== '7392') {
            alert("éªŒè¯ç é”™è¯¯ï¼Œè¯·è¾“å…¥ 7392");
            return false;
        }
        return true;
    }
</script>

</body>
</html>
```
---

### ğŸ“„ app\templates\auth\register.html
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCEPUå›¾ä¹¦é¦† - ç”¨æˆ·æ³¨å†Œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒåŸºç¡€è®¾ç½® --- */
        :root {
            --brand-blue: #004b9e; /* åç”µè“/æ·±è“ */
            --glass-bg: rgba(12, 45, 90, 0.65);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shine: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            /* ä½¿ç”¨ Flask url_for åŠ è½½åŠ¨æ€èƒŒæ™¯å›¾ */
            background: url("{{ url_for('static', filename='asset/BG2.png') }}") no-repeat center center/cover;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.3));
            z-index: -1;
        }

        .login-container {
            width: 1000px;
            height: 680px;
            border-radius: 24px;
            display: flex;
            position: relative;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .left-panel {
            width: 50%;
            position: relative;
            padding: 48px;
            display: flex;
            flex-direction: column;
            color: white;
            z-index: 1;
            background: linear-gradient(135deg, rgba(12, 45, 90, 0.55) 0%, rgba(12, 45, 90, 0.35) 100%);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            box-shadow: inset -1px 0 0 0 rgba(255, 255, 255, 0.1);
        }

        .left-panel::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 40%);
            pointer-events: none; z-index: -1;
        }

        .left-panel::after {
            content: '';
            position: absolute; width: 500px; height: 500px;
            border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 50%;
            top: -150px; right: -150px;
            pointer-events: none;
        }

        .header-logo { display: flex; align-items: center; margin-bottom: 50px; height: 50px; }

        .header-logo-img {
            height: 100%;
            width: auto; max-width: 220px; object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); margin-right: 15px;
        }

        .system-name {
            font-size: 18px;
            border-left: 1px solid rgba(255,255,255,0.3);
            padding-left: 15px; margin-left: 5px; font-weight: 500;
            letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap;
        }

        .welcome-text h2 {
            font-size: 30px;
            margin-bottom: 16px; font-weight: 600;
            line-height: 1.2; text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .welcome-text p { font-size: 15px; opacity: 0.85; line-height: 1.7; font-weight: 300; }

        .info-card {
            margin-top: auto;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 1px 0 0 rgba(255, 255, 255, 0.1), 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 16px;
            padding: 24px; transition: transform 0.3s ease;
        }

        .info-card:hover { background: rgba(255, 255, 255, 0.12); }

        .card-title { display: flex; align-items: center; font-size: 15px; font-weight: 600; margin-bottom: 18px; color: rgba(255,255,255,0.95); }
        .card-title i { margin-right: 10px; color: #64b5f6; }
        .card-subtitle { font-size: 11px; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; margin-left: auto; opacity: 0.9; }

        .time-row { display: flex; align-items: center; margin-bottom: 14px; background: rgba(0, 0, 0, 0.15); padding: 12px 16px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.03); }
        .time-row:last-child { margin-bottom: 0; }
        .time-icon { margin-right: 14px; font-size: 16px; color: rgba(255,255,255,0.7); }
        .time-content label { display: block; font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
        .time-content span { font-size: 15px; font-weight: 500; font-feature-settings: "tnum"; }

        .right-panel {
            width: 50%;
            background: rgba(255, 255, 255, 0.96); padding: 60px 70px;
            display: flex; flex-direction: column; justify-content: center; position: relative;
        }

        .auth-title { text-align: center; color: #1a1a1a; font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .auth-subtitle { text-align: center; color: #888; font-size: 13px; margin-bottom: 35px; }

        .tab-title { text-align: center; font-size: 16px; margin-bottom: 30px; position: relative; }
        .tab-title span { padding-bottom: 10px; border-bottom: 3px solid var(--brand-blue); color: var(--brand-blue); font-weight: 600; }

        .form-group { margin-bottom: 24px; }

        .input-wrapper {
            display: flex;
            align-items: center; background: #f2f4f7;
            border: 1px solid transparent; border-radius: 8px; padding: 0 16px;
            height: 48px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-wrapper:hover { background: #eaecf0; }
        .input-wrapper:focus-within { background: #fff; border-color: var(--brand-blue); box-shadow: 0 0 0 4px rgba(0, 75, 158, 0.1); }
        .input-wrapper i { color: #98a2b3; font-size: 16px; width: 24px; text-align: center; transition: color 0.3s; }
        .input-wrapper:focus-within i { color: var(--brand-blue); }

        .input-wrapper input {
            flex: 1;
            border: none; background: transparent; height: 100%;
            padding-left: 12px; outline: none; font-size: 15px; color: #333; font-weight: 500;
        }
        .input-wrapper input::placeholder { color: #aaa; font-weight: 400; }

        .captcha-group { display: flex; gap: 12px; }
        .captcha-img {
            width: 110px;
            height: 48px; background: #e0e0e0; border-radius: 8px; cursor: pointer;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="110" height="48" viewBox="0 0 110 48"><rect width="100%" height="100%" fill="%23f2f4f7"/><text x="50%" y="55%" font-family="Arial" font-size="22" font-weight="bold" font-style="italic" fill="%23004b9e" dy=".3em" text-anchor="middle" letter-spacing="3">7392</text><path d="M5,40 Q30,5 60,40 T100,10" stroke="%23ccc" fill="none" stroke-width="2"/><circle cx="20" cy="10" r="2" fill="%23999"/><circle cx="90" cy="30" r="2" fill="%23999"/></svg>');
            background-size: cover; transition: opacity 0.2s;
        }
        .captcha-img:hover { opacity: 0.8; }

        .links { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 30px; color: #666; }
        .links a { text-decoration: none; color: #555; transition: color 0.2s; }
        .links a:hover { color: var(--brand-blue); }

        .btn-login {
            width: 100%;
            height: 48px; background: linear-gradient(to bottom, #0052d9, #0042b0);
            color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
            transition: all 0.3s;
            font-weight: 600; letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(0, 66, 176, 0.3);
        }
        .btn-login:hover { background: linear-gradient(to bottom, #005ce6, #004bca); transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0, 66, 176, 0.4); }
        .btn-login:active { transform: translateY(1px); }

        .footer-text { margin-top: 30px; text-align: center; font-size: 12px; color: #999; line-height: 1.6; }

        /* Flask æ¶ˆæ¯æç¤ºæ ·å¼ */
        .alert-box {
            padding: 10px 15px;
            margin-bottom: 20px; border-radius: 8px; font-size: 14px;
            display: flex; align-items: center; gap: 10px;
        }
        .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

        @media (max-width: 900px) {
            .login-container { width: 95vw; height: auto; flex-direction: column; }
            .left-panel, .right-panel { width: 100%; padding: 40px; }
            .left-panel { min-height: 300px; }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="left-panel">
            <h2>æ¬¢è¿åŠ å…¥</h2>
            <p style="margin-top: 10px; opacity: 0.8;">åˆ›å»ºä¸€ä¸ªæ–°è´¦æˆ·ä»¥ä½¿ç”¨ NCEPU å›¾ä¹¦é¦†æœåŠ¡ã€‚</p>
        </div>
        <div class="right-panel">
            <h2 style="margin-bottom: 30px; text-align: center; color: #333;">è¯»è€…æ³¨å†Œ</h2>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert-box alert-{{ category }}">
                            <i class="fas fa-info-circle"></i> {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" onsubmit="return validateRegisterForm()">
                <div class="form-group">
                    <div class="input-wrapper">
                        <i class="fas fa-id-card"></i>
                     <input type="text" name="reader_id" id="reg_id" placeholder="å­¦å· / å·¥å· (8ä½æˆ–12ä½æ•°å­—)" required
                            value="{{ request.form.get('reader_id', '') }}"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <i class="fas fa-user"></i>
                        <input type="text" name="name" placeholder="çœŸå®å§“å" required
                               value="{{ request.form.get('name', '') }}">
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <i class="fas fa-venus-mars"></i>
                        <select name="sex" style="border:none; background:transparent; width:100%; margin-left:10px; outline:none; color:#555; cursor:pointer;" required>
                            <option value="" disabled {% if not request.form.get('sex') %}selected{% endif %}>é€‰æ‹©æ€§åˆ«</option>
                            <option value="M" {% if request.form.get('sex') == 'M' %}selected{% endif %}>ç”·</option>
                            <option value="F" {% if request.form.get('sex') == 'F' %}selected{% endif %}>å¥³</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                         <i class="fas fa-lock"></i>
                        <input type="password" name="password" id="reg_pwd" placeholder="è®¾ç½®å¯†ç  (æ•°å­—+å­—æ¯+ç‰¹æ®Šå­—ç¬¦)" required>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <i class="fas fa-shield-alt"></i>
                        <input type="password" name="confirm_password" placeholder="ç¡®è®¤å¯†ç " required>
                    </div>
                </div>

                <button type="submit" class="btn-login">ç«‹å³æ³¨å†Œ</button>
                <div style="margin-top: 20px; text-align: center;">
                    <a href="{{ url_for('auth.login') }}" style="color: #004b9e; text-decoration: none;">å·²æœ‰è´¦å·ï¼Ÿç›´æ¥ç™»å½•</a>
                </div>
            </form>
        </div>
    </div>
<script>
    function validateRegisterForm() {
        // 1. è´¦å·æ£€æŸ¥: å¿…é¡»æ˜¯ 8 ä½æˆ– 12 ä½çº¯æ•°å­—
        var id = document.getElementById('reg_id').value;
        var idRegex = /^(\d{8}|\d{12})$/;
        if (!idRegex.test(id)) {
            alert("æ³¨å†Œå¤±è´¥ï¼šè´¦å·å¿…é¡»ä¸¥æ ¼ä¸º 8 ä½æˆ– 12 ä½æ•°å­—ã€‚");
            return false;
        }

        // 2. å¯†ç å¼ºåº¦æ£€æŸ¥: å¿…é¡»åŒæ—¶åŒ…å«æ•°å­—ã€å­—æ¯å’Œç‰¹æ®Šå­—ç¬¦
        var pwd = document.getElementById('reg_pwd').value;
        // æ­£åˆ™è¯´æ˜:
        // (?=.*\d) å¿…é¡»åŒ…å«æ•°å­—
        // (?=.*[a-zA-Z]) å¿…é¡»åŒ…å«å­—æ¯
        // (?=.*[\W_]) å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦ (éå•è¯å­—ç¬¦æˆ–ä¸‹åˆ’çº¿)
        var pwdRegex = /^(?=.*\d)(?=.*[a-zA-Z])(?=.*[\W_]).+$/;

        if (!pwdRegex.test(pwd)) {
            alert("æ³¨å†Œå¤±è´¥ï¼šå¯†ç å¼ºåº¦ä¸è¶³ã€‚\n\nå¯†ç å¿…é¡»åŒæ—¶åŒ…å«ï¼š\n1. æ•°å­—\n2. å­—æ¯\n3. ç‰¹æ®Šå­—ç¬¦ (å¦‚ @, #, !, % ç­‰)");
            return false;
        }

        return true;
    }
</script>

</body>
</html>
```
---

### ğŸ“„ app\templates\base.html
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}NCEPU Library OS{% endblock %}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --brand-primary: #2563eb;
            --glass-sidebar-bg: rgba(15, 23, 42, 0.65);
            --glass-sidebar-border: rgba(255, 255, 255, 0.5);
            --shadow-float: 0 20px 50px -12px rgba(0, 0, 0, 0.1), 0 0 1px rgba(255, 255, 255, 0.1) inset;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body {
            height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background: radial-gradient(circle at 10%, rgba(56, 189, 248, 0.4) 0%, transparent 40%),
                        radial-gradient(circle at 90%, rgba(139, 92, 246, 0.4) 0%, transparent 40%),
                        radial-gradient(circle at 50%, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 1) 100%),
                        url('../static/asset/BG3.png') no-repeat center/cover;
            background-blend-mode: overlay;
        }
        .app-container { width: 96vw; height: 94vh; max-width: 1800px; border-radius: 28px; display: flex; position: relative; overflow: hidden; background: rgba(255, 255, 255, 0.02); box-shadow: var(--shadow-float); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar { width: 400px; height: 100%; position: relative; z-index: 10; display: flex; flex-direction: column; padding: 32px 24px; color: white; background: var(--glass-sidebar-bg); backdrop-filter: blur(30px) saturate(180%) brightness(110%); border-right: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1); }
        .sidebar::before { content: ''; position: absolute; inset: 0; z-index: -1; opacity: 0.07; background-image: linear-gradient(rgba(255,255,255,0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.5) 1px, transparent 1px); background-size: 20px 20px; mask-image: linear-gradient(to bottom, black 40%, transparent 100%); }
        .sidebar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent); }
        .brand { display: flex; align-items: center; margin-bottom: 50px; padding-left: 5px; height: 60px; }
        .brand-logo-img { height: 100%; width: auto; max-width: 100%; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .nav-menu { flex: 1; }
        .menu-label { font-size: 11px; color: rgba(255,255,255,0.4); margin: 0 10px; font-weight: 600; letter-spacing: 1px; }
        .nav-item { display: flex; align-items: center; padding: 14px 16px; margin-bottom: 6px; border-radius: 14px; color: rgba(255,255,255,0.75); text-decoration: none; transition: all 0.3s; position: relative; overflow: hidden; font-size: 14px; font-weight: 500; }
        .nav-item i { width: 24px; margin-right: 10px; font-size: 16px; transition: 0.3s; color: rgba(255,255,255,0.6); }
        .nav-item:hover { background: rgba(255, 255, 255, 0.08); color: white; }
        .nav-item:hover i { transform: scale(1.1); color: #fff; }
        .nav-item.active { background: linear-gradient(90deg, rgba(37, 99, 235, 0.3), rgba(37, 99, 235, 0.1)); color: white; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.1); }
        .nav-item.active::before { content:''; position: absolute; left: 0; top: 12px; bottom: 12px; width: 3px; background: #60a5fa; border-radius: 0 4px 4px 0; box-shadow: 0 0 10px #60a5fa; }
        .nav-item.active i { color: #60a5fa; }
        .main-content { flex: 1; background: rgba(245, 247, 250, 0.92); backdrop-filter: blur(40px); position: relative; display: flex; flex-direction: column; border-top-left-radius: 0px; }
        .top-bar { height: 72px; padding: 0 36px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.04); background: rgba(255,255,255,0.7); backdrop-filter: blur(15px); position: sticky; top: 0; z-index: 50; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 36px; }
        .card { background: #ffffff; border-radius: 20px; padding: 28px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 10px 15px -3px rgba(0, 0, 0, 0.04); border: 1px solid rgba(0,0,0,0.02); margin-bottom: 30px; transition: transform 0.3s, box-shadow 0.3s; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 20px 30px -4px rgba(0, 0, 0, 0.08); }
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .card-title { font-size: 18px; font-weight: 700; color: #1e293b; letter-spacing: -0.5px; }
        .btn-glow { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 10px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.35); transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-glow:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.5); }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 36px; }
        .stat-item { background: #fff; padding: 24px; border-radius: 18px; display: flex; flex-direction: column; box-shadow: 0 2px 10px rgba(0,0,0,0.02); position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,1); }
        .stat-item::before { content: ''; position: absolute; right: -20px; top: -20px; width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, rgba(59,130,246,0.1), transparent); }
        .stat-num { font-size: 32px; font-weight: 700; color: #0f172a; margin-top: 12px; line-height: 1; }
        .stat-label { font-size: 13px; color: #64748b; font-weight: 500; }
        .stat-icon-wrapper { width: 40px; height: 40px; border-radius: 10px; background: #eff6ff; color: #3b82f6; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .clean-table { width: 100%; border-collapse: collapse; }
        .clean-table th { text-align: left; padding: 16px; color: #94a3b8; font-size: 12px; font-weight: 600; text-transform: uppercase; border-bottom: 1px solid #f1f5f9; }
        .clean-table td { padding: 20px 16px; border-bottom: 1px solid #f8fafc; color: #334155; font-size: 14px; }
        .clean-table tr:hover td { background: #f8fafc; }
        .alert { padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 12px; }
        .alert-error { color: #a94442; background-color: #f2dede; border-color: #ebccd1; }
        .alert-success { color: #3c763d; background-color: #dff0d8; border-color: #d6e9c6; }
        .alert-warning { color: #8a6d3b; background-color: #fcf8e3; border-color: #faebcc; }

        .ios-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .ios-modal-overlay.open { display: flex; opacity: 1; }
        .ios-modal { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.5) inset; width: 500px; max-width: 90vw; transform: scale(0.95) translateY(10px); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); overflow: hidden; display: flex; flex-direction: column; max-height: 80vh; }
        .ios-modal-overlay.open .ios-modal { transform: scale(1) translateY(0); }
        .ios-modal-header { padding: 16px 24px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.5); }
        .ios-modal-title { font-size: 17px; font-weight: 600; color: #1d1d1f; }
        .ios-modal-close { cursor: pointer; color: #86868b; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.05); border-radius: 50%; }
        .ios-modal-body { padding: 0; overflow-y: auto; flex: 1; }
        .notice-list { list-style: none; }
        .notice-item { padding: 16px 24px; border-bottom: 1px solid rgba(0,0,0,0.05); transition: background 0.2s; cursor: default; }
        .notice-item:hover { background: rgba(255,255,255,0.6); }
        .notice-msg { background: #eff6ff; border-left: 4px solid #3b82f6; }
        .notice-top-tag, .msg-tag { display: inline-block; padding: 2px 6px; color: white; font-size: 10px; border-radius: 4px; font-weight: 600; margin-right: 6px; vertical-align: middle; }
        .notice-top-tag { background: #ef4444; } .msg-tag { background: #3b82f6; }
        .notice-title { font-size: 15px; font-weight: 600; color: #1d1d1f; margin-bottom: 4px; }
        .notice-meta { font-size: 12px; color: #86868b; display: flex; justify-content: space-between; margin-bottom: 8px; }
        .notice-content { font-size: 14px; color: #4b5563; line-height: 1.5; white-space: pre-wrap; }
        .ios-form-group { padding: 24px; }


        .ios-btn-primary { width: 100%; padding: 12px; background: #007aff; color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: background 0.2s; }
        .ios-btn-primary:hover { background: #0062cc; }
        .notification-wrapper { position: relative; display: flex; align-items: center; margin-left: 15px; }
        .bell-icon-btn { position: relative; padding: 8px; cursor: pointer; transition: transform 0.2s; }
        .bell-icon-btn:hover { transform: scale(1.1); }
        .notification-dot { position: absolute; top: 6px; right: 6px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; border: 2px solid #fff; display: none; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4); animation: pulseDot 2s infinite; }
        @keyframes pulseDot { 0% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);} 70% {box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);} 100% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);} }
        .btn-icon-soft { width: 36px; height: 36px; border-radius: 50%; border: none; background: #f1f5f9; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; margin-right: 12px; }
        .btn-icon-soft:hover { background: #e2e8f0; color: #3b82f6; transform: translateY(-1px); }
        .ai-float-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #8b5cf6); box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4); display: flex; align-items: center; justify-content: center; color: white; font-size: 26px; cursor: pointer; z-index: 9999; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .ai-float-btn:hover { transform: scale(1.1) rotate(10deg); }
        .ai-chat-window { position: fixed; bottom: 100px; right: 30px; width: 650px; height: 750px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); display: none; flex-direction: column; z-index: 9999; overflow: hidden; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; }
        .ai-chat-window.active { display: flex; opacity: 1; transform: translateY(0); }
        .ai-header { padding: 16px 20px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .ai-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #f8fafc; }
        .msg-bubble { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .msg-user { align-self: flex-end; background: #6366f1; color: white; border-bottom-right-radius: 2px; }
        .msg-ai { align-self: flex-start; background: white; color: #334155; border: 1px solid #e2e8f0; border-bottom-left-radius: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .ai-input-area { padding: 15px; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; }
        .ai-input { flex: 1; border: 1px solid #e2e8f0; border-radius: 20px; padding: 10px 15px; font-size: 14px; outline: none; transition: border-color 0.2s; }
        .ai-input:focus { border-color: #6366f1; }
        .ai-send-btn { background: #6366f1; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .ai-send-btn:hover { background: #4f46e5; }

        /* å·¦ä¸‹è§’ç”¨æˆ·ä¿¡æ¯æ¡æ ·å¼ */
        .sidebar-footer {
            margin-top: auto; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 16px;
            backdrop-filter: blur(10px); transition: background 0.2s;
            display: flex; align-items: center; gap: 12px; /* å…³é”®ï¼šFlexå¸ƒå±€ */
        }
        .sidebar-footer:hover { background: rgba(0,0,0,0.3); }
        .user-profile-link {
            text-decoration: none; color: inherit; display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden;
            cursor: pointer;
        }


        /* ========================================= */
    /* [æ–°å¢] iOS å…¨å±€é«˜çº§è¾“å…¥æ¡†æ ·å¼ (Global Inputs) */
    /* ========================================= */

    /* 1. æ ¸å¿ƒæ ·å¼ï¼šè¦†ç›–æ‰€æœ‰æ–‡æœ¬ç±»è¾“å…¥æ§ä»¶ */
    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="datetime-local"],
    input[type="search"],
    select,
    textarea,
    .form-control,
    .ios-input,    /* å…¼å®¹æ—§ç±»å */
    .search-input  /* å…¼å®¹æ—§ç±»å */
    {
        width: 100%;
        padding: 12px 16px;           /* èˆ’é€‚çš„å†…è¾¹è·ï¼Œæ‰‹æŒ‡è§¦æ§å‹å¥½ */
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
        font-size: 14px;
        line-height: 1.5;
        color: #1d1d1f;               /* Apple æ·±ç°æ–‡å­— */

        /* ç£¨ç ‚ç»ç’ƒè´¨æ„ŸèƒŒæ™¯ */
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);

        /* è¾¹æ¡†ä¸åœ†è§’ */
        border: 1px solid #d2d2d7;    /* ç»†è…»çš„ç°è‰²è¾¹æ¡† */
        border-radius: 12px;          /* iOS æ ‡å‡†å¤§åœ†è§’ */

        /* æ¶ˆé™¤é»˜è®¤æ ·å¼ */
        outline: none;
        -webkit-appearance: none;
        appearance: none;

        /* å¹³æ»‘è¿‡æ¸¡åŠ¨ç”» */
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02); /* æå¾®å¼±çš„ç«‹ä½“æ„Ÿ */
        margin-bottom: 15px; /* ç»Ÿä¸€é—´è· */
    }

    /* 2. æ‚¬åœçŠ¶æ€ (Hover) */
    input:hover, select:hover, textarea:hover {
        background-color: #ffffff;    /* æ‚¬åœæ—¶å˜çº¯ç™½ */
        border-color: #86868b;        /* è¾¹æ¡†è½»å¾®åŠ æ·± */
    }

    /* 3. èšç„¦çŠ¶æ€ (Focus) - æ ¸å¿ƒäº¤äº’ä½“éªŒ */
    input:focus, select:focus, textarea:focus {
        background-color: #ffffff;
        border-color: #007aff;        /* iOS å®˜æ–¹è“ */
        /* è“è‰²æŸ”å…‰æ‰©æ•£å…‰æ™• */
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
        transform: translateY(-1px);  /* æå¾®å°çš„ä¸Šæµ®åé¦ˆ */
    }

    /* 4. å ä½ç¬¦ (Placeholder) */
    ::placeholder {
        color: #86868b;
        opacity: 0.8;
        font-weight: 400;
    }

    /* 5. ä¸‹æ‹‰èœå• (Select) ä¸“å±ç¾åŒ– */
    select {
        /* è‡ªå®šä¹‰ SVG ç®­å¤´ï¼Œæ›¿æ¢æµè§ˆå™¨é»˜è®¤ä¸‘å›¾æ ‡ */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24' stroke='%2386868b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 14px;
        padding-right: 40px; /* ç»™ç®­å¤´ç•™å‡ºç©ºé—´ */
        cursor: pointer;
    }

    /* 6. æ–‡æœ¬åŸŸ (Textarea) è°ƒæ•´ */
    textarea {
        min-height: 100px;
        resize: vertical; /* ä»…å…è®¸å‚ç›´æ‹‰ä¼¸ */
    }

    /* 7. ç‰¹æ®Šåœºæ™¯ä¿®æ­£ï¼šè¡¨æ ¼å†…çš„è¾“å…¥æ¡† (å¦‚è®¢å•ä¿®æ”¹æ•°é‡) */
    table input, .clean-table input {
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 13px;
        margin-bottom: 0;
        background-color: #fff;
        border-color: #e5e5ea;
        box-shadow: none;
    }
    table input:focus {
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<div class="ai-float-btn" onclick="toggleChat()" title="AI æ™ºèƒ½åŠ©æ‰‹">
    <i class="fas fa-robot"></i>
</div>

<div class="ai-chat-window" id="aiWindow">
    <div class="ai-header" style="padding:16px 20px; background:linear-gradient(135deg,#6366f1,#8b5cf6); color:white; font-weight:600; display:flex; justify-content:space-between; align-items:center;">
        <span><i class="fas fa-sparkles"></i> AIåŠ©æ‰‹</span><i class="fas fa-times" style="cursor:pointer;" onclick="toggleChat()"></i>
    </div>
    <div class="ai-messages" id="aiMessages" style="flex:1; padding:20px; overflow-y:auto; background:#f8fafc;"></div>
    <div class="ai-input-area" style="padding:15px; background:white; display:flex; gap:10px;">
        <input type="text" id="aiInput" style="flex:1; border:1px solid #e2e8f0; border-radius:20px; padding:10px 15px; outline:none;" placeholder="Ask me...">
        <button onclick="sendMessage()" style="background:#6366f1; color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div class="ios-modal-overlay" id="noticePublishModal"><div class="ios-modal"><div class="ios-modal-header"><div class="ios-modal-title">å…¬å‘Š</div><div class="ios-modal-close" onclick="closeModal('noticePublishModal')"><i class="fas fa-times"></i></div></div><div class="ios-modal-body"><div class="ios-form-group"><input id="noticeTitle" class="ios-input" placeholder="æ ‡é¢˜"><textarea id="noticeContent" class="ios-input" rows="4" placeholder="å†…å®¹"></textarea><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><input type="checkbox" id="noticeTop"><label>ç½®é¡¶</label></div><button class="ios-btn-primary" onclick="submitNotice()">å‘å¸ƒ</button></div></div></div></div>
<div class="ios-modal-overlay" id="messageModal"><div class="ios-modal"><div class="ios-modal-header"><div class="ios-modal-title">ç•™è¨€</div><div class="ios-modal-close" onclick="closeModal('messageModal')"><i class="fas fa-times"></i></div></div><div class="ios-modal-body"><div class="ios-form-group"><textarea id="messageContent" class="ios-input" rows="4"></textarea><button class="ios-btn-primary" onclick="submitMessage()">å‘é€</button></div></div></div></div>
<div class="ios-modal-overlay" id="noticeListModal"><div class="ios-modal"><div class="ios-modal-header"><div class="ios-modal-title">é€šçŸ¥å…¬å‘Š</div><div class="ios-modal-close" onclick="closeModal('noticeListModal')"><i class="fas fa-times"></i></div></div><div class="ios-modal-body"><ul id="noticeUl" style="list-style:none;"></ul></div></div></div>


<script>
    // æ›´æ–° submitNotice å‡½æ•°ä»¥åŒ…å« include_overdue å‚æ•°
    async function submitNotice() {
        const title = document.getElementById('noticeTitle').value;
        const content = document.getElementById('noticeContent').value;
        const isTop = document.getElementById('noticeTop').checked;
        const includeOverdue = document.getElementById('noticeOverdue').checked; // è·å–é€‰ä¸­çŠ¶æ€

        if(!title) return alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º'); // content å¯ä»¥ä¸ºç©ºï¼Œå› ä¸ºå¯èƒ½åªå‘æŠ¥è¡¨

        await fetch("{{ url_for('notice.publish') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title, content, is_top: isTop, include_overdue: includeOverdue})
        });
        alert('å·²æˆåŠŸå‘å¸ƒ!');
        closeModal('noticePublishModal');
        // æ¸…ç©ºè¡¨å•
        document.getElementById('noticeTitle').value = '';
        document.getElementById('noticeContent').value = '';
        document.getElementById('noticeTop').checked = false;
        document.getElementById('noticeOverdue').checked = false;
    }


    function openModal(id) { document.getElementById(id).classList.add('open'); if(id === 'noticeListModal') fetchNotices(); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }

    let isChatOpen = false, isHistoryLoaded = false;
    function toggleChat() { const win = document.getElementById('aiWindow'); isChatOpen = !isChatOpen; if (isChatOpen) { win.classList.add('active'); if (!isHistoryLoaded) { loadHistory(); isHistoryLoaded=true; } } else { win.classList.remove('active'); } }
    async function loadHistory() { try { const res = await fetch("{{ url_for('ai.history') }}"); const data = await res.json(); if(data.history) { const c = document.getElementById('aiMessages'); c.innerHTML=''; data.history.forEach(m => appendMessage(m.role, m.content)); } } catch(e){} }
    function appendMessage(role, content) { const c = document.getElementById('aiMessages'); const d = document.createElement('div'); d.className = `msg-bubble ${role==='user'?'msg-user':'msg-ai'}`; d.innerHTML = content.replace(/\n/g, '<br>'); c.appendChild(d); c.scrollTop = c.scrollHeight; }
    function handleEnter(e) { if(e.key==='Enter') sendMessage(); }
    async function sendMessage() { const inp = document.getElementById('aiInput'); const text = inp.value.trim(); if(!text) return; appendMessage('user', text); inp.value = ''; try { const res = await fetch("{{ url_for('ai.ask') }}", {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:text})}); const data = await res.json(); appendMessage('assistant', data.reply); } catch(e) { appendMessage('assistant', 'Error connecting to AI.'); } }

    async function fetchNotices() {
        const ul = document.getElementById('noticeUl'); ul.innerHTML = '<li style="padding:20px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</li>';
        try {
            const res = await fetch("{{ url_for('notice.get_latest') }}");
            const data = await res.json();
            ul.innerHTML = '';
            if(data.notices && data.notices.length > 0) {
                data.notices.forEach(n => {
                    const li = document.createElement('li');
                    li.className = `notice-item ${n.type === 'message' ? 'notice-msg' : ''}`;
                    let tagHtml = '';
                    if(n.is_top) tagHtml += '<span class="notice-top-tag">ç½®é¡¶</span>';
                    if(n.type === 'message') tagHtml += '<span class="msg-tag">ç•™è¨€</span>';
                    li.innerHTML = `<div class="notice-title">${tagHtml}${n.title}</div><div class="notice-meta"><span>${n.publisher}</span><span>${n.date}</span></div><div class="notice-content">${n.content}</div>${n.type === 'message' && !n.is_read ? `<div style="text-align:right; margin-top:5px;"><button onclick="markRead(${n.id}, this)" style="font-size:11px; padding:2px 8px; border:1px solid #ccc; background:white; border-radius:4px; cursor:pointer;">æ ‡è®°å·²è¯»</button></div>` : ''}`;
                    ul.appendChild(li);
                });
                localStorage.setItem('last_notice_read_time', Date.now()); document.getElementById('noticeDot').style.display = 'none';
            } else { ul.innerHTML = '<li style="padding:20px; text-align:center;">æš‚æ— é€šçŸ¥</li>'; }
        } catch(e) { ul.innerHTML = '<li>åŠ è½½é€šçŸ¥å¤±è´¥</li>'; }
    }

    async function submitNotice() { const title = document.getElementById('noticeTitle').value; const content = document.getElementById('noticeContent').value; const isTop = document.getElementById('noticeTop').checked; if(!title || !content) return alert('å†…å®¹ä¸èƒ½ä¸ºç©º'); await fetch("{{ url_for('notice.publish') }}", {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title, content, is_top:isTop})}); alert('å·²æˆåŠŸå‘å¸ƒ!'); closeModal('noticePublishModal'); }
    async function submitMessage() { const content = document.getElementById('messageContent').value; if(!content) return alert('å†…å®¹ä¸èƒ½ä¸ºç©º'); await fetch("{{ url_for('notice.leave_message') }}", {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content})}); alert('ç•™è¨€å·²å‘é€!'); document.getElementById('messageContent').value=''; closeModal('messageModal'); }
    async function markRead(msgId, btn) { await fetch("{{ url_for('notice.read_message') }}", {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({msg_id:msgId})}); btn.parentElement.parentElement.style.opacity = '0.5'; btn.innerHTML = 'å·²è¯»'; }

    window.addEventListener('load', async () => {
        {% if session.get('user_id') %}
        try { const res = await fetch("{{ url_for('notice.get_latest') }}"); const data = await res.json(); if(data.notices && data.notices.length > 0) { const latestTime = new Date(data.notices[0].date).getTime(); const lastRead = localStorage.getItem('last_notice_read_time') || 0; if(latestTime > lastRead) document.getElementById('noticeDot').style.display = 'block'; } } catch(e){}
        {% endif %}
    });
</script>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="brand"><img src="{{ url_for('static', filename='asset/NCEPU_LIB.png') }}" alt="ååŒ—ç”µåŠ›å¤§å­¦å›¾ä¹¦é¦†" class="brand-logo-img"></div>
            <nav class="nav-menu">
                {% if 'access_dashboard' in session.get('permissions', []) or 'root_access' in session.get('permissions', []) %}
                <div class="menu-label">DASHBOARD</div>
                <a href="{{ url_for('main.dashboard') }}" class="nav-item {% if request.endpoint == 'main.dashboard' %}active{% endif %}"><i class="fas fa-landmark"></i> <span>å›¾ä¹¦é¦†é¦–é¡µ Home</span></a>
                <a href="{{ url_for('main.search') }}" class="nav-item {% if request.endpoint == 'main.search' %}active{% endif %}"><i class="fas fa-book"></i> <span>å›¾ä¹¦æ£€ç´¢ Books</span></a>
                <a href="{{ url_for('main.library_map') }}" class="nav-item {% if request.endpoint == 'main.library_map' %}active{% endif %}"><i class="fas fa-map"></i> <span>é¦†è—åœ°å›¾ Map</span></a>
                {% endif %}

                {% if 'access_services' in session.get('permissions', []) or 'root_access' in session.get('permissions', []) %}
                <div class="menu-label" style="margin-top: 25px;">SERVICES</div>
                <a href="{{ url_for('acq.suggestion') }}" class="nav-item {% if request.endpoint == 'acq.suggestion' %}active{% endif %}"><i class="fas fa-pen-fancy"></i> <span>è¯»è€…èè´­ Suggest</span></a>
                <a href="{{ url_for('circ.history') }}" class="nav-item {% if request.endpoint == 'circ.history' %}active{% endif %}"><i class="fas fa-history"></i> <span>å€Ÿé˜…è®°å½• History</span></a>
                {% endif %}

                {% if 'manage_acq_order' in session.get('permissions', []) or 'manage_acq_arrival' in session.get('permissions', []) or 'manage_circulation' in session.get('permissions', []) or 'manage_users' in session.get('permissions', []) or 'root_access' in session.get('permissions', []) %}
                    <div class="menu-label" style="margin-top: 25px;">MANAGEMENT</div>

                    {% if 'manage_acq_order' in session.get('permissions', []) or 'root_access' in session.get('permissions', []) %}
                    <a href="{{ url_for('acq.order_process') }}" class="nav-item {% if request.endpoint == 'acq.order_process' %}active{% endif %}"><i class="fas fa-shopping-cart"></i> <span>è®¢å•ç®¡ç† Orders</span></a>
                    {% endif %}
                    {% if 'manage_acq_arrival' in session.get('permissions', []) or 'root_access' in session.get('permissions', []) %}
                    <a href="{{ url_for('acq.arrival_check') }}" class="nav-item {% if request.endpoint == 'acq.arrival_check' %}active{% endif %}"><i class="fas fa-box-open"></i> <span>éªŒæ”¶ä¸å…¥åº“ Receipt</span></a>
                    {% endif %}
                    {% if 'manage_circulation' in session.get('permissions', []) or 'root_access' in session.get('permissions', []) %}
                    <a href="{{ url_for('circ.workbench') }}" class="nav-item {% if request.endpoint == 'circ.workbench' %}active{% endif %}"><i class="fas fa-id-card-alt"></i> <span>æµé€šå·¥ä½œå° Circulation</span></a>
                    {% endif %}

                    {% if 'view_statistics' in session.get('permissions', []) or 'manage_circulation' in session.get('permissions', []) or 'root_access' in session.get('permissions', []) %}
                    <a href="{{ url_for('sys_admin.statistics') }}" class="nav-item {% if request.endpoint == 'sys_admin.statistics' %}active{% endif %}"><i class="fas fa-chart-pie"></i> <span>ç»Ÿè®¡åˆ†æ Analytics</span></a>
                    {% endif %}

                    {% if 'manage_users' in session.get('permissions', []) or 'root_access' in session.get('permissions', []) %}
                    <a href="{{ url_for('sys_admin.user_list') }}" class="nav-item {% if request.endpoint == 'sys_admin.user_list' %}active{% endif %}"><i class="fas fa-users-cog"></i> <span>ç”¨æˆ·ç®¡ç† Users</span></a>
                    {% endif %}

                    {% if 'config_system' in session.get('permissions', []) or 'root_access' in session.get('permissions', []) %}
                    <a href="{{ url_for('sys_admin.access_config') }}" class="nav-item {% if request.endpoint == 'sys_admin.access_config' %}active{% endif %}"><i class="fas fa-sliders-h"></i> <span>è§„åˆ™é…ç½® Config</span></a>
                    {% endif %}
                {% endif %}

            <div class="sidebar-footer">
                <a href="{{ url_for('main.profile') }}" class="user-profile-link" title="ä¸ªäººä¿¡æ¯è®¾ç½® / Profile Settings">
                    <img src="https://ui-avatars.com/api/?name={{ session.get('user_name', 'Guest') }}&background=0ea5e9&color=fff" style="width: 36px; height: 36px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2);">
                    <div style="flex: 1; overflow: hidden;">
                        <div style="font-size: 13px; font-weight: 600; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">{{ session.get('user_name', 'Please log in') }}</div>
                        <div style="font-size: 11px; opacity: 0.6;">{{ session.get('role_name', 'Visitor') }}</div>
                    </div>
                </a>

                {% if session.get('user_id') %}
                <a href="{{ url_for('auth.logout') }}" title="Logout" style="color: white; opacity: 0.7; padding-left: 8px; border-left: 1px solid rgba(255,255,255,0.2);"><i class="fas fa-sign-out-alt"></i></a>
                {% else %}
                <a href="{{ url_for('auth.login') }}" title="Login" style="color: white; opacity: 0.7;"><i class="fas fa-sign-in-alt"></i></a>
                {% endif %}
            </div>
        </aside>
        <main class="main-content">
            <header class="top-bar">
                <div style="font-size: 18px; font-weight: 600; color: #333;">{% block page_title %}Dashboard{% endblock %}</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    {% if session.get('user_id') %}
                    <button class="btn-icon-soft" onclick="openModal('messageModal')" title="ç»™ç®¡ç†å‘˜ç•™è¨€"><i class="far fa-envelope"></i></button>
                    {% endif %}
                    {% if 'publish_notice' in session.get('permissions', []) or 'root_access' in session.get('permissions', []) %}
                    <button class="btn-icon-soft" onclick="openModal('noticePublishModal')" title="å‘å¸ƒå…¬å‘Š"><i class="fas fa-plus"></i></button>
                    {% endif %}
                    {% if session.get('role_id', 1) >= 2 %}
                    <div class="notification-wrapper"><div class="bell-icon-btn" onclick="openModal('noticeListModal')"><i class="far fa-bell" style="font-size: 20px; color: #555;"></i><div class="notification-dot" id="noticeDot"></div></div></div>
                    {% endif %}
                </div>
            </header>
            <div class="content-scroll">
                {% with messages = get_flashed_messages(with_categories=true) %}
                  {% if messages %}{% for category, message in messages %}<div class="alert alert-{{ category }}">{{ message }}</div>{% endfor %}{% endif %}
                {% endwith %}
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
</body>
</html>
```
---

### ğŸ“„ app\templates\circ\history.html
```html
{% extends "base.html" %}
{% block page_title %}å€Ÿé˜…è®°å½• / History{% endblock %}

{% block content %}
<style>
    /* iOS Filter Bar (Clean White Style) */
    .filter-bar {
        background: #fff;
        border-radius: 16px;
        padding: 16px 20px;
        margin-bottom: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
        border: 1px solid rgba(0,0,0,0.03);
    }
    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #fff; /* å»é™¤ç°åº• */
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid #e5e5ea; /* æ·»åŠ ç»†è¾¹æ¡† */
        transition: all 0.2s;
    }
    .filter-group:focus-within {
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    .filter-input {
        border: none;
        background: transparent;
        font-size: 13px;
        color: #1d1d1f;
        outline: none;
        width: 140px;
    }
    .filter-select {
        border: none;
        background: transparent;
        font-size: 13px;
        color: #1d1d1f;
        outline: none;
        cursor: pointer;
        padding-right: 15px;
    }
    .search-btn {
        background: #007aff;
        color: white;
        border: none;
        padding: 8px 24px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        margin-left: auto;
        box-shadow: 0 2px 5px rgba(0, 122, 255, 0.2);
    }
    .search-btn:hover { background: #0062cc; }
</style>

<div class="ios-modal-overlay" id="extendModal">
    <div class="ios-modal">
        <div class="ios-modal-header">
            <div class="ios-modal-title">å»¶æœŸç”³è¯·</div>
            <div class="ios-modal-close" onclick="closeModal('extendModal')"><i class="fas fa-times"></i></div>
        </div>
        <div class="ios-modal-body">
            <form action="{{ url_for('circ.apply_extension') }}" method="POST" class="ios-form-group">
                <input type="hidden" name="borrow_id" id="modal_borrow_id">
                <label style="display:block; margin-bottom:8px; font-weight:600; color:#555;">å»¶æœŸå¤©æ•° (1-7å¤©)</label>
                <select name="days" class="ios-input">
                    <option value="1">1 å¤©</option>
                    <option value="3">3 å¤©</option>
                    <option value="5">5 å¤©</option>
                    <option value="7" selected>7 å¤©</option>
                </select>
                <label style="display:block; margin-bottom:8px; font-weight:600; color:#555;">ç”³è¯·ç†ç”±</label>
                <textarea name="reason" class="ios-input" rows="3" placeholder="ä¾‹å¦‚ï¼šè¯¾ç¨‹è®ºæ–‡éœ€è¦..." required></textarea>
                <button type="submit" class="ios-btn-primary" style="margin-top:15px;">æäº¤ç”³è¯·</button>
            </form>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header-row">
        <div class="card-title">æˆ‘çš„å€Ÿé˜…æµæ°´</div>
        <div style="font-size: 13px; color: #64748b;">
            å½“å‰ä¿¡ç”¨åˆ†: <strong style="color: {{ '#10b981' if current_credit >= 80 else '#ef4444' }}">{{ current_credit }}</strong>
        </div>
    </div>

    <form method="GET" action="{{ url_for('circ.history') }}" class="filter-bar" onsubmit="return validateDateRange()">
        <div class="filter-group">
            <i class="far fa-calendar-alt" style="color: #86868b; font-size: 12px;"></i>
            <input type="date" id="startDate" name="start_date" class="filter-input" value="{{ request.args.get('start_date', '') }}" placeholder="å¼€å§‹æ—¥æœŸ">
        </div>
        <span style="color: #d1d1d6;">-</span>
        <div class="filter-group">
            <i class="far fa-calendar-alt" style="color: #86868b; font-size: 12px;"></i>
            <input type="date" id="endDate" name="end_date" class="filter-input" value="{{ request.args.get('end_date', '') }}" placeholder="ç»“æŸæ—¥æœŸ">
        </div>
        <div class="filter-group">
            <i class="fas fa-search" style="color: #86868b; font-size: 12px;"></i>
            <input type="text" name="keyword" class="filter-input" placeholder="ä¹¦å / ä½œè€…..." value="{{ request.args.get('keyword', '') }}">
        </div>
        <div class="filter-group">
            <i class="fas fa-filter" style="color: #86868b; font-size: 12px;"></i>
            <select name="status" class="filter-select">
                <option value="all" {% if request.args.get('status') == 'all' %}selected{% endif %}>å…¨éƒ¨çŠ¶æ€</option>
                <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>å€Ÿé˜…ä¸­</option>
                <option value="returned" {% if request.args.get('status') == 'returned' %}selected{% endif %}>å·²å½’è¿˜</option>
            </select>
        </div>
        <button type="submit" class="search-btn">ç­›é€‰è®°å½•</button>
    </form>

    <table class="clean-table">
        <thead>
            <tr>
                <th>å›¾ä¹¦åç§°</th>
                <th>å€Ÿé˜…æ—¥æœŸ</th>
                <th>åº”è¿˜æ—¥æœŸ</th>
                <th>çŠ¶æ€</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for r in records %}
            <tr>
                <td>
                    <div style="font-weight: 600;">{{ r['BOOK_NAME'] }}</div>
                    <div style="font-size:12px; color:#888;">{{ r['AUTHOR'] }} ({{ r['CALL_NUMBER'] }})</div>
                </td>
                <td>{{ r['BORROW_DATE'] }}</td>
                <td>{{ r['DUE_DATE'] }}</td>
                <td>
                    {% if r['STATUS'] == 1 %}<span style="color:#10b981; font-weight:600; background:#ecfdf5; padding:2px 6px; border-radius:4px;">å€Ÿé˜…ä¸­</span>
                    {% elif r['STATUS'] == 3 %}<span style="color:#ef4444; font-weight:600; background:#fef2f2; padding:2px 6px; border-radius:4px;">å·²é€¾æœŸ</span>
                    {% else %}<span style="color:#64748b;">å·²å½’è¿˜</span>{% endif %}
                </td>
                <td>
                    {% if r['STATUS'] == 1 %}
                        {% if r['APP_STATUS'] == 0 %}
                            <span style="font-size:12px; color:#f59e0b;">å®¡æ ¸ä¸­</span>
                        {% elif r['APP_STATUS'] == 1 %}
                            <span style="font-size:12px; color:#10b981;">å·²å»¶æœŸ</span>
                        {% elif r['APP_STATUS'] == 2 %}
                            <span style="font-size:12px; color:#ef4444;">å·²æ‹’ç»</span>
                        {% else %}
                            <button class="btn-glow" style="padding:4px 10px; font-size:12px;" onclick="openExtendModal('{{ r.BORROW_ID }}')">ç”³è¯·å»¶æœŸ</button>
                        {% endif %}
                    {% else %}
                        <span style="color: #ccc;">-</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                    <i class="fas fa-search" style="font-size: 32px; margin-bottom: 10px; opacity: 0.3;"></i><br>
                    æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å€Ÿé˜…è®°å½•
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    function openExtendModal(borrowId) { document.getElementById('modal_borrow_id').value = borrowId; document.getElementById('extendModal').classList.add('open'); }

    function validateDateRange() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;

        if (start && end) {
            if (new Date(start) > new Date(end)) {
                alert("æ—¥æœŸé”™è¯¯ï¼šå¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸã€‚");
                return false;
            }
        }
        return true;
    }
</script>
{% endblock %}
```
---

### ğŸ“„ app\templates\circ\workbench.html
```html
{% extends "base.html" %}
{% block page_title %}æµé€šå·¥ä½œå° / Circulation Desk{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 30px; align-items: stretch;">

    <div class="card" style="border-top: 4px solid var(--brand-primary); display: flex; flex-direction: column; height: 100%;">
        <div class="card-header-row" style="margin-bottom: 20px;">
            <div class="card-title"><i class="fas fa-upload" style="margin-right: 8px;"></i> å€Ÿä¹¦ (Check Out)</div>
        </div>
        <form method="POST" style="display: flex; flex-direction: column; flex: 1;">
            <input type="hidden" name="action" value="borrow">

            <div style="margin-bottom: 15px;">
    <label style="font-weight:600; font-size: 13px; color: #64748b; margin-bottom: 6px; display: block;">è¯»è€…ID</label>
    <input type="text" name="reader_id" class="search-input" placeholder="è¯·æ‰«ææˆ–è¾“å…¥å­¦å·/å·¥å·" required
           style="margin-bottom: 0;"
           pattern="^(\d{8}|\d{12})$"
           title="è¯»è€…IDåªèƒ½ä¸º 8 ä½æˆ–è€… 12 ä½æ•°å­—">
</div>

            <div style="margin-bottom: 20px;">
    <label style="font-weight:600; font-size: 13px; color: #64748b; margin-bottom: 6px; display: block;">å›¾ä¹¦æ¡ç </label>
    <input type="text" name="barcode" class="search-input" placeholder="è¯·æ‰«æå›¾ä¹¦æ¡å½¢ç " required
           style="margin-bottom: 0;"
           pattern="^\d{6}-\d{4}-\d{3}-\d{1}$"
           title="æ¡ç æ ¼å¼å¿…é¡»ä¸º xxxxxx-xxxx-xxx-x (å…¨æ•°å­—)">
</div>

            <button type="submit" class="btn-glow" style="width:100%; margin-top: auto; justify-content: center;">
                <i class="fas fa-check"></i> ç¡®è®¤å€Ÿé˜…
            </button>
        </form>
    </div>

    <div class="card" style="border-top: 4px solid #10b981; display: flex; flex-direction: column; height: 100%;">
        <div class="card-header-row" style="margin-bottom: 20px;">
            <div class="card-title"><i class="fas fa-download" style="margin-right: 8px;"></i> è¿˜ä¹¦ (Check In)</div>
        </div>
        <form method="POST" style="display: flex; flex-direction: column; flex: 1;">
            <input type="hidden" name="action" value="return">

            <div style="margin-bottom: 20px;">
                <label style="font-weight:600; font-size: 13px; color: #64748b; margin-bottom: 6px; display: block;">å›¾ä¹¦æ¡ç </label>
                <input type="text" name="barcode" class="search-input" placeholder="è¯·æ‰«æå›¾ä¹¦æ¡å½¢ç " required style="margin-bottom: 0;">
            </div>

            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 20px; line-height: 1.5; background: #f8fafc; padding: 10px; border-radius: 8px;">
                <i class="fas fa-info-circle"></i> ç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—é€¾æœŸç½šæ¬¾å¹¶æ›´æ–°å›¾ä¹¦çŠ¶æ€ã€‚
            </div>

            <button type="submit" class="btn-glow" style="width:100%; margin-top: auto; background: linear-gradient(135deg, #10b981, #059669); justify-content: center;">
                <i class="fas fa-box-open"></i> ç¡®è®¤å½’è¿˜
            </button>
        </form>
    </div>

    <div class="card" style="border-top: 4px solid #ef4444; display: flex; flex-direction: column; height: 100%;">
        <div class="card-header-row" style="margin-bottom: 20px;">
            <div class="card-title"><i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i> æŠ¥æŸ (Damage)</div>
        </div>
        <form method="POST" onsubmit="return confirm('ç¡®å®šè¦æ ‡è®°æ­¤ä¹¦ä¸ºæŠ¥æŸ/ä¸¢å¤±å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼');" style="display: flex; flex-direction: column; flex: 1;">
            <input type="hidden" name="action" value="report_damage">

            <div style="margin-bottom: 15px;">
                <label style="font-weight:600; font-size: 13px; color: #64748b; margin-bottom: 6px; display: block;">å›¾ä¹¦æ¡ç </label>
                <input type="text" name="barcode" class="search-input" placeholder="è¯·æ‰«æå›¾ä¹¦æ¡å½¢ç " required style="margin-bottom: 0;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-weight:600; font-size: 13px; color: #64748b; margin-bottom: 6px; display: block;">æŠ¥æŸåŸå› </label>
                <input type="text" name="reason" class="search-input" placeholder="ä¾‹å¦‚ï¼šç¼ºé¡µã€æ°´æµ¸ã€ä¸¢å¤±..." required style="margin-bottom: 0;">
            </div>

            <button type="submit" class="btn-glow" style="width:100%; margin-top: auto; background: linear-gradient(135deg, #ef4444, #b91c1c); justify-content: center;">
                <i class="fas fa-ban"></i> ç¡®è®¤æŠ¥æŸ
            </button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-title" style="margin-bottom: 20px;"><i class="fas fa-tasks" style="color: #3b82f6; margin-right: 8px;"></i> å»¶æœŸç”³è¯·å®¡æ‰¹</div>
    <table class="clean-table">
        <thead>
            <tr>
                <th width="15%">ç”³è¯·äºº</th>
                <th width="25%">å›¾ä¹¦</th>
                <th width="10%">ç”³è¯·å¤©æ•°</th>
                <th width="30%">ç†ç”±</th>
                <th width="20%">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for app in pending_apps %}
            <tr>
                <td>
                    <div style="font-weight: 500;">{{ app['READER_NAME'] }}</div>
                    <div style="font-size: 12px; color: #94a3b8;">ID: {{ app['READER_ID'] }}</div>
                </td>
                <td>{{ app['BOOK_NAME'] }}</td>
                <td><span style="font-weight:bold; color:#3b82f6; background:#eff6ff; padding:2px 8px; border-radius:4px;">+{{ app['APPLY_DAYS'] }} å¤©</span></td>
                <td style="color:#666;">{{ app['REASON'] }}</td>
                <td>
                    <form method="POST" style="display: flex; gap: 8px;">
                        <input type="hidden" name="action" value="review_extension">
                        <input type="hidden" name="app_id" value="{{ app['APP_ID'] }}">
                        <button type="submit" name="decision" value="approve" class="btn-glow" style="padding: 6px 12px; font-size: 12px; background: #10b981; box-shadow: none;">é€šè¿‡</button>
                        <button type="submit" name="decision" value="reject" class="btn-glow" style="padding: 6px 12px; font-size: 12px; background: #ef4444; box-shadow: none;">æ‹’ç»</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="5" style="text-align:center; padding: 40px; color:#999;">æš‚æ— å¾…å®¡æ‰¹çš„å»¶æœŸç”³è¯·</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <div class="card-title" style="color:#ef4444; margin-bottom: 20px;"><i class="fas fa-history" style="margin-right: 8px;"></i> å›¾ä¹¦æŠ¥æŸè®°å½• / Damage Log</div>
    <table class="clean-table">
        <thead>
            <tr><th>æ¡ç </th><th>ä¹¦å</th><th>åŸå› </th><th>ç»æ‰‹äºº</th><th>æ—¶é—´</th></tr>
        </thead>
        <tbody>
            {% for log in damage_logs %}
            <tr>
                <td style="font-family:monospace; color: #1e293b;">{{ log['BARCODE'] }}</td>
                <td>{{ log['BOOK_NAME'] }}</td>
                <td>{{ log['REASON'] }}</td>
                <td><span style="background:#f1f5f9; padding:2px 6px; border-radius:4px; font-size:12px;">{{ log['HANDLER'] }}</span></td>
                <td style="color:#888; font-size:12px;">{{ log['LOG_DATE'] }}</td>
            </tr>
            {% else %}
            <tr><td colspan="5" style="text-align:center; padding: 30px; color:#999;">æš‚æ— æŠ¥æŸè®°å½•</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
```
---

### ğŸ“„ app\templates\components\map_widget.html
```html
{% macro render_map(map_data, container_height="600px") %}
<style>
    /* --- Digital Twin Map Container (iOS Style) --- */
    .dt-wrapper {
        position: relative;
        width: 100%;
        height: {{ container_height }};
        background: #f5f5f7; /* Apple System Gray 6 */
        border-radius: 24px;
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.08);
        box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    }

    /* Floor Control (Floating Segmented Control) */
    .dt-controls {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        display: flex; background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        padding: 4px; border-radius: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.04);
        z-index: 10;
    }
    .dt-tab {
        padding: 8px 24px; border-radius: 20px; font-size: 14px;
        font-weight: 600;
        cursor: pointer; color: #86868b; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex; align-items: center; gap: 6px;
    }
    .dt-tab.active {
        background: white; color: #1d1d1f;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .dt-tab:hover:not(.active) { color: #1d1d1f; }

    /* Map Canvas */
    .dt-canvas {
        width: 100%;
        height: 100%;
        display: flex; align-items: center; justify-content: center;
        perspective: 1000px; /* 3D Perspective */
    }

    .floor-view {
        position: absolute;
        width: 100%; height: 100%;
        opacity: 0; pointer-events: none;
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        transform: scale(0.95) translateY(10px);
        display: flex;
        align-items: center; justify-content: center;
    }
    .floor-view.active {
        opacity: 1;
        pointer-events: all;
        transform: scale(1) translateY(0);
    }

    /* Shelf Elements */
    .shelf-group { cursor: pointer; transition: transform 0.3s; }
    .shelf-group:hover { transform: translateY(-2px); }

    .shelf-body {
        stroke: white; stroke-width: 2;
        vector-effect: non-scaling-stroke;
        filter: url(#shelfShadow);
        transition: fill 0.3s ease;
    }

    /* Heatmap Colors (Dynamic Fill) */
    .fill-level-0 { fill: #e5e7eb; } /* Empty */
    .fill-level-1 { fill: #dbeafe; } /* Low */
    .fill-level-2 { fill: #93c5fd; } /* Med */
    .fill-level-3 { fill: #3b82f6; } /* High */
    .fill-level-4 { fill: #2563eb; } /* Full */

    /* Target Shelf Styling (High Contrast for Selected Shelf) */
    .target-shelf-body {
        stroke: #ef4444 !important; /* Red Border */
        stroke-width: 3;
        fill: #fee2e2 !important; /* Light Red Fill */
    }

    /* --- [å…³é”®ä¿®æ”¹] æ–°çš„çŸ©å½¢æ³¢çº¹åŠ¨ç”»é€»è¾‘ --- */
    .ripple-rect {
        fill: none;
        stroke: #ef4444; /* çº¢è‰²æ³¢çº¹ */
        stroke-width: 2;
        opacity: 0;

        /* æ ¸å¿ƒï¼šç¡®ä¿å˜æ¢åŸºäºå…ƒç´ è‡ªèº«çš„è¾¹ç•Œæ¡†ä¸­å¿ƒ */
        transform-box: fill-box;
        transform-origin: center;

        animation: rippleExpand 2s infinite cubic-bezier(0, 0.2, 0.5, 1);
        pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€æ³¢çº¹å±‚ */
    }

    /* ç¬¬äºŒå±‚å»¶è¿Ÿæ³¢çº¹ï¼Œå¢åŠ å›å£°è´¨æ„Ÿ */
    .ripple-rect-delay {
        animation-delay: 0.6s;
    }

    @keyframes rippleExpand {
        0% {
            opacity: 0.8;
            transform: scale(1); /* ä»åŸå§‹å¤§å°å¼€å§‹ */
            stroke-width: 4px;
        }
        100% {
            opacity: 0;
            transform: scale(1.4); /* å‘å››å‘¨å‡åŒ€æ‰©å¤§ 40% */
            stroke-width: 0px;
        }
    }

    /* Pin Marker Animation */
    .pin-marker {
        animation: bouncePin 2s infinite;
        transform-origin: bottom center;
        /* ç¡®ä¿ Pin ä¹Ÿæ˜¯ç›¸å¯¹äºè‡ªèº«ä½ç½®è·³åŠ¨ */
        transform-box: fill-box;
    }
    @keyframes bouncePin {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }

    /* HUD Info Overlay */
    .dt-info-panel {
        position: absolute;
        bottom: 30px; left: 30px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        padding: 16px 24px; border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.05);
        display: none; animation: slideUp 0.3s ease;
        z-index: 20; min-width: 200px;
    }
    @keyframes slideUp { from {transform: translateY(10px); opacity:0;} to {transform: translateY(0); opacity:1;} }

    .info-title { font-size: 16px; font-weight: 700; color: #1d1d1f; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .info-stat { font-size: 13px; color: #86868b; display: flex; justify-content: space-between; margin-top: 8px; }
    .info-bar { height: 4px; background: #f5f5f7; border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .info-bar-fill { height: 100%; background: #3b82f6; width: 0%; transition: width 0.5s; }

    /* Legend */
    .dt-legend {
        position: absolute;
        bottom: 30px; right: 30px;
        display: flex; gap: 15px; align-items: center;
        font-size: 12px; color: #86868b;
        background: rgba(255,255,255,0.6); padding: 8px 16px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
    }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
</style>

<div class="dt-wrapper">
    <div class="dt-controls">
        <div class="dt-tab {{ 'active' if map_data.target_floor == 1 else '' }}" onclick="switchFloor(1)">
            <i class="fas fa-layer-group"></i> 1F äººæ–‡ç¤¾ç§‘
        </div>
        <div class="dt-tab {{ 'active' if map_data.target_floor == 2 else '' }}" onclick="switchFloor(2)">
            <i class="fas fa-flask"></i> 2F è‡ªç„¶ç§‘å­¦
        </div>
    </div>

    <div class="dt-canvas">
        <svg style="position: absolute; width:0; height:0;">
            <defs>
                <filter id="shelfShadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="0" dy="4" stdDeviation="4" flood-color="#000" flood-opacity="0.1"/>
                </filter>
                <pattern id="gridPattern" width="40" height="40" patternUnits="userSpaceOnUse">
                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#e5e7eb" stroke-width="0.5"/>
                </pattern>
            </defs>
        </svg>

        {% for floor_num in [1, 2] %}
        <div class="floor-view {{ 'active' if map_data.target_floor == floor_num else '' }}" id="floor-{{ floor_num }}">
            <svg viewBox="0 0 1000 600" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
                <rect x="0" y="0" width="1000" height="600" fill="url(#gridPattern)" opacity="0.6"/>

                {% for zone in map_data.zones if zone.floor == floor_num %}
                    {% set fill_class = 'fill-level-0' %}
                    {% if zone.intensity > 0.8 %} {% set fill_class = 'fill-level-4' %}
                    {% elif zone.intensity > 0.5 %} {% set fill_class = 'fill-level-3' %}
                    {% elif zone.intensity > 0.2 %} {% set fill_class = 'fill-level-2' %}
                    {% elif zone.intensity > 0 %} {% set fill_class = 'fill-level-1' %}
                    {% endif %}

                    <g class="shelf-group"
                       onclick="showZoneInfo('{{ zone.name }}', {{ zone.count }}, {{ zone.intensity }}, '{{ zone.icon }}')"
                       onmouseenter="highlightShelf(this)" onmouseleave="unhighlightShelf(this)">

                        <rect x="{{ zone.x }}" y="{{ zone.y }}" width="{{ zone.w }}" height="{{ zone.h }}" rx="6"
                              class="shelf-body {{ fill_class }} {{ 'target-shelf-body' if zone.id == map_data.target_zone_id else '' }}">
                        </rect>

                        <text x="{{ zone.x + zone.w/2 }}" y="{{ zone.y + zone.h/2 }}"
                              text-anchor="middle" dominant-baseline="middle"
                              fill="#1d1d1f" font-weight="700" font-size="16"
                              style="pointer-events:none; opacity: 0.8;">
                            {{ zone.id }}
                        </text>

                        {% if zone.id == map_data.target_zone_id %}
                            <rect x="{{ zone.x }}" y="{{ zone.y }}"
                                  width="{{ zone.w }}" height="{{ zone.h }}"
                                  rx="6"
                                  class="ripple-rect">
                            </rect>

                            <rect x="{{ zone.x }}" y="{{ zone.y }}"
                                  width="{{ zone.w }}" height="{{ zone.h }}"
                                  rx="6"
                                  class="ripple-rect ripple-rect-delay">
                            </rect>

                            <foreignObject x="{{ zone.x + zone.w/2 - 15 }}" y="{{ zone.y - 45 }}" width="30" height="30" class="pin-marker">
                                <div style="width:30px; height:30px; background:#ef4444; border-radius:50%;
                                            display:flex; align-items:center; justify-content:center;
                                            color:white; box-shadow:0 4px 10px rgba(239,68,68,0.4); border: 2px solid white;">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                            </foreignObject>
                        {% endif %}
                    </g>
                {% endfor %}
            </svg>
        </div>
        {% endfor %}
    </div>

    <div class="dt-info-panel" id="zoneInfo">
        <div class="info-title">
            <i id="infoIcon" class="fas fa-book"></i> <span id="infoName">åŒºåŸŸåç§°</span>
        </div>
        <div class="info-stat">
            <span>å½“å‰è—ä¹¦</span> <span style="font-weight:600; color:#1d1d1f;" id="infoCount">0</span>
        </div>
        <div class="info-stat">
            <span>åŒºåŸŸå¯†åº¦</span> <span id="infoPercent">0%</span>
        </div>
        <div class="info-bar"><div class="info-bar-fill" id="infoBar"></div></div>
    </div>

    <div class="dt-legend">
        <div class="legend-item"><div class="legend-dot" style="background:#dbeafe;"></div> ç©ºé—²</div>
        <div class="legend-item"><div class="legend-dot" style="background:#93c5fd;"></div> é€‚ä¸­</div>
        <div class="legend-item"><div class="legend-dot" style="background:#2563eb;"></div> å¯†é›†</div>
        {% if map_data.target_zone_id %}
        <div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div> ç›®æ ‡ä½ç½®</div>
        {% endif %}
    </div>
</div>

<script>
    function switchFloor(floor) {
        document.querySelectorAll('.dt-tab').forEach((el, idx) => el.classList.toggle('active', idx + 1 === floor));
        document.getElementById('floor-1').classList.toggle('active', floor === 1);
        document.getElementById('floor-2').classList.toggle('active', floor === 2);
    }

    function showZoneInfo(name, count, intensity, iconClass) {
        const panel = document.getElementById('zoneInfo');
        document.getElementById('infoName').innerText = name;
        document.getElementById('infoCount').innerText = count + ' æœ¬';
        document.getElementById('infoPercent').innerText = Math.round(intensity * 100) + '%';
        document.getElementById('infoBar').style.width = (intensity * 100) + '%';
        document.getElementById('infoIcon').className = iconClass || 'fas fa-book';

        panel.style.display = 'block';
    }

    function highlightShelf(el) { el.style.filter = 'brightness(0.95)'; }
    function unhighlightShelf(el) { el.style.filter = 'none'; }

    {% if map_data.target_zone_id %}
    // è‡ªåŠ¨é«˜äº®ç›®æ ‡åŒºåŸŸä¿¡æ¯ (å¯é€‰)
    // å®é™…é¡¹ç›®ä¸­å¯ä»¥é€šè¿‡ JS ä¼ é€’æ•°æ®è‡ªåŠ¨è§¦å‘ showZoneInfo
    {% endif %}
</script>
{% endmacro %}
```
---

### ğŸ“„ app\templates\main\book_detail.html
```html
{% extends "base.html" %}
{% import "components/map_widget.html" as map_widget %}

{% block page_title %}æ–‡çŒ®è¯¦æƒ… / Details{% endblock %}

{% block content %}
<div style="display:flex; gap:30px; margin-bottom: 30px;">
    <div class="card" style="width:300px; text-align:center;">
        {% if is_periodical %}
        <div style="width:100px; height:100px; background:#f3e8ff; border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center;">
             <i class="fas fa-newspaper" style="font-size:50px; color:#a855f7;"></i>
        </div>
        <div style="background:#f3e8ff; color:#7e22ce; padding:4px 8px; border-radius:12px; font-size:12px; font-weight:700; display:inline-block; margin-bottom:10px;">æœŸåˆŠ Periodical</div>
        {% else %}
        <i class="fas fa-book" style="font-size:80px; color:#cbd5e1; margin:20px 0;"></i>
        {% endif %}

        <h2>{{ item['BOOK_NAME'] }}</h2>
        <p>{{ item['AUTHOR'] }}</p>
        <p style="color:#888; font-family:monospace;">{{ item['ISBN'] }}</p>

        <div style="margin-top:20px; font-family: monospace; background:#f1f5f9; padding:5px; border-radius:5px;">
            {{ item['CALL_NUMBER'] }}
        </div>

        {% if is_periodical %}
            <div style="margin-top: 20px;">
                 <button class="btn-glow" disabled style="width: 100%; background: #e2e8f0; color: #64748b; box-shadow: none; cursor: not-allowed;">
                    <i class="fas fa-eye"></i> ä»…é™é˜…è§ˆ (Reference Only)
                </button>
                <div style="margin-top:8px; font-size:12px; color:#94a3b8;">
                    æœŸåˆŠä¸æä¾›å¤–å€ŸæœåŠ¡
                </div>
            </div>
        {% else %}
            {% set available = copies | selectattr('STATUS', 'equalto', 1) | list | length %}
            {% if available == 0 %}
                <div style="margin-top: 20px;">
                    <form action="{{ url_for('circ.reserve') }}" method="POST">
                        <input type="hidden" name="isbn" value="{{ item['ISBN'] }}">
                        <button class="btn-glow" style="width: 100%; background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">
                            <i class="fas fa-clock"></i> é¢„çº¦æœ¬ä¹¦ (Reserve)
                        </button>
                    </form>
                    <div style="margin-top:8px; font-size:12px; color:#d97706; line-height: 1.5;">
                        å½“å‰æ— åœ¨é¦†å¤æœ¬ï¼Œå¯é¢„çº¦æ’é˜Ÿã€‚<br>
                        <span style="opacity:0.8;">(éœ€ä¿¡ç”¨åˆ† >= 90ï¼Œä¸”æ— å…¶ä»–é¢„çº¦)</span>
                    </div>
                </div>
            {% else %}
                <div style="margin-top: 20px;">
                     <button class="btn-glow" disabled style="width: 100%; background: #e2e8f0; color: #94a3b8; box-shadow: none; cursor: default;">
                        <i class="fas fa-check-circle"></i> é¦†å†…æœ‰ä¹¦
                    </button>
                    <div style="margin-top:8px; font-size:12px; color:#64748b;">è¯·ç›´æ¥å‰å¾€æ¶ä½å€Ÿé˜…</div>
                </div>
            {% endif %}
        {% endif %}
    </div>

    <div class="card" style="flex:1;">
        <div class="card-title">é¦†è—å¤æœ¬ / Holdings</div>
        <table class="clean-table">
            <thead>
                <tr>
                    <th>æ¡ç </th>
                    <th>çŠ¶æ€</th>
                    <th>ä½ç½® / å¤‡æ³¨</th>
                </tr>
            </thead>
            <tbody>
                {% for copy in copies %}
                <tr>
                    <td style="font-family:monospace; color:#666;">{{ copy['BARCODE'] }}</td>
                    <td>
                        {% if copy['STATUS'] == 1 %}<span style="color:#10b981; font-weight:600;">åœ¨é¦† (Available)</span>
                        {% elif copy['STATUS'] == 2 %}<span style="color:#f59e0b;">å€Ÿå‡º (Borrowed)</span>
                        {% elif copy['STATUS'] == 3 %}<span style="color:#3b82f6;">è¢«é¢„çº¦ (Reserved)</span>
                        {% elif copy['STATUS'] == 4 %}<span style="color:#ef4444;">æŠ¥æŸ (Damaged)</span>
                        {% else %}ä¸å¯ç”¨{% endif %}
                    </td>
                    <td>
                        {{ copy['LOCATION'] }}
                        {% if is_periodical and copy['LOCATION_NOTE'] %}
                        <span style="background:#f3f4f6; padding:2px 6px; border-radius:4px; font-size:12px; margin-left:5px;">{{ copy['LOCATION_NOTE'] }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="3" style="text-align:center; padding:30px; color:#999;">æš‚æ— æ•°æ®</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card">
    <div class="card-header-row">
        <div class="card-title"><i class="fas fa-map-marked-alt"></i> é¦†è—ä½ç½®æŒ‡å¼• / Location Map</div>
        <div style="font-size: 13px; color: #666;">
            ä½äºï¼š{{ '2æ¥¼ è‡ªç„¶ç§‘å­¦åŒº' if map_data.target_floor == 2 else '1æ¥¼ äººæ–‡ç¤¾ç§‘åŒº' }}
        </div>
    </div>
    {{ map_widget.render_map(map_data) }}
</div>
{% endblock %}
```
---

### ğŸ“„ app\templates\main\dashboard.html
```html
{% extends "base.html" %}

{% block page_title %}å›¾ä¹¦é¦†é¦–é¡µ / Library Home{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* 0. é¡¶éƒ¨åŠ¨æ€æ—¶é’Ÿå®¹å™¨ */
    .smart-clock-card {
        background: white;
        border-radius: 24px;
        padding: 24px 40px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.02);
        position: relative;
        overflow: hidden;
    }
    .smart-clock-card::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle, rgba(59,130,246,0.03) 0%, transparent 70%);
        pointer-events: none;
    }

    /* æ¨¡æ‹Ÿæ—¶é’Ÿ (Analog) */
    .analog-clock {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: #f8fafc;
        border: 4px solid #fff;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.05), inset 0 0 20px rgba(0,0,0,0.05);
        position: relative;
        flex-shrink: 0;
    }
    .clock-face {
        position: relative; width: 100%; height: 100%;
        transform: translateY(-3px); /* correction for hands */
    }
    .hand {
        width: 50%;
        height: 6px;
        background: #1e293b;
        position: absolute; top: 50%; right: 50%;
        transform-origin: 100%;
        transform: rotate(90deg);
        transition: all 0.05s;
        border-radius: 6px;
    }
    .hand-hour { height: 6px; width: 35%; background: #334155; }
    .hand-min { height: 4px; width: 45%; background: #64748b; }
    .hand-sec { height: 2px; background: #ef4444; width: 48%; transition: none; }
    .clock-center {
        width: 12px; height: 12px; background: #334155;
        border-radius: 50%;
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* æ•°å­—æ—¶é—´ (Digital) */
    .digital-time-container {
        text-align: right;
        display: flex; flex-direction: column; justify-content: center;
    }
    .digital-time {
        font-size: 64px;
        font-weight: 200; color: #1e293b;
        font-variant-numeric: tabular-nums;
        letter-spacing: -2px; line-height: 1;
    }
    .digital-date {
        font-size: 18px; color: #64748b; font-weight: 500;
        margin-top: 8px; text-transform: uppercase; letter-spacing: 1px;
    }

    /* 1. æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ */
    .hero-stat-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 24px;
        margin-bottom: 30px;
    }
    .hero-card {
        background: white;
        border-radius: 20px;
        padding: 24px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 10px 15px -3px rgba(0, 0, 0, 0.04);
        transition: transform 0.3s;
        border: 1px solid rgba(0,0,0,0.02);
        display: flex; flex-direction: column; justify-content: center;
    }
    .hero-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .hero-icon-bg {
        position: absolute; top: -15px; right: -15px;
        font-size: 110px; opacity: 0.06; transform: rotate(15deg); pointer-events: none;
    }
    .hero-num {
        font-size: 36px;
        font-weight: 800; color: #1e293b; letter-spacing: -1.5px; margin-bottom: 4px; line-height: 1;
    }
    .hero-label {
        font-size: 12px; font-weight: 700; color: #94a3b8;
        text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;
    }
    .hero-trend {
        font-size: 13px;
        font-weight: 600; display: inline-flex; align-items: center; gap: 6px;
        background: #f1f5f9; padding: 6px 10px; border-radius: 8px; width: fit-content;
    }

    /* 2. å›¾è¡¨åŒºåŸŸå¸ƒå±€ */
    .chart-layout {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr; /* 2:1:1 å¸ƒå±€ */
        gap: 24px;
        margin-bottom: 30px;
        align-items: stretch;
    }
    .chart-card {
        background: white; border-radius: 20px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        border: 1px solid rgba(0,0,0,0.03);
        display: flex; flex-direction: column;
        height: 360px; /* å›ºå®šå¡ç‰‡é«˜åº¦ï¼Œä¿è¯æ•´é½ */
    }
    .chart-wrapper {
        position: relative;
        flex: 1; /* æ’‘æ»¡å‰©ä½™ç©ºé—´ */
        width: 100%;
        min-height: 0; /* å…è®¸ flex item ç¼©å° */
    }

    /* --- æ¯æ—¥é‡‘å¥ (Daily Quote Style) - ä¼˜åŒ–ç‰ˆ --- */
    .quote-card {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); /* æŸ”å’Œçš„é»„è‰²æ¸å˜ */
        position: relative;
        overflow: hidden;
    }

    /* èƒŒæ™¯åŒå¼•å·è£…é¥° */
    .quote-bg-icon {
        position: absolute;
        font-family: Georgia, "Times New Roman", serif;
        color: #d97706;
        opacity: 0.12; /* ç¨å¾®å¢åŠ ä¸é€æ˜åº¦ */
        line-height: 1;
        pointer-events: none;
        z-index: 0;
    }
    .quote-bg-left {
        top: 60px;
        left: 20px;
        font-size: 80px;
    }
    .quote-bg-right {
        bottom: 5px;
        right: 20px;
        font-size: 80px;
    }

    .quote-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        /* align-items: center;  <-- ç§»é™¤æ­¤è¡Œï¼Œå…è®¸å­å…ƒç´ è‡ªå®šä¹‰å¯¹é½ */
        padding: 0 20px;
        z-index: 2;
    }

    /* åŠ¨æ€æ–‡å­—æ•ˆæœ */
    .quote-text {
        font-size: 19px; /* å­—ä½“ç¨å¾®åŠ å¤§ */
        font-weight: 600;
        color: #451a03; /* æ·±æ£•è‰²æ–‡å­— */
        line-height: 1.6;
        font-family: "PingFang SC", "Songti SC", "SimSun", serif; /* è¡¬çº¿ä½“ */
        margin-bottom: 24px;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center; /* æ­£æ–‡å±…ä¸­ */
    }
    .quote-text.active {
        opacity: 1;
        transform: translateY(0);
    }

    /* ä½œè€…éƒ¨åˆ† */
    .quote-author {
        font-size: 14px;
        color: #92400e;
        font-style: italic;
        opacity: 0;
        transition: opacity 0.8s ease 0.2s; /* å»¶è¿Ÿæ˜¾ç¤º */

        /* æ ¸å¿ƒä¿®æ”¹ï¼šå³å¯¹é½å¸ƒå±€ */
        align-self: flex-end; /* è‡ªèº«åœ¨å®¹å™¨å†…å³å¯¹é½ */
        margin-right: 15px;   /* ç¦»å³è¾¹ç¨å¾®æœ‰ç‚¹è·ç¦» */
    }
    .quote-author.active {
        opacity: 0.85;
    }

    /* 3. æ¨èä¹¦ç›® */
    .arrival-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); gap: 20px;
    }
    .book-thumb {
        background: white;
        border-radius: 16px; padding: 16px; transition: all 0.2s; cursor: pointer;
        display: flex; flex-direction: column; align-items: center; text-align: center;
        border: 1px solid transparent;
    }
    .book-thumb:hover {
        background: white;
        box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1); border-color: #e2e8f0; transform: translateY(-3px);
    }
    .book-thumb img {
        width: 100px; height: 140px; object-fit: cover;
        border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); margin-bottom: 12px;
    }
    .book-thumb h4 {
        font-size: 14px;
        font-weight: 600; color: #333; margin-bottom: 4px;
        display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;
    }
    .book-thumb p { font-size: 12px; color: #888; }
</style>
{% endblock %}

{% block content %}

<div class="smart-clock-card">
    <div style="display: flex; align-items: center; gap: 20px;">
        <div class="analog-clock">
            <div class="clock-face">
                <div class="hand hand-hour"></div>
                <div class="hand hand-min"></div>
                <div class="hand hand-sec"></div>
                <div class="clock-center"></div>
            </div>
        </div>
        <div>
            <div style="font-size: 20px; font-weight: 700; color: #334155;">ååŒ—ç”µåŠ›å¤§å­¦ç½‘ä¸Šå›¾ä¹¦é¦†</div>
            <div style="font-size: 14px; color: #94a3b8;">æ™ºæ…§æœåŠ¡ç»ˆç«¯ Â· Smart Terminal</div>
        </div>
    </div>

    <div class="digital-time-container">
        <div class="digital-time" id="digitalTime">00:00:00</div>
        <div class="digital-date" id="digitalDate">MONDAY, JAN 01</div>
    </div>
</div>

<div class="hero-stat-grid">
    <div class="hero-card">
        <i class="fas fa-layer-group hero-icon-bg" style="color: #3b82f6;"></i>
        <div class="hero-label">å…¨éƒ¨é¦†è—</div>
        <div class="hero-num">{{ stats.titles }} <span style="font-size:16px; color:#cbd5e1; font-weight:400;">ç§</span></div>
        <div class="hero-trend" style="color:#3b82f6; background: rgba(59, 130, 246, 0.1);">
            <i class="fas fa-book"></i> å®ç‰© {{ stats.books }} å†Œ (å«æœŸåˆŠ)
        </div>
    </div>
    <div class="hero-card">
        <i class="fas fa-hand-holding-heart hero-icon-bg" style="color: #8b5cf6;"></i>
        <div class="hero-label">æ€»è®¡å€Ÿé˜…</div>
        <div class="hero-num">{{ stats.borrows }} <span style="font-size:16px; color:#cbd5e1; font-weight:400;">æ¬¡</span></div>
        <div class="hero-trend" style="color:#8b5cf6; background: rgba(139, 92, 246, 0.1);">
            <i class="fas fa-history"></i> å†å²ç´¯è®¡æµé€š
        </div>
    </div>
    <div class="hero-card">
        <i class="fas fa-book-reader hero-icon-bg" style="color: #10b981;"></i>
        <div class="hero-label">å½“å‰å€Ÿå‡º</div>
        <div class="hero-num">{{ stats.active }} <span style="font-size:16px; color:#cbd5e1; font-weight:400;">æœ¬</span></div>
        <div class="hero-trend" style="color:#10b981; background: rgba(16, 185, 129, 0.1);">
            <i class="fas fa-clock"></i> æ­£åœ¨å¤–å€Ÿä¸­
        </div>
    </div>
    <div class="hero-card">
        <i class="fas fa-user-friends hero-icon-bg" style="color: #f59e0b;"></i>
        <div class="hero-label">ä»Šæ—¥å€Ÿé˜…</div>
        <div class="hero-num">{{ stats.today_borrowers }} <span style="font-size:16px; color:#cbd5e1; font-weight:400;">äºº</span></div>
        <div class="hero-trend" style="color:#f59e0b; background: rgba(245, 158, 11, 0.1);">
            <i class="fas fa-calendar-day"></i> ä»Šæ—¥äº§ç”Ÿå€Ÿé˜…çš„è¯»è€…
        </div>
    </div>
</div>

<div class="chart-layout">

    <div class="chart-card">
        <div class="card-title" style="margin-bottom: 10px; font-size: 16px;">
            <i class="fas fa-chart-line" style="color:#3b82f6; margin-right:8px;"></i>è¿‘7å¤©å€Ÿé˜…è¶‹åŠ¿ / Weekly Trend
        </div>
        <div class="chart-wrapper">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="card-title" style="margin-bottom: 10px; font-size: 16px;">
            <i class="fas fa-chart-pie" style="color:#8b5cf6; margin-right:8px;"></i>é¦†è—åˆ†å¸ƒ (Top 10)
        </div>
        <div class="chart-wrapper">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>

    <div class="chart-card quote-card">
        <div class="quote-bg-icon quote-bg-left">â€œ</div>
        <div class="quote-bg-icon quote-bg-right">â€</div>

        <div class="card-title" style="margin-bottom: 10px; font-size: 16px; color: #92400e; position: relative; z-index: 2;">
            <i class="fas fa-bookmark" style="margin-right:8px;"></i>æ¯æ—¥é‡‘å¥ / Daily Quote
        </div>
        <div class="quote-container">
            <div id="quoteText" class="quote-text">Loading...</div>
            <div id="quoteAuthor" class="quote-author"></div>
        </div>
    </div>
</div>

<script>
    // --- 1. åŠ¨æ€æ—¶é’Ÿé€»è¾‘ ---
    function updateClock() {
        const now = new Date();
        const seconds = now.getSeconds();
        const minutes = now.getMinutes();
        const hours = now.getHours();
        // Analog Hands
        const secDegrees = ((seconds / 60) * 360) + 90;
        const minDegrees = ((minutes / 60) * 360) + ((seconds/60)*6) + 90;
        const hourDegrees = ((hours / 12) * 360) + ((minutes/60)*30) + 90;

        document.querySelector('.hand-sec').style.transform = `rotate(${secDegrees}deg)`;
        document.querySelector('.hand-min').style.transform = `rotate(${minDegrees}deg)`;
        document.querySelector('.hand-hour').style.transform = `rotate(${hourDegrees}deg)`;

        // Digital Display
        const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
        const dateStr = now.toLocaleDateString('en-GB', { weekday: 'long', month: 'short', day: 'numeric' });

        document.getElementById('digitalTime').innerText = timeStr;
        document.getElementById('digitalDate').innerText = dateStr.toUpperCase();
    }
    setInterval(updateClock, 1000);
    updateClock(); // Init

    // --- 2. æ¯æ—¥é‡‘å¥è½®æ’­é€»è¾‘ (ä¾¿ç­¾æ•ˆæœ) ---
    const quotes = [
        { text: "å›¾ä¹¦é¦†ä¸ä»…æ˜¯çŸ¥è¯†çš„å®åº“ï¼Œä¹Ÿæ˜¯æƒ³è±¡åŠ›çš„é¿éš¾æ‰€ã€‚", author: "â€”â€” åšå°”èµ«æ–¯" },
        { text: "é˜…è¯»æ˜¯ä¸€åº§éšèº«æºå¸¦çš„é¿éš¾æ‰€ã€‚", author: "â€”â€” æ¯›å§†" },
        { text: "æˆ‘å¿ƒé‡Œä¸€ç›´éƒ½åœ¨æš—æš—è®¾æƒ³ï¼Œå¤©å ‚åº”è¯¥æ˜¯å›¾ä¹¦é¦†çš„æ¨¡æ ·ã€‚", author: "â€”â€” åšå°”èµ«æ–¯" },
        { text: "ä¹¦ç±æ˜¯äººç±»è¿›æ­¥çš„é˜¶æ¢¯ã€‚", author: "â€”â€” é«˜å°”åŸº" },
        { text: "è¯»ä¸€æœ¬å¥½ä¹¦ï¼Œå°±æ˜¯å’Œè®¸å¤šé«˜å°šçš„äººè°ˆè¯ã€‚", author: "â€”â€” æ­Œå¾·" },
        { text: "ä¹¦çŠ¹è¯ä¹Ÿï¼Œå–„è¯»ä¹‹å¯ä»¥åŒ»æ„šã€‚", author: "â€”â€” åˆ˜å‘" }
    ];
    let currentQuoteIdx = 0;
    const textEl = document.getElementById('quoteText');
    const authorEl = document.getElementById('quoteAuthor');

    function showNextQuote() {
        const q = quotes[currentQuoteIdx];
        // 1. ç§»é™¤ active classï¼Œè§¦å‘ fade out
        textEl.classList.remove('active');
        authorEl.classList.remove('active');
        // 2. ç­‰å¾… fade out ç»“æŸåæ›´æ–°å†…å®¹å¹¶ fade in
        setTimeout(() => {
            textEl.innerText = q.text;
            authorEl.innerText = q.author;

            textEl.classList.add('active');
            authorEl.classList.add('active');
        }, 800); // å¯¹åº” CSS transition æ—¶é—´

        currentQuoteIdx = (currentQuoteIdx + 1) % quotes.length;
    }

    // åˆå§‹åŒ–æ˜¾ç¤ºç¬¬ä¸€æ¡
    showNextQuote();
    // æ¯ 6 ç§’è½®æ’­
    setInterval(showNextQuote, 6000);

    // --- 3. Chart.js å›¾è¡¨é…ç½® ---
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif';
    Chart.defaults.color = '#64748b';

    // è¶‹åŠ¿å›¾
    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    const gradientBorrow = ctxTrend.createLinearGradient(0, 0, 0, 400);
    gradientBorrow.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
    gradientBorrow.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
    new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: {{ stats.trend_labels | tojson }},
            datasets: [{
                label: 'å€Ÿé˜…é‡',
                data: {{ stats.trend_data | tojson }},
                backgroundColor: gradientBorrow,
                borderColor: '#3b82f6',
                borderWidth: 3,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: '#3b82f6',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)',
                    padding: 10,
                    cornerRadius: 8,
                    displayColors: false
                }
            },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [5, 5], color: '#f1f5f9' }, ticks: { stepSize: 1 } },
                x: { grid: { display: false } }
            }
        }
    });

    // åˆ†ç±»å›¾ (Top 10 ä¼˜åŒ–é…è‰²)
    const ctxCat = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctxCat, {
        type: 'doughnut',
        data: {
            labels: {{ stats.pie_labels | tojson }},
            datasets: [{
                data: {{ stats.pie_data | tojson }},
                backgroundColor: [
                    '#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444',
                    '#06b6d4', '#ec4899', '#6366f1', '#84cc16', '#14b8a6',
                    '#cbd5e1' // ç°è‰²ç»™"å…¶ä»–"
                ],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        boxWidth: 6,
                        font: { size: 11 } // ç¨å¾®è°ƒå°å­—ä½“é€‚åº”æ›´å¤šæ¡ç›®
                    }
                }
            },
            cutout: '70%'
        }
    });
</script>
{% endblock %}
```
---

### ğŸ“„ app\templates\main\library_map.html
```html
{% extends "base.html" %}
{% import "components/map_widget.html" as map_widget %}

{% block page_title %}å…¨é¦†ç©ºé—´ (Digital Twin){% endblock %}

{% block content %}
<div class="card" style="padding: 0; overflow: hidden; background: transparent; box-shadow: none; border: none;">
    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: end;">
        <div>
            <h1 style="font-size: 24px; font-weight: 700; color: #1d1d1f; margin-bottom: 5px;">é¦†è—åœ°å›¾</h1>
            <div style="color: #86868b; font-size: 14px;">å®æ—¶é¦†è—çƒ­åŠ›åˆ†å¸ƒ / Real-time Density Heatmap</div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 12px; color: #86868b; text-transform: uppercase; font-weight: 600;">å…¨é¦†è—ä¹¦</div>
            <div style="font-size: 24px; font-weight: 700; color: #1d1d1f;">{{ map_data.total_stock }} <span style="font-size:14px; color:#86868b; font-weight:400;">å†Œ</span></div>
        </div>
    </div>

    {{ map_widget.render_map(map_data, container_height="700px") }}
</div>
{% endblock %}
```
---

### ğŸ“„ app\templates\main\profile.html
```html
{% extends "base.html" %}

{% block page_title %}ä¸ªäººè®¾ç½® / Profile & Settings{% endblock %}

{% block extra_css %}
<style>
    /* iOS Settings Style Layout - Optimized */
    .profile-container {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 30px;
        align-items: start;
    }

    .settings-group {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 24px;
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }

    .settings-header {
        padding: 16px 20px;
        font-size: 13px; font-weight: 600; color: #64748b; text-transform: uppercase;
        background: #f8fafc;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .settings-item {
        padding: 16px 20px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #f1f5f9;
        font-size: 15px; color: #1e293b;
        min-height: 55px;
    }
    .settings-item:last-child { border-bottom: none; }

    /* æ ¸å¿ƒä¿®å¤ï¼šå›ºå®šæ ‡ç­¾å®½åº¦ï¼Œç¡®ä¿è¾“å…¥æ¡†èµ·å§‹ä½ç½®ä¸€è‡´ */
    .settings-label {
        font-weight: 500;
        color: #1d1d1f;
        width: 110px;        /* å›ºå®šå®½åº¦ */
        flex: 0 0 110px;     /* ç¦æ­¢ä¼¸ç¼© */
        margin-right: 15px;
        display: flex;       /* ç¡®ä¿å›¾æ ‡å’Œæ–‡å­—å‚ç›´å±…ä¸­ */
        align-items: center;
    }

    /* åªè¯»æ–‡æœ¬ï¼šä¿æŒå³å¯¹é½ iOS è®¾ç½®é£æ ¼ */
    .settings-value {
        color: #64748b;
        font-family: -apple-system, sans-serif;
        text-align: right;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* è¾“å…¥æ¡†æ ·å¼ï¼šæ”¹ä¸ºå·¦å¯¹é½æ›´åˆ©äºè¾“å…¥ï¼Œä¸”é•¿åº¦ç»Ÿä¸€ */
    .ios-input-clean {
        border: none;
        background: transparent;
        text-align: left;    /* è¾“å…¥æ¨¡å¼æ”¹ä¸ºå·¦å¯¹é½ï¼Œè§†è§‰æ›´æ•´é½ */
        flex: 1;             /* å¡«æ»¡å‰©ä½™ç©ºé—´ï¼Œé•¿åº¦ç»å¯¹ä¸€è‡´ */
        font-size: 15px;
        color: #007aff;
        outline: none;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        padding: 0;
        margin: 0;
        height: 100%;
    }
    .ios-input-clean:focus {
        color: #0056b3;
    }
    .ios-input-clean::placeholder {
        color: #94a3b8;
    }

    /* Credit Score Card */
    .credit-score-card {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        text-align: center;
        padding: 40px 20px;
        border-radius: 20px;
        margin-bottom: 24px;
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        position: relative;
        overflow: hidden;
    }
    .score-big { font-size: 64px; font-weight: 800; line-height: 1; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .score-label { opacity: 0.9; font-size: 14px; letter-spacing: 1px; }

    /* Log Timeline */
    .log-list { list-style: none; }
    .log-item {
        padding: 16px 0; border-bottom: 1px solid #f1f5f9;
        display: flex; gap: 15px;
    }
    .log-icon {
        width: 36px;
        height: 36px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 14px; flex-shrink: 0;
    }
    .log-content { flex: 1; }
    .log-time { font-size: 12px; color: #94a3b8; margin-top: 4px; }
    .log-val { font-weight: 700; font-size: 16px; }

    /* Danger Zone Specifics */
    .danger-header { background: #fef2f2; color: #b91c1c; border-bottom-color: #fee2e2; }
    .danger-item:hover { background-color: #fef2f2; }
    .btn-cancel {
        width: 100%; padding: 12px; border-radius: 10px;
        border: 1px solid #cbd5e1; background: white;
        color: #334155; font-weight: 600; font-size: 13px;
        cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: all 0.2s;
    }
    .btn-cancel:hover { background: #f8fafc; border-color: #94a3b8; }

    @media (max-width: 900px) {
        .profile-container { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">

    <div>
        <div class="credit-score-card" style="{{ 'background: linear-gradient(135deg, #ef4444, #b91c1c); box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);'
            if user['CURRENT_CREDIT'] < 60 else '' }}">
            <div class="score-big">{{ user['CURRENT_CREDIT'] }}</div>
            <div class="score-label">å½“å‰ä¿¡ç”¨åˆ† (Credit Score)</div>
            <div style="margin-top: 15px; font-size: 12px; background: rgba(255,255,255,0.2); display: inline-block; padding: 4px 12px; border-radius: 20px; backdrop-filter: blur(5px);">
                {% if user['CURRENT_CREDIT'] >= 90 %} ä¿¡ç”¨æå¥½ (Excellent)
                {% elif user['CURRENT_CREDIT'] >= 60 %} ä¿¡ç”¨è‰¯å¥½ (Good)
                {% else %} ä¿¡ç”¨å—é™ (Restricted) {% endif %}
            </div>
        </div>

        <div class="settings-group">
            <div class="settings-header">åŸºç¡€ä¿¡æ¯ (Read Only)</div>
            <div class="settings-item">
                <div class="settings-label">ç”¨æˆ· ID</div>
                <div class="settings-value">{{ user['READER_ID'] }}</div>
            </div>
            <div class="settings-item">
                <div class="settings-label">å§“å</div>
                <div class="settings-value">{{ user['NAME'] }}</div>
            </div>
            <div class="settings-item">
                <div class="settings-label">è§’è‰²</div>
                <div class="settings-value">
                    <span style="background: #eff6ff; color: #3b82f6; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                        {{ user['ROLE_NAME'] }}
                    </span>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-label">è´¦æˆ·æœ‰æ•ˆæœŸ</div>
                <div class="settings-value">{{ user['EXPIRY_DATE'] }}</div>
            </div>
        </div>

        {% if user['READER_ID'] != 1001 %}
        <div class="settings-group" style="border: 1px solid #fee2e2;">
            <div class="settings-header danger-header">
                <i class="fas fa-exclamation-circle" style="margin-right: 6px;"></i> è´¦å·ç®¡ç† (Zone)
            </div>

            {% if user['DELETION_SCHEDULED_AT'] %}
            <div style="padding: 20px; background: #fff1f2;">
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="font-size: 20px; color: #ef4444; padding-top:2px;"><i class="fas fa-user-clock"></i></div>
                    <div>
                        <h4 style="margin: 0 0 4px 0; font-size: 14px; color: #991b1b; font-weight: 600;">æ³¨é”€ç”³è¯·ç”Ÿæ•ˆä¸­</h4>
                        <p style="margin: 0; font-size: 13px; color: #b91c1c; line-height: 1.5;">
                            ç³»ç»Ÿå°†äº <strong>{{ user['DELETION_SCHEDULED_AT'] }}</strong> å½»åº•æ¸…é™¤æ‚¨çš„è´¦å·æ•°æ®ã€‚åœ¨æ­¤ä¹‹å‰æ‚¨å¯ä»¥æ’¤å›ç”³è¯·ã€‚
                        </p>
                    </div>
                </div>
                <form action="{{ url_for('main.cancel_deletion') }}" method="POST">
                    <button type="submit" class="btn-cancel">
                        æ’¤é”€æ³¨é”€ (Cancel Deletion)
                    </button>
                </form>
            </div>

            {% else %}
            <form action="{{ url_for('main.request_deletion') }}" method="POST" onsubmit="return confirm('ã€æ•æ„Ÿæ“ä½œè­¦å‘Šã€‘\n\næ‚¨ç¡®å®šè¦ç”³è¯·æ³¨é”€è´¦å·å—ï¼Ÿ\n\n1. ç”³è¯·æäº¤åå°†è¿›å…¥å†·é™æœŸã€‚\n2. å†·é™æœŸç»“æŸåï¼Œè´¦å·åŠæ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…ç‰©ç†åˆ é™¤ï¼Œæ— æ³•æ¢å¤ã€‚\n3. åœ¨å†·é™æœŸå†…ï¼Œæ‚¨å¯ä»¥éšæ—¶ç™»å½•å¹¶æ’¤é”€æ³¨é”€ç”³è¯·ã€‚');">
                <button type="submit" class="settings-item danger-item" style="width: 100%; border: none; background: white; cursor: pointer; text-align: left; padding: 16px 20px;">
                    <div class="settings-label" style="color: #ef4444;">
                        <i class="fas fa-trash-alt" style="width:20px; margin-right: 4px;"></i> æ³¨é”€è´¦å·
                    </div>
                    <div class="settings-value" style="color: #cbd5e1; font-size: 12px;">
                        Request Deletion <i class="fas fa-chevron-right" style="font-size: 12px; margin-left: 5px;"></i>
                    </div>
                </button>
            </form>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div>
        <form method="POST" action="{{ url_for('main.update_profile') }}">
            <input type="hidden" name="action" value="update_info">
            <div class="settings-group">
                <div class="settings-header">
                    <span>è”ç³»æ–¹å¼ç»´æŠ¤</span>
                    <button type="submit" style="border:none; background:none; color:#007aff; font-weight:600; cursor:pointer; font-size: 13px;">ä¿å­˜</button>
                </div>
                <div class="settings-item">
                    <div class="settings-label"><i class="far fa-envelope" style="width:20px; color:#94a3b8; margin-right: 4px;"></i> ç”µå­é‚®ç®±</div>
                    <input type="email" name="email" class="ios-input-clean"
       value="{{ user['EMAIL'] if user['EMAIL'] else '' }}"
       placeholder="è¾“å…¥ç”µå­é‚®ç®±" required
       pattern="^.+@.+\.com$"
       title="é‚®ç®±å¿…é¡»åŒ…å« '@' ç¬¦å·å¹¶ä»¥ .com ç»“å°¾">
                </div>
                <div class="settings-item">
                    <div class="settings-label"><i class="fas fa-mobile-alt" style="width:20px; color:#94a3b8; margin-right: 4px;"></i> æ‰‹æœºå·ç </div>
                    <input type="tel" name="phone" class="ios-input-clean"
       value="{{ user['TELEPHONE'] if user['TELEPHONE'] else '' }}"
       placeholder="è¾“å…¥æ‰‹æœºå·ç " required
       pattern="^\d{11}$"
       title="è¯·è¾“å…¥11ä½æ•°å­—æ‰‹æœºå·ç ">
                </div>
            </div>
        </form>

        <form method="POST" action="{{ url_for('main.update_profile') }}" onsubmit="return validatePwd()">
            <input type="hidden" name="action" value="change_password">
            <div class="settings-group">
                <div class="settings-header">
                    <span>å®‰å…¨è®¾ç½®</span>
                    <button type="submit" style="border:none; background:none; color:#007aff; font-weight:600; cursor:pointer; font-size: 13px;">ä¿®æ”¹å¯†ç </button>
                </div>
                <div class="settings-item">
                    <div class="settings-label">æ–°å¯†ç </div>
                    <input type="password" name="new_password" id="newPwd" class="ios-input-clean" placeholder="è¾“å…¥æ–°å¯†ç " required minlength="6">
                </div>
                <div class="settings-item">
                    <div class="settings-label">ç¡®è®¤å¯†ç </div>
                    <input type="password" name="confirm_password" id="confirmPwd" class="ios-input-clean" placeholder="å†æ¬¡è¾“å…¥å¯†ç " required>
                </div>
            </div>
        </form>

        <div class="card">
            <div class="card-title"><i class="fas fa-history" style="color: #64748b; margin-right: 8px;"></i> ä¿¡ç”¨åˆ†å˜æ›´æ˜ç»† / Credit Logs</div>
            <ul class="log-list">
                {% for log in credit_logs %}
                <li class="log-item">
                    <div class="log-icon" style="background: {{ '#ecfdf5' if log['CHANGE_VAL'] > 0 else '#fef2f2' }};
                        color: {{ '#10b981' if log['CHANGE_VAL'] > 0 else '#ef4444' }};">
                        <i class="fas {{ 'fa-plus' if log['CHANGE_VAL'] > 0 else 'fa-minus' }}"></i>
                    </div>
                    <div class="log-content">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight: 500; color: #334155;">{{ log['REASON'] }}</span>
                            <span class="log-val" style="color: {{ '#10b981' if log['CHANGE_VAL'] > 0 else '#ef4444' }}">
                                {{ '+' if log['CHANGE_VAL'] > 0 else '' }}{{ log['CHANGE_VAL'] }}
                            </span>
                        </div>
                        <div class="log-time">æ“ä½œäºº: {{ log['OPERATOR'] }} Â· {{ log['LOG_TIME'] }}</div>
                    </div>
                </li>
                {% else %}
                <li style="text-align:center; padding: 40px; color: #94a3b8;">
                    <i class="far fa-file-alt" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i><br>
                    æš‚æ— ä¿¡ç”¨å˜æ›´è®°å½•
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<script>
    function validatePwd() {
        var p1 = document.getElementById("newPwd").value;
        var p2 = document.getElementById("confirmPwd").value;

        // 1. éªŒè¯ä¸€è‡´æ€§
        if(p1 !== p2) {
            alert("é”™è¯¯ï¼šä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼");
            return false;
        }

        // 2. éªŒè¯å¤æ‚åº¦ (æ•°å­— + å­—æ¯ + ç‰¹æ®Šå­—ç¬¦)
        var pwdRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[\W_]).+$/;
        if (!pwdRegex.test(p1)) {
            alert("å¯†ç å¼ºåº¦ä¸è¶³ï¼šæ–°å¯†ç å¿…é¡»åŒæ—¶åŒ…å«æ•°å­—ã€å­—æ¯å’Œç‰¹æ®Šå­—ç¬¦ï¼");
            return false;
        }

        return true;
    }
</script>
{% endblock %}
```
---

### ğŸ“„ app\templates\main\profile_credit.html
```html
{% extends "base.html" %}
{% block page_title %}æˆ‘çš„ä¿¡ç”¨æ¡£æ¡ˆ / Credit Profile{% endblock %}

{% block content %}
<div class="card">
    <div style="text-align:center; padding:20px;">
        <h1 style="font-size:48px; color:var(--brand-primary);">{{ current_score }}</h1>
        <p style="color:#64748b;">å½“å‰ä¿¡ç”¨åˆ†</p>
    </div>
</div>

<div class="card">
    <div class="card-title">ä¿¡ç”¨å˜åŠ¨è®°å½•</div>
    <table class="clean-table">
        <thead>
            <tr>
                <th>æ—¶é—´</th>
                <th>å˜åŠ¨å€¼</th>
                <th>åŸå› </th>
                <th>æ“ä½œäºº</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log['LOG_TIME'] }}</td>
                <td style="font-weight:bold; color: {{ '#10b981' if log['CHANGE_VAL'] > 0 else '#ef4444' }}">
                    {{ '+' if log['CHANGE_VAL'] > 0 else '' }}{{ log['CHANGE_VAL'] }}
                </td>
                <td>{{ log['REASON'] }}</td>
                <td>{{ log['OPERATOR'] }}</td>
            </tr>
            {% else %}
            <tr><td colspan="4">æš‚æ— å˜åŠ¨è®°å½•</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
```
---

### ğŸ“„ app\templates\main\search.html
```html
{% extends "base.html" %}
{% block page_title %}å›¾ä¹¦é¦†è—æ¢ç´¢ / Discovery{% endblock %}

{% block extra_css %}
<style>
    /* iOS é£æ ¼æ¢ç´¢æ¨¡å¼æ ·å¼ */
    .search-hero { padding: 60px 20px; text-align: center; margin-bottom: 30px; position: relative; }
    .hero-title { font-size: 32px; font-weight: 700; color: #1d1d1f; letter-spacing: -0.5px; margin-bottom: 10px; }
    .hero-subtitle { font-size: 15px; color: #86868b; margin-bottom: 30px; font-weight: 400; }

    .ios-search-box {
        width: 100%; max-width: 720px; height: 60px; margin: 0 auto;
        background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1), 0 0 0 1px rgba(0,0,0,0.02);
        display: flex; align-items: center; padding: 4px 6px 4px 24px;
        transition: transform 0.2s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.2s;
    }
    .ios-search-box:focus-within {
        transform: scale(1.01); background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 20px 40px -10px rgba(0, 122, 255, 0.15), 0 0 0 2px rgba(0, 122, 255, 0.1);
    }
    .ios-search-icon { font-size: 20px; color: #86868b; margin-right: 12px; display: flex; align-items: center; opacity: 0.6; }
    .ios-search-input {
        flex: 1; height: 100% !important; border: none !important; background: transparent !important;
        box-shadow: none !important; margin-bottom: 0 !important; padding: 0 !important; border-radius: 0 !important;
        font-size: 17px; color: #1d1d1f; font-weight: 400; outline: none;
    }
    .ios-search-input::placeholder { color: #98989d; }
    .ios-search-btn {
        height: 48px; padding: 0 28px; background: #007aff; color: white; border: none; border-radius: 24px;
        font-size: 16px; font-weight: 600; cursor: pointer; margin-left: 8px;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); transition: all 0.2s ease;
        display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .ios-search-btn:hover { background: #0062cc; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0, 122, 255, 0.4); }
    .clear-btn { padding: 8px; color: #86868b; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: color 0.2s; opacity: 0.5; border-radius: 50%; }
    .clear-btn:hover { color: #1d1d1f; background: rgba(0,0,0,0.05); opacity: 1; }

    .bento-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 30px; align-items: start; }
    .ios-card {
        background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(30px);
        border-radius: 20px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        border: 1px solid rgba(255,255,255,0.6);
    }
    .card-header-ios { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .ios-label { font-size: 19px; font-weight: 600; color: #1d1d1f; letter-spacing: -0.015em; }

    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 24px 16px; }
    .book-item { position: relative; cursor: pointer; text-decoration: none; display: flex; flex-direction: column; transition: transform 0.2s; }
    .book-cover-wrapper { width: 100%; aspect-ratio: 2 / 3; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.05); position: relative; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s; margin-bottom: 12px; }
    .book-item:hover .book-cover-wrapper { transform: translateY(-5px) scale(1.02); box-shadow: 0 12px 20px rgba(0,0,0,0.15), 0 4px 8px rgba(0,0,0,0.1); }
    .book-cover-img { width: 100%; height: 100%; object-fit: cover; }
    .book-meta { padding: 0 4px; }
    .book-title-text { font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
    .book-author-text { font-size: 11px; color: #86868b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .stat-list { display: flex; flex-direction: column; }
    .stat-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); transition: background 0.2s; }
    .stat-row:last-child { border-bottom: none; }
    .stat-row:hover { background: #f5f5f7; border-radius: 8px; cursor: pointer; padding-left: 10px; padding-right: 10px; }
    .stat-circle { width: 36px; height: 36px; border-radius: 50%; background: #f5f5f7; color: #1d1d1f; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; margin-right: 12px; }
    .stat-info { flex: 1; }
    .stat-name { font-size: 14px; font-weight: 500; color: #1d1d1f; }
    .stat-count { font-size: 13px; color: #86868b; }
    .empty-search { text-align: center; padding: 80px 0; color: #86868b; }

    .badge-per { background: #f3e8ff; color: #7e22ce; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; border: 1px solid #d8b4fe; margin-right: 5px; }
    .badge-book { background: #dbeafe; color: #1d4ed8; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; border: 1px solid #93c5fd; margin-right: 5px; }
</style>
{% endblock %}

{% block content %}
<div class="search-hero">
    <div class="hero-title">å‘ç°å¥½ä¹¦ä¸æœŸåˆŠ</div>
    <div class="hero-subtitle">æ¢ç´¢é¦†è—èµ„æº Â· Find your next reading</div>

    <form method="GET" action="{{ url_for('main.search') }}" class="ios-search-box">
        <div class="ios-search-icon"><i class="fas fa-search"></i></div>
        <input type="text" name="q" class="ios-search-input" placeholder="æœç´¢ä¹¦åã€ISBNã€ISSNã€ä½œè€…..." value="{{ query }}">
        {% if query or clc_filter %}
        <a href="{{ url_for('main.search') }}" class="clear-btn" title="æ¸…é™¤æœç´¢æ¡ä»¶"><i class="fas fa-times-circle" style="font-size: 18px;"></i></a>
        {% endif %}
        <button type="submit" class="ios-search-btn"><span>æœç´¢</span><i class="fas fa-arrow-right" style="font-size: 12px;"></i></button>
    </form>
</div>

{% if query or clc_filter %}
    <div class="ios-card">
        <div class="card-header-ios">
            <div class="ios-label">
               {% if clc_filter %}Category: {{ clc_filter }} - {{ CLC_DATA.get(clc_filter, 'æœªçŸ¥åˆ†ç±»') }}{% else %}Search Results{% endif %}
            </div>
            <div style="font-size:13px; color:#86868b;">å…±æ‰¾åˆ° {{ results|length }} æ¡ç»“æœ</div>
        </div>

        <table class="clean-table">
            <thead>
                <tr>
                    <th>ID (ISBN/ISSN)</th>
                    <th>æ–‡çŒ®ä¿¡æ¯</th>
                    <th>ç´¢ä¹¦å· / åŒºåŸŸ</th>
                    <th>å‡ºç‰ˆç¤¾</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for item in results %}
                <tr>
                    <td style="font-family: monospace; color: #86868b;">{{ item['id'] }}</td>
                    <td>
                        <div style="font-weight: 600; color: #1d1d1f;">
                            {% if item['type'] == 'periodical' %}
                                <span class="badge-per">æœŸåˆŠ</span>
                            {% else %}
                                <span class="badge-book">å›¾ä¹¦</span>
                            {% endif %}
                            {{ item['title'] }}
                        </div>
                        <div style="font-size: 12px; color: #86868b;">{{ item['author'] }}</div>
                    </td>
                    <td><span style="background: #f5f5f7; padding: 4px 8px; border-radius: 6px; font-size: 12px; color: #1d1d1f; font-weight:500;">{{ item['call_no'] }}</span></td>
                    <td>{{ item['publisher'] }}</td>
                    <td>
                        {% if item['available_count'] > 0 %}
                             <span style="color: #34c759; font-weight: 600;">Available</span>
                        {% else %}
                            <span style="color: #ff3b30;">Out/Ref</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('main.book_detail', id=item['id']) }}" class="btn-glow"
                           style="padding: 6px 14px; font-size: 12px; background: #007aff; box-shadow: 0 2px 8px rgba(0,122,255,0.25); text-decoration: none;">
                            æŸ¥çœ‹
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="empty-search">
                    <i class="fas fa-search" style="font-size: 32px; margin-bottom: 10px; opacity: 0.3;"></i><br>
                    æœªæ‰¾åˆ°ç›¸å…³æ–‡çŒ®
                </td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="bento-grid">
        <div class="ios-card">
            <div class="card-header-ios">
                <div class="ios-label">New Books <span style="font-weight:400; color:#86868b; font-size:16px; margin-left:8px;">æœ€æ–°å…¥åº“å›¾ä¹¦</span></div>
            </div>
            <div class="gallery-grid">
                {% for book in discovery.latest %}
                <a href="{{ url_for('main.book_detail', id=book['ISBN']) }}" class="book-item">
                    <div class="book-cover-wrapper">
                         <img src="{{ url_for('static', filename='asset/covers/' + book['cover_image']) }}" alt="{{ book['BOOK_NAME'] }}" class="book-cover-img">
                    </div>
                    <div class="book-meta">
                        <div class="book-title-text">{{ book['BOOK_NAME'] }}</div>
                        <div class="book-author-text">{{ book['AUTHOR'] }}</div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>

        <div class="ios-card">
            <div class="card-header-ios">
                <div class="ios-label">åˆ†ç±» / Category</div>
            </div>
            <div class="stat-list">
                {% for stat in discovery.stats %}
                <div class="stat-row" onclick="window.location.href='{{ url_for('main.search', clc=stat.code) }}'">
                    <div class="stat-circle">{{ stat.code }}</div>
                    <div class="stat-info">
                        <div class="stat-name">{{ stat.name }}</div>
                        <div class="stat-count">{{ stat.count }} å†Œ</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color:#d1d1d6; font-size: 12px;"></i>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}
```
---

### ğŸ“„ config.py
```python
import os

class Config:
    SECRET_KEY = 'dev'
    # æ ¸å¿ƒä¸šåŠ¡æ•°æ®åº“ (å›¾ä¹¦ã€å€Ÿé˜…ç­‰)
    DATABASE = os.path.join(os.getcwd(), 'instance', 'library.db')
    # [æ–°å¢] æœŸåˆŠä¸šåŠ¡æ•°æ®åº“
    PERIODICAL_DATABASE = os.path.join(os.getcwd(), 'instance', 'periodicals.db')
    # AI åŠ©æ‰‹æ•°æ®åº“ (å­˜å‚¨å¯¹è¯å†å²)
    AI_DATABASE = os.path.join(os.getcwd(), 'instance', 'AI.db')
    # ç¡…åŸºæµåŠ¨ (SiliconCloud) API é…ç½®
    LLM_API_KEY = 'sk-gpgfpqxmrxythmzrgktgeqdudtluqigwrnjssrbqegxzfyax'
    LLM_BASE_URL = 'https://api.siliconflow.cn/v1'

    #LLM_MODEL_NAME = 'deepseek-ai/DeepSeek-R1-0528-Qwen3-8B'
    LLM_MODEL_NAME = 'Qwen/Qwen3-8B'
```
---

### ğŸ“„ OpsSystem\run_ops.py
```python
import os
import sqlite3
import shutil
import datetime
import time
import hashlib
import zipfile
import threading
import csv
import io
from flask import Flask, render_template, request, session, redirect, url_for, flash, send_file, make_response

# --- é…ç½®è·¯å¾„ ---
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
TEMPLATE_DIR = os.path.join(BASE_DIR, 'templates')
STATIC_DIR = os.path.join(BASE_DIR, 'static')

# æŒ‡å‘é¡¹ç›®æ ¹ç›®å½• (LibraryManage)
PROJECT_ROOT = os.path.abspath(os.path.join(BASE_DIR, '../'))
INSTANCE_PATH = os.path.abspath(os.path.join(BASE_DIR, '../instance'))

# è¿ç»´ç³»ç»Ÿè‡ªæœ‰æ•°æ®
OPS_DB = os.path.join(BASE_DIR, 'ops_data.db')
BACKUP_DIR = os.path.join(BASE_DIR, 'backups')

# æ•°æ®åº“æ˜ å°„
DB_MAP = {
    'library': os.path.join(INSTANCE_PATH, 'library.db'),
    'periodicals': os.path.join(INSTANCE_PATH, 'periodicals.db'),
    'ai': os.path.join(INSTANCE_PATH, 'AI.db'),
    'ops': OPS_DB
}

app = Flask(__name__, template_folder=TEMPLATE_DIR, static_folder=STATIC_DIR)
app.secret_key = 'ops_secret_key_2026'


# --- æ•°æ®åº“å·¥å…·å‡½æ•° ---

def get_daily_key():
    """ç”Ÿæˆæ¯æ—¥åŠ¨æ€æ³¨å†Œå¯†é’¥"""
    salt = "NCEPU_LIBRARY_OPS_SECRET_SALT_2026"
    today_str = datetime.datetime.now().strftime('%Y-%m-%d')
    raw_str = f"{today_str}_{salt}"
    hash_obj = hashlib.md5(raw_str.encode())
    return hash_obj.hexdigest()[:10].upper()


def get_db_connection(db_key):
    path = DB_MAP.get(db_key)
    if not path or not os.path.exists(path):
        if db_key == 'ops':
            pass
        else:
            return None
    conn = sqlite3.connect(path)
    conn.row_factory = sqlite3.Row
    return conn


def init_ops_db():
    """åˆå§‹åŒ–è¿ç»´æ•°æ®åº“"""
    conn = sqlite3.connect(OPS_DB)
    c = conn.cursor()
    c.execute('CREATE TABLE IF NOT EXISTS ADMIN_USER (ID INTEGER PRIMARY KEY, USERNAME TEXT, PASSWORD TEXT)')
    c.execute('CREATE TABLE IF NOT EXISTS SYS_CONFIG (KEY TEXT PRIMARY KEY, VALUE TEXT)')

    if not c.execute("SELECT * FROM ADMIN_USER WHERE USERNAME='1001'").fetchone():
        c.execute("INSERT INTO ADMIN_USER (USERNAME, PASSWORD) VALUES (?, ?)", ('1001', 'admin123'))

    default_configs = {
        'auto_backup_enabled': '0',
        'auto_backup_interval': '24',
        'last_backup_time': '0'
    }
    for k, v in default_configs.items():
        c.execute("INSERT OR IGNORE INTO SYS_CONFIG (KEY, VALUE) VALUES (?, ?)", (k, v))

    conn.commit()
    conn.close()


def get_sys_config(key):
    conn = get_db_connection('ops')
    row = conn.execute("SELECT VALUE FROM SYS_CONFIG WHERE KEY=?", (key,)).fetchone()
    conn.close()
    return row['VALUE'] if row else None


def set_sys_config(key, value):
    conn = get_db_connection('ops')
    conn.execute("INSERT OR REPLACE INTO SYS_CONFIG (KEY, VALUE) VALUES (?, ?)", (key, str(value)))
    conn.commit()
    conn.close()


# --- è‡ªåŠ¨å¤‡ä»½æ ¸å¿ƒé€»è¾‘ (åå°çº¿ç¨‹) ---

def perform_backup_logic(backup_type='db'):
    if not os.path.exists(BACKUP_DIR):
        os.makedirs(BACKUP_DIR)

    ts = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')

    try:
        if backup_type == 'db':
            for k, p in DB_MAP.items():
                if os.path.exists(p):
                    shutil.copy(p, os.path.join(BACKUP_DIR, f"AutoBackup_{k}_{ts}.db"))
            print(f">>> [AutoBackup] Databases backed up at {ts}")
            return True
        elif backup_type == 'full':
            zip_filename = os.path.join(BACKUP_DIR, f"AutoBackup_Full_{ts}.zip")
            with zipfile.ZipFile(zip_filename, 'w', zipfile.ZIP_DEFLATED) as zipf:
                for root, dirs, files in os.walk(PROJECT_ROOT):
                    for ignore in ['backups', '__pycache__', '.git', '.idea', 'venv', 'OpsSystem/backups']:
                        if ignore in dirs: dirs.remove(ignore)
                    for file in files:
                        if file.endswith('.zip') or file.endswith('.pyc') or 'backups' in root: continue
                        file_path = os.path.join(root, file)
                        zipf.write(file_path, os.path.relpath(file_path, PROJECT_ROOT))
            print(f">>> [AutoBackup] Full project archived at {ts}")
            return True
    except Exception as e:
        print(f"!!! [AutoBackup] Failed: {e}")
        return False


def scheduler_worker():
    print(">>> [Scheduler] Backup scheduler started.")
    while True:
        try:
            enabled = get_sys_config('auto_backup_enabled')
            if enabled != '1':
                time.sleep(60)
                continue

            interval_hours = float(get_sys_config('auto_backup_interval') or 24)
            last_run_ts = float(get_sys_config('last_backup_time') or 0)

            now_ts = time.time()
            elapsed_hours = (now_ts - last_run_ts) / 3600.0

            if elapsed_hours >= interval_hours:
                print(f">>> [Scheduler] Triggering auto backup (Elapsed: {elapsed_hours:.2f}h)")
                success = perform_backup_logic(backup_type='db')
                if success:
                    set_sys_config('last_backup_time', now_ts)

        except Exception as e:
            print(f"!!! [Scheduler] Error: {e}")

        time.sleep(60)


if not os.environ.get("WERKZEUG_RUN_MAIN") == "true":
    pass
else:
    t = threading.Thread(target=scheduler_worker, daemon=True)
    t.start()


# --- è£…é¥°å™¨ ---
def login_required(f):
    from functools import wraps
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'ops_user' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)

    return decorated_function


# --- è·¯ç”± ---

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        conn = get_db_connection('ops')
        user = conn.execute("SELECT * FROM ADMIN_USER WHERE USERNAME=?", (username,)).fetchone()
        conn.close()
        if user and user['PASSWORD'] == password:
            session['ops_user'] = username
            return redirect(url_for('dashboard'))
        flash('è®¤è¯å¤±è´¥ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error')
    return render_template('login.html')


@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        confirm = request.form['confirm_password']
        input_key = request.form.get('reg_key', '').strip().upper()

        correct_key = get_daily_key()
        if input_key != correct_key:
            flash(f'æ³¨å†Œå¯†é’¥é”™è¯¯ï¼', 'error')
            return render_template('register.html')

        if password != confirm:
            flash('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'error')
            return render_template('register.html')

        conn = get_db_connection('ops')
        exist = conn.execute("SELECT * FROM ADMIN_USER WHERE USERNAME=?", (username,)).fetchone()
        if exist:
            flash('ç”¨æˆ·åå·²å­˜åœ¨', 'error')
        else:
            conn.execute("INSERT INTO ADMIN_USER (USERNAME, PASSWORD) VALUES (?, ?)", (username, password))
            conn.commit()
            flash('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•', 'success')
            conn.close()
            return redirect(url_for('login'))
        conn.close()
    return render_template('register.html')


@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login'))


@app.route('/')
@login_required
def dashboard():
    status = []
    for k, p in DB_MAP.items():
        exists = os.path.exists(p)
        size = round(os.path.getsize(p) / 1024, 2) if exists else 0
        status.append({'name': k.upper(), 'path': p, 'exists': exists, 'size': size})

    today_key = get_daily_key()
    return render_template('dashboard.html', db_status=status, today_key=today_key)


# --- æ•°æ®åº“ç®¡ç†æ ¸å¿ƒ ---

@app.route('/db/<db_key>', methods=['GET', 'POST'])
@login_required
def db_manager(db_key):
    if db_key not in DB_MAP:
        return redirect(url_for('dashboard'))

    conn = get_db_connection(db_key)
    if not conn:
        flash(f'æ•°æ®åº“æ–‡ä»¶ {db_key} ä¸å­˜åœ¨', 'error')
        return redirect(url_for('dashboard'))

    cursor = conn.cursor()
    tables = [r['name'] for r in
              cursor.execute("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name").fetchall()]
    selected_table = request.args.get('table', tables[0] if tables else None)

    rows = []
    columns = []
    pk_col = None

    if selected_table:
        if selected_table not in tables:
            flash(f'è¡¨å {selected_table} æ— æ•ˆ', 'error')
            conn.close()
            return redirect(url_for('db_manager', db_key=db_key))

        cols_info = cursor.execute(f"PRAGMA table_info({selected_table})").fetchall()
        columns = [c['name'] for c in cols_info]
        for c in cols_info:
            if c['pk'] > 0:
                pk_col = c['name']
                break

        if request.method == 'POST':
            action = request.form.get('action')
            try:
                if action == 'add':
                    fields, values, placeholders = [], [], []
                    for col in columns:
                        val = request.form.get(f'col_{col}')
                        if col == pk_col and not val: continue
                        if val == '': val = None
                        fields.append(col)
                        values.append(val)
                        placeholders.append('?')

                    if fields:
                        sql = f"INSERT INTO {selected_table} ({','.join(fields)}) VALUES ({','.join(placeholders)})"
                        cursor.execute(sql, values)
                        conn.commit()
                        flash('æˆåŠŸæ·»åŠ ä¸€æ¡è®°å½•', 'success')

                elif action == 'edit':
                    rowid = request.form.get('rowid')
                    set_clause, values = [], []
                    for col in columns:
                        val = request.form.get(f'col_{col}')
                        if val == '': val = None
                        set_clause.append(f"{col} = ?")
                        values.append(val)
                    values.append(rowid)
                    sql = f"UPDATE {selected_table} SET {', '.join(set_clause)} WHERE rowid = ?"
                    cursor.execute(sql, values)
                    conn.commit()
                    flash(f'æ›´æ–°æˆåŠŸ (RowID: {rowid})', 'success')

                elif action == 'delete':
                    rowid = request.form.get('rowid')
                    cursor.execute(f"DELETE FROM {selected_table} WHERE rowid = ?", (rowid,))
                    conn.commit()
                    flash(f'åˆ é™¤æˆåŠŸ (RowID: {rowid})', 'success')

            except Exception as e:
                conn.rollback()
                flash(f'æ“ä½œå¤±è´¥: {str(e)}', 'error')

        # åˆ†é¡µ/é™åˆ¶æŸ¥è¯¢
        rows_raw = cursor.execute(f"SELECT rowid, * FROM {selected_table} ORDER BY rowid DESC LIMIT 200").fetchall()
        rows = []
        for r in rows_raw:
            item = dict(r)
            item['rowid'] = r[0]
            rows.append(item)

    conn.close()
    return render_template('db_manager.html', current_db=db_key, tables=tables, selected_table=selected_table,
                           columns=columns, rows=rows, pk_col=pk_col)


# --- å¯¼å…¥å¯¼å‡º CSV ---

@app.route('/db/<db_key>/export/<table_name>')
@login_required
def db_export_csv(db_key, table_name):
    conn = get_db_connection(db_key)
    if not conn: return "DB Error", 404
    cursor = conn.cursor()

    try:
        # è·å–æ‰€æœ‰æ•°æ®
        rows = cursor.execute(f"SELECT * FROM {table_name}").fetchall()
        # è·å–åˆ—å
        cols = [description[0] for description in cursor.description]

        # ä½¿ç”¨å†…å­˜å­—ç¬¦ä¸²IOæµ
        si = io.StringIO()
        # å†™å…¥ BOM é˜²æ­¢ Excel ä¸­æ–‡ä¹±ç 
        si.write('\ufeff')
        cw = csv.writer(si)
        cw.writerow(cols)
        cw.writerows(rows)

        output = make_response(si.getvalue())
        ts = datetime.datetime.now().strftime('%Y%m%d_%H%M')
        output.headers["Content-Disposition"] = f"attachment; filename={table_name}_export_{ts}.csv"
        output.headers["Content-type"] = "text/csv"
        return output

    except Exception as e:
        flash(f'å¯¼å‡ºå¤±è´¥: {str(e)}', 'error')
        return redirect(url_for('db_manager', db_key=db_key, table=table_name))
    finally:
        conn.close()


@app.route('/db/<db_key>/import/<table_name>', methods=['POST'])
@login_required
def db_import_csv(db_key, table_name):
    if 'file' not in request.files:
        flash('æœªä¸Šä¼ æ–‡ä»¶', 'error')
        return redirect(url_for('db_manager', db_key=db_key, table=table_name))

    file = request.files['file']
    if file.filename == '':
        flash('æœªé€‰æ‹©æ–‡ä»¶', 'error')
        return redirect(url_for('db_manager', db_key=db_key, table=table_name))

    if not file.filename.endswith('.csv'):
        flash('ä»…æ”¯æŒ CSV æ–‡ä»¶å¯¼å…¥', 'error')
        return redirect(url_for('db_manager', db_key=db_key, table=table_name))

    conn = get_db_connection(db_key)
    cursor = conn.cursor()

    try:
        # 1. æ™ºèƒ½ç¼–ç æ£€æµ‹
        raw_data = file.stream.read()
        decoded_content = None

        # ä¼˜å…ˆå°è¯• utf-8-sig (æ ‡å‡†CSV/å¯¼å‡ºæ ¼å¼)
        # å…¶æ¬¡å°è¯• gbk (Excelé»˜è®¤æ ¼å¼)
        # æœ€åå°è¯• gb18030 (è¶…å¤§å­—ç¬¦é›†) å’Œ latin1 (å…œåº•)
        for encoding in ['utf-8-sig', 'gbk', 'gb18030', 'utf-8', 'latin1']:
            try:
                decoded_content = raw_data.decode(encoding)
                print(f">>> [Import] Successfully decoded using {encoding}")
                break
            except UnicodeDecodeError:
                continue

        if decoded_content is None:
            raise Exception("æ— æ³•è¯†åˆ«æ–‡ä»¶ç¼–ç ï¼Œå»ºè®®å¦å­˜ä¸º UTF-8 æ ¼å¼ CSV")

        # 2. è¯»å– CSV å†…å®¹
        stream = io.StringIO(decoded_content, newline=None)
        csv_input = csv.DictReader(stream)

        # è·å–ç›®æ ‡è¡¨åˆ—å
        table_cols = [c['name'] for c in cursor.execute(f"PRAGMA table_info({table_name})").fetchall()]

        # éªŒè¯ CSV åˆ—æ˜¯å¦åœ¨è¡¨ä¸­å­˜åœ¨
        if not csv_input.fieldnames:
            raise Exception("CSV æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯")

        valid_fields = [f for f in csv_input.fieldnames if f in table_cols]
        if not valid_fields:
            raise Exception("CSV è¡¨å¤´ä¸æ•°æ®åº“å­—æ®µä¸åŒ¹é…ï¼Œè¯·æ£€æŸ¥ç¬¬ä¸€è¡Œæ ‡é¢˜ã€‚")

        success_count = 0
        error_count = 0

        # å¼€å¯äº‹åŠ¡
        for row in csv_input:
            try:
                # è¿‡æ»¤æ‰ä¸åœ¨è¡¨ä¸­çš„å­—æ®µ
                data = {k: v for k, v in row.items() if k in valid_fields}
                if not data: continue

                placeholders = ', '.join(['?'] * len(data))
                columns = ', '.join(data.keys())
                values = list(data.values())

                # æ‰§è¡Œæ’å…¥
                sql = f"INSERT INTO {table_name} ({columns}) VALUES ({placeholders})"
                cursor.execute(sql, values)
                success_count += 1
            except Exception:
                error_count += 1

        conn.commit()
        flash(f'å¯¼å…¥å®Œæˆï¼šæˆåŠŸ {success_count} æ¡ï¼Œå¤±è´¥/é‡å¤ {error_count} æ¡',
              'success' if error_count == 0 else 'warning')

    except Exception as e:
        conn.rollback()
        flash(f'å¯¼å…¥ä¸¥é‡é”™è¯¯ (äº‹åŠ¡å·²å›æ»š): {str(e)}', 'error')
    finally:
        conn.close()

    return redirect(url_for('db_manager', db_key=db_key, table=table_name))


# --- å¤‡ä»½ä¸­å¿ƒ ---

@app.route('/backup', methods=['GET', 'POST'])
@login_required
def backup_center():
    if not os.path.exists(BACKUP_DIR):
        os.makedirs(BACKUP_DIR)

    if request.method == 'POST':
        action = request.form.get('action')

        if action == 'update_config':
            enabled = '1' if request.form.get('auto_enabled') == 'on' else '0'
            interval = request.form.get('interval', '24')
            set_sys_config('auto_backup_enabled', enabled)
            set_sys_config('auto_backup_interval', interval)
            flash(f'è‡ªåŠ¨å¤‡ä»½ç­–ç•¥å·²æ›´æ–°', 'success')
            return redirect(url_for('backup_center'))

        ts = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')
        try:
            if action == 'db':
                perform_backup_logic('db')
                flash(f'æ‰€æœ‰æ•°æ®åº“æ‰‹åŠ¨å¤‡ä»½æˆåŠŸ', 'success')
            elif action == 'full':
                perform_backup_logic('full')
                flash(f'å…¨é¡¹ç›®æºç å½’æ¡£å®Œæˆï¼', 'success')
        except Exception as e:
            flash(f'å¤‡ä»½å‡ºé”™: {str(e)}', 'error')

    files = []
    if os.path.exists(BACKUP_DIR):
        for f in os.listdir(BACKUP_DIR):
            fp = os.path.join(BACKUP_DIR, f)
            if os.path.isfile(fp):
                size = round(os.path.getsize(fp) / (1024 * 1024), 2)
                t = datetime.datetime.fromtimestamp(os.path.getmtime(fp)).strftime('%Y-%m-%d %H:%M')
                files.append({'name': f, 'size': size, 'time': t})
        files.sort(key=lambda x: x['time'], reverse=True)

    config = {
        'enabled': get_sys_config('auto_backup_enabled') == '1',
        'interval': get_sys_config('auto_backup_interval'),
        'last_run': get_sys_config('last_backup_time')
    }

    next_run_str = "æœªè°ƒåº¦"
    if config['enabled']:
        last_ts = float(config['last_run'] or 0)
        interval_sec = float(config['interval']) * 3600
        next_ts = last_ts + interval_sec
        if last_ts == 0:
            next_run_str = "ç«‹å³æ‰§è¡Œ (Pending)"
        elif next_ts < time.time():
            next_run_str = "å³å°†æ‰§è¡Œ (Due)"
        else:
            next_run_str = datetime.datetime.fromtimestamp(next_ts).strftime('%Y-%m-%d %H:%M')

    return render_template('backup.html', files=files, config=config, next_run=next_run_str)


@app.route('/dl/<path:filename>')
@login_required
def dl_backup(filename):
    return send_file(os.path.join(BACKUP_DIR, filename), as_attachment=True)


if __name__ == '__main__':
    init_ops_db()
    app.run(host='0.0.0.0', port=5001, debug=True)
```
---

### ğŸ“„ OpsSystem\templates\backup.html
```html
{% extends "base_ops.html" %}

{% block title %}å¤‡ä»½ä¸å½’æ¡£ / Backup Center{% endblock %}

{% block content %}
<style>
    /* iOS Style Toggle Switch */
    .ios-switch {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 32px;
    }
    .ios-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #e9e9ea;
        transition: .4s;
        border-radius: 34px;
        border: 1px solid #d1d1d6;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: .4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input:checked + .slider {
        background-color: #34c759;
        border-color: #34c759;
    }
    input:checked + .slider:before {
        transform: translateX(20px);
    }

    /* Config Card Styles */
    .config-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 24px;
        border: 1px solid rgba(255,255,255,0.6);
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .config-left {
        flex: 1;
    }
    .config-title {
        font-size: 18px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .config-desc {
        font-size: 13px;
        color: #86868b;
        max-width: 600px;
        line-height: 1.5;
    }
    .config-control {
        display: flex;
        align-items: center;
        gap: 20px;
        background: #f5f5f7;
        padding: 12px 20px;
        border-radius: 16px;
    }
    .interval-input-group {
        display: flex;
        align-items: center;
        gap: 8px;
        border-right: 1px solid #e5e5ea;
        padding-right: 20px;
    }
    .ios-num-input {
        width: 60px;
        padding: 6px;
        border-radius: 8px;
        border: 1px solid #d1d1d6;
        text-align: center;
        font-weight: 600;
        color: #1d1d1f;
        outline: none;
    }
    .ios-num-input:focus {
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
    }

    /* Stats Badge */
    .next-run-badge {
        font-size: 12px;
        color: #007aff;
        background: rgba(0, 122, 255, 0.1);
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        margin-left: 10px;
    }
</style>

<form method="POST" action="{{ url_for('backup_center') }}">
    <input type="hidden" name="action" value="update_config">
    <div class="config-card">
        <div class="config-left">
            <div class="config-title">
                <i class="fas fa-robot" style="color: #5856d6;"></i>
                è‡ªåŠ¨åŒ–ç­–ç•¥ä¸­å¿ƒ (Automation Policy)
                {% if config.enabled %}
                <span class="next-run-badge"><i class="fas fa-clock"></i> ä¸‹æ¬¡æ‰§è¡Œ: {{ next_run }}</span>
                {% endif %}
            </div>
            <div class="config-desc">
                ç³»ç»Ÿå°†å¯åŠ¨åå°å®ˆæŠ¤çº¿ç¨‹ï¼ŒæŒ‰ç…§è®¾å®šçš„æ—¶é—´é—´éš”è‡ªåŠ¨æ‰§è¡Œ<b>æ•°æ®åº“å¢é‡å¤‡ä»½</b>ã€‚
                <br>Automation daemon thread will backup databases periodically.
            </div>
        </div>

        <div class="config-control">
            <div class="interval-input-group">
                <span style="font-size: 13px; font-weight: 600; color: #1d1d1f;">æ¯éš”</span>
                <input type="number" name="interval" class="ios-num-input" value="{{ config.interval }}" min="1" max="168">
                <span style="font-size: 13px; font-weight: 600; color: #1d1d1f;">å°æ—¶</span>
            </div>

            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 13px; font-weight: 600; color: {{ '#34c759' if config.enabled else '#86868b' }};">
                    {{ 'å·²å¯ç”¨' if config.enabled else 'å·²åœç”¨' }}
                </span>
                <label class="ios-switch">
                    <input type="checkbox" name="auto_enabled" onchange="this.form.submit()" {{ 'checked' if config.enabled else '' }}>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
</form>

<div class="card" style="margin-bottom: 24px;">
    <div class="card-title">æ‰‹åŠ¨å¤‡ä»½ (Manual Actions)</div>
    <div style="display: flex; gap: 20px; align-items: center;">

        <form method="POST" style="flex: 1;" onsubmit="showLoading()">
            <input type="hidden" name="action" value="db">
            <button type="submit" class="btn btn-glow" style="width: 100%; padding: 20px; background: linear-gradient(135deg, #34c759, #30b352);">
                <i class="fas fa-file-archive" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                <span style="font-size: 16px;">ä»…å¤‡ä»½æ•°æ®åº“ (Database Only)</span>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">å¿«é€Ÿ Â· ä½“ç§¯å° Â· æ¨è</div>
            </button>
        </form>

        <form method="POST" style="flex: 1;" onsubmit="showLoading()">
            <input type="hidden" name="action" value="full">
            <button type="submit" class="btn btn-glow" style="width: 100%; padding: 20px; background: linear-gradient(135deg, #007aff, #0056b3);">
                <i class="fas fa-file-archive" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                <span style="font-size: 16px;">å…¨é¡¹ç›®å½’æ¡£ (Full Project)</span>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">å«æºç ä¸é™æ€èµ„æº Â· è€—æ—¶</div>
            </button>
        </form>

    </div>
</div>

<div class="card">
    <div class="card-title">
        <span><i class="fas fa-history"></i> å¤‡ä»½å†å²æ¡£æ¡ˆ (History)</span>
    </div>
    <table class="clean-table">
        <thead>
            <tr>
                <th>æ–‡ä»¶å</th>
                <th>å¤§å° (MB)</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>ç±»å‹</th>
                <th style="text-align: right;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for f in files %}
            <tr>
                <td style="font-weight: 500;">
                    <i class="fas {{ 'fa-file-archive' if 'zip' in f.name else 'fa-database' }}"
                       style="color: {{ '#f59e0b' if 'zip' in f.name else '#10b981' }}; margin-right: 8px;"></i>
                    {{ f.name }}
                </td>
                <td style="font-family: monospace;">{{ f.size }}</td>
                <td style="color: #86868b;">{{ f.time }}</td>
                <td>
                    {% if 'AutoBackup' in f.name %}
                    <span style="font-size: 11px; background: #e0f2fe; color: #0284c7; padding: 2px 6px; border-radius: 4px; font-weight: 600;">AUTO</span>
                    {% else %}
                    <span style="font-size: 11px; background: #f3f4f6; color: #64748b; padding: 2px 6px; border-radius: 4px;">MANUAL</span>
                    {% endif %}
                </td>
                <td style="text-align: right;">
                    <a href="{{ url_for('dl_backup', filename=f.name) }}" class="btn-ghost" style="color: #007aff;">
                        <i class="fas fa-download"></i> ä¸‹è½½
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                    <i class="fas fa-box-open" style="font-size: 32px; margin-bottom: 10px; opacity: 0.3;"></i><br>
                    æš‚æ— å¤‡ä»½è®°å½•
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function showLoading() {
        // ç®€å•çš„åŠ è½½æç¤ºï¼Œé˜²æ­¢é‡å¤æäº¤
        const btns = document.querySelectorAll('button[type="submit"]');
        btns.forEach(btn => {
            btn.style.opacity = '0.7';
            btn.innerText = 'Processing...';
            btn.disabled = true;
        });
    }
</script>
{% endblock %}
```
---

### ğŸ“„ OpsSystem\templates\base_ops.html
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è¿ç»´ä¸­å° - NCEPU Library</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* å¤åˆ»ä¸»é¡¹ç›® Light Theme é£æ ¼ */
        :root {
            --brand-primary: #2563eb;
            --bg-color: #f1f5f9;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --sidebar-width: 260px; /* åˆå§‹å®½åº¦ */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- 1. å¯è°ƒæ•´å®½åº¦çš„ä¾§è¾¹æ  --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            flex-shrink: 0;
            min-width: 200px;
            max-width: 500px;
        }

        .resizer {
            width: 5px;
            height: 100%;
            background: transparent;
            position: absolute;
            right: 0;
            top: 0;
            cursor: col-resize;
            z-index: 100;
            transition: background 0.2s;
        }
        .resizer:hover, .sidebar.resizing .resizer {
            background: #cbd5e1;
        }

        .brand {
            padding: 24px;
            font-size: 18px;
            font-weight: 700;
            color: var(--brand-primary);
            display: flex; align-items: center; gap: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-menu {
            padding: 20px 10px;
            flex: 1;
            overflow-y: auto;
        }

        .menu-label {
            font-size: 11px;
            color: var(--text-sub);
            font-weight: 700;
            padding: 0 12px;
            margin: 20px 0 8px 0;
            text-transform: uppercase;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 10px;
            color: var(--text-sub);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .nav-item:hover {
            background: #f8fafc;
            color: var(--brand-primary);
        }
        .nav-item.active {
            background: #eff6ff;
            color: var(--brand-primary);
            font-weight: 600;
        }
        .nav-item i { width: 24px; }

        /* --- 2. ä¸»å†…å®¹åŒº --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .top-bar {
            height: 64px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 10;
        }

        .content-scroll {
            flex: 1;
            overflow: auto;
            padding: 30px;
        }

        /* --- 3. ç»„ä»¶æ ·å¼ (ä»¿ä¸»é¡¹ç›®) --- */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        .card-title {
            font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .btn-glow {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; border: none; padding: 8px 16px; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
            transition: transform 0.2s; display: inline-flex; align-items: center; gap: 6px; text-decoration: none;
        }
        .btn-glow:hover { transform: translateY(-1px); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
        .btn-ghost { background: transparent; color: var(--text-sub); box-shadow: none; border: 1px solid var(--border-color); }
        .btn-ghost:hover { background: #f8fafc; color: var(--text-main); }

        .clean-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .clean-table th { text-align: left; padding: 12px 16px; color: var(--text-sub); border-bottom: 1px solid var(--border-color); background: #f8fafc; font-weight: 600; }
        .clean-table td { padding: 12px 16px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        .clean-table tr:hover td { background: #f8fafc; }

        /* å¼¹çª—æ ·å¼ (iOS Modal) */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.2); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-box {
            background: white; width: 500px; max-height: 85vh; border-radius: 20px;
            box-shadow: var(--shadow-md); display: flex; flex-direction: column; overflow: hidden;
            animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); font-weight: 600; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 24px; overflow-y: auto; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; outline: none; transition: 0.2s; font-size: 14px; }
        .form-input:focus { border-color: var(--brand-primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .alert-success { background: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        .alert-error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="brand"><i class="fas fa-tools"></i> è¿ç»´ä¸­å°</div>
        <div class="nav-menu">
            <a href="{{ url_for('dashboard') }}" class="nav-item {{ 'active' if request.endpoint == 'dashboard' else '' }}">
                <i class="fas fa-tachometer-alt"></i> ç›‘æ§ä»ªè¡¨ç›˜
            </a>

            <div class="menu-label">DATABASES</div>
            <a href="{{ url_for('db_manager', db_key='library') }}" class="nav-item {{ 'active' if request.view_args.get('db_key') == 'library' else '' }}">
                <i class="fas fa-book"></i> ä¸šåŠ¡åº“ (Library)
            </a>
            <a href="{{ url_for('db_manager', db_key='ai') }}" class="nav-item {{ 'active' if request.view_args.get('db_key') == 'ai' else '' }}">
                <i class="fas fa-brain"></i> AI è®°å¿† (Memory)
            </a>
            <a href="{{ url_for('db_manager', db_key='ops') }}" class="nav-item {{ 'active' if request.view_args.get('db_key') == 'ops' else '' }}">
                <i class="fas fa-user-shield"></i> ç®¡ç†å‘˜ (Admin)
            </a>

            <div class="menu-label">SYSTEM</div>
            <a href="{{ url_for('backup_center') }}" class="nav-item {{ 'active' if request.endpoint == 'backup_center' else '' }}">
                <i class="fas fa-archive"></i> å¤‡ä»½å½’æ¡£
            </a>
        </div>
        <div style="padding: 20px; border-top: 1px solid var(--border-color);">
            <div style="font-size: 12px; color: var(--text-sub); margin-bottom: 8px;">Logged in as <b>{{ session.get('ops_user') }}</b></div>
            <a href="{{ url_for('logout') }}" style="color: #ef4444; text-decoration: none; font-size: 12px; font-weight: 600;">
                <i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•
            </a>
        </div>
        <div class="resizer" id="dragMe"></div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div style="font-size: 18px; font-weight: 700;">{% block page_title %}Dashboard{% endblock %}</div>
            <div>
                <span style="font-size: 12px; background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 20px; font-weight: 600;">
                    System Online
                </span>
            </div>
        </div>
        <div class="content-scroll">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        <i class="fas fa-info-circle"></i> {{ message }}
                    </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            {% block content %}{% endblock %}
        </div>
    </div>

    <script>
        // ä¾§è¾¹æ æ‹–æ‹½é€»è¾‘
        const sidebar = document.getElementById('sidebar');
        const resizer = document.getElementById('dragMe');
        let x = 0;
        let w = 0;

        const mouseDownHandler = function(e) {
            x = e.clientX;
            const styles = window.getComputedStyle(sidebar);
            w = parseInt(styles.width, 10);
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            sidebar.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
        };

        const mouseMoveHandler = function(e) {
            const dx = e.clientX - x;
            sidebar.style.width = `${w + dx}px`;
        };

        const mouseUpHandler = function() {
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
            sidebar.classList.remove('resizing');
            document.body.style.removeProperty('cursor');
        };

        resizer.addEventListener('mousedown', mouseDownHandler);

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }
    </script>
</body>
</html>
```
---

### ğŸ“„ OpsSystem\templates\dashboard.html
```html
{% extends "base_ops.html" %}

{% block page_title %}ç³»ç»Ÿç›‘æ§ / Dashboard{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
    <div class="card" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none;">
        <div class="card-title" style="color: white; border-bottom-color: rgba(255,255,255,0.2);">
            <span><i class="fas fa-key"></i> ä»Šæ—¥åŠ¨æ€æ³¨å†Œå¯†é’¥ (Daily Key)</span>
        </div>
        <div style="text-align: center; padding: 20px 0;">
            <div style="font-size: 48px; font-weight: 700; font-family: monospace; letter-spacing: 4px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                {{ today_key }}
            </div>
            <div style="font-size: 13px; opacity: 0.8; margin-top: 10px;">
                * ç”¨äºæ–°ç®¡ç†å‘˜æ³¨å†ŒéªŒè¯ï¼Œæ¯æ—¥è‡ªåŠ¨åˆ·æ–°
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">
            <span><i class="fas fa-server"></i> è¿è¡Œç¯å¢ƒ (Runtime)</span>
        </div>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9;">
                <span style="color: #64748b;">å½“å‰ç”¨æˆ·</span>
                <span style="font-weight: 600;">{{ session.get('ops_user') }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9;">
                <span style="color: #64748b;">ç³»ç»Ÿæ—¶é—´</span>
                <span id="sysTime" style="font-family: monospace;">Loading...</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #64748b;">æœåŠ¡çŠ¶æ€</span>
                <span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">Running</span>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-title">
        <span><i class="fas fa-database"></i> æ•°æ®åº“è¿æ¥çŠ¶æ€ (Database Status)</span>
    </div>
    <table class="clean-table">
        <thead>
            <tr>
                <th>æ ‡è¯† (Key)</th>
                <th>æ–‡ä»¶è·¯å¾„ (Path)</th>
                <th>çŠ¶æ€ (Status)</th>
                <th>å¤§å° (Size)</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for db in db_status %}
            <tr>
                <td style="font-weight: 600;">{{ db.name }}</td>
                <td style="color: #64748b; font-family: monospace; font-size: 12px;">{{ db.path }}</td>
                <td>
                    {% if db.exists %}
                    <span style="color: #10b981;"><i class="fas fa-check-circle"></i> åœ¨çº¿</span>
                    {% else %}
                    <span style="color: #ef4444;"><i class="fas fa-times-circle"></i> ä¸¢å¤±</span>
                    {% endif %}
                </td>
                <td>{{ db.size }} KB</td>
                <td>
                    {% if db.exists %}
                    <a href="{{ url_for('db_manager', db_key=db.name|lower) }}" class="btn-glow" style="padding: 4px 10px; font-size: 12px;">
                        ç®¡ç†æ•°æ®
                    </a>
                    {% else %}
                    <span style="color: #ccc;">ä¸å¯ç”¨</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function updateTime() {
        const now = new Date();
        document.getElementById('sysTime').innerText = now.toLocaleString();
    }
    setInterval(updateTime, 1000);
    updateTime();
</script>
{% endblock %}
```
---

### ğŸ“„ OpsSystem\templates\db_manager.html
```html
{% extends "base_ops.html" %}

{% block title %}æ•°æ®åº“ç®¡ç† / Database Manager{% endblock %}

{% block content %}
<style>
    /* --- iOS Premium Layout & Glassmorphism --- */
    :root {
        --ios-glass-bg: rgba(255, 255, 255, 0.85);
        --ios-glass-border: rgba(255, 255, 255, 0.5);
        --ios-blue: #007aff;
        --ios-red: #ff3b30;
        --ios-text-main: #1d1d1f;
        --ios-text-sub: #86868b;
    }

    .db-container {
        display: flex;
        gap: 20px;
        height: calc(100vh - 100px); /* é€‚é…é¡¶éƒ¨æ é«˜åº¦ */
        overflow: hidden;
    }

    /* å·¦ä¾§è¾¹æ ï¼šè¡¨å¯¼èˆª */
    .db-sidebar {
        width: 260px;
        min-width: 260px;
        background: var(--ios-glass-bg);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        border-radius: 16px;
        border: 1px solid var(--ios-glass-border);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        display: flex;
        flex-direction: column;
        padding: 16px;
    }

    .sidebar-header {
        font-size: 12px;
        font-weight: 600;
        color: var(--ios-text-sub);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
        padding-left: 8px;
    }

    .table-list {
        flex: 1;
        overflow-y: auto;
        padding-right: 4px;
    }

    /* æ»šåŠ¨æ¡éšè—ä½†ä¿ç•™åŠŸèƒ½ */
    .table-list::-webkit-scrollbar { width: 4px; }
    .table-list::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 2px; }

    .db-nav-item {
        display: flex;
        align-items: center;
        padding: 10px 14px;
        border-radius: 10px;
        color: var(--ios-text-main);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .db-nav-item:hover {
        background: rgba(0, 0, 0, 0.03);
    }

    .db-nav-item.active {
        background: var(--ios-blue);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);
    }

    .db-nav-item i {
        margin-right: 10px;
        font-size: 14px;
        opacity: 0.8;
    }

    /* å³ä¾§ä¸»å†…å®¹åŒº */
    .db-main {
        flex: 1;
        background: var(--ios-glass-bg);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        border-radius: 16px;
        border: 1px solid var(--ios-glass-border);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    /* é¡¶éƒ¨å·¥å…·æ  */
    .db-toolbar {
        padding: 16px 24px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.5);
    }

    .current-table-name {
        font-size: 18px;
        font-weight: 700;
        color: var(--ios-text-main);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .action-group {
        display: flex;
        gap: 12px;
    }

    /* iOS é£æ ¼æŒ‰é’® */
    .btn-ios {
        padding: 8px 16px;
        border-radius: 18px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.1s;
    }

    .btn-ios:active { transform: scale(0.96); }

    .btn-ghost-blue {
        background: rgba(0, 122, 255, 0.1);
        color: var(--ios-blue);
    }
    .btn-ghost-blue:hover { background: rgba(0, 122, 255, 0.15); }

    /* æ•°æ®è¡¨æ ¼å®¹å™¨ */
    .table-scroll-container {
        flex: 1;
        overflow: auto;
        position: relative;
    }

    .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 800px;
    }

    .data-table th {
        position: sticky;
        top: 0;
        background: rgba(249, 249, 249, 0.95);
        backdrop-filter: blur(10px);
        z-index: 10;
        text-align: left;
        padding: 12px 16px;
        font-size: 12px;
        font-weight: 600;
        color: var(--ios-text-sub);
        text-transform: uppercase;
        border-bottom: 1px solid rgba(0,0,0,0.08);
        white-space: nowrap;
    }

    .data-table td {
        padding: 14px 16px;
        border-bottom: 1px solid rgba(0,0,0,0.04);
        font-size: 14px;
        color: var(--ios-text-main);
        white-space: nowrap;
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
    }

    .data-table tr:hover td {
        background-color: rgba(0, 122, 255, 0.03);
    }

    /* æ“ä½œæŒ‰é’®å›¾æ ‡ */
    .icon-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--ios-text-sub);
        transition: all 0.2s;
        background: transparent;
        border: none;
        cursor: pointer;
    }

    .icon-btn.edit:hover { background: rgba(0, 122, 255, 0.1); color: var(--ios-blue); }
    .icon-btn.delete:hover { background: rgba(255, 59, 48, 0.1); color: var(--ios-red); }

    /* æµ®åŠ¨æ–°å¢æŒ‰é’® (FAB) */
    .fab-add {
        position: absolute;
        bottom: 30px;
        right: 30px;
        width: 56px;
        height: 56px;
        background: var(--ios-blue);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
        border: none;
        cursor: pointer;
        transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 50;
    }

    .fab-add:hover { transform: scale(1.1) rotate(90deg); }

    /* --- iOS Modal Style --- */
    .ios-modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .ios-modal-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    .ios-modal {
        background: rgba(255, 255, 255, 0.95);
        width: 500px;
        max-width: 90%;
        max-height: 85vh;
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.4);
        display: flex;
        flex-direction: column;
        transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .ios-modal-overlay.open .ios-modal {
        transform: scale(1);
    }

    .ios-modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid rgba(0,0,0,0.06);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .ios-modal-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--ios-text-main);
    }

    .ios-modal-body {
        padding: 24px;
        overflow-y: auto;
    }

    /* iOS è¡¨å•æ§ä»¶ */
    .ios-form-group {
        margin-bottom: 18px;
    }

    .ios-label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: var(--ios-text-sub);
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .ios-input {
        width: 100%;
        padding: 12px 16px;
        background: #f2f2f7;
        border: 1px solid transparent;
        border-radius: 12px;
        font-size: 15px;
        color: var(--ios-text-main);
        transition: all 0.2s;
        box-sizing: border-box;
        outline: none;
    }

    .ios-input:focus {
        background: #fff;
        border-color: var(--ios-blue);
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }

    .ios-btn-group {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        justify-content: flex-end;
    }

    .btn-cancel {
        background: #f2f2f7;
        color: var(--ios-text-main);
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 600;
        border: none;
        cursor: pointer;
    }
    .btn-cancel:hover { background: #e5e5ea; }

    .btn-save {
        background: var(--ios-blue);
        color: white;
        padding: 10px 24px;
        border-radius: 12px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 122, 255, 0.25);
    }
    .btn-save:hover { background: #0062cc; transform: translateY(-1px); }

    /* æ–‡ä»¶ä¸Šä¼ éšè— */
    .file-upload-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }
    .file-upload-wrapper input[type=file] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
    /* ... ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ ... */

    /* --- [ä¿®æ”¹] ä¾§è¾¹æ å¯¼èˆªé¡¹å¸ƒå±€ä¼˜åŒ– --- */
    .db-nav-item {
        display: flex;
        align-items: center; /* å‚ç›´å±…ä¸­å›¾æ ‡ */
        padding: 8px 12px;   /* ç¨å¾®å‡å°å†…è¾¹è·ä»¥å®¹çº³åŒè¡Œ */
        border-radius: 10px;
        color: var(--ios-text-main);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 6px;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        min-height: 48px; /* ä¿è¯é«˜åº¦ä¸€è‡´ */
    }

    .db-nav-item:hover {
        background: rgba(0, 0, 0, 0.03);
    }

    .db-nav-item.active {
        background: var(--ios-blue);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);
    }

    .db-nav-item i {
        margin-right: 12px;
        font-size: 16px;
        opacity: 0.8;
        width: 20px; /* å›ºå®šå›¾æ ‡å®½åº¦ç¡®ä¿å¯¹é½ */
        text-align: center;
    }

    /* --- [æ–°å¢] åŒè¡Œæ–‡æœ¬å®¹å™¨ --- */
    .table-info-col {
        display: flex;
        flex-direction: column;
        justify-content: center;
        line-height: 1.25;
        overflow: hidden; /* é˜²æ­¢é•¿æ–‡æœ¬æº¢å‡º */
    }

    .tbl-en {
        font-weight: 600;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .tbl-cn {
        font-size: 11px;
        opacity: 0.6; /* é»˜è®¤ç°è‰² */
        font-weight: 400;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 1px;
    }

    /* é€‰ä¸­çŠ¶æ€ä¸‹ï¼Œä¸­æ–‡è¯´æ˜çš„é€æ˜åº¦è°ƒæ•´ï¼Œç¡®ä¿åœ¨è“è‰²èƒŒæ™¯ä¸‹å¯è§ */
    .db-nav-item.active .tbl-cn {
        opacity: 0.85;
        color: rgba(255, 255, 255, 0.9);
    }
</style>

<div class="db-container">

    <div class="db-sidebar">
        <div class="sidebar-header">
            <i class="fas fa-database"></i> Tables in {{ current_db }}
        </div>
        <div class="table-list">
            {% for t in tables %}
            <a href="{{ url_for('db_manager', db_key=current_db, table=t) }}"
               class="db-nav-item {{ 'active' if selected_table == t else '' }}">

                <i class="fas fa-table" style="color: {{ '#fff' if selected_table == t else '#007aff' }};"></i>

                <div class="table-info-col">
                    <span class="tbl-en">{{ t }}</span>
                    <span class="tbl-cn" data-table-name="{{ t }}">Loading...</span>
                </div>
            </a>
            {% else %}
            <div style="text-align: center; color: #999; padding: 20px; font-size: 13px;">
                æ— æ•°æ®è¡¨
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // å®šä¹‰å®Œæ•´çš„æ•°æ®åº“è¡¨åæ˜ å°„å­—å…¸
            const tableMap = {
                // --- ç”¨æˆ·ä¸æƒé™ ---
                'READER': 'è¯»è€…ç”¨æˆ·ä¿¡æ¯è¡¨',
                'SYS_ROLE': 'ç³»ç»Ÿè§’è‰²å®šä¹‰',
                'SYS_PERMISSION': 'ç³»ç»Ÿæƒé™å®šä¹‰',
                'SYS_ROLE_PERMISSION': 'è§’è‰²-æƒé™å…³è”è¡¨',
                'CREDIT_LEVEL': 'ä¿¡ç”¨ç­‰çº§è§„åˆ™',
                'SYS_SETTINGS': 'ç³»ç»Ÿå…¨å±€é…ç½®',

                // --- å›¾ä¹¦é¦†è— ---
                'CIRCULATION_HEAD': 'å›¾ä¹¦ä¹¦ç›®æ€»è¡¨ (ç§)',
                'CIRCULATION_DETAIL': 'é¦†è—å®ä½“æ˜ç»† (å†Œ)',
                'BOOK_DAMAGE_LOG': 'å›¾ä¹¦æŠ¥æŸæ—¥å¿—',

                // --- æµé€šä¸šåŠ¡ ---
                'BORROW_RECORD': 'å€Ÿé˜…æµæ°´è®°å½•',
                'RESERVE_INFO': 'å›¾ä¹¦é¢„çº¦è®°å½•',
                'EXTENSION_APP': 'å€Ÿé˜…å»¶æœŸç”³è¯·',
                'CREDIT_LOG': 'ä¿¡ç”¨åˆ†å˜æ›´æ—¥å¿—',

                // --- é‡‡è®¿ä¸é‡‡è´­ ---
                'ACQ_SUGGESTION': 'è¯»è€…èè´­ç”³è¯·',
                'ORDER_HEAD': 'é‡‡è´­è®¢å•ä¸»è¡¨',
                'ORDER_LINE': 'é‡‡è´­è®¢å•æ˜ç»†',
                'ACCEPT_LIST': 'å…¥åº“éªŒæ”¶æ¸…å•',
                'RETURN_LIST': 'é‡‡è´­é€€è´§æ¸…å•',
                'SUPPLIER': 'ä¾›åº”å•†ä¿¡æ¯',

                // --- æ¶ˆæ¯ä¸å…¬å‘Š ---
                'NOTICE': 'ç³»ç»Ÿå…¬å‘Šé€šçŸ¥',
                'USER_MESSAGE': 'è¯»è€…ç•™è¨€åé¦ˆ',

                // --- æœŸåˆŠåº“ (Periodical DB) ---
                'PERIODICAL_HEAD': 'æœŸåˆŠç›®å½•ä¸»è¡¨',
                'PERIODICAL_DETAIL': 'æœŸåˆŠé¦†è—æ˜ç»†',
                'PER_SUGGESTION': 'æœŸåˆŠèè´­ç”³è¯·',
                'PER_DAMAGE_LOG': 'æœŸåˆŠæŠ¥æŸæ—¥å¿—',

                // --- AIåº“ (AI DB) ---
                'CHAT_MESSAGE': 'AIå¯¹è¯å†å²è®°å½•',

                // --- è¿ç»´åº“ (Ops DB) ---
                'ADMIN_USER': 'è¿ç»´ç®¡ç†å‘˜è¡¨',
                'SYS_CONFIG': 'è¿ç»´ç³»ç»Ÿé…ç½®'
            };

            // éå†æ‰€æœ‰å ä½ç¬¦å¹¶å¡«å…¥ä¸­æ–‡
            const spans = document.querySelectorAll('.tbl-cn');
            spans.forEach(span => {
                const tableName = span.getAttribute('data-table-name');
                if (tableMap[tableName]) {
                    span.textContent = tableMap[tableName];
                } else {
                    // å¦‚æœå­—å…¸é‡Œæ²¡æœ‰ï¼Œæ˜¾ç¤ºé»˜è®¤æ–‡å­—æˆ–ä¿ç•™è‹±æ–‡åçš„å˜ä½“
                    span.textContent = 'æ•°æ®è¡¨';
                }
            });
        });
    </script>

    <div class="db-main">
        {% if selected_table %}
            <div class="db-toolbar">
                <div class="current-table-name">
                    <i class="fas fa-table" style="color: var(--ios-blue);"></i>
                    {{ selected_table }}
                </div>
                <div class="action-group">
                    <a href="{{ url_for('db_export_csv', db_key=current_db, table_name=selected_table) }}"
                       class="btn-ios btn-ghost-blue">
                        <i class="fas fa-file-export"></i> å¯¼å‡º CSV
                    </a>

                    <form action="{{ url_for('db_import_csv', db_key=current_db, table_name=selected_table) }}"
                          method="POST" enctype="multipart/form-data" id="importForm" class="file-upload-wrapper">
                        <button type="button" class="btn-ios btn-ghost-blue">
                            <i class="fas fa-file-import"></i> å¯¼å…¥ CSV
                        </button>
                        <input type="file" name="file" accept=".csv" onchange="confirmImport(this)">
                    </form>
                </div>
            </div>

            <div class="table-scroll-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 60px; text-align: center;">ID</th>
                            {% for col in columns %}
                            <th>{{ col }}</th>
                            {% endfor %}
                            <th style="text-align: right; width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                        <tr>
                            <td style="text-align: center; font-family: monospace; color: var(--ios-text-sub);">
                                {{ row['rowid'] }}
                            </td>
                            {% for col in columns %}
                            <td title="{{ row[col] }}">
                                {{ row[col] }}
                            </td>
                            {% endfor %}
                            <td style="text-align: right;">
                                <div style="display: flex; justify-content: flex-end; gap: 4px;">
                                    <button class="icon-btn edit" onclick='openDataModal("edit", {{ row|tojson }})' title="ç¼–è¾‘">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button class="icon-btn delete" onclick="confirmDelete('{{ row['rowid'] }}')" title="åˆ é™¤">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button class="fab-add" onclick="openDataModal('add')">
                <i class="fas fa-plus"></i>
            </button>

        {% else %}
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--ios-text-sub);">
                <div style="width: 80px; height: 80px; background: #f2f2f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <i class="fas fa-database" style="font-size: 32px; opacity: 0.3;"></i>
                </div>
                <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ•°æ®è¡¨è¿›è¡Œç®¡ç†</p>
            </div>
        {% endif %}
    </div>
</div>

<div id="dataModal" class="ios-modal-overlay">
    <div class="ios-modal">
        <div class="ios-modal-header">
            <div class="ios-modal-title" id="modalTitle">Edit Record</div>
            <button class="icon-btn" onclick="closeDataModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="ios-modal-body">
            <form method="POST" id="dataForm">
                <input type="hidden" name="action" id="formAction" value="add">
                <input type="hidden" name="rowid" id="formRowId">

                <div style="max-height: 50vh; overflow-y: auto; padding-right: 10px;">
    {% for col in columns %}
    <div class="ios-form-group">
        <label class="ios-label">
            {{ col }}
            {% if col == pk_col %}<span style="color: var(--ios-blue);">(Primary Key)</span>{% endif %}
        </label>
        <input type="text" name="col_{{ col }}" id="input_{{ col }}" class="ios-input"
               placeholder="{% if col == pk_col %}Auto Increment (Leave Empty){% endif %}">
    </div>
    {% endfor %}
</div>

                <div class="ios-btn-group">
                    <button type="button" class="btn-cancel" onclick="closeDataModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-save">ä¿å­˜æ›´æ”¹</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="deleteForm" method="POST" style="display: none;">
    <input type="hidden" name="action" value="delete">
    <input type="hidden" name="rowid" id="deleteRowId">
</form>

<script>
    // ä½¿ç”¨ç‹¬ç«‹å‘½åçš„å…³é—­å‡½æ•°ï¼Œé˜²æ­¢ä¸ base_ops.html ä¸­çš„ closeModal(id) å†²çª
    function closeDataModal() {
        const modal = document.getElementById('dataModal');
        modal.classList.remove('open');
    }

    function openDataModal(mode, data = null) {
        const modal = document.getElementById('dataModal');
        const title = document.getElementById('modalTitle');
        const actionInput = document.getElementById('formAction');
        const form = document.getElementById('dataForm');

        // é‡ç½®è¡¨å•
        form.reset();

        if (mode === 'add') {
            title.innerText = 'æ–°å¢è®°å½• (New Record)';
            actionInput.value = 'add';
        } else {
            title.innerText = 'ç¼–è¾‘è®°å½• (Edit Record)';
            actionInput.value = 'edit';
            document.getElementById('formRowId').value = data.rowid;

            // è‡ªåŠ¨å¡«å……æ•°æ®
            {% for col in columns %}
            if (document.getElementById('input_{{ col }}')) {
                // å®‰å…¨å¡«å……ï¼Œå¤„ç†å¯èƒ½çš„ null/undefined
                const val = data['{{ col }}'];
                document.getElementById('input_{{ col }}').value = (val !== null && val !== undefined) ? val : '';
            }
            {% endfor %}
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.classList.add('open');
    }

    function confirmDelete(rowid) {
        if (confirm('è­¦å‘Šï¼šç¡®å®šè¦æ°¸ä¹…ç‰©ç†åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            document.getElementById('deleteRowId').value = rowid;
            document.getElementById('deleteForm').submit();
        }
    }

    function confirmImport(input) {
        if (input.files && input.files[0]) {
            if (confirm('ç¡®è®¤å¯¼å…¥æ–‡ä»¶ "' + input.files[0].name + '" åˆ°å½“å‰è¡¨å—ï¼Ÿ\n\næ³¨æ„ï¼šCSVé¦–è¡Œå¿…é¡»ä¸ºåˆ—åè¡¨å¤´ï¼Œå¦åˆ™å°†å¯¼è‡´æ•°æ®é”™ä¹±ã€‚')) {
                document.getElementById('importForm').submit();
            } else {
                input.value = ''; // ç”¨æˆ·å–æ¶ˆï¼Œæ¸…ç©ºé€‰æ‹©
            }
        }
    }

    // ç‚¹å‡»é®ç½©å±‚å…³é—­ (å¢å¼ºä½“éªŒ)
    document.getElementById('dataModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDataModal();
        }
    });
</script>
{% endblock %}
```
---

### ğŸ“„ OpsSystem\templates\login.html
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è¿ç»´ç³»ç»Ÿç™»å½•</title>
    <style>
        body {
            margin: 0; height: 100vh; display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at top left, #4f46e5, transparent 60%),
                        radial-gradient(circle at bottom right, #db2777, transparent 60%),
                        #0f172a;
            font-family: -apple-system, sans-serif;
        }
        .login-box {
            width: 400px; padding: 40px; border-radius: 24px;
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        h2 { color: white; text-align: center; margin-bottom: 30px; font-weight: 300; }
        input {
            width: 100%; padding: 14px; margin-bottom: 20px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);
            color: white; outline: none; transition: 0.3s; box-sizing: border-box;
        }
        input:focus { border-color: #6366f1; background: rgba(0,0,0,0.4); }
        button {
            width: 100%; padding: 14px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        button:hover { transform: scale(1.02); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); }
        .flash { color: #f87171; text-align: center; font-size: 13px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="login-box">
        <h2>System O&M</h2>
        {% with messages = get_flashed_messages() %}
            {% if messages %}<div class="flash">{{ messages[0] }}</div>{% endif %}
        {% endwith %}
        <form method="POST">
            <input type="text" name="username" placeholder="ç®¡ç†å‘˜è´¦å·" required>
            <input type="password" name="password" placeholder="å®‰å…¨å¯†é’¥" required>
            <button type="submit">è¿›å…¥ç³»ç»Ÿ</button>
        </form>

        <div style="text-align: center; margin-top: 20px;">
            <a href="{{ url_for('register') }}" style="color: rgba(255,255,255,0.5); text-decoration: none; font-size: 14px; transition: 0.2s;">
                æ³¨å†Œæ–°ç®¡ç†å‘˜
            </a>
            <style> a:hover { color: white !important; } </style>
        </div>
        </div>
</body>
</html>
```
---

### ğŸ“„ OpsSystem\templates\register.html
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†å‘˜æ³¨å†Œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0; height: 100vh; display: flex; align-items: center; justify-content: center;
            background: #f1f5f9; font-family: -apple-system, sans-serif;
        }
        .box {
            width: 380px; padding: 40px; background: white; border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
        }
        h2 { margin-bottom: 20px; color: #1e293b; font-weight: 700; }
        .input-group { position: relative; margin-bottom: 16px; }
        .input-group i { position: absolute; left: 14px; top: 14px; color: #94a3b8; }

        input {
            width: 100%; padding: 12px 12px 12px 40px;
            border: 1px solid #e2e8f0; border-radius: 8px; outline: none; background: #f8fafc; box-sizing: border-box;
            transition: 0.2s;
        }
        input:focus { border-color: #10b981; background: white; }

        button {
            width: 100%; padding: 12px; background: #10b981; color: white; border: none;
            border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px;
        }
        button:hover { background: #059669; }

        .flash { color: #ef4444; font-size: 13px; margin-bottom: 15px; padding: 10px; background: #fef2f2; border-radius: 8px; }
        .links a { font-size: 13px; color: #64748b; text-decoration: none; margin-top: 20px; display: inline-block; }
    </style>
</head>
<body>
    <div class="box">
        <div style="font-size: 30px; color: #10b981; margin-bottom: 10px;"><i class="fas fa-user-plus"></i></div>
        <h2>Create Account</h2>

        {% with messages = get_flashed_messages() %}
            {% if messages %}<div class="flash">{{ messages[0] }}</div>{% endif %}
        {% endwith %}

        <form method="POST">
            <div class="input-group">
                <i class="fas fa-key"></i>
                <input type="text" name="reg_key" placeholder="ä»Šæ—¥æ³¨å†Œå¯†é’¥ (Ask Admin)" required style="border-color: #f59e0b; background: #fffbeb;">
            </div>

            <div class="input-group">
                <i class="fas fa-user"></i>
                <input type="text" name="username" placeholder="è®¾ç½®ç”¨æˆ·å" required>
            </div>

            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" name="password" placeholder="è®¾ç½®å¯†ç " required>
            </div>

            <div class="input-group">
                <i class="fas fa-check-circle"></i>
                <input type="password" name="confirm_password" placeholder="ç¡®è®¤å¯†ç " required>
            </div>

            <button type="submit">ç«‹å³æ³¨å†Œ</button>
        </form>
        <div class="links"><a href="/login">è¿”å›ç™»å½•</a></div>
    </div>
</body>
</html>
```
---

### ğŸ“„ run.py
```python
from app import create_app, models
import os

app = create_app()

with app.app_context():
    # 1. ä¸šåŠ¡ä¸»åº“åˆå§‹åŒ–ä¸ä¿®å¤
    if not os.path.exists(os.path.join(app.instance_path, 'library.db')):
        print(">>> æ²¡æœ‰library.db, åˆ›å»ºä¸­...")
        models.init_db()
    else:
        # å³ä½¿æ•°æ®åº“å­˜åœ¨ï¼Œä¹Ÿæ£€æŸ¥ç»“æ„æ›´æ–° (Fix for: no such column PUBLISHER)
        print(">>> æ£€æµ‹åˆ° library.db å­˜åœ¨ï¼Œæ­£åœ¨æ£€æŸ¥ Schema...")
        models.update_db_schema()

    # 2. æœŸåˆŠåº“åˆå§‹åŒ–
    if not os.path.exists(os.path.join(app.instance_path, 'periodicals.db')):
        print(">>> æ²¡æœ‰periodicals.db, åˆ›å»ºä¸­...")
        models.init_periodical_db()

    # 3. AIåº“åˆå§‹åŒ–
    if not os.path.exists(os.path.join(app.instance_path, 'AI.db')):
        print(">>> æ²¡æœ‰AI.db, åˆ›å»ºä¸­...")
        models.init_ai_db()

    print("ç³»ç»Ÿå¯åŠ¨å°±ç»ªï¼Œè®¿é—®åœ°å€: http://127.0.0.1:5000")

if __name__ == '__main__':
    app.run(host='0.0.0.0', debug=True, port=5000)
```